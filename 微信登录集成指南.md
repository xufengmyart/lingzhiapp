# 微信登录集成指南

## 功能概述

本项目集成了微信开放平台网页授权登录功能，用户可以使用微信快速注册和登录，无需手动填写繁琐的注册信息。

### 主要特性

- ✅ **一键微信登录**：用户通过微信扫码即可快速注册和登录
- ✅ **自动获取信息**：自动获取微信昵称和头像作为用户基本信息
- ✅ **分阶段完善**：用户可以在需要时（如充值、提现）完善详细信息
- ✅ **安全验证**：完善信息时需要填写真实姓名、手机号等关键信息
- ✅ **无缝体验**：完善的用户引导和错误处理

## 配置步骤

### 1. 申请微信开放平台账号

1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 注册并登录开发者账号
3. 完成开发者资质认证（需要企业认证）

### 2. 创建网站应用

1. 在微信开放平台创建网站应用
2. 填写应用信息：
   - 应用名称：灵值生态园
   - 应用简介：基于AI的文化价值创造平台
   - 应用官网：https://your-domain.com
   - 应用图标：上传应用图标
3. 提交审核，等待微信审核通过

### 3. 获取配置信息

审核通过后，获取以下信息：
- `AppID`：应用唯一标识
- `AppSecret`：应用密钥

### 4. 配置回调地址

在微信开放平台后台设置授权回调域：
- 授权回调域：`your-domain.com`
- 完整回调地址：`http://your-domain.com/wechat/callback`

### 5. 配置环境变量

在 `admin-backend/.env` 文件中添加以下配置：

```env
# 微信开放平台配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=1234567890abcdef1234567890abcdef
WECHAT_REDIRECT_URI=http://your-domain.com/wechat/callback
```

## 数据库变更

系统会自动扩展数据库表结构，新增以下字段：

### users 表新增字段

```sql
ALTER TABLE users ADD COLUMN login_type TEXT DEFAULT 'phone';
ALTER TABLE users ADD COLUMN wechat_openid TEXT UNIQUE;
ALTER TABLE users ADD COLUMN wechat_unionid TEXT;
ALTER TABLE users ADD COLUMN wechat_nickname TEXT;
ALTER TABLE users ADD COLUMN wechat_avatar TEXT;
```

### 新增 user_profiles 表

```sql
CREATE TABLE user_profiles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER UNIQUE NOT NULL,
    real_name TEXT,
    phone TEXT UNIQUE,
    email TEXT UNIQUE,
    id_card TEXT,
    bank_account TEXT,
    bank_name TEXT,
    address TEXT,
    is_completed BOOLEAN DEFAULT 0,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## API 接口

### 1. 获取微信登录授权 URL

**接口：** `GET /api/wechat/login`

**响应：**
```json
{
  "success": true,
  "data": {
    "auth_url": "https://open.weixin.qq.com/connect/qrconnect?...",
    "state": "random_state_string"
  }
}
```

### 2. 微信登录回调

**接口：** `GET /api/wechat/callback?code=xxx&state=xxx`

**响应：**
```json
{
  "success": true,
  "data": {
    "token": "jwt_token_here",
    "user_id": 123,
    "username": "微信昵称",
    "avatar_url": "微信头像URL",
    "is_completed": false,
    "need_complete_info": true
  }
}
```

### 3. 获取用户详细信息

**接口：** `GET /api/user/profile`

**请求头：**
```
Authorization: Bearer {token}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 123,
      "username": "微信昵称",
      "email": null,
      "phone": null,
      "avatar_url": "微信头像URL"
    },
    "profile": null,
    "is_completed": false
  }
}
```

### 4. 完善用户信息

**接口：** `POST /api/user/profile`

**请求头：**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体：**
```json
{
  "real_name": "张三",
  "phone": "13800138000",
  "email": "example@email.com",
  "id_card": "110101199001011234",
  "bank_account": "6222021234567890123",
  "bank_name": "工商银行",
  "address": "北京市朝阳区"
}
```

**响应：**
```json
{
  "success": true,
  "message": "用户信息完善成功"
}
```

### 5. 检查是否需要完善信息

**接口：** `GET /api/user/require-complete`

**请求头：**
```
Authorization: Bearer {token}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "need_complete": true,
    "login_type": "wechat",
    "is_completed": false
  }
}
```

## 前端页面

### 1. 登录页面

登录页面新增"微信登录"按钮，点击后跳转到微信授权页面。

**路由：** `/login`

### 2. 微信回调页面

微信授权后回调到此页面，自动处理登录逻辑。

**路由：** `/wechat/callback`

### 3. 完善信息页面

微信登录用户首次登录后，会跳转到此页面完善信息。

**路由：** `/complete-profile`

## 用户流程

### 正常登录流程

```
用户点击"微信登录" 
  → 跳转到微信授权页面 
  → 用户扫码授权 
  → 回调到 /wechat/callback 
  → 创建/登录用户 
  → 检查是否完善信息 
  → 未完善：跳转到 /complete-profile 
  → 已完善：跳转到首页
```

### 完善信息流程

```
用户访问需要完善信息的页面
  → 系统检测未完善信息
  → 跳转到 /complete-profile
  → 用户填写信息
  → 提交信息
  → 更新用户状态
  → 返回原页面
```

## 注意事项

1. **微信开放平台认证**：需要企业认证，个人账号无法创建网站应用
2. **回调地址配置**：必须在微信开放平台后台配置正确的回调地址
3. **HTTPS 要求**：生产环境建议使用 HTTPS 协议
4. **用户隐私**：严格遵守微信开放平台用户隐私政策
5. **数据安全**：用户敏感信息加密存储，防止泄露

## 测试方法

### 1. 本地测试

由于微信开放平台需要真实的域名，本地测试可以使用内网穿透工具（如 ngrok）：

```bash
# 使用 ngrok 创建临时域名
ngrok http 3000

# 将生成的域名配置到微信开放平台
WECHAT_REDIRECT_URI=https://your-ngrok-domain.com/wechat/callback
```

### 2. 生产环境

确保以下配置正确：
- 微信开放平台回调地址配置正确
- 域名已备案
- 服务器防火墙开放相应端口
- HTTPS 证书已配置（建议）

## 常见问题

### 1. 授权失败

**原因：**
- AppID 或 AppSecret 配置错误
- 回调地址未配置或配置错误
- 应用未通过审核

**解决方案：**
- 检查 .env 文件中的配置
- 确认微信开放平台回调地址配置正确
- 确认应用已通过审核

### 2. 无法获取用户信息

**原因：**
- access_token 过期
- 用户取消了授权
- scope 配置不正确

**解决方案：**
- 检查 scope 是否包含 snsapi_userinfo
- 引导用户重新授权
- 检查微信开放平台应用权限

### 3. 回调地址错误

**原因：**
- 回调地址与微信开放平台配置不一致
- URL 编码问题

**解决方案：**
- 确保 WECHAT_REDIRECT_URI 与微信开放平台配置完全一致
- 检查 URL 编码是否正确

## 技术支持

如有问题，请联系技术支持或查看微信开放平台官方文档：
- [微信开放平台文档](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html)
