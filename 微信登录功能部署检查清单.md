# 微信登录功能部署检查清单

使用此检查清单验证微信登录功能是否成功部署。

---

## 部署前检查

- [ ] 已在微信开放平台注册开发者账号
- [ ] 已完成企业认证（个人账号无法创建网站应用）
- [ ] 已创建网站应用并审核通过
- [ ] 已获取 AppID 和 AppSecret
- [ ] 已准备域名（建议使用 HTTPS）
- [ ] 域名已完成 ICP 备案（如服务器在国内）
- [ ] 服务器已配置好环境（Python 3.13+, Node.js 18+）
- [ ] 服务器防火墙已开放相应端口（80, 443, 8001）

---

## 配置检查

### 后端配置

- [ ] `admin-backend/.env` 文件已创建
- [ ] 已填写 `WECHAT_APP_ID`（正确格式：wx 开头，18位）
- [ ] 已填写 `WECHAT_APP_SECRET`（32位字符）
- [ ] 已填写 `WECHAT_REDIRECT_URI`（格式：https://domain.com/wechat/callback）
- [ ] .env 文件未提交到版本控制系统
- [ ] AppSecret 未暴露在前端代码中

### 微信开放平台配置

- [ ] 已在应用详情页找到 AppID 和 AppSecret
- [ ] 已设置授权回调域（只填域名，不含协议和路径）
- [ ] 授权回调域与 WECHAT_REDIRECT_URI 中的域名一致
- [ ] 应用状态为"已审核通过"

---

## 代码部署检查

### 后端部署

- [ ] 后端代码已上传到服务器
- [ ] Python 依赖已安装（pip3 install -r requirements.txt）
- [ ] 数据库已更新（包含微信相关字段）
- [ ] 后端服务已启动（systemctl start lingzhi-api）
- [ ] 后端服务运行正常（systemctl status lingzhi-api）
- [ ] 后端监听端口 8001

### 前端部署

- [ ] 前端代码已构建（npm run build）
- [ ] 构建产物已上传到服务器
- [ ] Nginx 已配置正确
- [ ] Nginx 已重启（systemctl restart nginx）
- [ ] 网站可正常访问

---

## 功能测试检查

### 基础功能测试

- [ ] 网站首页可正常访问
- [ ] 登录页面可正常访问
- [ ] "微信登录"按钮显示正常
- [ ] 点击"微信登录"可跳转到微信授权页面

### 微信授权测试

- [ ] 微信授权页面可正常显示
- [ ] 可扫码授权
- [ ] 授权成功后可正常回调
- [ ] 回调页面可正常处理授权信息

### 用户创建/登录测试

- [ ] 首次微信登录可自动创建用户
- [ ] 再次微信登录可正常登录
- [ ] 用户信息（昵称、头像）可正确获取
- [ ] JWT token 可正确生成

### 信息完善测试

- [ ] 首次微信登录后跳转到信息完善页面
- [ ] 信息完善页面显示正常
- [ ] 表单验证功能正常
- [ ] 提交信息后可正确保存
- [ ] 提交后可跳转到首页

---

## API 接口检查

### 检查脚本

使用以下脚本检查 API 接口：

```bash
#!/bin/bash

BASE_URL="http://123.56.142.143:8001"

echo "测试微信登录 API 接口..."
echo ""

# 测试 1: 获取微信登录授权 URL
echo "[测试 1] 获取微信登录授权 URL"
curl -s "$BASE_URL/api/wechat/login" | python3 -m json.tool
echo ""

# 测试 2: 检查是否需要完善信息（需要 token）
echo "[测试 2] 检查是否需要完善信息（需要 token）"
TOKEN="your_token_here"
curl -s -H "Authorization: Bearer $TOKEN" "$BASE_URL/api/user/require-complete" | python3 -m json.tool
echo ""

# 测试 3: 获取用户详细信息（需要 token）
echo "[测试 3] 获取用户详细信息（需要 token）"
curl -s -H "Authorization: Bearer $TOKEN" "$BASE_URL/api/user/profile" | python3 -m json.tool
echo ""

echo "API 接口测试完成"
```

### API 接口清单

- [ ] `GET /api/wechat/login` - 返回微信授权 URL
- [ ] `GET /api/wechat/callback` - 处理微信授权回调
- [ ] `GET /api/user/profile` - 获取用户详细信息
- [ ] `POST /api/user/profile` - 完善用户信息
- [ ] `GET /api/user/require-complete` - 检查是否需要完善信息

---

## 日志检查

### 后端日志

```bash
# 查看实时日志
ssh root@123.56.142.143 'journalctl -u lingzhi-api -f'

# 查看最近 50 条日志
ssh root@123.56.142.143 'journalctl -u lingzhi-api -n 50'

# 查看错误日志
ssh root@123.56.142.143 'journalctl -u lingzhi-api -p err -n 50'
```

检查项：
- [ ] 服务启动无错误
- [ ] 数据库连接正常
- [ ] 微信授权回调处理正常
- [ ] 用户创建/登录无错误

### Nginx 日志

```bash
# 查看访问日志
ssh root@123.56.142.143 'tail -f /var/log/nginx/access.log'

# 查看错误日志
ssh root@123.56.142.143 'tail -f /var/log/nginx/error.log'
```

检查项：
- [ ] 无 404 错误
- [ ] 无 500 错误
- [ ] 回调请求可正常处理

---

## 安全检查

- [ ] AppSecret 已妥善保管
- [ ] .env 文件权限正确（600）
- [ ] 数据库密码已修改
- [ ] 使用 HTTPS 协议（生产环境）
- [ ] 防火墙规则已配置
- [ ] 禁用了调试模式（debug=False）

---

## 性能检查

- [ ] 页面加载时间 < 3 秒
- [ ] API 响应时间 < 500ms
- [ ] 并发用户支持 > 100
- [ ] 数据库查询已优化

---

## 兼容性检查

### 浏览器兼容性

- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）
- [ ] 移动浏览器（iOS Safari, Chrome Mobile）

### 微信版本

- [ ] 微信 8.0+
- [ ] 支持微信扫码授权

---

## 文档检查

- [ ] 已阅读《微信登录集成指南.md》
- [ ] 已阅读《微信登录功能详细操作指南.md》
- [ ] 已阅读《微信登录功能完成总结.md》
- [ ] 已了解常见问题和解决方案

---

## 回滚计划

如果部署出现问题，准备回滚方案：

- [ ] 已备份原始代码
- [ ] 已备份数据库
- [ ] 已备份配置文件
- [ ] 知道如何快速回滚
- [ ] 已通知相关团队

---

## 部署验证签名

如果以上所有检查都通过，请在下方签名确认：

```
部署人员：_________________
部署日期：_________________
验证结果：[ ] 通过  [ ] 不通过
备注：___________________
```

---

## 常见问题快速排查

### 问题 1：微信授权页面显示 "redirect_uri 参数错误"

**检查项：**
- [ ] WECHAT_REDIRECT_URI 是否正确
- [ ] 微信开放平台授权回调域是否正确
- [ ] 域名是否一致
- [ ] 是否包含协议或路径（应该只填域名）

### 问题 2：微信授权页面显示 "AppID 或 AppSecret 错误"

**检查项：**
- [ ] AppID 是否正确（wx 开头，18位）
- [ ] AppSecret 是否正确（32位）
- [ ] 应用是否已审核通过
- [ ] 后端是否已重启

### 问题 3：授权成功后回调失败

**检查项：**
- [ ] 后端服务是否正常运行
- [ ] 端口 8001 是否开放
- [ ] Nginx 配置是否正确
- [ ] 回调地址是否可访问

### 问题 4：无法获取用户信息

**检查项：**
- [ ] scope 是否包含 snsapi_userinfo
- [ ] access_token 是否有效
- [ ] 网络连接是否正常

### 问题 5：前端构建错误

**检查项：**
- [ ] 依赖是否已安装（npm install）
- [ ] Node.js 版本是否正确（18+）
- [ ] TypeScript 错误是否已修复

---

## 部署完成确认

当所有检查项都通过后，部署即视为完成。

**部署状态：** 🟢 成功

**部署时间：** _______

**下次维护：** _______

---

## 技术支持

如果遇到无法解决的问题，请：

1. 查阅相关文档
2. 查看日志文件
3. 联系技术支持

**技术支持联系方式：**
- 邮箱：support@example.com
- 电话：400-XXX-XXXX
- 工作时间：周一至周五 9:00-18:00

---

祝您部署顺利！🎉
