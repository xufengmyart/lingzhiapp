<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸è½½ Service Worker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
        }
        h1 {
            color: #4F46E5;
            margin-bottom: 20px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        button {
            background-color: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background-color: #3B82F6;
        }
        button:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
        }
        .step {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 4px;
            text-align: left;
        }
        .step strong {
            color: #4F46E5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å¸è½½ Service Worker</h1>
        <p>æ­¤é¡µé¢å°†å¸è½½æ‰€æœ‰ Service Worker å¹¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜</p>

        <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>

        <div class="steps">
            <div class="step"><strong>æ­¥éª¤ 1ï¼š</strong>æ¸…é™¤æ‰€æœ‰ç¼“å­˜</div>
            <div class="step"><strong>æ­¥éª¤ 2ï¼š</strong>å¸è½½æ‰€æœ‰ Service Worker</div>
            <div class="step"><strong>æ­¥éª¤ 3ï¼š</strong>æ¸…é™¤æœ¬åœ°å­˜å‚¨</div>
            <div class="step"><strong>æ­¥éª¤ 4ï¼š</strong>é‡å®šå‘åˆ°ä¸»é¡µ</div>
        </div>

        <button id="unregisterBtn" onclick="unregisterAll()">ç«‹å³å¸è½½</button>
        <button onclick="goHome()">è¿”å›ä¸»é¡µ</button>

        <script>
            const statusDiv = document.getElementById('status');
            const unregisterBtn = document.getElementById('unregisterBtn');

            function updateStatus(message, isError = false) {
                statusDiv.textContent = message;
                statusDiv.className = isError ? 'status error' : 'status';
                console.log('[å¸è½½ Service Worker]', message);
            }

            async function unregisterAll() {
                unregisterBtn.disabled = true;
                updateStatus('å¼€å§‹å¸è½½...');

                try {
                    // æ­¥éª¤ 1: æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                    updateStatus('æ­¥éª¤ 1: æ¸…é™¤æ‰€æœ‰ç¼“å­˜...');
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                        console.log('å·²æ¸…é™¤ç¼“å­˜:', cacheNames);
                    }

                    // æ­¥éª¤ 2: å¸è½½æ‰€æœ‰ Service Worker
                    updateStatus('æ­¥éª¤ 2: å¸è½½æ‰€æœ‰ Service Worker...');
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                            console.log('å·²å¸è½½ Service Worker:', registration.scope);
                        }
                    }

                    // æ­¥éª¤ 3: æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    updateStatus('æ­¥éª¤ 3: æ¸…é™¤æœ¬åœ°å­˜å‚¨...');
                    localStorage.clear();
                    sessionStorage.clear();

                    // æ¸…é™¤æ‰€æœ‰ cookies
                    document.cookie.split(";").forEach(function(c) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });

                    // æ­¥éª¤ 4: é‡å®šå‘åˆ°ä¸»é¡µ
                    updateStatus('æ­¥éª¤ 4: æ­£åœ¨è·³è½¬åˆ°ä¸»é¡µ...');
                    console.log('æ‰€æœ‰æ¸…ç†å®Œæˆï¼Œå‡†å¤‡è·³è½¬');

                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);

                } catch (error) {
                    console.error('å¸è½½å¤±è´¥:', error);
                    updateStatus('å¸è½½å¤±è´¥: ' + error.message, true);
                    unregisterBtn.disabled = false;
                }
            }

            function goHome() {
                window.location.href = '/';
            }

            // è‡ªåŠ¨æ£€æµ‹æ˜¯å¦éœ€è¦å¸è½½
            window.addEventListener('load', async () => {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length > 0) {
                        updateStatus(`å‘ç° ${registrations.length} ä¸ª Service Workerï¼Œå»ºè®®å¸è½½`);
                    } else {
                        updateStatus('æœªå‘ç° Service Workerï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨');
                    }
                } else {
                    updateStatus('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
                }
            });
        </script>
    </div>
</body>
</html>
