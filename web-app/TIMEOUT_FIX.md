# 🔧 对话连接超时问题排查指南

## 问题描述

**错误信息**: "对话连接已断开，请刷新页面重连对话: timeout, try reconnecting"

---

## ✅ 快速解决方案

### 方案1：清除浏览器缓存（推荐）

**Chrome/Edge**:
1. 按 `Ctrl + Shift + Delete` (Windows) 或 `Cmd + Shift + Delete` (Mac)
2. 选择"缓存的图片和文件"
3. 选择"过去1小时"或"全部时间"
4. 点击"清除数据"
5. 刷新页面

**Firefox**:
1. 按 `Ctrl + Shift + Delete` (Windows) 或 `Cmd + Shift + Delete` (Mac)
2. 选择"缓存"
3. 点击"立即清除"
4. 刷新页面

**Safari (Mac)**:
1. Safari菜单 > 偏好设置 > 隐私
2. 点击"管理网站数据"
3. 点击"全部移除"
4. 刷新页面

---

### 方案2：检查网络连接

1. 确保网络连接正常
2. 尝试刷新页面
3. 如果使用VPN，尝试关闭VPN

---

### 方案3：使用无痕/隐私模式

1. 打开无痕窗口：
   - Chrome: `Ctrl + Shift + N` (Windows) / `Cmd + Shift + N` (Mac)
   - Firefox: `Ctrl + Shift + P` (Windows) / `Cmd + Shift + P` (Mac)
   - Safari: `Cmd + Shift + N` (Mac)
2. 访问应用
3. 测试对话功能

---

### 方案4：禁用浏览器扩展

某些浏览器扩展可能会干扰应用：

1. Chrome/Edge:
   - 访问 `chrome://extensions/`
   - 暂时禁用所有扩展
   - 刷新页面测试
   - 逐个启用扩展以找出问题

2. Firefox:
   - 访问 `about:addons`
   - 暂时禁用所有扩展
   - 刷新页面测试

---

## 🔍 深度排查

### 检查1：查看浏览器控制台错误

1. 按 `F12` 打开开发者工具
2. 切换到"Console"（控制台）标签
3. 查看是否有红色错误信息
4. 截图并保存错误信息

### 检查2：查看Network（网络）请求

1. 按 `F12` 打开开发者工具
2. 切换到"Network"（网络）标签
3. 发送一条对话消息
4. 查看是否有失败的请求（红色）
5. 点击失败的请求，查看详情

### 检查3：确认Mock API已启用

1. 打开开发者工具（F12）
2. 在Console中输入：
   ```javascript
   localStorage.getItem('token')
   ```
3. 如果返回null或undefined，说明未登录

---

## 🛠️ 开发者修复

### 修复1：确保Mock API已启用

检查 `web-app/src/services/api.ts`:

```typescript
// 确保这一行是 true
const USE_MOCK_API = true
```

如果不是，修改为 `true` 并重启应用。

### 修复2：重启开发服务器

```bash
# 停止服务器（Ctrl + C）

# 清理缓存
rm -rf node_modules/.vite

# 重新启动
npm run dev
```

### 修复3：更新依赖

```bash
# 清理缓存
npm cache clean --force

# 删除node_modules
rm -rf node_modules package-lock.json

# 重新安装
npm install

# 启动应用
npm run dev
```

---

## 📊 已修复的问题

### 问题1：错误处理不够详细

**修复内容**:
- 添加了更详细的错误类型判断
- 根据错误类型提供不同的错误消息
- 改进了用户反馈

**修复位置**: `web-app/src/contexts/ChatContext.tsx`

### 问题2：超时处理

**修复内容**:
- 添加了超时错误检测
- 提供了超时后的重试建议
- 优化了错误消息显示

---

## 🎯 预防措施

### 1. 定期清除缓存

建议每周清除一次浏览器缓存，避免缓存问题。

### 2. 使用最新版本

确保使用最新版本的浏览器：
- Chrome: 90+
- Firefox: 88+
- Edge: 90+
- Safari: 14+

### 3. 禁用不必要的扩展

只保留必要的浏览器扩展，避免冲突。

### 4. 检查网络连接

确保网络连接稳定，避免网络波动。

---

## 🆘 如果问题仍然存在

### 收集信息

请提供以下信息以便进一步排查：

1. **浏览器信息**:
   - 浏览器类型和版本
   - 操作系统

2. **错误截图**:
   - 控制台错误信息
   - Network失败请求

3. **复现步骤**:
   - 具体的操作步骤
   - 错误发生的时机

### 提交问题

将收集的信息提交到：
- GitHub Issues
- 技术支持邮箱
- 在线客服

---

## 📝 已知问题列表

| 问题 | 状态 | 解决方案 |
|------|------|----------|
| 首次加载缓慢 | 已知 | 使用Mock API已优化 |
| 消息延迟1秒 | 正常 | Mock API模拟延迟 |
| 刷新页面后对话清空 | 正常 | 当前版本特性 |
| 离线无法使用 | 已知 | PWA功能开发中 |

---

## ✅ 验证修复

修复后，请执行以下验证：

1. [ ] 清除浏览器缓存
2. [ ] 刷新页面
3. [ ] 登录应用
4. [ ] 进入对话页面
5. [ ] 发送测试消息
6. [ ] 确认收到回复
7. [ ] 检查控制台无错误

---

## 🎉 成功标志

如果看到以下情况，说明问题已解决：

✅ 发送消息后1-2秒内收到回复
✅ 错误信息不再出现
✅ 控制台无红色错误
✅ 可以正常多轮对话
✅ 刷新页面后功能正常

---

**如果以上方案都无法解决问题，请联系技术支持！** 📞
