<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¼“å­˜è¯Šæ–­å·¥å…·</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <style>
    body {
      font-family: monospace;
      background: #0A0D18;
      color: #00C3FF;
      padding: 20px;
      margin: 0;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #fff;
      border-bottom: 2px solid #00C3FF;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(18, 26, 47, 0.8);
      border: 1px solid rgba(0, 195, 255, 0.2);
      border-radius: 8px;
    }
    .section-title {
      font-weight: bold;
      color: #47D1FF;
      margin-bottom: 10px;
    }
    .ok {
      color: #00ff88;
    }
    .error {
      color: #ff4444;
    }
    .warning {
      color: #ffc107;
    }
    .info {
      color: #B4C7E7;
    }
    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .action-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: linear-gradient(90deg, #00C3FF, #00E0FF);
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 195, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ç¼“å­˜è¯Šæ–­å·¥å…·</h1>

    <div class="section">
      <div class="section-title">1. å½“å‰é¡µé¢ä¿¡æ¯</div>
      <div id="pageInfo"></div>
    </div>

    <div class="section">
      <div class="section-title">2. åŠ è½½çš„é™æ€èµ„æº</div>
      <div id="resources"></div>
    </div>

    <div class="section">
      <div class="section-title">3. Service Worker çŠ¶æ€</div>
      <div id="swStatus"></div>
    </div>

    <div class="section">
      <div class="section-title">4. ç¼“å­˜çŠ¶æ€</div>
      <div id="cacheStatus"></div>
    </div>

    <div class="section">
      <div class="section-title">5. ç‰ˆæœ¬ä¿¡æ¯</div>
      <div id="versionInfo"></div>
    </div>

    <div class="section">
      <div class="section-title">6. è¯Šæ–­å»ºè®®</div>
      <div id="suggestions"></div>
    </div>

    <button class="action-btn" onclick="window.location.href='/force-refresh.html'">
      ğŸš€ å‰å¾€å¼ºåˆ¶åˆ·æ–°é¡µé¢
    </button>
  </div>

  <script>
    // è¯Šæ–­ä¿¡æ¯
    async function diagnose() {
      const pageInfo = document.getElementById('pageInfo');
      const resources = document.getElementById('resources');
      const swStatus = document.getElementById('swStatus');
      const cacheStatus = document.getElementById('cacheStatus');
      const versionInfo = document.getElementById('versionInfo');
      const suggestions = document.getElementById('suggestions');

      // 1. é¡µé¢ä¿¡æ¯
      pageInfo.innerHTML = `
        <div>URL: <code>${window.location.href}</code></div>
        <div>æ—¶é—´: <code>${new Date().toLocaleString()}</code></div>
        <div>User Agent: <code>${navigator.userAgent.substring(0, 100)}...</code></div>
      `;

      // 2. é™æ€èµ„æº
      let resourcesHtml = '';
      document.querySelectorAll('script[src], link[rel="stylesheet"]').forEach(el => {
        const src = el.src || el.href;
        const fileName = src.split('/').pop();
        resourcesHtml += `
          <div>
            <span class="info">${fileName}</span>
            <br>
            <small>${src}</small>
          </div>
        `;
      });
      resources.innerHTML = resourcesHtml || '<div class="info">æ— é™æ€èµ„æº</div>';

      // 3. Service Worker
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        if (registrations.length > 0) {
          swStatus.innerHTML = `
            <div class="warning">å·²æ³¨å†Œ ${registrations.length} ä¸ª Service Worker</div>
            ${registrations.map(reg => `
              <div class="info">
                Scope: ${reg.scope}<br>
                Active: ${reg.active ? 'Yes' : 'No'}<br>
                Installing: ${reg.installing ? 'Yes' : 'No'}<br>
                Waiting: ${reg.waiting ? 'Yes' : 'No'}
              </div>
            `).join('')}
          `;
        } else {
          swStatus.innerHTML = '<div class="ok">æœªæ³¨å†Œ Service Worker</div>';
        }
      } else {
        swStatus.innerHTML = '<div class="info">æµè§ˆå™¨ä¸æ”¯æŒ Service Worker</div>';
      }

      // 4. ç¼“å­˜
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        if (cacheNames.length > 0) {
          cacheStatus.innerHTML = `
            <div class="warning">å­˜åœ¨ ${cacheNames.length} ä¸ªç¼“å­˜</div>
            ${cacheNames.map(name => `<div class="info">${name}</div>`).join('')}
          `;
        } else {
          cacheStatus.innerHTML = '<div class="ok">æ— ç¼“å­˜</div>';
        }
      } else {
        cacheStatus.innerHTML = '<div class="info">æµè§ˆå™¨ä¸æ”¯æŒ Cache API</div>';
      }

      // 5. ç‰ˆæœ¬ä¿¡æ¯
      try {
        const response = await fetch('/version.json?' + Date.now(), { cache: 'no-store' });
        if (response.ok) {
          const versionData = await response.json();
          versionInfo.innerHTML = `
            <div class="ok">æœåŠ¡å™¨ç‰ˆæœ¬: ${versionData.version}</div>
            <div class="info">æ„å»ºæ—¶é—´: ${versionData.buildTime}</div>
            <div class="info">Git æäº¤: ${versionData.gitCommit}</div>
          `;
        } else {
          versionInfo.innerHTML = '<div class="error">æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯</div>';
        }
      } catch (e) {
        versionInfo.innerHTML = `<div class="error">è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥: ${e.message}</div>`;
      }

      // 6. å»ºè®®
      const suggestionsList = [];

      // æ£€æŸ¥ JS æ–‡ä»¶ç‰ˆæœ¬
      const currentJs = document.querySelector('script[src*="index-"]')?.src || '';
      const match = currentJs.match(/index-([A-Z0-9]+)\.js/);
      if (match) {
        const hash = match[1];
        if (hash === 'KGT10jHb' || hash === 'CiAneXUA') {
          suggestionsList.push('<div class="error">âŒ æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬æ–‡ä»¶ï¼è¯·å¼ºåˆ¶åˆ·æ–°ç¼“å­˜</div>');
        } else {
          suggestionsList.push(`<div class="ok">âœ“ åŠ è½½æ­£ç¡®ç‰ˆæœ¬çš„æ–‡ä»¶</div>`);
        }
      }

      // æ£€æŸ¥ Service Worker
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        if (registrations.length > 0) {
          suggestionsList.push('<div class="warning">âš ï¸ å»ºè®®æ¸…é™¤ Service Worker</div>');
        }
      }

      // æ£€æŸ¥ç¼“å­˜
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        if (cacheNames.length > 0) {
          suggestionsList.push('<div class="warning">âš ï¸ å»ºè®®æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</div>');
        }
      }

      // æœ€ç»ˆå»ºè®®
      if (suggestionsList.some(s => s.includes('error'))) {
        suggestionsList.push('<div class="error"><strong>ğŸš¨ ç«‹å³æ“ä½œï¼š</strong>è®¿é—® <a href="/force-refresh.html" style="color: #00C3FF;">å¼ºåˆ¶åˆ·æ–°é¡µé¢</a></div>');
      } else if (suggestionsList.some(s => s.includes('warning'))) {
        suggestionsList.push('<div class="warning"><strong>å»ºè®®ï¼š</strong>è®¿é—® <a href="/force-refresh.html" style="color: #00C3FF;">å¼ºåˆ¶åˆ·æ–°é¡µé¢</a> ä»¥ç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬</div>');
      } else {
        suggestionsList.push('<div class="ok">âœ“ ä¸€åˆ‡æ­£å¸¸ï¼</div>');
      }

      suggestions.innerHTML = suggestionsList.join('');
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œè¯Šæ–­
    window.addEventListener('load', diagnose);
  </script>
</body>
</html>
