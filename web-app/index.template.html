<!doctype html>
<!-- Build Time: {{BUILD_TIME}} -->
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#4F46E5" />
    <meta name="description" content="灵值生态园智能体应用 - 用户旅程管理、经济模型计算、智能对话" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="灵值生态园" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-TileColor" content="#4F46E5" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="app-version" content="{{VERSION}}" />

    <title>灵值生态园 - 智能体APP</title>

    <!-- 极激进的缓存清理脚本 - 立即执行 -->
    <script>
      (function() {
        'use strict';

        console.log('[紧急清理] 开始紧急清理...');

        // 1. 立即阻止任何 Service Worker 注册
        if ('serviceWorker' in navigator) {
          const originalRegister = navigator.serviceWorker.register;
          navigator.serviceWorker.register = function(...args) {
            console.warn('[紧急清理] 严格阻止 Service Worker 注册');
            return Promise.reject(new Error('Service Worker 已被严格禁用'));
          };
        }

        // 2. 立即注销所有 Service Worker
        async function forceCleanupServiceWorkers() {
          if ('serviceWorker' in navigator) {
            try {
              const registrations = await navigator.serviceWorker.getRegistrations();
              console.log(`[紧急清理] 发现 ${registrations.length} 个 Service Worker，全部注销`);

              await Promise.all(registrations.map(reg => reg.unregister()));
              console.log('[紧急清理] 所有 Service Worker 已强制注销');
            } catch (error) {
              console.error('[紧急清理] 注销失败:', error);
            }
          }
        }

        // 3. 立即清除所有缓存
        async function forceCleanupCaches() {
          if ('caches' in window) {
            try {
              const cacheNames = await caches.keys();
              console.log(`[紧急清理] 发现 ${cacheNames.length} 个缓存，全部清除`);

              await Promise.all(cacheNames.map(name => caches.delete(name)));
              console.log('[紧急清理] 所有缓存已强制清除');
            } catch (error) {
              console.error('[紧急清理] 缓存清除失败:', error);
            }
          }
        }

        // 4. 立即清除所有存储
        function forceCleanupStorage() {
          try {
            localStorage.clear();
            sessionStorage.clear();
            console.log('[紧急清理] 所有存储已强制清除');
          } catch (error) {
            console.error('[紧急清理] 存储清除失败:', error);
          }
        }

        // 同步执行关键操作
        forceCleanupStorage();

        // 异步执行清理
        Promise.all([
          forceCleanupServiceWorkers(),
          forceCleanupCaches()
        ]).then(() => {
          console.log('[紧急清理] 紧急清理完成');
        }).catch(error => {
          console.error('[紧急清理] 清理过程出错:', error);
        });
      })();
    </script>

    <!-- 版本检查与强制刷新（增强版） -->
    <script>
      (function() {
        'use strict';

        const CURRENT_VERSION = '{{VERSION}}';
        const STORAGE_KEY = 'app_version';
        const FORCE_REFRESH_KEY = 'force_refresh_' + CURRENT_VERSION;

        console.log('[版本检查] 当前版本:', CURRENT_VERSION);

        // 从 localStorage 读取版本
        let savedVersion;
        try {
          savedVersion = localStorage.getItem(STORAGE_KEY);
        } catch (e) {
          savedVersion = null;
        }

        console.log('[版本检查] 本地版本:', savedVersion);

        // 检查是否需要强制刷新
        const needForceRefresh = savedVersion && savedVersion !== CURRENT_VERSION;

        if (needForceRefresh) {
          console.log('[版本检查] 版本不一致，执行强制刷新');
          console.log('[版本检查] 旧版本:', savedVersion, '新版本:', CURRENT_VERSION);

          // 清除所有存储
          try {
            localStorage.clear();
            sessionStorage.clear();
            console.log('[版本检查] 本地存储已清除');
          } catch (e) {
            console.error('[版本检查] 存储清除失败:', e);
          }

          // 设置刷新标志
          try {
            sessionStorage.setItem(FORCE_REFRESH_KEY, 'true');
          } catch (e) {
            // 忽略
          }

          // 强制刷新页面（绕过所有缓存）
          console.log('[版本检查] 正在强制刷新页面...');

          // 方法1: 添加随机参数刷新
          const url = new URL(window.location.href);
          url.searchParams.set('v', CURRENT_VERSION);
          url.searchParams.set('t', Date.now());
          url.searchParams.set('r', Math.random());

          // 方法2: 清除 URL 哈希
          url.hash = '';

          window.location.replace(url.toString());
          return; // 停止执行
        }

        // 检查是否刚刚刷新过
        const justRefreshed = sessionStorage.getItem(FORCE_REFRESH_KEY) === 'true';
        if (justRefreshed) {
          console.log('[版本检查] 刚刚完成刷新，清除标志');
          sessionStorage.removeItem(FORCE_REFRESH_KEY);
        }

        // 保存当前版本
        try {
          localStorage.setItem(STORAGE_KEY, CURRENT_VERSION);
          console.log('[版本检查] 版本已保存:', CURRENT_VERSION);
        } catch (e) {
          console.error('[版本检查] 版本保存失败:', e);
        }

        // 显示提示（如果版本不一致）
        if (savedVersion && savedVersion !== CURRENT_VERSION && !justRefreshed) {
          console.log('[版本检查] 检测到版本变化，建议手动清除浏览器缓存');
          if (confirm('检测到新版本，建议清除浏览器缓存以获得最佳体验。\n\n点击"确定"将尝试自动刷新页面，如果仍有问题请手动清除浏览器缓存。')) {
            window.location.reload(true);
          }
        }
      })();
    </script>

    <!-- 添加额外的缓存控制 -->
    <script>
      // 禁用所有可能的缓存
      if (window.history && window.history.pushState) {
        const originalPushState = window.history.pushState;
        window.history.pushState = function(state, title, url) {
          if (url) {
            // 添加版本参数
            const version = '{{VERSION}}';
            const separator = url.includes('?') ? '&' : '?';
            return originalPushState.call(this, state, title, url + separator + 'v=' + version);
          }
          return originalPushState.call(this, state, title, url);
        };
      }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- 加载主脚本 -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
