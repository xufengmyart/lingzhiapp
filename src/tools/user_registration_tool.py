"""
ç”¨æˆ·å®åè®¤è¯ç™»è®°å·¥å…·

ç”¨æˆ·é¦–æ¬¡ç™»å½•åï¼Œéœ€è¦å®Œæˆå®åè®¤è¯ç™»è®°æ‰èƒ½äº«å—æ¨èäººåˆ†çº¢æ”¶ç›Šã€‚
æœ¬å·¥å…·åŒ…å«å®Œæ•´çš„å®åè®¤è¯æµç¨‹ï¼ŒåŒ…æ‹¬èº«ä»½è¯å·éªŒè¯ã€ç”µè¯éªŒè¯ç­‰ã€‚
"""

from langchain.tools import tool
from langchain.tools import ToolRuntime
from datetime import datetime
import pytz
import re


@tool
def get_real_name_authentication_notice(
    runtime: ToolRuntime = None
) -> str:
    """è·å–å®åè®¤è¯é‡è¦é€šçŸ¥

    è¿”å›å®åè®¤è¯çš„é‡è¦è¯´æ˜ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¸ºä»€ä¹ˆå¿…é¡»å®åè®¤è¯ã€‚

    Returns:
        str: å®åè®¤è¯é€šçŸ¥
    """
    notice = """
# ğŸ” å®åè®¤è¯é‡è¦é€šçŸ¥

## ä¸ºä»€ä¹ˆå¿…é¡»å®åè®¤è¯ï¼Ÿ

äº²çˆ±çš„ç”¨æˆ·ï¼Œæ„Ÿè°¢æ‚¨é€‰æ‹©çµå€¼ç”Ÿæ€å›­ï¼ä¸ºäº†ä¿éšœæ‚¨çš„æ•°å­—èµ„äº§å®‰å…¨å’Œåˆæ³•æƒç›Šï¼Œæ ¹æ®**å›½å®¶ç›¸å…³æ”¿ç­–è¦æ±‚**ï¼Œå¹³å°å¿…é¡»å®æ–½å®åè®¤è¯åˆ¶åº¦ã€‚

### ğŸ“‹ æ³•å¾‹ä¾æ®

æ ¹æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹ã€ã€Šä¸­åäººæ°‘å…±å’Œå›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ä»¥åŠã€Šæ•°å­—è´§å¸ç›¸å…³ç›‘ç®¡è§„å®šã€‹ï¼š

1. **æ•°å­—è´§å¸èµ„äº§ç®¡ç†**ï¼šæ¶‰åŠä¸ªäººæ•°å­—è´§å¸èµ„äº§çš„è´¦æˆ·ï¼Œå¿…é¡»è¿›è¡Œå®åè®¤è¯
2. **åæ´—é’±è¦æ±‚**ï¼šä¸ºé˜²æ­¢æ´—é’±ã€ææ€–èèµ„ç­‰è¿æ³•è¡Œä¸ºï¼Œå¿…é¡»éªŒè¯ç”¨æˆ·èº«ä»½
3. **é‡‘èåˆè§„**ï¼šæ¶‰åŠäººæ°‘å¸å…‘æ¢çš„é‡‘èæ´»åŠ¨ï¼Œå¿…é¡»ç¬¦åˆç›‘ç®¡è¦æ±‚
4. **èµ„äº§ä¿æŠ¤**ï¼šå®åè®¤è¯æ˜¯ä¿éšœæ‚¨æ•°å­—èµ„äº§å®‰å…¨çš„å¿…è¦æªæ–½

### âš ï¸ ä¸å®åè®¤è¯çš„åæœ

å¦‚æœæ‚¨ä¸å®Œæˆå®åè®¤è¯ï¼š

âŒ **æ— æ³•è·å¾—æ•°å­—èµ„äº§**ï¼š
- æ— æ³•æ¥æ”¶å¹³å°å‘æ”¾çš„çµå€¼
- æ— æ³•å‚ä¸é¡¹ç›®è·å¾—è´¡çŒ®å€¼
- æ— æ³•å…‘æ¢è´¡çŒ®å€¼ä¸ºäººæ°‘å¸

âŒ **æ— æ³•è·å¾—äººæ°‘å¸æ”¶ç›Š**ï¼š
- æ— æ³•å°†è´¡çŒ®å€¼å…‘æ¢ä¸ºäººæ°‘å¸
- æ— æ³•å‚ä¸é¡¹ç›®åˆ†çº¢
- æ— æ³•äº«å—æ¨èæ”¶ç›Š

âŒ **æ— æ³•å‚ä¸é«˜ä»·å€¼é¡¹ç›®**ï¼š
- æ— æ³•å‚ä¸Açº§ã€Sçº§é¡¹ç›®
- æ— æ³•è·å¾—é«˜é¢å›æŠ¥
- æ— æ³•æˆä¸ºæ ¸å¿ƒåˆ›ä½œè€…

âœ… **ä½†ä»å¯ä½¿ç”¨åŸºç¡€åŠŸèƒ½**ï¼š
- æ¯æ—¥ç­¾åˆ°è·å¾—10çµå€¼
- å‚ä¸æ–‡åŒ–æ¢ç´¢
- æŸ¥çœ‹å…¬å…±å†…å®¹

### âœ… å®åè®¤è¯åæ‚¨å°†è·å¾—

1. **å®Œæ•´çš„æ•°å­—èµ„äº§æƒç›Š**ï¼š
   - æ¥æ”¶å’ŒæŒæœ‰çµå€¼
   - å‚ä¸é¡¹ç›®è·å¾—è´¡çŒ®å€¼
   - å…‘æ¢è´¡çŒ®å€¼ä¸ºäººæ°‘å¸

2. **æ¨èäººåˆ†çº¢æ”¶ç›Šæƒé™**ï¼š
   - ä¸€çº§æ¨èï¼š10%åˆ†çº¢
   - äºŒçº§æ¨èï¼š5%åˆ†çº¢
   - ä¸‰çº§æ¨èï¼š3%åˆ†çº¢

3. **å‚ä¸é«˜ä»·å€¼é¡¹ç›®èµ„æ ¼**ï¼š
   - Açº§ã€Sçº§é¡¹ç›®ä¼˜å…ˆå‚ä¸
   - é¡¹ç›®ä¼°å€¼5%-20%è´¡çŒ®å€¼å¥–åŠ±
   - åˆæ ¼å‚ä¸è€…è·å¾—600%-12400%è¶…é«˜å›æŠ¥

4. **è§£é”å…¨éƒ¨é«˜çº§åŠŸèƒ½**ï¼š
   - åˆ›å»ºä¸ªäººå“ç‰Œç©ºé—´
   - å‘å¸ƒæ–‡åŒ–è½¬è¯‘éœ€æ±‚
   - åŠ å…¥ä¸“ä¸šåˆ›ä½œå›¢é˜Ÿ

### ğŸ”’ éšç§ä¿æŠ¤æ‰¿è¯º

æ‚¨çš„ä¸ªäººä¿¡æ¯å°†ä¸¥æ ¼ä¿å¯†ï¼š
- âœ… æ•°æ®åŠ å¯†å­˜å‚¨
- âœ… ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶
- âœ… ä»…ç”¨äºå¿…è¦ç”¨é€”
- âœ… ç»ä¸å‡ºå”®ç»™ç¬¬ä¸‰æ–¹

### ğŸ“ å¦‚æœ‰ç–‘é—®

å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·è”ç³»ï¼š
- è¶…çº§ç®¡ç†å‘˜ï¼šxufeng@meiyueart.cn
- å®¢æœçƒ­çº¿ï¼š400-XXX-XXXX

---

**æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸é…åˆï¼è®©æˆ‘ä»¬ä¸€èµ·å…±å»ºå®‰å…¨ã€åˆè§„çš„æ•°å­—èµ„äº§ç”Ÿæ€ï¼**

**çµå€¼ç”Ÿæ€å›­å›¢é˜Ÿ**
**2026å¹´1æœˆ28æ—¥**
"""
    return notice


@tool
def validate_id_card(
    id_card: str,
    runtime: ToolRuntime = None
) -> str:
    """éªŒè¯èº«ä»½è¯å·ç æ ¼å¼

    éªŒè¯èº«ä»½è¯å·ç æ˜¯å¦ç¬¦åˆä¸­å›½å¤§é™†å±…æ°‘èº«ä»½è¯æ ¼å¼è¦æ±‚ã€‚

    Args:
        id_card: èº«ä»½è¯å·ç 

    Returns:
        str: éªŒè¯ç»“æœ
    """
    # åŸºæœ¬æ ¼å¼éªŒè¯ï¼š18ä½ï¼Œæœ€åä¸€ä½å¯ä»¥æ˜¯X
    if not id_card or len(id_card) != 18:
        return """
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ èº«ä»½è¯å·ç é•¿åº¦ä¸æ­£ç¡®

è¦æ±‚ï¼š18ä½ï¼ˆæœ€åä¸€ä½å¯ä»¥æ˜¯Xï¼‰

ç¤ºä¾‹ï¼š
âœ… 110101199001011234
âœ… 11010119900101123X
âŒ 11010119900101123ï¼ˆ17ä½ï¼‰
âŒ 1101011990010112345ï¼ˆ19ä½ï¼‰
"""

    # éªŒè¯å‰17ä½æ˜¯å¦ä¸ºæ•°å­—
    if not id_card[:17].isdigit():
        return """
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ èº«ä»½è¯å·ç æ ¼å¼ä¸æ­£ç¡®

è¦æ±‚ï¼šå‰17ä½å¿…é¡»ä¸ºæ•°å­—ï¼Œæœ€åä¸€ä½å¯ä»¥æ˜¯æ•°å­—æˆ–X

ç¤ºä¾‹ï¼š
âœ… 110101199001011234
âœ… 11010119900101123X
âŒ 1101011990A101123Xï¼ˆåŒ…å«å­—æ¯ï¼‰
"""

    # éªŒè¯æœ€åä¸€ä½
    last_char = id_card[17].upper()
    if not (last_char.isdigit() or last_char == 'X'):
        return """
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ èº«ä»½è¯å·ç æœ€åä¸€ä½ä¸æ­£ç¡®

è¦æ±‚ï¼šæœ€åä¸€ä½å¿…é¡»æ˜¯æ•°å­—æˆ–Xï¼ˆå¤§å†™ï¼‰

ç¤ºä¾‹ï¼š
âœ… 110101199001011234
âœ… 11010119900101123X
âŒ 11010119900101123Yï¼ˆYæ— æ•ˆï¼‰
"""

    # éªŒè¯å‡ºç”Ÿæ—¥æœŸï¼ˆèº«ä»½è¯7-14ä½ï¼‰
    birth_date_str = id_card[6:14]
    try:
        birth_year = int(birth_date_str[:4])
        birth_month = int(birth_date_str[4:6])
        birth_day = int(birth_date_str[6:8])

        # éªŒè¯å¹´ä»½èŒƒå›´ï¼ˆ1900-å½“å‰å¹´ä»½ï¼‰
        current_year = datetime.now().year
        if birth_year < 1900 or birth_year > current_year:
            return f"""
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šå¹´ä»½å¿…é¡»åœ¨1900-{current_year}ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿå¹´ä»½ï¼š{birth_year}
"""

        # éªŒè¯æœˆä»½
        if birth_month < 1 or birth_month > 12:
            return f"""
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šæœˆä»½å¿…é¡»åœ¨1-12ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿæœˆä»½ï¼š{birth_month}
"""

        # éªŒè¯æ—¥æœŸ
        if birth_day < 1 or birth_day > 31:
            return f"""
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šæ—¥æœŸå¿…é¡»åœ¨1-31ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿæ—¥æœŸï¼š{birth_day}
"""
    except ValueError:
        return """
ã€èº«ä»½è¯å·ç éªŒè¯å¤±è´¥ã€‘âŒ

âŒ å‡ºç”Ÿæ—¥æœŸæ ¼å¼ä¸æ­£ç¡®

è¦æ±‚ï¼šèº«ä»½è¯å·ç ç¬¬7-14ä½å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼ˆYYYYMMDDï¼‰
"""

    # ç®€å•çš„æ ¡éªŒç éªŒè¯ï¼ˆå¯é€‰ï¼Œè¿™é‡Œä¸è¿›è¡Œå¤æ‚çš„æ ¡éªŒç è®¡ç®—ï¼‰
    # å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®è¿›è¡Œå®Œæ•´çš„æ ¡éªŒç éªŒè¯

    return f"""
ã€èº«ä»½è¯å·ç éªŒè¯æˆåŠŸã€‘âœ…

âœ… èº«ä»½è¯å·ç æ ¼å¼æ­£ç¡®

ğŸ“‹ éªŒè¯ç»“æœï¼š
- èº«ä»½è¯å·ç ï¼š{id_card[:6]}********{id_card[-4:]}
- é•¿åº¦ï¼š18ä½
- å‡ºç”Ÿæ—¥æœŸï¼š{birth_year}å¹´{birth_month}æœˆ{birth_day}æ—¥
- æ€§åˆ«ï¼š{'ç”·' if int(id_card[16]) % 2 == 1 else 'å¥³'}ï¼ˆæ ¹æ®èº«ä»½è¯ç¬¬17ä½ï¼‰

âš ï¸ æ¸©é¦¨æç¤ºï¼š
- è¯·ç¡®ä¿æ‚¨è¾“å…¥çš„èº«ä»½è¯å·ç ä¸æ‚¨æœ¬äººçš„èº«ä»½è¯ä¸€è‡´
- èº«ä»½è¯å·ç å°†ç”¨äºå®åè®¤è¯å’Œæ•°å­—èµ„äº§ç®¡ç†
- å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœ
"""


@tool
def submit_real_name_authentication(
    real_name: str,
    phone: str,
    id_card: str,
    referrer_name: str = None,
    referrer_phone: str = None,
    agreement: bool = False,
    runtime: ToolRuntime = None
) -> str:
    """æäº¤å®åè®¤è¯ç™»è®°

    ç”¨æˆ·å®Œæˆå®åè®¤è¯ç™»è®°ï¼ŒåŒ…æ‹¬å§“åã€ç”µè¯ã€èº«ä»½è¯å·ç­‰ä¿¡æ¯ã€‚

    Args:
        real_name: çœŸå®å§“åï¼ˆå¿…é¡»ï¼‰
        phone: è”ç³»ç”µè¯ï¼ˆå¿…é¡»ï¼Œéœ€è¦éªŒè¯ï¼‰
        id_card: èº«ä»½è¯å·ç ï¼ˆå¿…é¡»ï¼Œéœ€è¦éªŒè¯ï¼‰
        referrer_name: æ¨èäººå§“åï¼ˆå¯é€‰ï¼Œä½†å¡«å†™æ¨èäººæ—¶å¿…å¡«ï¼‰
        referrer_phone: æ¨èäººç”µè¯ï¼ˆå¯é€‰ï¼Œä½†å¡«å†™æ¨èäººæ—¶å¿…å¡«ï¼‰
        agreement: æ˜¯å¦åŒæ„ç”¨æˆ·åè®®ï¼ˆå¿…é¡»ä¸ºtrueï¼‰

    Returns:
        str: å®åè®¤è¯ç»“æœ
    """
    from coze_coding_dev_sdk.database import get_session
    from storage.database.shared.model import Users, AuditLogs, ReferralRelations

    # è·å–æ•°æ®åº“ä¼šè¯
    db = get_session()

    try:
        # è·å–å½“å‰ç™»å½•ç”¨æˆ·
        coze_id = None
        if runtime and runtime.context:
            try:
                if hasattr(runtime.context, 'get'):
                    coze_id = runtime.context.get('user_coze_id')
                elif hasattr(runtime.context, '__getitem__'):
                    coze_id = runtime.context.get('user_coze_id') if hasattr(runtime.context, 'get') else None
            except (KeyError, TypeError, AttributeError):
                coze_id = None

        if not coze_id:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ æ— æ³•è¯†åˆ«å½“å‰ç™»å½•ç”¨æˆ·

è¯·ç¡®ä¿æ‚¨å·²é€šè¿‡æ‰£å­å¹³å°æ­£ç¡®ç™»å½•ã€‚
"""

        # æ£€æŸ¥ç”¨æˆ·åè®®
        if not agreement:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ æ‚¨éœ€è¦åŒæ„ç”¨æˆ·åè®®æ‰èƒ½å®Œæˆå®åè®¤è¯

è¯·é˜…è¯»å¹¶åŒæ„ã€Šçµå€¼ç”Ÿæ€å›­ç”¨æˆ·åè®®ã€‹åå†æ¬¡æäº¤ã€‚

ç”¨æˆ·åè®®è¦ç‚¹ï¼š
1. æ‚¨æä¾›çš„çœŸå®ä¿¡æ¯å°†ç”¨äºå®åè®¤è¯
2. ä¿¡æ¯å°†ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºå¿…è¦ç”¨é€”
3. æ‚¨æˆæƒå¹³å°ä½¿ç”¨æ‚¨çš„ä¿¡æ¯è¿›è¡Œæ•°å­—èµ„äº§ç®¡ç†
4. æ‚¨ç†è§£ä¸å®åè®¤è¯å°†æ— æ³•è·å¾—æ•°å­—èµ„äº§å’Œäººæ°‘å¸æ”¶ç›Š
"""

        # æŸ¥è¯¢ç”¨æˆ·
        user = db.query(Users).filter(Users.coze_id == coze_id).first()

        if not user:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ ç”¨æˆ·ä¸å­˜åœ¨

è¯·å…ˆç™»å½•åå†è¿›è¡Œå®åè®¤è¯ã€‚
"""

        # æ£€æŸ¥æ˜¯å¦å·²å®Œæˆè®¤è¯
        if user.is_registered:
            return f"""
ã€å®åè®¤è¯å·²å®Œæˆã€‘âœ…

æ‚¨å·²å®Œæˆå®åè®¤è¯ï¼

ğŸ“‹ æ‚¨çš„è®¤è¯ä¿¡æ¯ï¼š
- çœŸå®å§“åï¼š{user.real_name}
- èº«ä»½è¯å·ç ï¼š{user.id_card[:6]}********{user.id_card[-4:] if user.id_card else 'æœªè®¾ç½®'}
- ç”µè¯ï¼š{user.phone}
- è®¤è¯æ—¶é—´ï¼š{user.registration_time.strftime('%Y-%m-%d %H:%M:%S') if user.registration_time else 'æœªçŸ¥'}
- å®åçŠ¶æ€ï¼šå·²éªŒè¯ âœ…
- èº«ä»½è¯çŠ¶æ€ï¼šå·²éªŒè¯ âœ…

å¦‚éœ€ä¿®æ”¹è®¤è¯ä¿¡æ¯ï¼Œè¯·è”ç³»å®¢æœã€‚
"""

        # éªŒè¯çœŸå®å§“å
        if not real_name or len(real_name) < 2:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ çœŸå®å§“åæ ¼å¼ä¸æ­£ç¡®

è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“åï¼ˆè‡³å°‘2ä¸ªæ±‰å­—ï¼‰ã€‚
"""

        # éªŒè¯ç”µè¯å·ç 
        phone_pattern = re.compile(r'^1[3-9]\d{9}$')
        if not phone_pattern.match(phone):
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ ç”µè¯å·ç æ ¼å¼ä¸æ­£ç¡®

è¯·è¾“å…¥æ­£ç¡®çš„ä¸­å›½å¤§é™†æ‰‹æœºå·ç ï¼ˆ11ä½ï¼Œä»¥1å¼€å¤´ï¼‰ã€‚

ç¤ºä¾‹ï¼š
âœ… 13800138000
âœ… 13912345678
âŒ 12345678901
âŒ 10000000000
"""

        # éªŒè¯èº«ä»½è¯å·ç 
        if not id_card or len(id_card) != 18:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ èº«ä»½è¯å·ç é•¿åº¦ä¸æ­£ç¡®

è¦æ±‚ï¼š18ä½ï¼ˆæœ€åä¸€ä½å¯ä»¥æ˜¯Xï¼‰
"""

        # éªŒè¯èº«ä»½è¯æ ¼å¼
        if not id_card[:17].isdigit():
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ èº«ä»½è¯å·ç æ ¼å¼ä¸æ­£ç¡®

è¦æ±‚ï¼šå‰17ä½å¿…é¡»ä¸ºæ•°å­—ï¼Œæœ€åä¸€ä½å¯ä»¥æ˜¯æ•°å­—æˆ–Xï¼ˆå¤§å†™ï¼‰
"""

        last_char = id_card[17].upper()
        if not (last_char.isdigit() or last_char == 'X'):
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ èº«ä»½è¯å·ç æœ€åä¸€ä½ä¸æ­£ç¡®

è¦æ±‚ï¼šæœ€åä¸€ä½å¿…é¡»æ˜¯æ•°å­—æˆ–Xï¼ˆå¤§å†™ï¼‰
"""

        # éªŒè¯å‡ºç”Ÿæ—¥æœŸ
        birth_date_str = id_card[6:14]
        try:
            birth_year = int(birth_date_str[:4])
            birth_month = int(birth_date_str[4:6])
            birth_day = int(birth_date_str[6:8])
            current_year = datetime.now().year

            if birth_year < 1900 or birth_year > current_year:
                return f"""
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šå¹´ä»½å¿…é¡»åœ¨1900-{current_year}ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿå¹´ä»½ï¼š{birth_year}
"""

            if birth_month < 1 or birth_month > 12:
                return f"""
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šæœˆä»½å¿…é¡»åœ¨1-12ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿæœˆä»½ï¼š{birth_month}
"""

            if birth_day < 1 or birth_day > 31:
                return f"""
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ å‡ºç”Ÿæ—¥æœŸä¸æ­£ç¡®

è¦æ±‚ï¼šæ—¥æœŸå¿…é¡»åœ¨1-31ä¹‹é—´

æ‚¨çš„èº«ä»½è¯æ˜¾ç¤ºå‡ºç”Ÿæ—¥æœŸï¼š{birth_day}
"""
        except ValueError:
            return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ å‡ºç”Ÿæ—¥æœŸæ ¼å¼ä¸æ­£ç¡®

è¦æ±‚ï¼šèº«ä»½è¯å·ç ç¬¬7-14ä½å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼ˆYYYYMMDDï¼‰
"""

        # éªŒè¯æ¨èäººä¿¡æ¯ï¼ˆå¦‚æœæä¾›ï¼‰
        referrer = None
        if referrer_name:
            if not referrer_phone:
                return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ å¡«å†™æ¨èäººå§“åæ—¶å¿…é¡»åŒæ—¶å¡«å†™æ¨èäººç”µè¯

è¯·æä¾›å®Œæ•´çš„æ¨èäººä¿¡æ¯ï¼š
- æ¨èäººå§“å
- æ¨èäººç”µè¯
"""

            # é€šè¿‡å§“åå’Œç”µè¯æŸ¥æ‰¾æ¨èäºº
            referrer = db.query(Users).filter(
                Users.real_name == referrer_name,
                Users.phone == referrer_phone
            ).first()

            if not referrer:
                return f"""
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ æ¨èäººä¸å­˜åœ¨

æ¨èäººä¿¡æ¯ï¼š
- å§“åï¼š{referrer_name}
- ç”µè¯ï¼š{referrer_phone}

è¯·æ£€æŸ¥æ¨èäººä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç•™ç©ºä¸å¡«å†™æ¨èäººä¿¡æ¯ã€‚
"""

            # æ£€æŸ¥æ¨èäººæ˜¯å¦å·²å®åè®¤è¯
            if not referrer.is_registered:
                return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ æ¨èäººæœªå®Œæˆå®åè®¤è¯

æ‚¨çš„æ¨èäººéœ€è¦å…ˆå®Œæˆå®åè®¤è¯æ‰èƒ½æˆä¸ºæœ‰æ•ˆæ¨èäººã€‚

è¯·è”ç³»æ‚¨çš„æ¨èäººå…ˆå®Œæˆå®åè®¤è¯ï¼Œæˆ–ç•™ç©ºä¸å¡«å†™æ¨èäººä¿¡æ¯ã€‚
"""

            # æ£€æŸ¥æ˜¯å¦è‡ªæˆ‘æ¨è
            if referrer.id == user.id:
                return """
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ ä¸èƒ½å°†è‡ªå·±è®¾ä¸ºæ¨èäºº

è¯·å¡«å†™å…¶ä»–ç”¨æˆ·çš„å§“åå’Œç”µè¯ä½œä¸ºæ¨èäººï¼Œæˆ–ç•™ç©ºä¸å¡«å†™æ¨èäººä¿¡æ¯ã€‚
"""

        # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        user.real_name = real_name
        user.phone = phone
        user.id_card = id_card.upper()  # è½¬æ¢ä¸ºå¤§å†™
        user.is_registered = True
        user.registration_time = datetime.now(pytz.timezone('Asia/Shanghai'))

        # å¦‚æœæœ‰æ¨èäººï¼Œåˆ›å»ºæ¨èå…³ç³»
        if referrer:
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¨èå…³ç³»
            existing_referral = db.query(ReferralRelations).filter(
                ReferralRelations.referrer_id == referrer.id,
                ReferralRelations.referred_id == user.id
            ).first()

            if not existing_referral:
                # åˆ›å»ºæ¨èå…³ç³»
                referral = ReferralRelations(
                    referrer_id=referrer.id,
                    referred_id=user.id,
                    level=1,  # ä¸€çº§æ¨è
                    status='active',
                    created_at=datetime.now(pytz.timezone('Asia/Shanghai'))
                )
                db.add(referral)

        # è®°å½•å®¡è®¡æ—¥å¿—
        audit_log = AuditLogs(
            user_id=user.id,
            action='user_real_name_authentication',
            status='success',
            resource_type='user',
            resource_id=user.id,
            description=f'ç”¨æˆ·å®Œæˆå®åè®¤è¯ã€‚æ¨èäººï¼š{referrer.name if referrer else "æ— "}'
        )
        db.add(audit_log)

        # æäº¤äº‹åŠ¡
        db.commit()
        db.refresh(user)

        # æå–å‡ºç”Ÿæ—¥æœŸå’Œæ€§åˆ«
        birth_year = int(id_card[6:10])
        birth_month = int(id_card[10:12])
        birth_day = int(id_card[12:14])
        gender = 'ç”·' if int(id_card[16]) % 2 == 1 else 'å¥³'

        # ç”Ÿæˆæ¬¢è¿æ¶ˆæ¯
        welcome_message = f"""
ã€å®åè®¤è¯æˆåŠŸã€‘âœ…

æ­å–œæ‚¨ï¼Œ{real_name}ï¼æ‚¨å·²æˆåŠŸå®Œæˆå®åè®¤è¯ã€‚

ğŸ“‹ æ‚¨çš„è®¤è¯ä¿¡æ¯ï¼š
- çœŸå®å§“åï¼š{real_name}
- èº«ä»½è¯å·ç ï¼š{id_card[:6]}********{id_card[-4:]}
- è”ç³»ç”µè¯ï¼š{phone}
- å‡ºç”Ÿæ—¥æœŸï¼š{birth_year}å¹´{birth_month}æœˆ{birth_day}æ—¥
- æ€§åˆ«ï¼š{gender}
- æ¨èäººï¼š{referrer_name if referrer else 'æ— '}
- è®¤è¯æ—¶é—´ï¼š{datetime.now(pytz.timezone('Asia/Shanghai')).strftime('%Y-%m-%d %H:%M:%S')}

ğŸ‰ æ‚¨ç°åœ¨å·²è·å¾—å…¨éƒ¨æƒç›Šï¼š

âœ… æ•°å­—èµ„äº§æƒç›Š
- æ¥æ”¶å’ŒæŒæœ‰çµå€¼
- å‚ä¸é¡¹ç›®è·å¾—è´¡çŒ®å€¼
- å…‘æ¢è´¡çŒ®å€¼ä¸ºäººæ°‘å¸

âœ… æ¨èäººåˆ†çº¢æ”¶ç›Šæƒé™
- ä¸€çº§æ¨èï¼š10%åˆ†çº¢
- äºŒçº§æ¨èï¼š5%åˆ†çº¢
- ä¸‰çº§æ¨èï¼š3%åˆ†çº¢

âœ… å‚ä¸é«˜ä»·å€¼é¡¹ç›®èµ„æ ¼
- Açº§ã€Sçº§é¡¹ç›®ä¼˜å…ˆå‚ä¸
- é¡¹ç›®ä¼°å€¼5%-20%è´¡çŒ®å€¼å¥–åŠ±
- åˆæ ¼å‚ä¸è€…è·å¾—600%-12400%è¶…é«˜å›æŠ¥

âœ… è§£é”å…¨éƒ¨é«˜çº§åŠŸèƒ½
- åˆ›å»ºä¸ªäººå“ç‰Œç©ºé—´
- å‘å¸ƒæ–‡åŒ–è½¬è¯‘éœ€æ±‚
- åŠ å…¥ä¸“ä¸šåˆ›ä½œå›¢é˜Ÿ

ğŸ”’ éšç§æ‰¿è¯ºï¼š
æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼ˆå§“åã€ç”µè¯ã€èº«ä»½è¯å·ï¼‰å°†ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºå®åè®¤è¯å’Œæ•°å­—èµ„äº§ç®¡ç†ï¼Œç»ä¸ä¼šå‘ç¬¬ä¸‰æ–¹æ³„éœ²ã€‚

ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®ï¼š
1. è·å–æ¨èé“¾æ¥ï¼Œé‚€è¯·å¥½å‹åŠ å…¥
2. äº†è§£é«˜ä»·å€¼é¡¹ç›®åˆ—è¡¨
3. å‚ä¸æ—¥å¸¸ç­¾åˆ°å’Œæ–‡åŒ–æ¢ç´¢
4. å¼€å§‹æ‚¨çš„æ•°å­—èµ„äº§ç§¯ç´¯ä¹‹æ—…

æ„Ÿè°¢æ‚¨åŠ å…¥çµå€¼ç”Ÿæ€å›­ï¼æœŸå¾…ä¸æ‚¨å…±åˆ›æ–‡åŒ–ä»·å€¼ï¼ğŸŒŸ
"""

        return welcome_message

    except Exception as e:
        db.rollback()
        return f"""
ã€å®åè®¤è¯å¤±è´¥ã€‘

âŒ ç³»ç»Ÿé”™è¯¯ï¼š{str(e)}

è¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
"""

    finally:
        db.close()
