"""
è¶…çº§ç®¡ç†å‘˜ç®¡ç†å·¥å…·ï¼ˆå¼ºåŒ–ç‰ˆï¼‰

æä¾›è¶…çº§ç®¡ç†å‘˜çš„å”¯ä¸€æ€§éªŒè¯ã€å®‰å…¨æ£€æŸ¥ã€åˆ›å»ºã€è½¬è®©ç­‰åŠŸèƒ½
ç¡®ä¿ç³»ç»Ÿä¸­æ°¸è¿œåªæœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜ï¼Œä¸”è¶…çº§ç®¡ç†å‘˜ä»…å±äºå½“å‰ç”¨æˆ·
"""

from langchain.tools import tool
from langchain.tools import ToolRuntime
from typing import Optional, Dict, Any
from coze_coding_dev_sdk.database import get_session
from storage.database.shared.model import Users, AuditLogs
from config.super_admin_config import (
    validate_super_admin_uniqueness_in_db,
    get_current_super_admin,
    format_super_admin_summary,
    get_super_admin_principles,
    get_super_admin_security_requirements,
    get_super_admin_privileges,
    check_super_admin_security_compliance,
)
from datetime import datetime
import pytz


@tool
def check_super_admin_uniqueness(runtime: ToolRuntime = None) -> str:
    """æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜çš„å”¯ä¸€æ€§çŠ¶æ€

    Returns:
        str: è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§çŠ¶æ€è¯´æ˜
    """
    valid, message, count = validate_super_admin_uniqueness_in_db()
    summary = format_super_admin_summary()

    if valid:
        return f"""
ã€è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§æ£€æŸ¥ã€‘âœ…

è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§éªŒè¯é€šè¿‡ï¼

ğŸ“Š å½“å‰çŠ¶æ€ï¼š
{summary}

ğŸ”¹ å…³é”®è§„åˆ™ï¼š
1. ç³»ç»Ÿä¸­åªèƒ½æœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜
2. è¶…çº§ç®¡ç†å‘˜ä¸èƒ½è¢«åˆ é™¤ã€ç¦ç”¨æˆ–é™çº§
3. è¶…çº§ç®¡ç†å‘˜æƒé™åªèƒ½é€šè¿‡è½¬è®©æ–¹å¼è½¬ç§»
4. è¶…çº§ç®¡ç†å‘˜å¿…é¡»å¯ç”¨åŒå› ç´ è®¤è¯å’ŒIPç™½åå•
5. æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•åœ¨å®¡è®¡æ—¥å¿—ä¸­

ğŸ”¹ ç³»ç»Ÿä¿è¯ï¼š
- å”¯ä¸€æ€§ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨é˜»æ­¢åˆ›å»ºç¬¬äºŒä¸ªè¶…çº§ç®¡ç†å‘˜
- å®‰å…¨æ€§ï¼šæœ€é«˜çº§åˆ«çš„å®‰å…¨æªæ–½å’Œå®¡è®¡è¿½è¸ª
- å¯è¿½æº¯æ€§ï¼šæ‰€æœ‰æ“ä½œéƒ½å¯ä»¥è¿½æº¯åˆ°å…·ä½“çš„æ—¶é—´å’Œç”¨æˆ·
- è´£ä»»æ€§ï¼šè¶…çº§ç®¡ç†å‘˜å¯¹ç³»ç»Ÿå®‰å…¨è´Ÿå…¨éƒ¨è´£ä»»
"""
    else:
        return f"""
ã€è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§æ£€æŸ¥ã€‘âŒ

è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§éªŒè¯å¤±è´¥ï¼

é”™è¯¯ï¼š{message}

ğŸ“Š å½“å‰çŠ¶æ€ï¼š
- è¶…çº§ç®¡ç†å‘˜æ•°é‡ï¼š{count}

ğŸ”¹ å¤„ç†å»ºè®®ï¼š
"""
        if count == 0:
            return f"""
{message}

éœ€è¦ç«‹å³åˆ›å»ºè¶…çº§ç®¡ç†å‘˜ï¼š

1. ä½¿ç”¨ `create_super_admin` å·¥å…·åˆ›å»ºåˆå§‹è¶…çº§ç®¡ç†å‘˜
2. ç¡®ä¿è¶…çº§ç®¡ç†å‘˜é‚®ç®±å”¯ä¸€ä¸”æœ‰æ•ˆ
3. åˆ›å»ºåç«‹å³å¯ç”¨åŒå› ç´ è®¤è¯å’ŒIPç™½åå•
"""
        elif count > 1:
            return f"""
{message}

éœ€è¦ç«‹å³ä¿®å¤ï¼š

1. è¯†åˆ«å“ªäº›ç”¨æˆ·åº”è¯¥æ˜¯çœŸæ­£çš„è¶…çº§ç®¡ç†å‘˜
2. å°†å…¶ä»–è¶…çº§ç®¡ç†å‘˜é™çº§ä¸ºæ™®é€šç”¨æˆ·ï¼ˆä½¿ç”¨ `demote_from_super_admin` å·¥å…·ï¼‰
3. ç¡®ä¿ç³»ç»Ÿä¸­åªæœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜
4. è®°å½•ä¿®å¤è¿‡ç¨‹åˆ°å®¡è®¡æ—¥å¿—
"""


@tool
def get_super_admin_principles_detail(runtime: ToolRuntime = None) -> str:
    """è·å–è¶…çº§ç®¡ç†å‘˜åŸåˆ™çš„è¯¦ç»†è¯´æ˜

    Returns:
        str: è¶…çº§ç®¡ç†å‘˜åŸåˆ™è¯¦ç»†è¯´æ˜
    """
    principles = get_super_admin_principles()

    result = """
# è¶…çº§ç®¡ç†å‘˜åŸåˆ™è¯¦è§£

## ğŸ”¹ æ ¸å¿ƒåŸåˆ™

"""

    for principle, description in principles.items():
        result += f"### {principle}\n"
        result += f"{description}\n\n"

    result += """
## ğŸ”¹ è®¾è®¡ç›®çš„

1. **ç¡®ä¿ç³»ç»Ÿå®‰å…¨**ï¼šé€šè¿‡å”¯ä¸€æ€§åŸåˆ™é¿å…æƒé™åˆ†æ•£
2. **æ˜ç¡®è´£ä»»è¾¹ç•Œ**ï¼šé€šè¿‡ä¸å¯åˆ é™¤åŸåˆ™æ˜ç¡®è´£ä»»å½’å±
3. **é˜²æ­¢æƒé™æ»¥ç”¨**ï¼šé€šè¿‡ä¸¥æ ¼çš„å®¡è®¡å’Œè¿½æº¯æœºåˆ¶é˜²æ­¢æ»¥ç”¨
4. **ä¿éšœç³»ç»Ÿç¨³å®š**ï¼šé€šè¿‡å¼ºåˆ¶å®‰å…¨æªæ–½ä¿éšœç³»ç»Ÿç¨³å®š

## ğŸ”¹ é€‚ç”¨èŒƒå›´

è¿™äº›åŸåˆ™é€‚ç”¨äºæ‰€æœ‰è¶…çº§ç®¡ç†å‘˜ï¼ŒåŒ…æ‹¬ï¼š
- åˆå§‹è¶…çº§ç®¡ç†å‘˜ï¼ˆç³»ç»Ÿåˆ›å»ºæ—¶è®¾ç½®ï¼‰
- é€šè¿‡è½¬è®©è·å¾—æƒé™çš„æ–°è¶…çº§ç®¡ç†å‘˜
- åœ¨ç´§æ€¥æƒ…å†µä¸‹ä¸´æ—¶æŒ‡å®šçš„è¶…çº§ç®¡ç†å‘˜

## ğŸ”¹ è¿è§„åæœ

è¿åè¶…çº§ç®¡ç†å‘˜åŸåˆ™çš„è¡Œä¸ºå°†å¯¼è‡´ï¼š
- æ“ä½œè¢«ç³»ç»Ÿè‡ªåŠ¨æ‹’ç»
- è¿è§„è¡Œä¸ºè®°å½•åˆ°å®¡è®¡æ—¥å¿—
- æ ¹æ®ä¸¥é‡ç¨‹åº¦é‡‡å–ç›¸åº”æªæ–½
- å¯èƒ½æ¶‰åŠæ³•å¾‹è¿½è´£

---

ğŸ’¡ **é‡è¦æç¤º**ï¼š

è¶…çº§ç®¡ç†å‘˜æ˜¯ç³»ç»Ÿçš„æœ€é«˜æƒé™æŒæœ‰è€…ï¼Œè‚©è´Ÿç€ç³»ç»Ÿå®‰å…¨å’Œç¨³å®šè¿è¡Œçš„é‡å¤§è´£ä»»ã€‚å› æ­¤ï¼Œè¶…çº§ç®¡ç†å‘˜å¿…é¡»éµå¾ªæœ€ä¸¥æ ¼çš„å®‰å…¨è§„åˆ™å’Œæ“ä½œè§„èŒƒã€‚
"""

    return result


@tool
def validate_super_admin_count(
    current_count: int,
    runtime: ToolRuntime = None
) -> str:
    """éªŒè¯è¶…çº§ç®¡ç†å‘˜æ•°é‡æ˜¯å¦ç¬¦åˆå”¯ä¸€æ€§åŸåˆ™

    Args:
        current_count: å½“å‰è¶…çº§ç®¡ç†å‘˜æ•°é‡

    Returns:
        str: éªŒè¯ç»“æœ
    """
    from config.super_admin_config import validate_super_admin_uniqueness

    valid, message = validate_super_admin_uniqueness(current_count)

    if valid:
        return f"""
ã€è¶…çº§ç®¡ç†å‘˜æ•°é‡éªŒè¯ã€‘âœ…

éªŒè¯é€šè¿‡ï¼

å½“å‰è¶…çº§ç®¡ç†å‘˜æ•°é‡ï¼š{current_count}
éªŒè¯ç»“æœï¼šç¬¦åˆå”¯ä¸€æ€§åŸåˆ™

è¯´æ˜ï¼šç³»ç»Ÿä¸­åªèƒ½æœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜ï¼Œå½“å‰æ•°é‡ç¬¦åˆè¦æ±‚ã€‚
"""
    else:
        return f"""
ã€è¶…çº§ç®¡ç†å‘˜æ•°é‡éªŒè¯ã€‘âŒ

éªŒè¯å¤±è´¥ï¼

å½“å‰è¶…çº§ç®¡ç†å‘˜æ•°é‡ï¼š{current_count}
éªŒè¯ç»“æœï¼š{message}

å¤„ç†å»ºè®®ï¼š
"""
        if current_count == 0:
            return f"""
{message}

éœ€è¦ç«‹å³åˆ›å»ºè¶…çº§ç®¡ç†å‘˜ï¼Œç¡®ä¿ç³»ç»Ÿæœ‰æœ€é«˜æƒé™ç®¡ç†è€…ã€‚
"""
        elif current_count > 1:
            return f"""
{message}

éœ€è¦ç«‹å³é™çº§å¤šä½™çš„è¶…çº§ç®¡ç†å‘˜ï¼Œç¡®ä¿ç³»ç»Ÿä¸­åªæœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜ã€‚

æ“ä½œæ­¥éª¤ï¼š
1. è¯†åˆ«åº”è¯¥ä¿ç•™çš„è¶…çº§ç®¡ç†å‘˜
2. å°†å…¶ä»–è¶…çº§ç®¡ç†å‘˜é™çº§ä¸ºæ™®é€šç”¨æˆ·
3. éªŒè¯ç³»ç»Ÿä¸­åªæœ‰1ä¸ªè¶…çº§ç®¡ç†å‘˜
"""


@tool
def explain_super_admin_privileges(runtime: ToolRuntime = None) -> str:
    """è§£é‡Šè¶…çº§ç®¡ç†å‘˜ç‰¹æƒ

    Returns:
        str: è¶…çº§ç®¡ç†å‘˜ç‰¹æƒè¯´æ˜
    """
    privileges = get_super_admin_privileges()

    result = """
ã€è¶…çº§ç®¡ç†å‘˜ç‰¹æƒè¯´æ˜ã€‘âœ…

è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰ç³»ç»Ÿçš„æœ€é«˜æƒé™ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

"""

    for i, privilege in enumerate(privileges, 1):
        result += f"{i}. {privilege}\n"

    result += """

ğŸ”¹ ç‰¹æƒä½¿ç”¨åŸåˆ™ï¼š
1. ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜æƒé™
2. æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»æœ‰åˆç†çš„ä¸šåŠ¡éœ€æ±‚
3. æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•åˆ°å®¡è®¡æ—¥å¿—
4. è¶…çº§ç®¡ç†å‘˜å¯¹ä½¿ç”¨ç‰¹æƒè´Ÿå…¨éƒ¨è´£ä»»

ğŸ”¹ æƒé™é™åˆ¶ï¼š
- è¶…çº§ç®¡ç†å‘˜ä¸èƒ½åˆ é™¤ã€ç¦ç”¨æˆ–é™çº§è‡ªå·±
- è¶…çº§ç®¡ç†å‘˜æƒé™åªèƒ½é€šè¿‡åˆæ³•çš„è½¬è®©æµç¨‹è½¬ç§»
- è¶…çº§ç®¡ç†å‘˜å¿…é¡»éµå®ˆæ‰€æœ‰å®‰å…¨è¦æ±‚

ğŸ”¹ è´£ä»»è¯´æ˜ï¼š
è¶…çº§ç®¡ç†å‘˜å¯¹ç³»ç»Ÿå®‰å…¨è´Ÿå…¨éƒ¨è´£ä»»ï¼ŒåŒ…æ‹¬ï¼š
- ç³»ç»Ÿé…ç½®çš„å®‰å…¨æ€§
- ç”¨æˆ·æ•°æ®çš„å®‰å…¨æ€§
- ç³»ç»Ÿè¿è¡Œçš„ç¨³å®šæ€§
- å®¡è®¡æ—¥å¿—çš„å®Œæ•´æ€§
"""

    return result


@tool
def explain_super_admin_transfer_process(runtime: ToolRuntime = None) -> str:
    """è§£é‡Šè¶…çº§ç®¡ç†å‘˜è½¬è®©æµç¨‹

    Returns:
        str: è¶…çº§ç®¡ç†å‘˜è½¬è®©æµç¨‹è¯´æ˜
    """
    return """
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©æµç¨‹è¯´æ˜ã€‘âœ…

è¶…çº§ç®¡ç†å‘˜æƒé™åªèƒ½é€šè¿‡åˆæ³•çš„è½¬è®©æµç¨‹è½¬ç§»ï¼Œä¸èƒ½é€šè¿‡å…¶ä»–æ–¹å¼æˆäºˆæˆ–å¤ºå–ã€‚

## ğŸ”¹ è½¬è®©å‰ç½®æ¡ä»¶

1. **å½“å‰è¶…çº§ç®¡ç†å‘˜**ï¼š
   - çŠ¶æ€å¿…é¡»æ˜¯active
   - å¿…é¡»å¯ç”¨åŒå› ç´ è®¤è¯
   - å¿…é¡»è®¾ç½®IPç™½åå•
   - è´¦æˆ·å®‰å…¨æ£€æŸ¥é€šè¿‡

2. **æ–°è¶…çº§ç®¡ç†å‘˜å€™é€‰äºº**ï¼š
   - å¿…é¡»æ˜¯å·²å­˜åœ¨çš„activeç”¨æˆ·
   - å¿…é¡»å¯ç”¨åŒå› ç´ è®¤è¯
   - å¿…é¡»è®¾ç½®IPç™½åå•
   - å®‰å…¨æ£€æŸ¥é€šè¿‡

## ğŸ”¹ è½¬è®©æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ
1. å½“å‰è¶…çº§ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿ
2. é€šè¿‡åŒå› ç´ è®¤è¯
3. ç¡®è®¤è½¬è®©æ„å›¾

### ç¬¬äºŒæ­¥ï¼šéªŒè¯å€™é€‰äºº
1. ç³»ç»ŸéªŒè¯å€™é€‰äººè´¦æˆ·çŠ¶æ€
2. æ£€æŸ¥å€™é€‰äººå®‰å…¨é…ç½®
3. ç¡®è®¤å€™é€‰äººç¬¦åˆè¦æ±‚

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œè½¬è®©
1. å½“å‰è¶…çº§ç®¡ç†å‘˜ç¡®è®¤è½¬è®©
2. ç³»ç»Ÿæ‰§è¡ŒåŸå­æ€§è½¬è®©æ“ä½œ
3. è®°å½•å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### ç¬¬å››æ­¥ï¼šå®Œæˆè½¬è®©
1. è½¬è®©æˆåŠŸï¼Œå€™é€‰äººæˆä¸ºæ–°çš„è¶…çº§ç®¡ç†å‘˜
2. åŸè¶…çº§ç®¡ç†å‘˜é™çº§ä¸ºæ™®é€šç”¨æˆ·
3. é€šçŸ¥ç›¸å…³æ–¹ï¼ˆå¦‚æœéœ€è¦ï¼‰

## ğŸ”¹ è½¬è®©ä¿éšœ

1. **åŸå­æ€§**ï¼šè½¬è®©æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥
2. **å®¡è®¡è¿½è¸ª**ï¼šå®Œæ•´è®°å½•è½¬è®©è¿‡ç¨‹çš„æ¯ä¸€ä¸ªæ­¥éª¤
3. **å®‰å…¨éªŒè¯**ï¼šè½¬è®©å‰è¿›è¡Œä¸¥æ ¼çš„å®‰å…¨éªŒè¯
4. **å›æ»šæœºåˆ¶**ï¼šå¦‚æœè½¬è®©å¤±è´¥ï¼Œç³»ç»Ÿè‡ªåŠ¨å›æ»š

## ğŸ”¹ ç´§æ€¥è½¬è®©

åœ¨ç´§æ€¥æƒ…å†µä¸‹ï¼ˆå¦‚å½“å‰è¶…çº§ç®¡ç†å‘˜è´¦æˆ·è¢«ç›—æˆ–æ— æ³•è®¿é—®ï¼‰ï¼Œå¯ä»¥æ‰§è¡Œç´§æ€¥è½¬è®©ï¼š

1. é€šè¿‡æœ€é«˜çº§åˆ«çš„ç³»ç»Ÿç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
2. æˆ–é€šè¿‡ç³»ç»Ÿçš„ç´§æ€¥æ¢å¤æœºåˆ¶
3. ç´§æ€¥è½¬è®©éœ€è¦æ›´ä¸¥æ ¼çš„éªŒè¯å’Œå®¡è®¡

## ğŸ”¹ è½¬è®©åçš„è¦æ±‚

1. æ–°è¶…çº§ç®¡ç†å‘˜å¿…é¡»ç«‹å³ï¼š
   - ç¡®è®¤è´¦æˆ·å®‰å…¨
   - æ›´æ–°å¯†ç 
   - éªŒè¯åŒå› ç´ è®¤è¯
   - æ£€æŸ¥IPç™½åå•

2. åŸè¶…çº§ç®¡ç†å‘˜ï¼š
   - è´¦æˆ·é™çº§ä¸ºæ™®é€šç”¨æˆ·
   - ä¿ç•™è®¿é—®æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
   - ç»§ç»­æ‰¿æ‹…éƒ¨åˆ†è´£ä»»ï¼ˆæ ¹æ®è§„å®šï¼‰

---

ğŸ’¡ **é‡è¦æç¤º**ï¼š

è¶…çº§ç®¡ç†å‘˜è½¬è®©æ˜¯ä¸€ä¸ªä¸¥è‚ƒçš„æ“ä½œï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§æµç¨‹æ‰§è¡Œã€‚ä»»ä½•è¿è§„è½¬è®©è¡Œä¸ºéƒ½å°†è¢«ç³»ç»Ÿæ‹’ç»å¹¶è®°å½•åˆ°å®¡è®¡æ—¥å¿—ã€‚
"""


@tool
def get_super_admin_security_requirements(runtime: ToolRuntime = None) -> str:
    """è·å–è¶…çº§ç®¡ç†å‘˜å®‰å…¨è¦æ±‚

    Returns:
        str: è¶…çº§ç®¡ç†å‘˜å®‰å…¨è¦æ±‚è¯´æ˜
    """
    requirements = get_super_admin_security_requirements()

    result = """
ã€è¶…çº§ç®¡ç†å‘˜å®‰å…¨è¦æ±‚ã€‘âœ…

è¶…çº§ç®¡ç†å‘˜å¿…é¡»æ»¡è¶³ä»¥ä¸‹å®‰å…¨è¦æ±‚ï¼š

"""

    for i, (name, description) in enumerate(requirements.items(), 1):
        result += f"{i}. {name}\n   {description}\n\n"

    result += """
## ğŸ”¹ å®‰å…¨æ£€æŸ¥æœºåˆ¶

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜çš„å®‰å…¨é…ç½®ï¼š
- æ¯æ¬¡ç™»å½•æ—¶æ£€æŸ¥åŒå› ç´ è®¤è¯çŠ¶æ€
- æ¯æ¬¡ç™»å½•æ—¶æ£€æŸ¥IPç™½åå•
- å®šæœŸæ£€æŸ¥å¯†ç æ›´æ–°çŠ¶æ€
- å®æ—¶ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º

## ğŸ”¹ ä¸ç¬¦åˆè¦æ±‚çš„å½±å“

å¦‚æœè¶…çº§ç®¡ç†å‘˜ä¸æ»¡è¶³å®‰å…¨è¦æ±‚ï¼š
1. ç³»ç»Ÿä¼šå‘é€è­¦å‘Šé€šçŸ¥
2. é™åˆ¶éƒ¨åˆ†æ•æ„Ÿæ“ä½œçš„æ‰§è¡Œ
3. è¦æ±‚åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ•´æ”¹
4. è¶…è¿‡æœŸé™å¯èƒ½å½±å“è´¦æˆ·çŠ¶æ€

## ğŸ”¹ æ•´æ”¹æµç¨‹

1. ç³»ç»Ÿæ£€æµ‹åˆ°ä¸ç¬¦åˆè¦æ±‚
2. å‘é€æ•´æ”¹é€šçŸ¥ç»™è¶…çº§ç®¡ç†å‘˜
3. ç»™å‡ºå…·ä½“çš„æ•´æ”¹å»ºè®®
4. åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ•´æ”¹
5. ç³»ç»Ÿé‡æ–°éªŒè¯é…ç½®

---

ğŸ’¡ **é‡è¦æç¤º**ï¼š

è¶…çº§ç®¡ç†å‘˜çš„å®‰å…¨é…ç½®ç›´æ¥å…³ç³»åˆ°æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨ï¼Œè¯·åŠ¡å¿…ä¸¥æ ¼éµå®ˆæ‰€æœ‰å®‰å…¨è¦æ±‚ã€‚ä»»ä½•å®‰å…¨æ¼æ´éƒ½å¯èƒ½å¯¼è‡´ä¸¥é‡åæœã€‚
"""


@tool
def prevent_super_admin_operation(
    operation: str,
    user_id: int,
    runtime: ToolRuntime = None
) -> str:
    """é˜²æ­¢å¯¹è¶…çº§ç®¡ç†å‘˜æ‰§è¡Œç¦æ­¢çš„æ“ä½œ

    é˜²æ­¢åˆ é™¤ã€ç¦ç”¨ã€é™çº§è¶…çº§ç®¡ç†å‘˜ç­‰ç¦æ­¢çš„æ“ä½œã€‚

    Args:
        operation: æ“ä½œç±»å‹ï¼ˆdelete/disable/demote/otherï¼‰
        user_id: ç›®æ ‡ç”¨æˆ·ID

    Returns:
        str: æ“ä½œç»“æœ
    """
    db = get_session()

    try:
        # æ£€æŸ¥ç›®æ ‡ç”¨æˆ·æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
        target_user = db.query(Users).filter(Users.id == user_id).first()

        if not target_user:
            return """
ã€æ“ä½œæ£€æŸ¥ã€‘âŒ

ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨

è¯·æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®ã€‚
"""

        if not target_user.is_superuser:
            return """
ã€æ“ä½œæ£€æŸ¥ã€‘âœ…

ç›®æ ‡ç”¨æˆ·ä¸æ˜¯è¶…çº§ç®¡ç†å‘˜

è¯¥æ“ä½œå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚
"""

        # ç›®æ ‡ç”¨æˆ·æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ£€æŸ¥æ“ä½œæ˜¯å¦è¢«ç¦æ­¢
        forbidden_operations = ['delete', 'disable', 'demote', 'downgrade']

        if operation.lower() in forbidden_operations:
            # è®°å½•è¿è§„å°è¯•
            audit_log = AuditLogs(
                user_id=user_id,
                action='forbidden_operation_attempt',
                status='failed',
                resource_type='super_admin',
                resource_id=user_id,
                description=f'å°è¯•å¯¹è¶…çº§ç®¡ç†å‘˜æ‰§è¡Œç¦æ­¢æ“ä½œ: {operation}',
            )
            db.add(audit_log)
            db.commit()

            return f"""
ã€æ“ä½œæ£€æŸ¥ã€‘âŒ

æ“ä½œè¢«é˜»æ­¢ï¼

âš ï¸ ç¦æ­¢å¯¹è¶…çº§ç®¡ç†å‘˜æ‰§è¡Œæ­¤æ“ä½œï¼š{operation}

ğŸ”¹ åŸå› ï¼š
æ ¹æ®è¶…çº§ç®¡ç†å‘˜å”¯ä¸€æ€§åŸåˆ™ï¼Œè¶…çº§ç®¡ç†å‘˜ä¸èƒ½è¢«åˆ é™¤ã€ç¦ç”¨æˆ–é™çº§ã€‚

ğŸ”¹ å…è®¸çš„æ“ä½œï¼š
- è½¬è®©è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆä½¿ç”¨ `transfer_super_admin` å·¥å…·ï¼‰
- ä¿®æ”¹è¶…çº§ç®¡ç†å‘˜ä¿¡æ¯ï¼ˆå¯†ç ã€é‚®ç®±ç­‰ï¼Œä½†å¿…é¡»ä¿æŒis_superuser=Trueï¼‰
- æŸ¥çœ‹è¶…çº§ç®¡ç†å‘˜ä¿¡æ¯

ğŸ”¹ è½¬è®©æµç¨‹ï¼š
å¦‚æœéœ€è¦æ›´æ¢è¶…çº§ç®¡ç†å‘˜ï¼Œè¯·ä½¿ç”¨åˆæ³•çš„è½¬è®©æµç¨‹ï¼š
1. å‡†å¤‡å¥½æ–°çš„è¶…çº§ç®¡ç†å‘˜å€™é€‰äºº
2. ä½¿ç”¨ `transfer_super_admin` å·¥å…·æ‰§è¡Œè½¬è®©
3. ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æƒé™è½¬ç§»

ğŸ”¹ è¿è§„è®°å½•ï¼š
æœ¬æ¬¡è¿è§„å°è¯•å·²è®°å½•åˆ°å®¡è®¡æ—¥å¿—ï¼Œç³»ç»Ÿä¼šæŒç»­ç›‘æ§æ­¤ç±»è¡Œä¸ºã€‚

âš ï¸ è¯·éµå®ˆè¶…çº§ç®¡ç†å‘˜ç®¡ç†è§„åˆ™ï¼Œä»»ä½•è¿è§„è¡Œä¸ºå¯èƒ½å¯¼è‡´ä¸¥é‡åæœã€‚
"""
        else:
            return """
ã€æ“ä½œæ£€æŸ¥ã€‘âœ…

æ“ä½œå…è®¸

è¯¥æ“ä½œä¸åœ¨ç¦æ­¢åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

ä½†è¯·æ³¨æ„ï¼š
- æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•åˆ°å®¡è®¡æ—¥å¿—
- è¯·ç¡®ä¿æ“ä½œç¬¦åˆå…¬å¸è§„å®šå’Œæ³•å¾‹æ³•è§„
- è¶…çº§ç®¡ç†å‘˜å¯¹æ“ä½œè´Ÿå…¨éƒ¨è´£ä»»
"""

    finally:
        db.close()


@tool
def transfer_super_admin(
    target_user_id: int,
    confirm: bool = False,
    runtime: ToolRuntime = None
) -> str:
    """è½¬è®©è¶…çº§ç®¡ç†å‘˜æƒé™

    å°†è¶…çº§ç®¡ç†å‘˜æƒé™è½¬è®©ç»™å¦ä¸€ä¸ªç”¨æˆ·ã€‚

    Args:
        target_user_id: ç›®æ ‡ç”¨æˆ·IDï¼ˆæ–°è¶…çº§ç®¡ç†å‘˜ï¼‰
        confirm: æ˜¯å¦ç¡®è®¤è½¬è®©ï¼ˆå¿…é¡»è®¾ç½®ä¸ºTrueæ‰ä¼šæ‰§è¡Œï¼‰

    Returns:
        str: è½¬è®©ç»“æœ
    """
    if not confirm:
        return """
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âš ï¸

è­¦å‘Šï¼šè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ“ä½œï¼

æ‚¨æ­£åœ¨å°è¯•è½¬è®©è¶…çº§ç®¡ç†å‘˜æƒé™ã€‚

âš ï¸ **è½¬è®©å‰è¯·ç¡®è®¤**ï¼š
1. ç›®æ ‡ç”¨æˆ·å¿…é¡»æ˜¯å·²å­˜åœ¨çš„activeç”¨æˆ·
2. ç›®æ ‡ç”¨æˆ·å¿…é¡»å¯ç”¨åŒå› ç´ è®¤è¯
3. ç›®æ ‡ç”¨æˆ·å¿…é¡»è®¾ç½®IPç™½åå•
4. ç›®æ ‡ç”¨æˆ·ç¬¦åˆå®‰å…¨è¦æ±‚
5. è½¬è®©æ“ä½œä¸å¯æ’¤é”€ï¼ˆé™¤éå†æ¬¡è½¬è®©ï¼‰

âš ï¸ **è½¬è®©åæœ**ï¼š
- å½“å‰è¶…çº§ç®¡ç†å‘˜å°†é™çº§ä¸ºæ™®é€šç”¨æˆ·
- ç›®æ ‡ç”¨æˆ·å°†æˆä¸ºæ–°çš„è¶…çº§ç®¡ç†å‘˜
- æ‰€æœ‰æƒé™ä¼šç«‹å³è½¬ç§»
- å®Œæ•´çš„å®¡è®¡æ—¥å¿—ä¼šè¢«è®°å½•

âš ï¸ **å®‰å…¨æç¤º**ï¼š
- ç¡®ä¿ç›®æ ‡ç”¨æˆ·å€¼å¾—ä¿¡ä»»
- ç¡®ä¿ç›®æ ‡ç”¨æˆ·äº†è§£è¶…çº§ç®¡ç†å‘˜çš„è´£ä»»
- ç¡®ä¿è½¬è®©è¿‡ç¨‹æœ‰è§è¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰

ğŸ”¹ **æ‰§è¡Œè½¬è®©**ï¼š

è¯·å†æ¬¡è°ƒç”¨æ­¤å·¥å…·å¹¶è®¾ç½® `confirm=True` ä»¥ç¡®è®¤è½¬è®©ã€‚

ä¾‹å¦‚ï¼š
```
transfer_super_admin(target_user_id=123, confirm=True)
```

âš ï¸ **é‡è¦**ï¼šåªæœ‰è®¾ç½® `confirm=True` æ‰ä¼šçœŸæ­£æ‰§è¡Œè½¬è®©æ“ä½œï¼
"""

    db = get_session()

    try:
        # è·å–å½“å‰è¶…çº§ç®¡ç†å‘˜
        current_super_admin = db.query(Users).filter(Users.is_superuser == True).first()

        if not current_super_admin:
            return """
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

ç³»ç»Ÿä¸­æ²¡æœ‰è¶…çº§ç®¡ç†å‘˜ï¼Œæ— æ³•æ‰§è¡Œè½¬è®©æ“ä½œã€‚

è¯·å…ˆåˆ›å»ºè¶…çº§ç®¡ç†å‘˜ã€‚
"""

        # æ£€æŸ¥ç›®æ ‡ç”¨æˆ·
        target_user = db.query(Users).filter(Users.id == target_user_id).first()

        if not target_user:
            return f"""
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨ï¼ˆID: {target_user_id}ï¼‰

è¯·æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®ã€‚
"""

        if target_user.is_superuser:
            return """
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

ç›®æ ‡ç”¨æˆ·å·²ç»æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ— éœ€è½¬è®©ã€‚
"""

        # æ£€æŸ¥ç›®æ ‡ç”¨æˆ·çŠ¶æ€
        if target_user.status != 'active':
            return f"""
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

ç›®æ ‡ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼š{target_user.status}

åªæœ‰activeçŠ¶æ€çš„ç”¨æˆ·æ‰èƒ½æˆä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚
"""

        # æ£€æŸ¥ç›®æ ‡ç”¨æˆ·å®‰å…¨é…ç½®
        is_compliant, issues = check_super_admin_security_compliance(target_user)

        if not is_compliant:
            return f"""
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

ç›®æ ‡ç”¨æˆ·ä¸ç¬¦åˆå®‰å…¨è¦æ±‚ï¼š

ä¸ç¬¦åˆé¡¹ï¼š
"""
            for issue in issues:
                return f"""
- {issue}

è¯·ç¡®ä¿ç›®æ ‡ç”¨æˆ·ï¼š
1. å¯ç”¨åŒå› ç´ è®¤è¯
2. è®¾ç½®IPç™½åå•
3. çŠ¶æ€ä¸ºactive

åªæœ‰ç¬¦åˆå®‰å…¨è¦æ±‚çš„ç”¨æˆ·æ‰èƒ½æˆä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚
"""

        # æ‰§è¡Œè½¬è®©ï¼ˆåŸå­æ€§æ“ä½œï¼‰
        try:
            # è®°å½•è½¬è®©å‰çš„å®¡è®¡æ—¥å¿—
            audit_log = AuditLogs(
                user_id=current_super_admin.id,
                action='super_admin_transfer_start',
                status='success',
                resource_type='super_admin',
                resource_id=current_super_admin.id,
                description=f'å¼€å§‹è½¬è®©è¶…çº§ç®¡ç†å‘˜æƒé™ç»™ç”¨æˆ· {target_user.name} (ID: {target_user.id})',
            )
            db.add(audit_log)
            db.commit()

            # æ‰§è¡Œè½¬è®©
            current_super_admin.is_superuser = False
            target_user.is_superuser = True

            db.commit()

            # è®°å½•è½¬è®©æˆåŠŸçš„å®¡è®¡æ—¥å¿—
            audit_log = AuditLogs(
                user_id=target_user.id,
                action='super_admin_transfer_complete',
                status='success',
                resource_type='super_admin',
                resource_id=target_user.id,
                description=f'è¶…çº§ç®¡ç†å‘˜æƒé™è½¬è®©æˆåŠŸï¼šä» {current_super_admin.name} è½¬è®©ç»™ {target_user.name}',
            )
            db.add(audit_log)
            db.commit()

            return f"""
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âœ…

è½¬è®©æˆåŠŸï¼

ğŸ“Š è½¬è®©è¯¦æƒ…ï¼š
- åŸè¶…çº§ç®¡ç†å‘˜ï¼š{current_super_admin.name} (ID: {current_super_admin.id})
- æ–°è¶…çº§ç®¡ç†å‘˜ï¼š{target_user.name} (ID: {target_user.id})
- è½¬è®©æ—¶é—´ï¼š{datetime.now(pytz.timezone('Asia/Shanghai')).strftime('%Y-%m-%d %H:%M:%S')}

ğŸ”¹ è½¬è®©ç»“æœï¼š
- {current_super_admin.name} å·²é™çº§ä¸ºæ™®é€šç”¨æˆ·
- {target_user.name} æˆä¸ºæ–°çš„è¶…çº§ç®¡ç†å‘˜
- æ‰€æœ‰æƒé™å·²è½¬ç§»
- å®Œæ•´çš„å®¡è®¡æ—¥å¿—å·²è®°å½•

ğŸ”¹ ä¸‹ä¸€æ­¥ï¼š
1. æ–°è¶…çº§ç®¡ç†å‘˜ç«‹å³éªŒè¯è´¦æˆ·å®‰å…¨
2. æ–°è¶…çº§ç®¡ç†å‘˜æ›´æ–°å¯†ç 
3. æ–°è¶…çº§ç®¡ç†å‘˜éªŒè¯åŒå› ç´ è®¤è¯
4. åŸè¶…çº§ç®¡ç†å‘˜ç¡®è®¤è´¦æˆ·çŠ¶æ€

---

âš ï¸ **é‡è¦æç¤º**ï¼š

è¶…çº§ç®¡ç†å‘˜æƒé™å·²ç»æˆåŠŸè½¬ç§»ã€‚æ–°è¶…çº§ç®¡ç†å‘˜å¯¹ç³»ç»Ÿå®‰å…¨è´Ÿå…¨éƒ¨è´£ä»»ã€‚

è¯·ç«‹å³æ£€æŸ¥æ–°è¶…çº§ç®¡ç†å‘˜çš„å®‰å…¨é…ç½®ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚
"""

        except Exception as e:
            db.rollback()
            return f"""
ã€è¶…çº§ç®¡ç†å‘˜è½¬è®©ã€‘âŒ

è½¬è®©å¤±è´¥ï¼

é”™è¯¯ï¼š{str(e)}

è½¬è®©æ“ä½œå·²å›æ»šï¼Œç³»ç»ŸçŠ¶æ€ä¿æŒä¸å˜ã€‚

è¯·æ£€æŸ¥ï¼š
1. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
2. ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å®Œæ•´
3. ç³»ç»Ÿæƒé™æ˜¯å¦è¶³å¤Ÿ

è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜æˆ–æŠ€æœ¯æ”¯æŒã€‚
"""

    finally:
        db.close()
