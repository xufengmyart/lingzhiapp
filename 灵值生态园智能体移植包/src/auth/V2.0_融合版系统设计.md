# çµå€¼ç”Ÿæ€å›­åˆä¼™äººæ¨¡å¼ç³»ç»Ÿ V2.0 èåˆç‰ˆ - ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: V2.0 èåˆç‰ˆ
> **å‘å¸ƒæ—¥æœŸ**: 2026å¹´1æœˆ25æ—¥
> **èåˆç›®æ ‡**: å®Œå…¨ç»Ÿä¸€V2.0ä¸ç°æœ‰my_userç³»ç»Ÿ

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿèåˆæ¦‚è¿°](#ç³»ç»Ÿèåˆæ¦‚è¿°)
2. [æ ¸å¿ƒå·®å¼‚åˆ†æ](#æ ¸å¿ƒå·®å¼‚åˆ†æ)
3. [èåˆæ–¹æ¡ˆè®¾è®¡](#èåˆæ–¹æ¡ˆè®¾è®¡)
4. [æ¨¡å—è°ƒæ•´æ¸…å•](#æ¨¡å—è°ƒæ•´æ¸…å•)
5. [æ•°æ®åº“å˜æ›´æ–¹æ¡ˆ](#æ•°æ®åº“å˜æ›´æ–¹æ¡ˆ)
6. [APIæ¥å£å˜æ›´](#apiæ¥å£å˜æ›´)
7. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## ç³»ç»Ÿèåˆæ¦‚è¿°

### èåˆç›®æ ‡

å°†V2.0ç‰ˆæœ¬çš„åˆä¼™äººæ¨¡å¼è®¾è®¡å®Œå…¨èå…¥ç°æœ‰my_userç³»ç»Ÿï¼Œä¿æŒäºŒè€…å®Œå…¨ç»Ÿä¸€ï¼Œå½¢æˆä¸€å¥—å®Œæ•´ã€ä¸€è‡´ã€å¯æ‰©å±•çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿã€‚

### èåˆåŸåˆ™

1. **å®Œå…¨ç»Ÿä¸€**: æ‰€æœ‰åŠŸèƒ½åŸºäºV2.0è®¾è®¡ï¼Œä¿æŒä¸€è‡´
2. **å‘åå…¼å®¹**: ä¿ç•™ç°æœ‰ç³»ç»Ÿä¼˜åŠ¿ï¼Œå¹³æ»‘è¿‡æ¸¡
3. **å¯æ‰©å±•æ€§**: é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæœªæ¥æ‰©å±•
4. **æ•°æ®äº’é€š**: é€šè¿‡çµå€¼è´¦æˆ·å®ç°æ‰€æœ‰æ¨¡å—æ•°æ®äº’é€š

### èåˆèŒƒå›´

- âœ… ç”¨æˆ·åˆ†å±‚ä½“ç³»
- âœ… æ¨èä½£é‡‘ç³»ç»Ÿ
- âœ… è´¡çŒ®å€¼ç»æµæ¨¡å‹
- âœ… ç³»ç»Ÿè‡ªåŠ¨è¿è¥è§„åˆ™
- âœ… å®‰å…¨ä¸åˆè§„æœºåˆ¶

---

## æ ¸å¿ƒå·®å¼‚åˆ†æ

### 1. ç”¨æˆ·åˆ†å±‚ä½“ç³»å¯¹æ¯”

| ç»´åº¦ | V2.0 | ç°æœ‰ç³»ç»Ÿ | èåˆæ–¹æ¡ˆ |
|------|------|---------|---------|
| **å±‚çº§æ•°é‡** | 4çº§ | 5çº§ | **é‡‡ç”¨V2.0çš„4çº§** |
| **å±‚çº§å‘½å** | æ™®é€šç”¨æˆ·/åˆä¼™äºº | è¯•ç”¨/åŸºç¡€/æ ‡å‡†/é«˜çº§/ä¸“å®¶ä¼šå‘˜ | **é‡‡ç”¨V2.0å‘½å** |
| **å‡†å…¥é—¨æ§›** | 0/50000/100000/200000 | 0/1000/5000/20000/100000 | **é‡‡ç”¨V2.0é—¨æ§›** |
| **æŠ•èµ„è·¯å¾„** | æ”¯æŒï¼ˆç›´æ¥æŠ•èµ„ï¼‰ | ä¸æ”¯æŒ | **å¢åŠ ç›´æ¥æŠ•èµ„è·¯å¾„** |
| **å‡çº§æ–¹å¼** | ç´¯è®¡çµå€¼ OR ç›´æ¥æŠ•èµ„ | ç´¯è®¡è´¡çŒ®å€¼ | **æ”¯æŒä¸¤ç§æ–¹å¼** |

#### V2.0 ç”¨æˆ·å±‚çº§ä½“ç³»

| å±‚çº§ | ç´¯è®¡çµå€¼ | ç›´æ¥æŠ•èµ„ | æ ¸å¿ƒæƒé™ | çµå€¼åˆ†é…è§„åˆ™ |
|------|---------|---------|---------|------------|
| **æ™®é€šç”¨æˆ·** | â‰¥0 | - | é¡¹ç›®å‚ä¸æƒã€çµå€¼ç§¯ç´¯ | å®Œæˆé¡¹ç›®è·å¾—åŸºç¡€è´¡çŒ®å€¼<br>æ¨èç”¨æˆ·è·å¾—10%çµå€¼å¥–åŠ± |
| **æ™®é€šåˆä¼™äºº** | â‰¥50000 | â‰¥50000 | äºŒçº§æ¨èï¼ˆ10%+5%ï¼‰<br>é¡¹ç›®ä¼˜å…ˆå‚ä¸æƒ | è‡ªèº«é¡¹ç›®è´¡çŒ®å€¼é¢å¤–+20%<br>å›¢é˜Ÿçµå€¼æ”¶ç›Šé¢å¤–+10% |
| **é«˜çº§åˆä¼™äºº** | â‰¥100000 | â‰¥100000 | ä¸‰çº§æ¨èï¼ˆ10%+5%+3%ï¼‰<br>é¡¹ç›®å†³ç­–æƒ | è‡ªèº«é¡¹ç›®è´¡çŒ®å€¼é¢å¤–+30%<br>å›¢é˜Ÿçµå€¼æ”¶ç›Šé¢å¤–+15% |
| **åˆ›å§‹åˆä¼™äºº** | â‰¥200000 | â‰¥200000 | å¹³å°åˆ†çº¢æƒ<br>è§„åˆ™åˆ¶å®šå‚ä¸æƒ | è‡ªèº«é¡¹ç›®è´¡çŒ®å€¼é¢å¤–+50%<br>å›¢é˜Ÿçµå€¼æ”¶ç›Šé¢å¤–+20%<br>å¹´åº¦å¹³å°æ”¶ç›Š10%åˆ†çº¢ |

### 2. æ¨èä½£é‡‘ç³»ç»Ÿå¯¹æ¯”

| ç»´åº¦ | V2.0 | ç°æœ‰ç³»ç»Ÿ | èåˆæ–¹æ¡ˆ |
|------|------|---------|---------|
| **æ¨èå±‚çº§** | ä¸‰çº§ | ä¸€çº§ | **é‡‡ç”¨V2.0ä¸‰çº§æ¨è** |
| **ä½£é‡‘æ¯”ä¾‹** | å›ºå®šï¼ˆ10%/5%/3%ï¼‰ | åŠ¨æ€ï¼ˆ5%-25%ï¼‰ | **é‡‡ç”¨V2.0å›ºå®šæ¯”ä¾‹** |
| **ä½£é‡‘è®¡ç®—** | çµå€¼æ”¶ç›Šç™¾åˆ†æ¯” | äº¤æ˜“é‡‘é¢ç™¾åˆ†æ¯” | **é‡‡ç”¨V2.0çµå€¼æ”¶ç›Šç™¾åˆ†æ¯”** |
| **åˆ†çº¢æ± è´¡çŒ®** | æœªæ˜ç¡® | 5%è¿›å…¥åˆ†çº¢æ±  | **ä¿ç•™5%åˆ†çº¢æ± æœºåˆ¶** |
| **å‡çº§å¥–åŠ±** | æ”¯æŒï¼ˆ5000-20000ï¼‰ | ä¸æ”¯æŒ | **å¢åŠ åˆä¼™äººå‡çº§å¥–åŠ±** |

#### V2.0 ä¸‰çº§æ¨èä½£é‡‘ä½“ç³»

```
Aï¼ˆåˆ›å§‹åˆä¼™äººï¼‰
â”œâ”€â”€ Bï¼ˆé«˜çº§åˆä¼™äººï¼‰ â† Aè·å¾—Bçš„10%ä½£é‡‘
â”‚   â”œâ”€â”€ Cï¼ˆæ™®é€šåˆä¼™äººï¼‰ â† Aè·å¾—Cçš„5%ä½£é‡‘ï¼ŒBè·å¾—Cçš„10%ä½£é‡‘
â”‚   â”‚   â””â”€â”€ Dï¼ˆæ™®é€šç”¨æˆ·ï¼‰ â† Aè·å¾—Dçš„3%ä½£é‡‘ï¼ŒBè·å¾—Dçš„5%ä½£é‡‘ï¼ŒCè·å¾—Dçš„10%ä½£é‡‘
â”‚   â””â”€â”€ Eï¼ˆæ™®é€šåˆä¼™äººï¼‰ â† Aè·å¾—Eçš„5%ä½£é‡‘ï¼ŒBè·å¾—Eçš„10%ä½£é‡‘
â””â”€â”€ Fï¼ˆæ™®é€šåˆä¼™äººï¼‰ â† Aè·å¾—Fçš„10%ä½£é‡‘
```

**ä½£é‡‘è®¡ç®—è§„åˆ™**ï¼š
- **ä¸€çº§æ¨è**ï¼šç›´æ¥æ¨èç”¨æˆ·å®Œæˆé¡¹ç›®ï¼Œè·å¾—å…¶çµå€¼æ”¶ç›Šçš„10%
- **äºŒçº§æ¨è**ï¼šé—´æ¥æ¨èç”¨æˆ·å®Œæˆé¡¹ç›®ï¼Œè·å¾—å…¶çµå€¼æ”¶ç›Šçš„5%
- **ä¸‰çº§æ¨è**ï¼šä¸‰çº§æ¨èç”¨æˆ·å®Œæˆé¡¹ç›®ï¼Œè·å¾—å…¶çµå€¼æ”¶ç›Šçš„3%
- **åˆä¼™äººå‡çº§å¥–åŠ±**ï¼šå›¢é˜Ÿç´¯è®¡çµå€¼è¾¾æ ‡ï¼Œé¢å¤–è·å¾—ä¸€æ¬¡æ€§å¥–åŠ±ï¼ˆ5000-20000ï¼‰

### 3. è´¡çŒ®å€¼æ¨¡å‹å¯¹æ¯”

| è´¡çŒ®å€¼ç±»å‹ | V2.0 | ç°æœ‰ç³»ç»Ÿ | èåˆæ–¹æ¡ˆ |
|-----------|------|---------|---------|
| **ç´¯è®¡è´¡çŒ®å€¼** | âœ“ | âœ“ | **ä¿ç•™å¹¶å¼ºåŒ–** |
| **é¡¹ç›®è´¡çŒ®å€¼** | âœ“ | âœ— | **æ–°å¢** |
| **å‰©ä½™è´¡çŒ®å€¼** | âœ“ | âœ— | **æ–°å¢** |
| **æ€»è´¡çŒ®å€¼** | âœ— | âœ“ | **é‡å‘½åä¸ºç´¯è®¡è´¡çŒ®å€¼** |

#### V2.0 ä¸‰ç»´è´¡çŒ®å€¼æ¨¡å‹

```python
class ContributionModel:
    # 1. ç´¯è®¡è´¡çŒ®å€¼ï¼ˆCumulative Contribution Valueï¼‰
    # ç”¨é€”ï¼šåˆä¼™äººå±‚çº§åˆ¤å®šä¾æ®
    # è®¡ç®—ï¼šåˆå§‹çµå€¼ + é¡¹ç›®è´¡çŒ®å€¼ + æ¨èå¥–åŠ± - æ¶ˆè´¹çµå€¼
    cumulative_contribution = 1000 + 50000 + 10000 - 2000 = 59000
    
    # 2. é¡¹ç›®è´¡çŒ®å€¼ï¼ˆProject Contribution Valueï¼‰
    # ç”¨é€”ï¼šçµå€¼æ”¶ç›Šæ ¸å¿ƒæ¥æº
    # è®¡ç®—ï¼šé¡¹ç›®éš¾åº¦ç³»æ•° Ã— å®Œæˆè´¨é‡è¯„åˆ† Ã— å‚ä¸åº¦å æ¯”
    project_contribution = 1.5 Ã— 9.0 Ã— 0.8 = 10.8
    
    # 3. å‰©ä½™è´¡çŒ®å€¼ï¼ˆRemaining Contribution Valueï¼‰
    # ç”¨é€”ï¼šå¯ç”¨äºå…‘æ¢æƒç›Šã€å‚ä¸é¡¹ç›®ç«æ‹
    # è®¡ç®—ï¼šç´¯è®¡è´¡çŒ®å€¼ - æ¶ˆè´¹çš„è´¡çŒ®å€¼
    remaining_contribution = 59000 - 2000 = 57000
```

### 4. ç³»ç»Ÿè‡ªåŠ¨è¿è¥è§„åˆ™å¯¹æ¯”

| è§„åˆ™ç±»å‹ | V2.0 | ç°æœ‰ç³»ç»Ÿ | èåˆæ–¹æ¡ˆ |
|---------|------|---------|---------|
| **æ–°ç”¨æˆ·å¥–åŠ±** | 1000åˆå§‹+500é¦–é¡¹ç›® | 100åˆå§‹ | **é‡‡ç”¨V2.0å¥–åŠ±** |
| **æ´»è·ƒç”¨æˆ·å‹‹ç« ** | 30å¤©è¿ç»­ç™»å½•+5%æ”¶ç›Š | æ—  | **æ–°å¢** |
| **æ²‰ç¡ç”¨æˆ·å”¤é†’** | 60å¤©æœªç™»å½•+200å”¤é†’ | æ—  | **æ–°å¢** |
| **é¡¹ç›®è‡ªåŠ¨åˆ†é…** | æ™ºèƒ½åŒ¹é… | æ‰‹åŠ¨å‚ä¸ | **æ–°å¢æ™ºèƒ½åŒ¹é…** |
| **é¡¹ç›®è¶…æ—¶æƒ©ç½š** | 7å¤©-100çµå€¼ | æ—  | **æ–°å¢** |

#### V2.0 ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
# 1. æ–°ç”¨æˆ·æ³¨å†Œ
æ–°ç”¨æˆ·æ³¨å†Œ â†’ è‡ªåŠ¨èµ é€1000åˆå§‹çµå€¼
    â†“
7å¤©å†…å®Œæˆé¦–é¡¹ç›® â†’ é¢å¤–å¥–åŠ±500çµå€¼
    â†“
30å¤©æœªå®Œæˆé¦–é¡¹ç›® â†’ æé†’å¼•å¯¼

# 2. æ´»è·ƒç”¨æˆ·
è¿ç»­30å¤©ç™»å½• â†’ è·å¾—"æ´»è·ƒå‹‹ç« "
    â†“
çµå€¼æ”¶ç›Šé¢å¤–+5%

# 3. æ²‰ç¡ç”¨æˆ·
è¿ç»­60å¤©æœªç™»å½• â†’ å‘é€å”¤é†’çŸ­ä¿¡
    â†“
ç™»å½•å³é€200çµå€¼

# 4. é¡¹ç›®è‡ªåŠ¨åˆ†é…
ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®ï¼š
- ç”¨æˆ·èŒç§°
- å†å²é¡¹ç›®ç»éªŒ
- çµå€¼ç­‰çº§
    â†“
åŒ¹é…é€‚åˆçš„é¡¹ç›®

# 5. é¡¹ç›®è¶…æ—¶æƒ©ç½š
æœªå®Œæˆé¡¹ç›®è¶…è¿‡7å¤© â†’ è‡ªåŠ¨æ‰£é™¤100çµå€¼æƒ©ç½š
```

---

## èåˆæ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ1ï¼šä¼šå‘˜çº§åˆ«ä½“ç³»è°ƒæ•´

#### ç›®æ ‡
å°†5çº§ä¼šå‘˜ä½“ç³»è°ƒæ•´ä¸º4çº§åˆä¼™äººä½“ç³»

#### å®æ–½æ­¥éª¤

1. **æ–°å¢ç”¨æˆ·å±‚çº§æšä¸¾**
```python
class PartnerLevelType(Enum):
    """åˆä¼™äººçº§åˆ«æšä¸¾ï¼ˆV2.0ï¼‰"""
    NORMAL_USER = "normal_user"           # æ™®é€šç”¨æˆ·
    REGULAR_PARTNER = "regular_partner"   # æ™®é€šåˆä¼™äºº
    SENIOR_PARTNER = "senior_partner"     # é«˜çº§åˆä¼™äºº
    FOUNDING_PARTNER = "founding_partner" # åˆ›å§‹åˆä¼™äºº
```

2. **æ›´æ–°åˆä¼™äººçº§åˆ«å®šä¹‰**
```python
PARTNER_LEVELS = {
    PartnerLevelType.NORMAL_USER: {
        "name": "æ™®é€šç”¨æˆ·",
        "min_contribution": 0,
        "min_investment": 0,
        "commission_bonus": 0.0,  # åŸºç¡€10%
        "team_bonus": 0.0,       # å›¢é˜Ÿ0%
        "referral_depth": 1,     # åªæœ‰ä¸€çº§æ¨è
        "rights": ["é¡¹ç›®å‚ä¸æƒ", "çµå€¼ç§¯ç´¯"]
    },
    PartnerLevelType.REGULAR_PARTNER: {
        "name": "æ™®é€šåˆä¼™äºº",
        "min_contribution": 50000,
        "min_investment": 50000,
        "commission_bonus": 0.0,  # åŸºç¡€10%
        "team_bonus": 0.1,       # å›¢é˜Ÿé¢å¤–+10%
        "referral_depth": 2,     # äºŒçº§æ¨èï¼ˆ10%+5%ï¼‰
        "upgrade_reward": 5000,  # å‡çº§å¥–åŠ±5000
        "rights": ["äºŒçº§æ¨è", "é¡¹ç›®ä¼˜å…ˆå‚ä¸æƒ"]
    },
    PartnerLevelType.SENIOR_PARTNER: {
        "name": "é«˜çº§åˆä¼™äºº",
        "min_contribution": 100000,
        "min_investment": 100000,
        "commission_bonus": 0.0,  # åŸºç¡€10%
        "team_bonus": 0.15,      # å›¢é˜Ÿé¢å¤–+15%
        "referral_depth": 3,     # ä¸‰çº§æ¨èï¼ˆ10%+5%+3%ï¼‰
        "upgrade_reward": 10000, # å‡çº§å¥–åŠ±10000
        "rights": ["ä¸‰çº§æ¨è", "é¡¹ç›®å†³ç­–æƒ"]
    },
    PartnerLevelType.FOUNDING_PARTNER: {
        "name": "åˆ›å§‹åˆä¼™äºº",
        "min_contribution": 200000,
        "min_investment": 200000,
        "commission_bonus": 0.0,  # åŸºç¡€10%
        "team_bonus": 0.2,       # å›¢é˜Ÿé¢å¤–+20%
        "referral_depth": 3,     # ä¸‰çº§æ¨è
        "upgrade_reward": 20000, # å‡çº§å¥–åŠ±20000
        "dividend_percentage": 0.1,  # å¹´åº¦å¹³å°æ”¶ç›Š10%åˆ†çº¢
        "rights": ["å¹³å°åˆ†çº¢æƒ", "è§„åˆ™åˆ¶å®šå‚ä¸æƒ"]
    }
}
```

3. **å‡çº§é€»è¾‘è°ƒæ•´**
```python
def check_partner_upgrade_eligibility(user_id: int) -> Tuple[bool, Optional[PartnerLevelType]]:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¬¦åˆåˆä¼™äººå‡çº§æ¡ä»¶"""
    
    user_level = get_user_partner_level(user_id)
    
    # æ£€æŸ¥ç´¯è®¡çµå€¼
    cumulative_contribution = get_cumulative_contribution(user_id)
    
    # æ£€æŸ¥ç›´æ¥æŠ•èµ„ï¼ˆæ–°å¢ï¼‰
    direct_investment = get_direct_investment(user_id)
    
    # ä¸¤ç§å‡çº§è·¯å¾„ï¼šç´¯è®¡çµå€¼ OR ç›´æ¥æŠ•èµ„
    if cumulative_contribution >= 200000 or direct_investment >= 200000:
        return True, PartnerLevelType.FOUNDING_PARTNER
    elif cumulative_contribution >= 100000 or direct_investment >= 100000:
        return True, PartnerLevelType.SENIOR_PARTNER
    elif cumulative_contribution >= 50000 or direct_investment >= 50000:
        return True, PartnerLevelType.REGULAR_PARTNER
    else:
        return False, None
```

### æ–¹æ¡ˆ2ï¼šæ¨èä½£é‡‘ç³»ç»Ÿå‡çº§

#### ç›®æ ‡
å°†ä¸€çº§æ¨èå‡çº§ä¸ºä¸‰çº§æ¨èï¼ˆ10%/5%/3%ï¼‰

#### å®æ–½æ­¥éª¤

1. **æ–°å¢æ¨èå±‚çº§æšä¸¾**
```python
class ReferralLevel(Enum):
    """æ¨èå±‚çº§æšä¸¾"""
    LEVEL_1 = 1  # ä¸€çº§æ¨èï¼šç›´æ¥æ¨è
    LEVEL_2 = 2  # äºŒçº§æ¨èï¼šé—´æ¥æ¨è
    LEVEL_3 = 3  # ä¸‰çº§æ¨èï¼šä¸‰çº§æ¨è
```

2. **æ›´æ–°ä½£é‡‘è®¡ç®—è§„åˆ™**
```python
# V2.0 ä¸‰çº§æ¨èä½£é‡‘è§„åˆ™
REFERRAL_COMMISSION_RATES = {
    ReferralLevel.LEVEL_1: 0.10,  # ä¸€çº§æ¨èï¼š10%
    ReferralLevel.LEVEL_2: 0.05,  # äºŒçº§æ¨èï¼š5%
    ReferralLevel.LEVEL_3: 0.03,  # ä¸‰çº§æ¨èï¼š3%
}

def calculate_referral_commission(
    referrer_id: int,
    referee_id: int,
    contribution_earned: float
) -> List[Dict]:
    """
    è®¡ç®—ä¸‰çº§æ¨èä½£é‡‘
    
    Args:
        referrer_id: æ¨èäººID
        referee_id: è¢«æ¨èäººID
        contribution_earned: è¢«æ¨èäººè·å¾—çš„è´¡çŒ®å€¼
    
    Returns:
        ä½£é‡‘åˆ†é…åˆ—è¡¨ï¼ˆåŒ…æ‹¬ä¸‰çº§æ¨èäººï¼‰
    """
    
    commissions = []
    
    # 1. ä¸€çº§æ¨èï¼ˆç›´æ¥æ¨èï¼‰
    referrer = get_user(referrer_id)
    if referrer:
        level1_commission = contribution_earned * 0.10
        commissions.append({
            "referrer_id": referrer_id,
            "level": 1,
            "rate": 0.10,
            "amount": level1_commission
        })
        
        # 2. äºŒçº§æ¨èï¼ˆå¦‚æœæ¨èäººæ˜¯åˆä¼™äººï¼‰
        if referrer.partner_level >= PartnerLevelType.REGULAR_PARTNER:
            referrer_referrer = get_user_referrer(referrer_id)
            if referrer_referrer:
                level2_commission = contribution_earned * 0.05
                commissions.append({
                    "referrer_id": referrer_referrer.id,
                    "level": 2,
                    "rate": 0.05,
                    "amount": level2_commission
                })
                
                # 3. ä¸‰çº§æ¨èï¼ˆå¦‚æœäºŒçº§æ¨èäººæ˜¯é«˜çº§/åˆ›å§‹åˆä¼™äººï¼‰
                if referrer_referrer.partner_level >= PartnerLevelType.SENIOR_PARTNER:
                    referrer_referrer_referrer = get_user_referrer(referrer_referrer.id)
                    if referrer_referrer_referrer:
                        level3_commission = contribution_earned * 0.03
                        commissions.append({
                            "referrer_id": referrer_referrer_referrer.id,
                            "level": 3,
                            "rate": 0.03,
                            "amount": level3_commission
                        })
    
    return commissions
```

3. **å¢åŠ åˆä¼™äººå‡çº§å¥–åŠ±**
```python
def handle_partner_upgrade_reward(user_id: int, new_level: PartnerLevelType):
    """å¤„ç†åˆä¼™äººå‡çº§å¥–åŠ±"""
    
    # è·å–å‡çº§å¥–åŠ±é‡‘é¢
    reward_amount = PARTNER_LEVELS[new_level]["upgrade_reward"]
    
    if reward_amount > 0:
        # å‘æ”¾ä¸€æ¬¡æ€§å¥–åŠ±
        add_contribution(
            user_id=user_id,
            amount=reward_amount,
            transaction_type=TransactionType.LEVEL_UPGRADE,
            description=f"åˆä¼™äººå‡çº§å¥–åŠ±ï¼š{PARTNER_LEVELS[new_level]['name']}"
        )
```

### æ–¹æ¡ˆ3ï¼šè´¡çŒ®å€¼æ¨¡å‹ç»†åŒ–

#### ç›®æ ‡
å°†å•ä¸€è´¡çŒ®å€¼ç»†åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼ˆç´¯è®¡/é¡¹ç›®/å‰©ä½™ï¼‰

#### å®æ–½æ­¥éª¤

1. **æ›´æ–°ç”¨æˆ·è´¡çŒ®å€¼è¡¨ç»“æ„**
```python
class UserContributionV2(Base):
    """ç”¨æˆ·è´¡çŒ®å€¼è¡¨ï¼ˆV2.0ï¼‰"""
    __tablename__ = 'user_contributions_v2'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    
    # ç´¯è®¡è´¡çŒ®å€¼ï¼ˆCumulativeï¼‰
    cumulative_contribution = Column(Float, default=0.0)  # ç´¯è®¡è´¡çŒ®å€¼
    
    # é¡¹ç›®è´¡çŒ®å€¼ï¼ˆProjectï¼‰
    project_contribution = Column(Float, default=0.0)    # é¡¹ç›®è´¡çŒ®å€¼
    
    # å‰©ä½™è´¡çŒ®å€¼ï¼ˆRemainingï¼‰
    remaining_contribution = Column(Float, default=0.0)   # å‰©ä½™è´¡çŒ®å€¼
    
    # æ¶ˆè´¹è´¡çŒ®å€¼
    consumed_contribution = Column(Float, default=0.0)   # æ¶ˆè´¹è´¡çŒ®å€¼
    
    # åˆå§‹çµå€¼
    initial_contribution = Column(Float, default=1000.0)  # åˆå§‹1000çµå€¼
    
    # æ¨èå¥–åŠ±
    referral_reward = Column(Float, default=0.0)          # æ¨èå¥–åŠ±
    
    # ä½£é‡‘æ”¶å…¥
    commission_income = Column(Float, default=0.0)       # ä½£é‡‘æ”¶å…¥
    
    # å›¢é˜Ÿæ”¶ç›Š
    team_income = Column(Float, default=0.0)              # å›¢é˜Ÿæ”¶ç›Š
    
    # æ›´æ–°æ—¶é—´
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
```

2. **è´¡çŒ®å€¼è®¡ç®—é€»è¾‘**
```python
def update_contribution_model(user_id: int):
    """
    æ›´æ–°è´¡çŒ®å€¼æ¨¡å‹
    
    è®¡ç®—ï¼š
    - ç´¯è®¡è´¡çŒ®å€¼ = åˆå§‹çµå€¼ + é¡¹ç›®è´¡çŒ®å€¼ + æ¨èå¥–åŠ± + ä½£é‡‘æ”¶å…¥ + å›¢é˜Ÿæ”¶ç›Š - æ¶ˆè´¹è´¡çŒ®å€¼
    - å‰©ä½™è´¡çŒ®å€¼ = ç´¯è®¡è´¡çŒ®å€¼ - æ¶ˆè´¹è´¡çŒ®å€¼
    """
    
    contribution = get_user_contribution(user_id)
    
    # ç´¯è®¡è´¡çŒ®å€¼
    contribution.cumulative_contribution = (
        contribution.initial_contribution +
        contribution.project_contribution +
        contribution.referral_reward +
        contribution.commission_income +
        contribution.team_income -
        contribution.consumed_contribution
    )
    
    # å‰©ä½™è´¡çŒ®å€¼
    contribution.remaining_contribution = (
        contribution.cumulative_contribution -
        contribution.consumed_contribution
    )
    
    contribution.updated_at = datetime.now()
```

### æ–¹æ¡ˆ4ï¼šç³»ç»Ÿè‡ªåŠ¨è¿è¥è§„åˆ™

#### ç›®æ ‡
å®ç°V2.0çš„è‡ªåŠ¨è¿è¥è§„åˆ™

#### å®æ–½æ­¥éª¤

1. **æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±**
```python
def handle_new_user_registration(user_id: int):
    """å¤„ç†æ–°ç”¨æˆ·æ³¨å†Œï¼ˆV2.0ï¼‰"""
    
    # 1. è‡ªåŠ¨èµ é€1000åˆå§‹çµå€¼
    add_contribution(
        user_id=user_id,
        amount=1000.0,
        transaction_type=TransactionType.NEW_USER_REWARD,
        description="æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±ï¼ˆV2.0ï¼‰"
    )
    
    # 2. è®°å½•æ³¨å†Œæ—¶é—´
    user = get_user(user_id)
    user.registration_date = datetime.now()
    
    # 3. 7å¤©å®šæ—¶ä»»åŠ¡æé†’
    schedule_first_project_reminder(user_id, days=7)
```

2. **æ´»è·ƒç”¨æˆ·å‹‹ç« **
```python
def check_active_user_badge():
    """æ£€æŸ¥æ´»è·ƒç”¨æˆ·å‹‹ç« ï¼ˆæ¯å¤©å®šæ—¶æ‰§è¡Œï¼‰"""
    
    # æŸ¥æ‰¾è¿ç»­30å¤©ç™»å½•çš„ç”¨æˆ·
    active_users = get_users_with_consecutive_login(days=30)
    
    for user in active_users:
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰å‹‹ç« 
        if not has_active_badge(user.id):
            # é¢å‘å‹‹ç« 
            grant_active_badge(user.id)
            
            # çµå€¼æ”¶ç›Šé¢å¤–+5%ï¼ˆå…¨å±€æ•ˆæœï¼‰
            set_user_bonus_multiplier(user.id, 1.05)  # 1.05å€
```

3. **æ²‰ç¡ç”¨æˆ·å”¤é†’**
```python
def check_dormant_users():
    """æ£€æŸ¥æ²‰ç¡ç”¨æˆ·ï¼ˆæ¯å¤©å®šæ—¶æ‰§è¡Œï¼‰"""
    
    # æŸ¥æ‰¾è¿ç»­60å¤©æœªç™»å½•çš„ç”¨æˆ·
    dormant_users = get_users_without_login(days=60)
    
    for user in dormant_users:
        # å‘é€å”¤é†’çŸ­ä¿¡
        send_wakeup_sms(user.phone)
        
        # è®°å½•å”¤é†’å¥–åŠ±ï¼ˆç™»å½•æ—¶å‘æ”¾ï¼‰
        set_pending_wakeup_reward(user.id, 200.0)

def handle_user_login(user_id: int):
    """å¤„ç†ç”¨æˆ·ç™»å½•"""
    
    user = get_user(user_id)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘æ”¾çš„å”¤é†’å¥–åŠ±
    wakeup_reward = get_pending_wakeup_reward(user_id)
    if wakeup_reward:
        add_contribution(
            user_id=user_id,
            amount=wakeup_reward.amount,
            transaction_type=TransactionType.WAKEUP_REWARD,
            description="æ²‰ç¡ç”¨æˆ·å”¤é†’å¥–åŠ±"
        )
        clear_pending_wakeup_reward(user_id)
```

4. **é¡¹ç›®è‡ªåŠ¨åˆ†é…**
```python
def auto_assign_projects(user_id: int):
    """
    è‡ªåŠ¨åˆ†é…é¡¹ç›®ç»™ç”¨æˆ·
    
    åŒ¹é…å› å­ï¼š
    - ç”¨æˆ·èŒç§°
    - å†å²é¡¹ç›®ç»éªŒ
    - çµå€¼ç­‰çº§
    """
    
    user = get_user(user_id)
    
    # è·å–ç”¨æˆ·ç”»åƒ
    user_profile = {
        "position": user.position,
        "experience": get_project_experience(user_id),
        "contribution_level": get_user_contribution_level(user_id)
    }
    
    # è·å–é€‚åˆçš„é¡¹ç›®
    suitable_projects = get_suitable_projects(user_profile)
    
    # æŒ‰ä¼˜å…ˆçº§æ’åº
    ranked_projects = rank_projects_by_priority(suitable_projects, user_profile)
    
    # æ¨èå‰5ä¸ªé¡¹ç›®
    recommended_projects = ranked_projects[:5]
    
    return recommended_projects
```

5. **é¡¹ç›®è¶…æ—¶æƒ©ç½š**
```python
def check_project_timeout():
    """æ£€æŸ¥é¡¹ç›®è¶…æ—¶ï¼ˆæ¯å¤©å®šæ—¶æ‰§è¡Œï¼‰"""
    
    # æŸ¥æ‰¾è¶…è¿‡7å¤©æœªå®Œæˆçš„é¡¹ç›®
    timeout_projects = get_timeout_projects(days=7)
    
    for project in timeout_projects:
        for participation in project.participations:
            # æ‰£é™¤100çµå€¼æƒ©ç½š
            consume_contribution(
                user_id=participation.user_id,
                amount=100.0,
                transaction_type=TransactionType.PROJECT_TIMEOUT_PENALTY,
                description=f"é¡¹ç›®è¶…æ—¶æƒ©ç½šï¼š{project.project_name}"
            )
            
            # å‘é€é€šçŸ¥
            send_timeout_notification(
                user_id=participation.user_id,
                project_name=project.project_name
            )
```

---

## æ¨¡å—è°ƒæ•´æ¸…å•

### éœ€è¦è°ƒæ•´çš„æ¨¡å—

| æ¨¡å— | è°ƒæ•´å†…å®¹ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| **my_user.py** | ä¼šå‘˜çº§åˆ«ä½“ç³»è°ƒæ•´ã€è´¡çŒ®å€¼æ¨¡å‹ç»†åŒ– | P0 |
| **referral_manager.py** | ä¸‰çº§æ¨èä½£é‡‘ã€åˆä¼™äººå‡çº§å¥–åŠ± | P0 |
| **project_manager.py** | é¡¹ç›®è‡ªåŠ¨åˆ†é…ã€é¡¹ç›®è¶…æ—¶æƒ©ç½š | P1 |
| **dividend_manager.py** | åˆ›å§‹åˆä¼™äººå¹´åº¦åˆ†çº¢ | P1 |
| **auto_operation.py** | æ–°å¢ï¼šè‡ªåŠ¨è¿è¥è§„åˆ™æ¨¡å— | P0 |
| **user_management_api.py** | APIæ¥å£æ›´æ–° | P0 |

---

## æ•°æ®åº“å˜æ›´æ–¹æ¡ˆ

### æ–°å¢è¡¨

1. **user_contributions_v2** - ç”¨æˆ·è´¡çŒ®å€¼è¡¨ï¼ˆV2.0ï¼‰
2. **user_active_badges** - æ´»è·ƒç”¨æˆ·å‹‹ç« è¡¨
3. **project_assignments** - é¡¹ç›®è‡ªåŠ¨åˆ†é…è®°å½•è¡¨
4. **pending_rewards** - å¾…å‘æ”¾å¥–åŠ±è¡¨

### æ›´æ–°è¡¨

1. **users** - æ–°å¢å­—æ®µï¼š
   - `registration_date` - æ³¨å†Œæ—¥æœŸ
   - `last_login_date` - æœ€åç™»å½•æ—¥æœŸ
   - `consecutive_login_days` - è¿ç»­ç™»å½•å¤©æ•°
   - `partner_level` - åˆä¼™äººçº§åˆ«
   - `direct_investment` - ç›´æ¥æŠ•èµ„é‡‘é¢

2. **member_levels** - æ›´æ–°æ•°æ®ï¼š
   - åˆ é™¤åŸæœ‰5çº§æ•°æ®
   - æ’å…¥4çº§åˆä¼™äººæ•°æ®

3. **referral_commissions** - æ–°å¢å­—æ®µï¼š
   - `referral_level` - æ¨èå±‚çº§ï¼ˆ1/2/3ï¼‰
   - `is_upgrade_reward` - æ˜¯å¦å‡çº§å¥–åŠ±

---

## APIæ¥å£å˜æ›´

### æ–°å¢APIæ¥å£

1. **è‡ªåŠ¨è¿è¥**
   - `POST /api/user/active-badge/check` - æ£€æŸ¥æ´»è·ƒå‹‹ç« 
   - `POST /api/user/dormant/check` - æ£€æŸ¥æ²‰ç¡ç”¨æˆ·
   - `GET /api/user/{user_id}/project-recommendations` - è·å–é¡¹ç›®æ¨è

2. **åˆä¼™äººå‡çº§**
   - `POST /api/user/{user_id}/partner/upgrade` - åˆä¼™äººå‡çº§
   - `GET /api/user/{user_id}/upgrade-eligibility` - æ£€æŸ¥å‡çº§æ¡ä»¶

3. **æŠ•èµ„è·¯å¾„**
   - `POST /api/user/{user_id}/invest` - ç›´æ¥æŠ•èµ„
   - `GET /api/user/{user_id}/investments` - æŠ•èµ„è®°å½•

### æ›´æ–°APIæ¥å£

1. **è´¡çŒ®å€¼API**
   - `GET /api/user/{user_id}/contribution` - è¿”å›ä¸‰ç»´è´¡çŒ®å€¼
   - `POST /api/user/{user_id}/contribution/add` - æ”¯æŒæŒ‡å®šç±»å‹

2. **æ¨èAPI**
   - `POST /api/referral` - æ”¯æŒä¸‰çº§æ¨èä½£é‡‘è®¡ç®—
   - `GET /api/user/{user_id}/referral/tree` - è·å–ä¸‰çº§æ¨èæ ‘

---

## å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šæ•°æ®åº“è°ƒæ•´ï¼ˆ2å°æ—¶ï¼‰

1. âœ… åˆ›å»ºæ–°è¡¨
2. âœ… æ›´æ–°ç°æœ‰è¡¨ç»“æ„
3. âœ… åˆå§‹åŒ–4çº§åˆä¼™äººæ•°æ®
4. âœ… æ•°æ®è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰

### é˜¶æ®µ2ï¼šæ ¸å¿ƒæ¨¡å—è°ƒæ•´ï¼ˆ4å°æ—¶ï¼‰

1. âœ… my_user.pyè°ƒæ•´
2. âœ… referral_manager.pyè°ƒæ•´
3. âœ… æ–°å¢auto_operation.py

### é˜¶æ®µ3ï¼šAPIæ¥å£æ›´æ–°ï¼ˆ2å°æ—¶ï¼‰

1. âœ… æ›´æ–°ç°æœ‰API
2. âœ… æ–°å¢APIæ¥å£
3. âœ… APIæ–‡æ¡£æ›´æ–°

### é˜¶æ®µ4ï¼šæµ‹è¯•éªŒè¯ï¼ˆ2å°æ—¶ï¼‰

1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… æ€§èƒ½æµ‹è¯•

### æ€»è®¡ï¼š10å°æ—¶

---

## æ€»ç»“

### èåˆæˆæœ

é€šè¿‡æœ¬æ–¹æ¡ˆï¼Œå°†V2.0ç‰ˆæœ¬çš„åˆä¼™äººæ¨¡å¼è®¾è®¡å®Œå…¨èå…¥ç°æœ‰my_userç³»ç»Ÿï¼Œå®ç°ï¼š

1. âœ… **4çº§åˆä¼™äººä½“ç³»**ï¼šæ™®é€šç”¨æˆ·ã€æ™®é€šåˆä¼™äººã€é«˜çº§åˆä¼™äººã€åˆ›å§‹åˆä¼™äºº
2. âœ… **ä¸‰çº§æ¨èä½£é‡‘**ï¼š10%+5%+3%å›ºå®šæ¯”ä¾‹
3. âœ… **ä¸‰ç»´è´¡çŒ®å€¼æ¨¡å‹**ï¼šç´¯è®¡ã€é¡¹ç›®ã€å‰©ä½™è´¡çŒ®å€¼
4. âœ… **è‡ªåŠ¨è¿è¥è§„åˆ™**ï¼šæ³¨å†Œå¥–åŠ±ã€æ´»è·ƒå‹‹ç« ã€æ²‰ç¡å”¤é†’ã€é¡¹ç›®åˆ†é…ã€è¶…æ—¶æƒ©ç½š
5. âœ… **åŒé‡å‡çº§è·¯å¾„**ï¼šç´¯è®¡çµå€¼ OR ç›´æ¥æŠ•èµ„

### ç³»ç»Ÿä»·å€¼

èåˆåçš„ç³»ç»Ÿå°†å®ç°ï¼š

- **æ›´æ¸…æ™°çš„å±‚çº§ä½“ç³»**ï¼š4çº§åˆä¼™äººï¼Œé—¨æ§›æ˜ç¡®ï¼Œæƒç›Šæ¸…æ™°
- **æ›´å¼ºå¤§çš„æ¿€åŠ±æœºåˆ¶**ï¼šä¸‰çº§æ¨èï¼Œå¤šé‡å¥–åŠ±ï¼Œç”Ÿæ€å¾ªç¯
- **æ›´ç²¾ç»†çš„è´¡çŒ®å€¼ç®¡ç†**ï¼šä¸‰ç»´æ¨¡å‹ï¼Œç”¨é€”æ˜ç¡®ï¼Œä»·å€¼æ¸…æ™°
- **æ›´æ™ºèƒ½çš„è‡ªåŠ¨è¿è¥**ï¼šè‡ªåŠ¨åŒ–è§„åˆ™ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **æ›´å®Œæ•´çš„ç”Ÿæ€é—­ç¯**ï¼šç”¨æˆ·â†’é¡¹ç›®â†’å¹³å°ï¼Œä¸‰æ–¹ä»·å€¼å…±ç”Ÿ

---

**èåˆç›®æ ‡ï¼šå®Œå…¨ç»Ÿä¸€ï¼Œæ— ç¼è¡”æ¥ï¼ŒæŒç»­è¿›åŒ–ï¼ğŸš€**
