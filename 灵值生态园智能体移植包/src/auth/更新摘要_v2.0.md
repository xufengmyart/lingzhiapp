# 更新摘要：CEO角色和访客管理系统

**更新日期**：2026年1月23日
**更新类型**：核心功能增强
**版本**：v2.0
**优先级**：⭐⭐⭐⭐⭐（最高）

---

## 📋 更新概述

本次更新为"媄月商业艺术"权限管理系统添加了CEO角色、黄爱莉CEO账号以及完整的访客管理系统，支持访客注册、团队管理和团队长审批等功能。

---

## 🎯 更新目标

1. **添加CEO角色**：创建CEO角色，权限级别高于超级管理员
2. **创建黄爱莉账号**：为黄爱莉创建CEO账号
3. **访客登记系统**：支持访客信息的完整登记
4. **团队管理功能**：支持团队成员管理和团队长审批
5. **团队长机制**：团队长必须拥有3个以上角色的成员

---

## 📂 新增/修改文件

### 1. models.py（修改）

**修改内容**：
- **User模型**：
  - 添加`wechat`字段：微信号
  - 添加`is_ceo`字段：是否为CEO

- **新增Visitor模型**：访客表
  - `name`：姓名
  - `wechat`：微信号
  - `phone`：联系方式
  - `referrer`：推荐人
  - `notes`：备注
  - `shipping_address`：收货地址
  - `is_team_leader`：是否为团队长
  - `willing_to_be_leader`：是否愿意成为团队长
  - `status`：状态
  - `created_at`、`updated_at`、`created_by`：时间戳和创建人

- **新增TeamMember模型**：团队成员表
  - `team_leader_id`：团队长ID
  - `member_id`：成员ID
  - `role`：角色
  - `joined_at`：加入时间
  - `notes`：备注

**新增属性**：
- `Visitor.can_be_team_leader`：检查是否可以成为团队长（拥有3个以上成员）

---

### 2. init_data_v2.py（全新文件）

**创建的初始数据**：

#### 角色（8个）
1. **CEO**（级别0）：公司首席执行官，拥有所有权限
2. **超级管理员**（级别1）：拥有所有系统权限
3. **CTO管理员**（级别2）：技术部门高级管理员
4. **CMO管理员**（级别2）：市场部门高级管理员
5. **COO管理员**（级别2）：运营部门高级管理员
6. **CFO管理员**（级别2）：财务部门高级管理员
7. **部门经理**（级别3）：部门级别权限
8. **普通员工**（级别4）：普通员工权限

#### 权限（36个）
- 原有30个权限
- **新增6个访客管理权限**：
  - `visitor:create`：创建访客
  - `visitor:delete`：删除访客
  - `visitor:modify`：修改访客
  - `visitor:view`：查看访客
  - `visitor:approve_leader`：审批团队长
  - `visitor:manage_team`：管理团队

#### 用户（6个）

| 账号 | 邮箱 | 密码 | 角色 | 级别 |
|-----|------|------|------|------|
| **黄爱莉** | huangaili@meiyue.com | Huang@2026 | CEO | 0 |
| 许锋 | xufeng@meiyue.com | Xu@2026 | 超级管理员 | 1 |
| CTO（待定） | cto@meiyue.com | Temp@2026 | CTO管理员 | 2 |
| CMO（待定） | cmo@meiyue.com | Temp@2026 | CMO管理员 | 2 |
| COO（待定） | coo@meiyue.com | Temp@2026 | COO管理员 | 2 |
| CFO（待定） | cfo@meiyue.com | Temp@2026 | CFO管理员 | 2 |

---

### 3. visitor_api.py（全新文件）

**访客管理API接口**：

#### 访客管理接口
- `POST /api/visitors` - 创建访客
- `GET /api/visitors` - 获取访客列表（支持按状态和团队长筛选）
- `GET /api/visitors/{visitor_id}` - 获取访客详情
- `PUT /api/visitors/{visitor_id}` - 更新访客信息
- `DELETE /api/visitors/{visitor_id}` - 删除访客

#### 团队长管理接口
- `POST /api/visitors/{visitor_id}/approve-leader` - 审批团队长申请
- `GET /api/visitors/{visitor_id}/team-members` - 获取访客的团队成员

#### 团队成员管理接口
- `POST /api/team-members` - 添加团队成员
- `DELETE /api/team-members/{team_member_id}` - 移除团队成员

**团队长审批条件**：
- 必须拥有3个以上角色的成员
- 访客必须愿意成为团队长（willing_to_be_leader = True）

---

### 4. visitor_register.html（全新文件）

**访客注册页面**：

#### 必填字段
- 姓名
- 微信号
- 联系方式（电话）

#### 可选字段
- 推荐人
- 收货地址
- 备注

#### 团队长信息
- 是否为团队长（复选框）
- 是否愿意成为团队长（复选框）

#### 验证规则
- 手机号格式验证：`/^1[3-9]\d{9}$/`
- 微信号长度验证：6-20位
- 所有必填字段验证

#### 用户界面
- 响应式设计，支持移动端
- 团队长说明信息框
- 成功/错误提示

---

### 5. index.html（修改）

**新增功能**：
- 在导航栏添加"访客管理"标签
- 添加访客管理页面

**访客管理页面功能**：
- 访客列表展示（ID、姓名、微信、电话、推荐人、是否团队长、团队成员数、状态）
- 访客注册按钮（打开新窗口）
- 刷新列表按钮
- 批准团队长按钮（当访客满足条件时显示）
- 删除访客按钮

**团队成员信息展示**：
- 团队成员数量
- 是否可以成为团队长（✅ 可申请 / ⏳ 不足3人）

---

### 6. api.py（修改）

**修改内容**：
- 在`startup_event`后添加访客API模块导入
- 支持36个权限（原30个 + 新增6个访客管理权限）

---

## 📊 权限级别调整

| 角色 | 英文名 | 级别 | 说明 |
|-----|--------|------|------|
| CEO | ceo | 0 | 最高级别，公司首席执行官 |
| 超级管理员 | super_admin | 1 | 拥有所有系统权限 |
| CTO管理员 | cto_admin | 2 | 技术部门高级管理员 |
| CMO管理员 | cmo_admin | 2 | 市场部门高级管理员 |
| COO管理员 | coo_admin | 2 | 运营部门高级管理员 |
| CFO管理员 | cfo_admin | 2 | 财务部门高级管理员 |
| 部门经理 | manager | 3 | 部门级别权限 |
| 普通员工 | staff | 4 | 普通员工权限 |

---

## 🔐 访客登记信息

### 必填信息
1. **姓名**：访客的真实姓名
2. **微信号**：访客的微信号（唯一标识）
3. **联系方式**：访客的电话号码（唯一标识）

### 可选信息
4. **推荐人**：推荐访客加入的人
5. **备注**：其他备注信息
6. **收货地址**：访客的收货地址

### 团队长信息
7. **是否为团队长**：当前是否已经是团队长
8. **是否愿意成为团队长**：是否愿意成为团队长（如果当前不是）

---

## 🏆 团队长机制

### 团队长申请条件
1. **成员数量**：必须拥有3个以上角色的成员
2. **意愿确认**：访客必须愿意成为团队长
3. **人工审批**：需要管理员手动审批

### 团队长审批流程
```
访客申请 → 系统检查（成员≥3）→ 管理员审批 → 成为团队长
```

### 团队长权限
- 查看团队成员列表
- 管理团队成员
- 查看团队统计数据

---

## 📝 使用指南

### 使用新的初始化脚本

由于数据库结构发生了变化（添加了访客表），需要使用新的初始化脚本：

```bash
# 备份旧数据库（如果有重要数据）
cp auth.db auth.db.backup

# 使用新的初始化脚本
python init_data_v2.py
```

### 启动系统

```bash
# 方法1：使用启动脚本
./start.sh  # Linux/Mac
start.bat   # Windows

# 方法2：手动启动
python api.py
```

### 访问系统

1. **后端API**：http://localhost:8000
2. **API文档**：http://localhost:8000/docs
3. **管理界面**：打开 `index.html`
4. **访客注册**：打开 `visitor_register.html`

### 登录黄爱莉CEO账号

1. 打开 `index.html`
2. 输入邮箱：`huangaili@meiyue.com`
3. 输入密码：`Huang@2026`
4. 点击"登录"按钮

### 注册访客

1. 以管理员身份登录
2. 点击"访客管理"标签
3. 点击"访客注册"按钮
4. 填写访客信息
5. 提交注册

### 审批团队长

1. 在访客管理列表中找到符合条件的访客
2. 确认访客有3个以上成员
3. 点击"批准团队长"按钮
4. 系统将访客设为团队长

---

## 🔄 数据库迁移

如果已有数据库需要迁移到新版本：

### 方法1：重新初始化（推荐）

```bash
# 1. 备份现有数据
python -c "
from models import SessionLocal, User, Role, Permission
db = SessionLocal()
users = db.query(User).all()
for user in users:
    print(f'{user.id},{user.name},{user.email},{user.position}')
db.close()
" > users_backup.txt

# 2. 删除旧数据库
rm auth.db

# 3. 使用新脚本初始化
python init_data_v2.py

# 4. 手动导入用户数据（根据备份文件）
```

### 方法2：手动迁移

```python
from sqlalchemy import create_engine, text
engine = create_engine("sqlite:///./auth.db")

# 添加新字段
with engine.connect() as conn:
    conn.execute(text("ALTER TABLE users ADD COLUMN wechat VARCHAR(50)"))
    conn.execute(text("ALTER TABLE users ADD COLUMN is_ceo BOOLEAN DEFAULT 0"))
    conn.commit()
```

---

## 🎉 更新成果

本次更新成功实现了以下功能：

- ✅ 创建CEO角色（级别0，高于超级管理员）
- ✅ 创建黄爱莉CEO账号
- ✅ 完整的访客登记系统
- ✅ 团队管理功能
- ✅ 团队长审批机制
- ✅ 访客注册页面
- ✅ 访客管理界面
- ✅ 36个权限（新增6个访客管理权限）
- ✅ 8个角色（新增CEO角色）

---

## ⚠️ 重要提醒

1. **密码安全**：
   - CEO初始密码：`Huang@2026`
   - 超级管理员初始密码：`Xu@2026`
   - 首次登录后请立即修改密码

2. **数据库迁移**：
   - 使用`init_data_v2.py`重新初始化数据库
   - 备份现有数据（如果有重要数据）

3. **团队长条件**：
   - 必须拥有3个以上成员
   - 必须愿意成为团队长
   - 需要管理员审批

4. **API导入**：
   - 确保`visitor_api.py`与`api.py`在同一目录
   - 启动时会自动导入访客API模块

---

## 📞 技术支持

- **技术支持**：tech@meiyue.com
- **权限咨询**：admin@meiyue.com
- **安全举报**：security@meiyue.com

---

**更新完成日期**：2026年1月23日
**更新执行人**：灵值生态团队
**文档版本**：v2.0

---

**媄月商业艺术 - 文化科技驱动的品牌未来资产**
**© 2026 媄月商业 版权所有 | 未经授权不得复制、下载、传播**
