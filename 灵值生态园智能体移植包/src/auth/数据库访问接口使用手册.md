# æ•°æ®åº“è®¿é—®æ¥å£ä½¿ç”¨æ‰‹å†Œ

**ç‰ˆæœ¬**ï¼šv1.0
**å‘å¸ƒæ—¥æœŸ**ï¼š2026å¹´1æœˆ23æ—¥
**ç›®æ ‡ç”¨æˆ·**ï¼šè¶…çº§ç®¡ç†å‘˜ã€CEOã€ç³»ç»Ÿç®¡ç†å‘˜

---

## ğŸ“‹ æ¦‚è¿°

æ•°æ®åº“è®¿é—®æ¥å£æä¾›äº†ä¾¿æ·çš„APIï¼Œå…è®¸ç»è¿‡æˆæƒçš„ç”¨æˆ·æŸ¥è¯¢ç³»ç»Ÿæ•°æ®åº“ä¸­çš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰ä¿¡æ¯ï¼Œæ— éœ€ç›´æ¥æ“ä½œæ•°æ®åº“æ–‡ä»¶ã€‚

### ğŸ¯ é€‚ç”¨åœºæ™¯

- æŸ¥çœ‹ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨å’Œè¯¦æƒ…
- æŸ¥çœ‹è§’è‰²é…ç½®å’Œæƒé™åˆ†é…
- æŸ¥çœ‹æƒé™ä½¿ç”¨æƒ…å†µ
- è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
- å®¡è®¡å’Œç›‘æ§

---

## ğŸ” æƒé™è¦æ±‚

| æ¥å£ | æ‰€éœ€æƒé™ | è¯´æ˜ |
|-----|---------|------|
| `/api/database/stats` | `database:view` | æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ |
| `/api/database/users` | `user:view` | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ |
| `/api/database/users/{user_id}` | `user:view` | æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ… |
| `/api/database/roles` | `role:view` | æŸ¥çœ‹è§’è‰²åˆ—è¡¨ |
| `/api/database/roles/{role_id}` | `role:view` | æŸ¥çœ‹è§’è‰²è¯¦æƒ… |
| `/api/database/permissions` | `permission:view` | æŸ¥çœ‹æƒé™åˆ—è¡¨ |
| `/api/database/permissions/{permission_id}` | `permission:view` | æŸ¥çœ‹æƒé™è¯¦æƒ… |
| `/api/database/current-user` | æ— éœ€æƒé™ | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1ï¼šä½¿ç”¨Pythonè„šæœ¬ï¼ˆæ¨èï¼‰

ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªPythonæµ‹è¯•è„šæœ¬ `test_db_connection.py`ï¼Œå¯ä»¥å¿«é€Ÿè¿æ¥æ•°æ®åº“å¹¶æŸ¥è¯¢ä¿¡æ¯ã€‚

#### 1. å¯åŠ¨APIæœåŠ¡

```bash
cd çµå€¼ç”Ÿæ€å›­æ™ºèƒ½ä½“ç§»æ¤åŒ…/src/auth
python api.py
```

#### 2. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
python test_db_connection.py
```

è„šæœ¬å°†ä»¥è®¸é”‹èº«ä»½ç™»å½•ï¼Œå¹¶æ˜¾ç¤ºï¼š
- å½“å‰ç”¨æˆ·ä¿¡æ¯
- æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
- ç”¨æˆ·åˆ—è¡¨
- è§’è‰²åˆ—è¡¨
- æƒé™åˆ—è¡¨

### æ–¹æ³•2ï¼šä½¿ç”¨APIæ¥å£

#### 1. ç™»å½•è·å–Token

```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=xufeng@meiyue.com&password=Xu@2026"
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 2,
    "name": "è®¸é”‹",
    "email": "xufeng@meiyue.com",
    "position": "è¶…çº§ç®¡ç†å‘˜"
  }
}
```

#### 2. ä½¿ç”¨Tokenè®¿é—®API

```bash
# è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
curl -X GET "http://localhost:8000/api/database/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"

# è·å–ç”¨æˆ·åˆ—è¡¨
curl -X GET "http://localhost:8000/api/database/users?limit=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
curl -X GET "http://localhost:8000/api/database/current-user" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸ“Š APIæ¥å£è¯¦è§£

### 1. è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯

**æ¥å£**ï¼š`GET /api/database/stats`

**æƒé™**ï¼š`database:view`

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "users_count": 6,
  "roles_count": 8,
  "permissions_count": 38,
  "user_roles_count": 10,
  "role_permissions_count": 150,
  "database_size": "2.45 MB"
}
```

---

### 2. è·å–ç”¨æˆ·åˆ—è¡¨

**æ¥å£**ï¼š`GET /api/database/users`

**æƒé™**ï¼š`user:view`

**æŸ¥è¯¢å‚æ•°**ï¼š
- `skip`ï¼šè·³è¿‡çš„è®°å½•æ•°ï¼ˆé»˜è®¤0ï¼‰
- `limit`ï¼šè¿”å›çš„è®°å½•æ•°ï¼ˆé»˜è®¤100ï¼Œæœ€å¤§100ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
[
  {
    "id": 1,
    "name": "é»„çˆ±è‰",
    "email": "huangaili@meiyue.com",
    "position": "CEO",
    "is_ceo": true,
    "wechat": null,
    "created_at": "2026-01-23T00:00:00",
    "updated_at": "2026-01-23T00:00:00",
    "roles": ["CEO"]
  },
  {
    "id": 2,
    "name": "è®¸é”‹",
    "email": "xufeng@meiyue.com",
    "position": "è¶…çº§ç®¡ç†å‘˜",
    "is_ceo": false,
    "wechat": null,
    "created_at": "2026-01-23T00:00:00",
    "updated_at": "2026-01-23T00:00:00",
    "roles": ["è¶…çº§ç®¡ç†å‘˜"]
  }
]
```

---

### 3. è·å–ç”¨æˆ·è¯¦æƒ…

**æ¥å£**ï¼š`GET /api/database/users/{user_id}`

**æƒé™**ï¼š`user:view`

**è·¯å¾„å‚æ•°**ï¼š
- `user_id`ï¼šç”¨æˆ·ID

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "id": 1,
  "name": "é»„çˆ±è‰",
  "email": "huangaili@meiyue.com",
  "position": "CEO",
  "is_ceo": true,
  "wechat": null,
  "created_at": "2026-01-23T00:00:00",
  "updated_at": "2026-01-23T00:00:00",
  "roles": ["CEO"]
}
```

---

### 4. è·å–è§’è‰²åˆ—è¡¨

**æ¥å£**ï¼š`GET /api/database/roles`

**æƒé™**ï¼š`role:view`

**æŸ¥è¯¢å‚æ•°**ï¼š
- `skip`ï¼šè·³è¿‡çš„è®°å½•æ•°ï¼ˆé»˜è®¤0ï¼‰
- `limit`ï¼šè¿”å›çš„è®°å½•æ•°ï¼ˆé»˜è®¤100ï¼Œæœ€å¤§100ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
[
  {
    "id": 1,
    "name": "CEO",
    "english_name": "ceo",
    "level": 0,
    "description": "å…¬å¸é¦–å¸­æ‰§è¡Œå®˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
    "permissions_count": 38,
    "users_count": 1,
    "created_at": "2026-01-23T00:00:00"
  },
  {
    "id": 2,
    "name": "è¶…çº§ç®¡ç†å‘˜",
    "english_name": "super_admin",
    "level": 1,
    "description": "æ‹¥æœ‰æ‰€æœ‰ç³»ç»Ÿæƒé™",
    "permissions_count": 38,
    "users_count": 1,
    "created_at": "2026-01-23T00:00:00"
  }
]
```

---

### 5. è·å–è§’è‰²è¯¦æƒ…

**æ¥å£**ï¼š`GET /api/database/roles/{role_id}`

**æƒé™**ï¼š`role:view`

**è·¯å¾„å‚æ•°**ï¼š
- `role_id`ï¼šè§’è‰²ID

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "id": 1,
  "name": "CEO",
  "english_name": "ceo",
  "level": 0,
  "description": "å…¬å¸é¦–å¸­æ‰§è¡Œå®˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
  "permissions_count": 38,
  "users_count": 1,
  "created_at": "2026-01-23T00:00:00"
}
```

---

### 6. è·å–æƒé™åˆ—è¡¨

**æ¥å£**ï¼š`GET /api/database/permissions`

**æƒé™**ï¼š`permission:view`

**æŸ¥è¯¢å‚æ•°**ï¼š
- `skip`ï¼šè·³è¿‡çš„è®°å½•æ•°ï¼ˆé»˜è®¤0ï¼‰
- `limit`ï¼šè¿”å›çš„è®°å½•æ•°ï¼ˆé»˜è®¤100ï¼Œæœ€å¤§100ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
[
  {
    "id": 1,
    "code": "user:create",
    "name": "åˆ›å»ºç”¨æˆ·",
    "description": "åˆ›å»ºæ–°ç”¨æˆ·",
    "roles": ["CEO", "è¶…çº§ç®¡ç†å‘˜", "éƒ¨é—¨ç»ç†"]
  },
  {
    "id": 2,
    "code": "user:delete",
    "name": "åˆ é™¤ç”¨æˆ·",
    "description": "åˆ é™¤ç”¨æˆ·",
    "roles": ["CEO", "è¶…çº§ç®¡ç†å‘˜"]
  }
]
```

---

### 7. è·å–æƒé™è¯¦æƒ…

**æ¥å£**ï¼š`GET /api/database/permissions/{permission_id}`

**æƒé™**ï¼š`permission:view`

**è·¯å¾„å‚æ•°**ï¼š
- `permission_id`ï¼šæƒé™ID

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "id": 1,
  "code": "user:create",
  "name": "åˆ›å»ºç”¨æˆ·",
  "description": "åˆ›å»ºæ–°ç”¨æˆ·",
  "roles": ["CEO", "è¶…çº§ç®¡ç†å‘˜", "éƒ¨é—¨ç»ç†"]
}
```

---

### 8. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**æ¥å£**ï¼š`GET /api/database/current-user`

**æƒé™**ï¼šæ— éœ€æƒé™ï¼ˆéœ€ç™»å½•ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "id": 2,
  "name": "è®¸é”‹",
  "email": "xufeng@meiyue.com",
  "position": "è¶…çº§ç®¡ç†å‘˜",
  "is_ceo": false,
  "wechat": null,
  "roles": [
    {
      "id": 2,
      "name": "è¶…çº§ç®¡ç†å‘˜",
      "english_name": "super_admin",
      "level": 1
    }
  ],
  "permissions": [
    "user:create",
    "user:delete",
    "user:modify",
    "user:view",
    ...
  ],
  "created_at": "2026-01-23T00:00:00"
}
```

---

## ğŸ“ è®¸é”‹é»˜è®¤è´¦å·ä¿¡æ¯

| å­—æ®µ | å€¼ |
|-----|---|
| é‚®ç®± | xufeng@meiyue.com |
| å¯†ç  | Xu@2026 |
| è§’è‰² | è¶…çº§ç®¡ç†å‘˜ |
| çº§åˆ« | 1 |
| æƒé™ | æ‰€æœ‰æƒé™ |

---

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### Pythonä»£ç ç¤ºä¾‹

```python
import requests

# 1. ç™»å½•
login_response = requests.post(
    "http://localhost:8000/api/auth/login",
    data={"username": "xufeng@meiyue.com", "password": "Xu@2026"}
)
token = login_response.json()["access_token"]

# 2. è®¾ç½®è¯·æ±‚å¤´
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# 3. è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
stats = requests.get(
    "http://localhost:8000/api/database/stats",
    headers=headers
).json()
print(f"ç”¨æˆ·æ•°é‡: {stats['users_count']}")

# 4. è·å–ç”¨æˆ·åˆ—è¡¨
users = requests.get(
    "http://localhost:8000/api/database/users",
    headers=headers
).json()
for user in users:
    print(f"{user['name']} - {user['email']}")
```

### curlå‘½ä»¤ç¤ºä¾‹

```bash
# ç™»å½•å¹¶ä¿å­˜Token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=xufeng@meiyue.com&password=Xu@2026" \
  | jq -r '.access_token')

# è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
curl -X GET "http://localhost:8000/api/database/stats" \
  -H "Authorization: Bearer $TOKEN"

# è·å–ç”¨æˆ·åˆ—è¡¨
curl -X GET "http://localhost:8000/api/database/users" \
  -H "Authorization: Bearer $TOKEN"
```

---

## âš ï¸ é‡è¦æé†’

1. **æƒé™æ§åˆ¶**ï¼šæ‰€æœ‰æ¥å£éƒ½éœ€è¦ç›¸åº”æƒé™ï¼Œç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™åå†è°ƒç”¨
2. **Tokenæœ‰æ•ˆæœŸ**ï¼šAccess Tokenæœ‰æ•ˆæœŸä¸º8å°æ—¶ï¼Œè¿‡æœŸåéœ€é‡æ–°ç™»å½•
3. **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢æ“ä½œéƒ½ä¼šè¢«è®°å½•åœ¨å®¡è®¡æ—¥å¿—ä¸­
4. **æ•°æ®å®‰å…¨**ï¼šä¸è¦åœ¨å‰ç«¯ä»£ç ä¸­ç¡¬ç¼–ç API Token
5. **å¯†ç å®‰å…¨**ï¼šé¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç 

---

## ğŸ”„ æ•°æ®åº“åˆå§‹åŒ–

å¦‚æœéœ€è¦é‡æ–°åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ·»åŠ æ–°çš„æƒé™ï¼‰ï¼š

```bash
# å¤‡ä»½ç°æœ‰æ•°æ®åº“
cp auth.db auth.db.backup

# åˆ é™¤æ—§æ•°æ®åº“
rm -f auth.db

# ä½¿ç”¨æ–°è„šæœ¬åˆå§‹åŒ–
python init_data_v2.py
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **æŠ€æœ¯æ”¯æŒ**ï¼štech@meiyue.com
- **æƒé™å’¨è¯¢**ï¼šadmin@meiyue.com

---

**åª„æœˆå•†ä¸šè‰ºæœ¯ - æ–‡åŒ–ç§‘æŠ€é©±åŠ¨çš„å“ç‰Œæœªæ¥èµ„äº§**
**Â© 2026 åª„æœˆå•†ä¸š ç‰ˆæƒæ‰€æœ‰ | æœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¸‹è½½ã€ä¼ æ’­**
