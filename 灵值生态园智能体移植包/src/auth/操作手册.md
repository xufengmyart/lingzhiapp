# 媄月商业艺术 - 权限管理系统操作手册

**版本**：v1.0
**发布日期**：2026年1月23日
**适用人员**：系统管理员、部门经理、普通用户

---

## 目录

1. [系统概述](#系统概述)
2. [安装与启动](#安装与启动)
3. [首次登录](#首次登录)
4. [用户管理](#用户管理)
5. [角色管理](#角色管理)
6. [权限管理](#权限管理)
7. [审计日志](#审计日志)
8. [常见问题](#常见问题)
9. [安全建议](#安全建议)

---

## 系统概述

### 功能特性

本权限管理系统提供以下核心功能：

- ✅ **用户管理**：创建、修改、删除用户
- ✅ **角色管理**：管理角色和角色权限
- ✅ **权限管理**：细粒度的权限控制
- ✅ **审计日志**：完整的操作审计记录
- ✅ **登录认证**：JWT令牌认证
- ✅ **双因素认证**：支持2FA（可选）

### 系统架构

```
权限管理系统
├── 后端API（FastAPI）
├── 前端界面（HTML/JavaScript）
├── 数据库（SQLite）
└── 认证系统（JWT）
```

---

## 安装与启动

### 环境要求

- Python 3.8+
- pip（Python包管理器）
- 现代浏览器（Chrome、Firefox、Edge等）

### 安装步骤

#### 1. 安装依赖

```bash
cd 灵值生态园智能体移植包/src/auth

pip install fastapi uvicorn sqlalchemy pydantic pyotp bcrypt python-jose python-multipart
```

#### 2. 初始化数据库

```bash
python init_data.py
```

这将创建数据库并填充默认数据，包括：
- 30+个权限
- 7个角色
- 5个初始用户（许锋 + 4个管理员）

#### 3. 启动后端服务

```bash
# 方式1：直接运行
python api.py

# 方式2：使用uvicorn
uvicorn api:app --reload --host 0.0.0.0 --port 8000
```

后端服务将在 http://localhost:8000 启动

#### 4. 启动前端界面

直接在浏览器中打开 `index.html` 文件：
```
file:///path/to/灵值生态园智能体移植包/src/auth/index.html
```

或者使用本地服务器（推荐）：
```bash
# 使用Python的http.server
cd 灵值生态园智能体移植包/src/auth
python -m http.server 8080
```

然后访问：http://localhost:8080

---

## 首次登录

### 默认账号信息

系统初始化后会创建以下账号：

| 账号 | 邮箱 | 密码 | 角色 | 状态 |
|-----|------|------|------|------|
| 许锋 | xufeng@meiyue.com | Meiyue@2026 | 超级管理员 | 激活 |
| CTO | cto@meiyue.com | Temp@2026 | CTO管理员 | 待定 |
| CMO | cmo@meiyue.com | Temp@2026 | CMO管理员 | 待定 |
| COO | coo@meiyue.com | Temp@2026 | COO管理员 | 待定 |
| CFO | cfo@meiyue.com | Temp@2026 | CFO管理员 | 待定 |

### 登录步骤

1. 打开前端界面
2. 输入邮箱：`xufeng@meiyue.com`
3. 输入密码：`Meiyue@2026`
4. 点击"登录"按钮

### 重要提醒

⚠️ **首次登录后请立即修改密码！**

---

## 用户管理

### 创建用户

#### 通过Web界面

1. 以管理员身份登录系统
2. 点击"用户管理"标签
3. 点击"创建用户"按钮
4. 填写用户信息：
   - 姓名：必填
   - 邮箱：必填，唯一
   - 密码：必填，至少8位
   - 部门：必填
   - 职位：必填
   - 角色：可选择多个
5. 点击"创建"按钮

#### 通过API

```bash
curl -X POST "http://localhost:8000/api/users" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三",
    "email": "zhangsan@meiyue.com",
    "password": "Password@123",
    "department": "产品技术部",
    "position": "开发工程师",
    "role_ids": [7]
  }'
```

### 修改用户

#### 通过Web界面

当前版本暂不支持通过Web界面修改用户信息，请使用API。

#### 通过API

```bash
curl -X PUT "http://localhost:8000/api/users/2" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三（修改）",
    "position": "高级开发工程师"
  }'
```

### 删除用户

#### 通过Web界面

1. 在用户列表中找到目标用户
2. 点击该用户行的"删除"按钮
3. 确认删除操作

#### 通过API

```bash
curl -X DELETE "http://localhost:8000/api/users/2" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 查看用户列表

#### 通过Web界面

1. 以管理员身份登录系统
2. 点击"用户管理"标签
3. 查看用户列表

#### 通过API

```bash
curl -X GET "http://localhost:8000/api/users" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 角色管理

### 查看角色列表

#### 通过Web界面

1. 以管理员身份登录系统
2. 点击"角色管理"标签
3. 查看角色列表

#### 通过API

```bash
curl -X GET "http://localhost:8000/api/roles" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 系统角色说明

| 角色名称 | 英文名称 | 级别 | 权限范围 |
|---------|---------|------|---------|
| 超级管理员 | super_admin | 1 | 所有权限 |
| CTO管理员 | cto_admin | 2 | 技术相关权限 |
| CMO管理员 | cmo_admin | 2 | 市场相关权限 |
| COO管理员 | coo_admin | 2 | 运营相关权限 |
| CFO管理员 | cfo_admin | 2 | 财务相关权限 |
| 部门经理 | manager | 3 | 部门内部权限 |
| 普通员工 | staff | 4 | 岗位相关权限 |

---

## 权限管理

### 查看权限列表

#### 通过Web界面

1. 以管理员身份登录系统
2. 点击"权限查看"标签
3. 查看权限列表

#### 通过API

```bash
curl -X GET "http://localhost:8000/api/permissions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 权限模块说明

系统包含以下13个权限模块：

1. **用户管理**（user_management）
   - 创建用户、删除用户、修改用户、查看用户
   - 分配角色、重置密码

2. **角色管理**（role_management）
   - 创建角色、删除角色、修改角色、查看角色
   - 分配权限

3. **权限管理**（permission_management）
   - 授予权限、撤销权限、查看权限

4. **系统配置**（system_config）
   - 修改系统配置、查看系统配置

5. **数据管理**（data_management）
   - 查看数据、修改数据、删除数据、导出数据

6. **审批管理**（approval_management）
   - 提交审批、审批通过、查看审批

7. **财务管理**（financial_management）
   - 查看财务、修改财务、审批预算

8. **合同管理**（contract_management）
   - 创建合同、查看合同、签署合同

9. **产品管理**（product_management）
   - 创建产品、修改产品、查看产品

10. **营销管理**（marketing_management）
    - 创建营销、修改营销、查看营销

11. **运营管理**（operation_management）
    - 运营管理、查看运营

12. **文档管理**（document_management）
    - 创建文档、修改文档、查看文档

13. **日志管理**（log_management）
    - 查看日志、导出日志

---

## 审计日志

### 查看审计日志

#### 通过Web界面

1. 以管理员身份登录系统
2. 点击"审计日志"标签
3. 查看日志列表

#### 通过API

```bash
curl -X GET "http://localhost:8000/api/audit-logs" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 日志记录的操作

系统会记录以下操作：
- 用户登录（成功/失败）
- 用户创建
- 用户修改
- 用户删除
- 角色创建
- 角色修改
- 角色删除
- 权限授予
- 权限撤销
- 其他关键操作

### 日志字段说明

| 字段 | 说明 |
|-----|------|
| ID | 日志ID |
| 用户 | 操作用户的ID |
| 操作 | 操作类型（如user:create、login_success等） |
| 描述 | 操作的详细描述 |
| 状态 | 操作状态（success/failed） |
| 时间 | 操作时间 |

---

## 常见问题

### Q1: 忘记密码怎么办？

**A:** 当前版本不支持通过界面重置密码。请联系超级管理员通过数据库直接修改密码：

```python
from auth.models import SessionLocal, User
import bcrypt

db = SessionLocal()
user = db.query(User).filter(User.email == "your@email.com").first()
user.password_hash = bcrypt.hashpw("NewPassword@123".encode(), bcrypt.gensalt()).decode()
db.commit()
db.close()
```

### Q2: 如何修改自己的密码？

**A:** 当前版本不支持通过界面修改密码。请使用类似Q1的方法修改密码。

### Q3: 为什么无法登录？

**A:** 请检查以下几点：
1. 邮箱和密码是否正确
2. 账号状态是否为"active"
3. 后端服务是否正常启动
4. 浏览器控制台是否有错误信息

### Q4: 如何添加新的权限？

**A:** 需要在数据库中直接添加权限记录：

```python
from auth.models import SessionLocal, Permission

db = SessionLocal()
new_permission = Permission(
    code="new:permission",
    name="新权限",
    module="new_module",
    description="新权限的描述"
)
db.add(new_permission)
db.commit()
db.close()
```

### Q5: 如何修改角色的权限？

**A:** 当前版本需要通过数据库直接修改角色-权限关联：

```python
from auth.models import SessionLocal, Role, Permission

db = SessionLocal()
role = db.query(Role).filter_by(name_en="super_admin").first()
permissions = db.query(Permission).filter(Permission.module == "user_management").all()
role.permissions = permissions
db.commit()
db.close()
```

### Q6: 为什么创建用户时提示权限不足？

**A:** 确保当前用户具有`user:create`权限。只有超级管理员和高级管理员才具有此权限。

### Q7: 如何查看API文档？

**A:** 启动后端服务后，访问 http://localhost:8000/docs 查看Swagger API文档。

---

## 安全建议

### 密码安全

1. **定期更换密码**：建议每90天更换一次密码
2. **使用强密码**：密码应包含大小写字母、数字和特殊字符
3. **不要共享密码**：不要将密码告诉他人
4. **不要重复使用密码**：不要在其他网站使用相同密码

### 账号安全

1. **及时锁定账号**：离职员工账号应立即停用
2. **定期清理无用账号**：删除长期未使用的账号
3. **最小权限原则**：只授予用户完成工作所需的最小权限
4. **职责分离**：关键操作需要多人审批

### 系统安全

1. **定期备份数据库**：每天备份数据库
2. **监控审计日志**：定期检查异常操作
3. **更新依赖包**：及时更新Python依赖包
4. **使用HTTPS**：生产环境必须使用HTTPS

### 网络安全

1. **限制访问IP**：只允许特定IP访问管理界面
2. **使用VPN**：远程访问时使用VPN
3. **防火墙设置**：配置防火墙规则
4. **定期扫描漏洞**：定期进行安全扫描

---

## API接口文档

### 认证接口

#### 登录

```http
POST /api/auth/login
Content-Type: application/x-www-form-urlencoded

username=xufeng@meiyue.com&password=Meiyue@2026
```

响应：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "name": "许锋",
    "email": "xufeng@meiyue.com",
    ...
  }
}
```

### 用户接口

#### 获取用户列表

```http
GET /api/users
Authorization: Bearer YOUR_TOKEN
```

#### 创建用户

```http
POST /api/users
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "name": "张三",
  "email": "zhangsan@meiyue.com",
  "password": "Password@123",
  "department": "产品技术部",
  "position": "开发工程师",
  "role_ids": [7]
}
```

#### 删除用户

```http
DELETE /api/users/2
Authorization: Bearer YOUR_TOKEN
```

### 其他接口

完整的API文档请访问：http://localhost:8000/docs

---

## 技术支持

### 联系方式

- **技术支持**：tech@meiyue.com
- **权限咨询**：admin@meiyue.com
- **安全举报**：security@meiyue.com

### 问题反馈

如遇到问题，请提供以下信息：
1. 问题描述
2. 错误信息（如有）
3. 操作步骤
4. 浏览器控制台日志（如有）

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|-----|------|---------|
| v1.0 | 2026-01-23 | 初始版本，建立基础权限管理系统 |

---

**媄月商业艺术 - 文化科技驱动的品牌未来资产**
**© 2026 媄月商业 版权所有 | 未经授权不得复制、下载、传播**
