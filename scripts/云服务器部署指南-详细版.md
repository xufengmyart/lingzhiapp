# äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å— - æƒ…ç»ªç³»ç»Ÿ v8.1

**æœåŠ¡å™¨**: 123.56.142.143
**SSH ç”¨æˆ·**: root
**éƒ¨ç½²æ—¥æœŸ**: 2025å¹´1æœˆ15æ—¥

---

## ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

### 1.1 åœ¨æœ¬åœ°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```bash
# åˆ›å»ºä¸´æ—¶ç›®å½•ï¼ˆç”¨äºå­˜æ”¾éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼‰
mkdir -p /tmp/deploy_files

# å¤åˆ¶éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
cp src/storage/database/shared/model.py /tmp/deploy_files/
cp src/storage/database/emotion_manager.py /tmp/deploy_files/
cp src/tools/emotion_tools.py /tmp/deploy_files/
cp src/tools/user_registration_tool.py /tmp/deploy_files/
cp config/agent_llm_config.json /tmp/deploy_files/
cp src/agents/agent.py /tmp/deploy_files/
cp scripts/create_emotion_tables.sql /tmp/deploy_files/
cp scripts/verify_emotion_tools.py /tmp/deploy_files/

# æ‰“åŒ…æ–‡ä»¶
cd /tmp
tar -czf deploy_v8.1.tar.gz deploy_files/

echo "âœ… æ–‡ä»¶æ‰“åŒ…å®Œæˆ: /tmp/deploy_v8.1.tar.gz"
```

### 1.2 ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# ä¸Šä¼ å‹ç¼©åŒ…åˆ°æœåŠ¡å™¨
scp /tmp/deploy_v8.1.tar.gz root@123.56.142.143:/tmp/

echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
```

---

## ç¬¬äºŒæ­¥ï¼šç™»å½•æœåŠ¡å™¨å¹¶éƒ¨ç½²

### 2.1 SSH ç™»å½•æœåŠ¡å™¨

```bash
ssh root@123.56.142.143
```

### 2.2 ç¡®è®¤é¡¹ç›®è·¯å¾„

```bash
# æŸ¥æ‰¾é¡¹ç›®ç›®å½•
find / -name "agent.py" -type f 2>/dev/null | grep -E "lingzhi|backend"

# å‡è®¾é¡¹ç›®è·¯å¾„ä¸º /var/www/backendï¼Œå¦‚æœä¸æ˜¯ï¼Œè¯·æ›¿æ¢ä¸ºå®é™…è·¯å¾„
cd /var/www/backend
```

### 2.3 å¤‡ä»½ç°æœ‰æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backup_$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½è¦ä¿®æ”¹çš„æ–‡ä»¶
cp src/storage/database/shared/model.py backup_$(date +%Y%m%d_%H%M%S)/
cp src/tools/emotion_tools.py backup_$(date +%Y%m%d_%H%M%S)/
cp config/agent_llm_config.json backup_$(date +%Y%m%d_%H%M%S)/
cp src/agents/agent.py backup_$(date +%Y%m%d_%H%M%S)/
cp src/tools/user_registration_tool.py backup_$(date +%Y%m%d_%H%M%S)/

echo "âœ… å¤‡ä»½å®Œæˆ"
```

### 2.4 è§£å‹å¹¶å¤åˆ¶æ–‡ä»¶

```bash
# è§£å‹ä¸Šä¼ çš„æ–‡ä»¶
cd /tmp
tar -xzf deploy_v8.1.tar.gz
cd deploy_files

# å¤åˆ¶æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
cp model.py /var/www/backend/src/storage/database/shared/
cp emotion_manager.py /var/www/backend/src/storage/database/
cp emotion_tools.py /var/www/backend/src/tools/
cp user_registration_tool.py /var/www/backend/src/tools/
cp agent_llm_config.json /var/www/backend/config/
cp agent.py /var/www/backend/src/agents/
cp create_emotion_tables.sql /var/www/backend/scripts/
cp verify_emotion_tools.py /var/www/backend/scripts/

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 644 /var/www/backend/src/storage/database/shared/model.py
chmod 644 /var/www/backend/src/storage/database/emotion_manager.py
chmod 644 /var/www/backend/src/tools/emotion_tools.py
chmod 644 /var/www/backend/src/tools/user_registration_tool.py
chmod 644 /var/www/backend/config/agent_llm_config.json
chmod 644 /var/www/backend/src/agents/agent.py
chmod 644 /var/www/backend/scripts/create_emotion_tables.sql
chmod 644 /var/www/backend/scripts/verify_emotion_tools.py

echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
```

---

## ç¬¬ä¸‰æ­¥ï¼šæ•°æ®åº“è¿ç§»

### 3.1 æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -U postgres -d lingzhi_db -c "SELECT version();"

# å¦‚æœæç¤ºè¾“å…¥å¯†ç ï¼Œè¯·è¾“å…¥ postgres ç”¨æˆ·å¯†ç 
```

### 3.2 æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/backend

# æ‰§è¡Œæ•°æ®åº“è¿ç§» SQL
psql -h localhost -U postgres -d lingzhi_db -f scripts/create_emotion_tables.sql

echo "âœ… æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ"
```

### 3.3 éªŒè¯è¡¨åˆ›å»º

```bash
# æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
psql -h localhost -U postgres -d lingzhi_db << EOF
SELECT table_name
FROM information_schema.tables
WHERE table_name IN ('emotion_records', 'emotion_diaries')
ORDER BY table_name;
EOF

# æŸ¥çœ‹è¡¨ç»“æ„
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_records"
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_diaries"

echo "âœ… è¡¨éªŒè¯å®Œæˆ"
```

---

## ç¬¬å››æ­¥ï¼šé‡å¯æœåŠ¡

### 4.1 æŸ¥æ‰¾æœåŠ¡åç§°

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„ Python æœåŠ¡
ps aux | grep python | grep -v grep

# æˆ–è€…æŸ¥çœ‹ systemd æœåŠ¡
systemctl list-units --type=service | grep -E "lingzhi|backend|app"
```

### 4.2 é‡å¯æœåŠ¡

```bash
# æ–¹å¼1ï¼šä½¿ç”¨ systemctlï¼ˆæ¨èï¼‰
# å‡è®¾æœåŠ¡åç§°ä¸º lingzhi-backend
systemctl restart lingzhi-backend

# æ–¹å¼2ï¼šä½¿ç”¨ supervisor
supervisorctl restart lingzhi-backend

# æ–¹å¼3ï¼šæ‰‹åŠ¨é‡å¯ï¼ˆå¦‚æœæ²¡æœ‰æœåŠ¡ç®¡ç†ï¼‰
# 1. åœæ­¢æ—§è¿›ç¨‹
pkill -f "python.*main.py"

# 2. å¯åŠ¨æ–°è¿›ç¨‹
cd /var/www/backend
nohup python -u src/main.py > logs/app.log 2>&1 &

echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
```

### 4.3 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ–¹å¼1ï¼šä½¿ç”¨ systemctl
systemctl status lingzhi-backend

# æ–¹å¼2ï¼šæŸ¥çœ‹è¿›ç¨‹
ps aux | grep python | grep -v grep

# æ–¹å¼3ï¼šæŸ¥çœ‹æ—¥å¿—
tail -f /var/www/backend/logs/app.log
```

---

## ç¬¬äº”æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 5.1 è¿è¡ŒéªŒè¯è„šæœ¬

```bash
cd /var/www/backend

# è¿è¡ŒéªŒè¯è„šæœ¬
python scripts/verify_emotion_tools.py

# é¢„æœŸè¾“å‡ºï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ5/5ï¼‰
```

### 5.2 æµ‹è¯•æƒ…ç»ªç³»ç»ŸåŠŸèƒ½

```bash
# æµ‹è¯•æƒ…ç»ªè®°å½•åŠŸèƒ½
python -c "
from src.storage.database.emotion_manager import EmotionManager
manager = EmotionManager()
result = manager.record_emotion(
    user_id=1,
    emotion='joy',
    emotion_name='å¼€å¿ƒ',
    intensity=0.9,
    context='æµ‹è¯•éƒ¨ç½²'
)
print('âœ… æƒ…ç»ªè®°å½•æµ‹è¯•é€šè¿‡:', result)
"

# æµ‹è¯•æƒ…ç»ªç»Ÿè®¡åŠŸèƒ½
python -c "
from src.storage.database.emotion_manager import EmotionManager
manager = EmotionManager()
result = manager.get_emotion_statistics(user_id=1, period='week')
print('âœ… æƒ…ç»ªç»Ÿè®¡æµ‹è¯•é€šè¿‡:', result)
"
```

### 5.3 æµ‹è¯•æ™ºèƒ½ä½“

```bash
# æµ‹è¯•æ™ºèƒ½ä½“æ„å»º
python -c "
from src.agents.agent import build_agent
agent = build_agent()
print('âœ… æ™ºèƒ½ä½“æ„å»ºæˆåŠŸ')
"
```

---

## ç¬¬å…­æ­¥ï¼šWeb ç«¯éªŒè¯

### 6.1 è®¿é—®ç™»å½•é¡µé¢

```
æµè§ˆå™¨è®¿é—®: http://123.56.142.143/login
```

### 6.2 ç™»å½•ç³»ç»Ÿ

```
1. è¾“å…¥é‚®ç®±å’Œå¯†ç 
2. ç‚¹å‡»ç™»å½•
3. ç™»å½•æˆåŠŸåï¼Œæ£€æŸ¥é¦–é¡µæ˜¯å¦æ˜¾ç¤ºæƒ…ç»ªç›¸å…³åŠŸèƒ½
```

### 6.3 æµ‹è¯•æƒ…ç»ªåŠŸèƒ½

```
1. æ‰¾åˆ°"æƒ…ç»ªè®°å½•"åŠŸèƒ½
2. ç‚¹å‡»è®°å½•æƒ…ç»ª
3. é€‰æ‹©æƒ…ç»ªç±»å‹ï¼ˆå¼€å¿ƒ/æ‚²ä¼¤/æ„¤æ€’ç­‰ï¼‰
4. è°ƒèŠ‚æƒ…ç»ªå¼ºåº¦
5. è¾“å…¥æƒ…ç»ªä¸Šä¸‹æ–‡
6. æäº¤è®°å½•
7. æŸ¥çœ‹æƒ…ç»ªç»Ÿè®¡å’Œæ—¥è®°
```

---

## ç¬¬ä¸ƒæ­¥ï¼šå¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# é”™è¯¯ï¼šFATAL: password authentication failed for user "postgres"
# è§£å†³ï¼šæ£€æŸ¥æ•°æ®åº“å¯†ç 

psql -h localhost -U postgres -d lingzhi_db
# è¾“å…¥æ­£ç¡®çš„å¯†ç 
```

### é—®é¢˜2ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -n 100 /var/www/backend/logs/app.log | grep -i error

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -xe -u lingzhi-backend
```

### é—®é¢˜3ï¼šæ¨¡å—å¯¼å…¥å¤±è´¥

```bash
# æ£€æŸ¥ Python è·¯å¾„
echo $PYTHONPATH

# è®¾ç½® Python è·¯å¾„
export PYTHONPATH=/var/www/backend/src:$PYTHONPATH

# é‡æ–°è¿è¡ŒéªŒè¯
python scripts/verify_emotion_tools.py
```

### é—®é¢˜4ï¼šè¡¨å·²å­˜åœ¨

```bash
# é”™è¯¯ï¼šrelation "emotion_records" already exists
# è§£å†³ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼ŒSQL å·²ä½¿ç”¨ IF NOT EXISTS

# å¯ä»¥å¿½ç•¥ï¼Œæˆ–æŸ¥çœ‹è¡¨ç»“æ„ç¡®è®¤
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_records"
```

---

## ç¬¬å…«æ­¥ï¼šå›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéƒ¨ç½²å¤±è´¥ï¼‰

### 8.1 åœæ­¢æœåŠ¡

```bash
systemctl stop lingzhi-backend
# æˆ–
pkill -f "python.*main.py"
```

### 8.2 æ¢å¤æ–‡ä»¶

```bash
# æŸ¥æ‰¾å¤‡ä»½ç›®å½•
ls -la /var/www/backend/ | grep backup_

# æ¢å¤æ–‡ä»¶ï¼ˆæ›¿æ¢ä¸ºå®é™…çš„å¤‡ä»½ç›®å½•ï¼‰
cp backup_20250115_120000/model.py /var/www/backend/src/storage/database/shared/
cp backup_20250115_120000/emotion_tools.py /var/www/backend/src/tools/
cp backup_20250115_120000/agent_llm_config.json /var/www/backend/config/
cp backup_20250115_120000/agent.py /var/www/backend/src/agents/
cp backup_20250115_120000/user_registration_tool.py /var/www/backend/src/tools/

# åˆ é™¤æ–°å¢çš„æ–‡ä»¶
rm /var/www/backend/src/storage/database/emotion_manager.py
rm /var/www/backend/scripts/create_emotion_tables.sql
rm /var/www/backend/scripts/verify_emotion_tools.py
```

### 8.3 åˆ é™¤æ–°å¢çš„è¡¨ï¼ˆå¯é€‰ï¼‰

```bash
psql -h localhost -U postgres -d lingzhi_db << EOF
DROP TABLE IF EXISTS emotion_diaries;
DROP TABLE IF EXISTS emotion_records;
EOF
```

### 8.4 é‡å¯æœåŠ¡

```bash
systemctl start lingzhi-backend
# æˆ–
cd /var/www/backend
nohup python -u src/main.py > logs/app.log 2>&1 &
```

---

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ï¼š
- [ ] å¤‡ä»½ç°æœ‰ä»£ç 
- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] ç¡®è®¤é¡¹ç›®è·¯å¾„
- [ ] ç¡®è®¤æ•°æ®åº“ä¿¡æ¯

éƒ¨ç½²ä¸­ï¼š
- [ ] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- [ ] æ–‡ä»¶å¤åˆ¶æˆåŠŸ
- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] æœåŠ¡é‡å¯æˆåŠŸ

éƒ¨ç½²åï¼š
- [ ] éªŒè¯è„šæœ¬é€šè¿‡ï¼ˆ5/5ï¼‰
- [ ] æ™ºèƒ½ä½“æ„å»ºæˆåŠŸ
- [ ] Web ç«¯å¯ä»¥ç™»å½•
- [ ] æƒ…ç»ªåŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## è”ç³»æ–¹å¼

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒï¼š
- æŠ€æœ¯æ”¯æŒï¼šå¾…å®š
- ç´§æ€¥è”ç³»ï¼šå¾…å®š

---

**ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€
