"""
çµå€¼ç”Ÿæ€å›­æ™ºèƒ½ä½“ç³»ç»Ÿ - ä¸»åº”ç”¨å…¥å£
ç®€åŒ–ç‰ˆæœ¬ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘å·²è¿ç§»åˆ° routes/ æ¨¡å—
"""

from flask import Flask, jsonify
from flask_cors import CORS
import os
import sqlite3

# å¯¼å…¥é…ç½®ç®¡ç†æ¨¡å—
from config import config

# åŠ è½½ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
try:
    from dotenv import load_dotenv
    env_path = os.path.join(os.path.dirname(__file__), '.env')
    if os.path.exists(env_path):
        load_dotenv(env_path)
        print(f"âœ… ç¯å¢ƒå˜é‡å·²åŠ è½½: {env_path}")
    else:
        print(f"âš ï¸  .envæ–‡ä»¶ä¸å­˜åœ¨: {env_path}")
except ImportError:
    print("âš ï¸  python-dotenvæœªå®‰è£…ï¼Œä½¿ç”¨é»˜è®¤ç¯å¢ƒå˜é‡")

# ä½¿ç”¨é…ç½®ç®¡ç†æ¨¡å—è·å–æ‰€æœ‰é…ç½®
SECRET_KEY = config.JWT_SECRET_KEY
# å¦‚æœæ˜¯æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨æµ‹è¯•æ•°æ®åº“
DATABASE = os.getenv('TEST_DATABASE_PATH', config.DATABASE_PATH)
OLD_DATABASE = config.OLD_DATABASE
JWT_SECRET = config.JWT_SECRET_KEY
JWT_EXPIRATION = config.JWT_EXPIRATION

print(f"[é…ç½®] æ•°æ®åº“è·¯å¾„: {DATABASE}")
print(f"[é…ç½®] JWTè¿‡æœŸæ—¶é—´: {JWT_EXPIRATION}ç§’")

# å¯¼å…¥æ—¥å¿—æ¨¡å—
from logger import setup_logger
logger = setup_logger('app', log_dir='logs')

# è®¾ç½® Coze ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
os.environ.setdefault('COZE_WORKLOAD_IDENTITY_API_KEY', 'WU9RNGFQTmZTc3VnbnRCMmsyWUtDcDZHOWJMa0g5ZVk6NVN5cHNRbkNidjFzWHNEVnJ4UTZKQlN1SUxYMlU3ZEtidVRXbDYwWDFyZW9sdmhQbTU1QVdQaVJHcVo4b1BoWA==')
os.environ.setdefault('COZE_INTEGRATION_MODEL_BASE_URL', 'https://integration.coze.cn/api/v3')
os.environ.setdefault('COZE_INTEGRATION_BASE_URL', 'https://integration.coze.cn')
os.environ.setdefault('COZE_PROJECT_ID', '7597768668038643746')

# åˆ›å»º Flask åº”ç”¨
app = Flask(__name__)

# ============ æ³¨å†Œä¸­é—´ä»¶ ============

print("\nğŸ”§ åˆå§‹åŒ–ä¸­é—´ä»¶...")

# 1. åˆå§‹åŒ– JWT è®¤è¯
try:
    from middleware.jwt_auth import init_jwt_auth
    init_jwt_auth(JWT_SECRET, JWT_EXPIRATION)
    print("âœ… JWT è®¤è¯ä¸­é—´ä»¶å·²åˆå§‹åŒ–")
except ImportError as e:
    print(f"âš ï¸  JWT è®¤è¯ä¸­é—´ä»¶åˆå§‹åŒ–å¤±è´¥: {e}")

# 2. æ³¨å†Œé”™è¯¯å¤„ç†å™¨
try:
    from middleware.error_handler import register_error_handlers
    register_error_handlers(app)
    print("âœ… é”™è¯¯å¤„ç†å™¨å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  é”™è¯¯å¤„ç†å™¨æ³¨å†Œå¤±è´¥: {e}")

# 3. æ³¨å†Œè¯·æ±‚æ—¥å¿—
try:
    from middleware.request_logger import setup_request_logging
    setup_request_logging(app)
    print("âœ… è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶æ³¨å†Œå¤±è´¥: {e}")

# é…ç½® CORS å…è®¸è·¨åŸŸè¯·æ±‚
CORS(app, resources={
    r"/api/*": {
        "origins": ["https://meiyueart.com", "http://meiyueart.com", "*"],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    },
    r"/*": {
        "origins": "*",
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    }
})

# é…ç½®é™æ€æ–‡ä»¶è·¯å¾„
ENV = os.getenv('ENV', 'development')
if ENV == 'production':
    public_dir = os.getenv('STATIC_DIR', '/var/www/meiyueart.com')
else:
    public_dir = os.path.join(os.path.dirname(__file__), '../public')

if os.path.exists(public_dir):
    app.static_folder = public_dir
    app.static_url_path = '/'
    print(f"é™æ€æ–‡ä»¶ç›®å½•: {public_dir}")

# ============ æ³¨å†Œè“å›¾ï¼ˆæŒ‰åŠŸèƒ½æ¨¡å—ï¼‰ ============

print("\nğŸ“¦ å¼€å§‹æ³¨å†Œè·¯ç”±æ¨¡å—...")

# 1. è®¤è¯ç³»ç»Ÿ
try:
    from routes.auth import auth_bp
    app.register_blueprint(auth_bp)
    print("âœ… è®¤è¯ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  è®¤è¯ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 2. ç®¡ç†å‘˜åŠŸèƒ½
try:
    from routes.admin import admin_bp
    app.register_blueprint(admin_bp)
    print("âœ… ç®¡ç†å‘˜åŠŸèƒ½ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç®¡ç†å‘˜åŠŸèƒ½æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 3. æ¨èç³»ç»Ÿ
try:
    from routes.referral import referral_bp
    app.register_blueprint(referral_bp)
    print("âœ… æ¨èç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  æ¨èç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 4. ç­¾åˆ°ç³»ç»Ÿ
try:
    from routes.checkin import checkin_bp
    app.register_blueprint(checkin_bp)
    print("âœ… ç­¾åˆ°ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç­¾åˆ°ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 5. å……å€¼ç³»ç»Ÿ
try:
    from routes.recharge import recharge_bp
    app.register_blueprint(recharge_bp)
    print("âœ… å……å€¼ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  å……å€¼ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 6. å¯¹è¯è®°å¿†ç³»ç»Ÿ
try:
    from conversation_memory import memory_bp, ensure_memory_tables
    app.register_blueprint(memory_bp, url_prefix='/api/memory')
    ensure_memory_tables()
    print("âœ… å¯¹è¯è®°å¿†ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  å¯¹è¯è®°å¿†ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 7. ç”¨æˆ·æ—…ç¨‹ç³»ç»Ÿ
try:
    from user_journey import journey_bp, init_journey_tables
    app.register_blueprint(journey_bp)
    init_journey_tables()
    print("âœ… ç”¨æˆ·æ—…ç¨‹ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç”¨æˆ·æ—…ç¨‹ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 8. ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ
try:
    from unified_auth import auth_bp as unified_auth_bp
    app.register_blueprint(unified_auth_bp)
    print("âœ… ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 9. å•†å®¶æœåŠ¡ç³»ç»Ÿ
try:
    from merchant_service import (
        init_merchant_tables,
        seed_merchant_data
    )
    init_merchant_tables()
    seed_merchant_data()
    print("âœ… å•†å®¶æœåŠ¡ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  å•†å®¶æœåŠ¡ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 10. ç”¨æˆ·èµ„æ–™ç¼–è¾‘
try:
    from routes.user_profile import user_profile_bp
    app.register_blueprint(user_profile_bp)
    print("âœ… ç”¨æˆ·èµ„æ–™ç¼–è¾‘ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç”¨æˆ·èµ„æ–™ç¼–è¾‘æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 11. è´¡çŒ®å€¼ç³»ç»Ÿ
try:
    from routes.contribution import contribution_bp
    app.register_blueprint(contribution_bp)
    print("âœ… è´¡çŒ®å€¼ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  è´¡çŒ®å€¼ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 12. å•†å®¶åŠŸèƒ½
try:
    from routes.merchant import merchant_bp
    app.register_blueprint(merchant_bp)
    print("âœ… å•†å®¶åŠŸèƒ½ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  å•†å®¶åŠŸèƒ½æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 13. ä¸“å®¶åŠŸèƒ½
try:
    from routes.expert import expert_bp
    app.register_blueprint(expert_bp)
    print("âœ… ä¸“å®¶åŠŸèƒ½ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ä¸“å®¶åŠŸèƒ½æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 14. æ–‡åŒ–åœ£åœ°
try:
    from routes.sacred_sites import sacred_bp
    app.register_blueprint(sacred_bp)
    print("âœ… æ–‡åŒ–åœ£åœ° API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  æ–‡åŒ–åœ£åœ°æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 15. ç¾å­¦ä¾¦æ¢ä»»åŠ¡
try:
    from routes.aesthetic_tasks import aesthetic_bp
    app.register_blueprint(aesthetic_bp)
    print("âœ… ç¾å­¦ä¾¦æ¢ä»»åŠ¡ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  ç¾å­¦ä¾¦æ¢ä»»åŠ¡æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 16. æ•°å­—èµ„äº§
try:
    from routes.digital_assets import assets_bp
    app.register_blueprint(assets_bp)
    print("âœ… æ•°å­—èµ„äº§ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  æ•°å­—èµ„äº§æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 17. ç”¨æˆ·åé¦ˆ
try:
    from routes.feedback import feedback_bp
    app.register_blueprint(feedback_bp, url_prefix='/api')
    print("âœ… ç”¨æˆ·åé¦ˆ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç”¨æˆ·åé¦ˆæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 18. æ•°æ®åˆ†æ
try:
    from routes.analytics import analytics_bp
    app.register_blueprint(analytics_bp, url_prefix='/api')
    print("âœ… æ•°æ®åˆ†æ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  æ•°æ®åˆ†ææ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 19. å¯¼èˆªé…ç½®
try:
    from routes.navigation_config import navigation_config_bp
    app.register_blueprint(navigation_config_bp, url_prefix='/api')
    print("âœ… å¯¼èˆªé…ç½® API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  å¯¼èˆªé…ç½®æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 20. ç”¨æˆ·å¼•å¯¼æ–‡æ¡£
try:
    from routes.user_guide import user_guide_bp
    app.register_blueprint(user_guide_bp, url_prefix='/api')
    print("âœ… ç”¨æˆ·å¼•å¯¼æ–‡æ¡£ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç”¨æˆ·å¼•å¯¼æ–‡æ¡£æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 21. æ™ºèƒ½ä½“èŠå¤©
try:
    from routes.agent import agent_bp
    app.register_blueprint(agent_bp)
    print("âœ… æ™ºèƒ½ä½“èŠå¤© API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  æ™ºèƒ½ä½“èŠå¤©æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 22. çŸ¥è¯†åº“
try:
    from routes.knowledge import knowledge_bp
    app.register_blueprint(knowledge_bp)
    print("âœ… çŸ¥è¯†åº“ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  çŸ¥è¯†åº“æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 23. ç”¨æˆ·ç³»ç»Ÿ
try:
    from routes.user_system import user_bp
    app.register_blueprint(user_bp)
    print("âœ… ç”¨æˆ·ç³»ç»Ÿ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç”¨æˆ·ç³»ç»Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 24. ç»¼åˆåŠŸèƒ½
try:
    from routes.complete_apis import complete_bp
    app.register_blueprint(complete_bp)
    print("âœ… ç»¼åˆåŠŸèƒ½ API å·²æ³¨å†Œ")
except ImportError as e:
    print(f"âš ï¸  ç»¼åˆåŠŸèƒ½æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 25. å¾®ä¿¡å°ç¨‹åºç™»å½•
try:
    from routes.wechat_login import wechat_bp
    app.register_blueprint(wechat_bp)
    print("âœ… å¾®ä¿¡å°ç¨‹åºç™»å½• API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  å¾®ä¿¡å°ç¨‹åºç™»å½•æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 26. å¯¹è¯è®¡è´¹
try:
    from routes.conversation_billing import conversation_billing_bp
    app.register_blueprint(conversation_billing_bp)
    print("âœ… å¯¹è¯è®¡è´¹ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  å¯¹è¯è®¡è´¹æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 27. åŠ¨æ€èµ„è®¯
try:
    from news_articles import news_bp
    app.register_blueprint(news_bp)
    print("âœ… åŠ¨æ€èµ„è®¯ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  åŠ¨æ€èµ„è®¯æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 28. ä¸­è§†é¢‘é¡¹ç›®
try:
    from medium_video_api import medium_video_bp
    app.register_blueprint(medium_video_bp)
    print("âœ… ä¸­è§†é¢‘é¡¹ç›® API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  ä¸­è§†é¢‘é¡¹ç›®æ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 29. æ¨èå…³ç³»ç½‘ç»œ
try:
    from referral_network_api import referral_network_bp
    app.register_blueprint(referral_network_bp)
    print("âœ… æ¨èå…³ç³»ç½‘ç»œ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  æ¨èå…³ç³»ç½‘ç»œæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# 30. åˆä¼™äººæ‹›å‹Ÿ
try:
    from partner_api import partner_bp
    app.register_blueprint(partner_bp)
    print("âœ… åˆä¼™äººæ‹›å‹Ÿ API å·²æ³¨å†Œ")
except Exception as e:
    print(f"âš ï¸  åˆä¼™äººæ‹›å‹Ÿæ¨¡å—åŠ è½½å¤±è´¥: {e}")

print("\nâœ… æ‰€æœ‰è·¯ç”±æ¨¡å—æ³¨å†Œå®Œæˆï¼\n")

# ============ æ ¸å¿ƒè·¯ç”±ï¼ˆç•™åœ¨ app.py ä¸­ï¼‰ ============

@app.route('/')
def index():
    """é¦–é¡µ"""
    return jsonify({
        'success': True,
        'message': 'çµå€¼ç”Ÿæ€å›­æ™ºèƒ½ä½“ç³»ç»Ÿ',
        'version': '9.24.0',
        'status': 'running'
    })

@app.route('/api/status')
def status():
    """ç³»ç»ŸçŠ¶æ€"""
    return jsonify({
        'success': True,
        'message': 'ç³»ç»Ÿæ­£å¸¸è¿è¡Œ',
        'version': '9.24.0',
        'modules': 'å·²é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„'
    })

@app.route('/api/health')
def health():
    """å¥åº·æ£€æŸ¥"""
    try:
        conn = sqlite3.connect(DATABASE)
        conn.execute("SELECT 1")
        conn.close()
        return jsonify({
            'success': True,
            'status': 'healthy',
            'database': 'connected'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'status': 'unhealthy',
            'database': 'disconnected',
            'error': str(e)
        }), 500

# ============ æ•°æ®åº“åˆå§‹åŒ– ============

def init_db():
    """åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„"""
    print("ğŸ“¦ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...")

    try:
        conn = sqlite3.connect(DATABASE)
        cursor = conn.cursor()

        # ç”¨æˆ·è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT,
            phone TEXT,
            password_hash TEXT NOT NULL,
            total_lingzhi INTEGER DEFAULT 0,
            status TEXT DEFAULT 'active',
            last_login_at TIMESTAMP,
            avatar_url TEXT,
            real_name TEXT,
            is_verified BOOLEAN DEFAULT 0,
            login_type TEXT DEFAULT 'phone',
            wechat_openid TEXT,
            wechat_unionid TEXT,
            wechat_nickname TEXT,
            wechat_avatar TEXT,
            referrer_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        ''')

        # æ·»åŠ å­—æ®µï¼ˆå¦‚æœè¡¨å·²å­˜åœ¨ï¼‰
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN status TEXT DEFAULT 'active'")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN avatar_url TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN real_name TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN is_verified BOOLEAN DEFAULT 0")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN login_type TEXT DEFAULT 'phone'")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_openid TEXT UNIQUE")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_unionid TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_nickname TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_avatar TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN referrer_id INTEGER")
        except:
            pass

        # ç®¡ç†å‘˜è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS admins (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            role TEXT DEFAULT 'admin',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        ''')

        # ç­¾åˆ°è®°å½•è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS checkin_records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            checkin_date DATE NOT NULL,
            lingzhi_earned INTEGER DEFAULT 10,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id),
            UNIQUE(user_id, checkin_date)
        )
        ''')

        # æ¨èå…³ç³»è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS referral_relationships (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            referrer_id INTEGER NOT NULL,
            referred_user_id INTEGER NOT NULL,
            level INTEGER DEFAULT 1,
            lingzhi_reward INTEGER DEFAULT 0,
            reward_status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (referrer_id) REFERENCES users(id),
            FOREIGN KEY (referred_user_id) REFERENCES users(id),
            UNIQUE(referrer_id, referred_user_id)
        )
        ''')

        # æ¨èç è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS referral_codes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            referrer_id INTEGER NOT NULL,
            code TEXT UNIQUE NOT NULL,
            status TEXT DEFAULT 'active',
            expires_at TIMESTAMP,
            used_count INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (referrer_id) REFERENCES users(id)
        )
        ''')

        # å……å€¼æ¡£ä½è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS recharge_tiers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            description TEXT,
            price DECIMAL(10,2) NOT NULL,
            base_lingzhi INTEGER NOT NULL,
            bonus_lingzhi INTEGER NOT NULL,
            bonus_percentage INTEGER NOT NULL,
            partner_level INTEGER DEFAULT 0,
            benefits TEXT,
            status TEXT DEFAULT 'active',
            sort_order INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        ''')

        # å……å€¼è®°å½•è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS recharge_records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            tier_id INTEGER NOT NULL,
            order_no TEXT UNIQUE NOT NULL,
            amount DECIMAL(10,2) NOT NULL,
            base_lingzhi INTEGER NOT NULL,
            bonus_lingzhi INTEGER NOT NULL,
            total_lingzhi INTEGER NOT NULL,
            payment_method VARCHAR(20) DEFAULT 'online',
            payment_status VARCHAR(20) DEFAULT 'pending',
            payment_time TIMESTAMP,
            transaction_id TEXT,
            voucher_id INTEGER,
            audit_status VARCHAR(20),
            bank_info TEXT,
            status TEXT DEFAULT 'active',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id),
            FOREIGN KEY (tier_id) REFERENCES recharge_tiers(id)
        )
        ''')

        # å…¬å¸æ”¶æ¬¾è´¦æˆ·è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS company_accounts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            account_name VARCHAR(200) NOT NULL,
            account_number VARCHAR(50) NOT NULL,
            bank_name VARCHAR(200) NOT NULL,
            bank_branch VARCHAR(200),
            company_name VARCHAR(200) NOT NULL,
            company_credit_code VARCHAR(50),
            account_type VARCHAR(20) NOT NULL DEFAULT 'primary',
            is_active BOOLEAN DEFAULT 1,
            sort_order INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        ''')

        # è½¬è´¦å‡­è¯è¡¨
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS transfer_vouchers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            recharge_record_id INTEGER NOT NULL,
            user_id INTEGER NOT NULL,
            image_url VARCHAR(500) NOT NULL,
            transfer_amount DECIMAL(10, 2) NOT NULL,
            transfer_time TIMESTAMP,
            transfer_account VARCHAR(200),
            remark TEXT,
            audit_status VARCHAR(20) DEFAULT 'pending',
            audit_user_id INTEGER,
            audit_time TIMESTAMP,
            audit_remark TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (recharge_record_id) REFERENCES recharge_records(id),
            FOREIGN KEY (user_id) REFERENCES users(id),
            FOREIGN KEY (audit_user_id) REFERENCES admins(id)
        )
        ''')

        conn.commit()
        conn.close()

        print("âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")
        return True

    except Exception as e:
        print(f"âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: {e}")
        return False

# ============ åº”ç”¨å¯åŠ¨ ============

if __name__ == '__main__':
    print("\n" + "="*60)
    print("ğŸš€ çµå€¼ç”Ÿæ€å›­æ™ºèƒ½ä½“ç³»ç»Ÿ - V9.24.0")
    print("="*60 + "\n")

    # åˆå§‹åŒ–æ•°æ®åº“
    init_db()

    # å¯åŠ¨åº”ç”¨
    host = os.getenv('FLASK_HOST', '0.0.0.0')
    port = int(os.getenv('FLASK_PORT', 5000))
    debug = os.getenv('FLASK_DEBUG', 'False') == 'True'

    print(f"\nğŸŒ æœåŠ¡å™¨å¯åŠ¨: http://{host}:{port}")
    print(f"ğŸ“ è°ƒè¯•æ¨¡å¼: {debug}")
    print(f"ğŸ”§ å·¥ä½œç›®å½•: {os.getcwd()}\n")

    app.run(host=host, port=port, debug=debug)
