from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
from datetime import datetime, date, timedelta
import sqlite3
import hashlib
import jwt
import os
import bcrypt
import random
import string
import json
from urllib.parse import urlencode, quote
from urllib.parse import urlencode, quote, unquote
import requests

# 导入配置管理模块
from config import config

# 加载环境变量配置文件
try:
    from dotenv import load_dotenv
    env_path = os.path.join(os.path.dirname(__file__), '.env')
    if os.path.exists(env_path):
        load_dotenv(env_path)
        print(f"✅ 环境变量已加载: {env_path}")
    else:
        print(f"⚠️  .env文件不存在: {env_path}")
except ImportError:
    print("⚠️  python-dotenv未安装，使用默认环境变量")

# 使用配置管理模块获取所有配置
SECRET_KEY = config.JWT_SECRET_KEY
DATABASE = config.DATABASE_PATH
OLD_DATABASE = config.OLD_DATABASE
JWT_SECRET = config.JWT_SECRET_KEY
JWT_EXPIRATION = config.JWT_EXPIRATION

print(f"[配置] 数据库路径: {DATABASE}")
print(f"[配置] JWT过期时间: {JWT_EXPIRATION}秒")

# 导入日志模块
from logger import logger

# 设置 Coze 环境变量（如果未设置）
os.environ.setdefault('COZE_WORKLOAD_IDENTITY_API_KEY', 'WU9RNGFQTmZTc3VnbnRCMmsyWUtDcDZHOWJMa0g5ZVk6NVN5cHNRbkNidjFzWHNEVnJ4UTZKQlN1SUxYMlU3ZEtidVRXbDYwWDFyZW9sdmhQbTU1QVdQaVJHcVo4b1BoWA==')
os.environ.setdefault('COZE_INTEGRATION_MODEL_BASE_URL', 'https://integration.coze.cn/api/v3')
os.environ.setdefault('COZE_INTEGRATION_BASE_URL', 'https://integration.coze.cn')
os.environ.setdefault('COZE_PROJECT_ID', '7597768668038643746')

from langchain_core.messages import SystemMessage, HumanMessage, AIMessage

# 导入大模型 SDK（使用 coze_coding_dev_sdk）
try:
    from coze_coding_dev_sdk import LLMClient
    from coze_coding_utils.runtime_ctx.context import new_context
    LLM_AVAILABLE = True
    print("✓ coze_coding_dev_sdk 已加载，智能对话功能可用")
except ImportError:
    LLM_AVAILABLE = False
    print("警告: coze_coding_dev_sdk 未安装，智能对话功能将不可用")

import os

# 导入对话记忆系统
try:
    from conversation_memory import memory_bp, ensure_memory_tables
    MEMORY_AVAILABLE = True
    print("✅ 对话记忆系统已加载")
    # 延迟初始化表
    try:
        ensure_memory_tables()
    except Exception as e:
        print(f"⚠️ 记忆系统初始化失败: {e}")
except ImportError:
    MEMORY_AVAILABLE = False
    print("⚠️  对话记忆系统不可用")

# 导入用户旅程和统一认证系统
try:
    from user_journey import journey_bp, init_journey_tables
    JOURNEY_AVAILABLE = True
    print("✅ 用户旅程系统已加载")
    try:
        init_journey_tables()
    except Exception as e:
        print(f"⚠️ 用户旅程系统初始化失败: {e}")
except ImportError:
    JOURNEY_AVAILABLE = False
    print("⚠️ 用户旅程系统不可用")

try:
    from unified_auth import auth_bp
    AUTH_AVAILABLE = True
    print("✅ 统一认证系统已加载")
except ImportError:
    AUTH_AVAILABLE = False
    print("⚠️ 统一认证系统不可用")

# 导入商家服务系统
try:
    from merchant_service import (
        init_merchant_tables,
        seed_merchant_data,
        get_merchant_list,
        get_merchant_by_id,
        add_merchant_review,
        toggle_favorite,
        get_user_favorites,
        submit_collaboration,
        get_merchant_analytics
    )
    MERCHANT_AVAILABLE = True
    print("✅ 商家服务系统已加载")
    try:
        init_merchant_tables()
        seed_merchant_data()
    except Exception as e:
        print(f"⚠️ 商家系统初始化失败: {e}")
except ImportError:
    MERCHANT_AVAILABLE = False
    print("⚠️ 商家服务系统不可用")

app = Flask(__name__)

# 配置 CORS 允许跨域请求
CORS(app, resources={
    r"/api/*": {
        "origins": ["https://meiyueart.com", "http://meiyueart.com", "*"],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    },
    r"/*": {
        "origins": "*",
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    }
})

# 注册对话记忆蓝图
if MEMORY_AVAILABLE:
    app.register_blueprint(memory_bp, url_prefix='/api/memory')
    print("✅ 对话记忆 API 已注册")

# 注册用户旅程蓝图
if JOURNEY_AVAILABLE:
    app.register_blueprint(journey_bp)
    print("✅ 用户旅程 API 已注册")

# 注册统一认证蓝图
if AUTH_AVAILABLE:
    app.register_blueprint(auth_bp)
    print("✅ 统一认证 API 已注册")

# 注册用户资料编辑蓝图
try:
    from routes.user_profile import user_profile_bp
    app.register_blueprint(user_profile_bp)
    print("✅ 用户资料编辑 API 已注册")
except ImportError:
    print("⚠️ 用户资料编辑系统不可用")

# 注册贡献值系统蓝图
try:
    from routes.contribution import contribution_bp
    app.register_blueprint(contribution_bp)
    print("✅ 贡献值系统 API 已注册")
except ImportError:
    print("⚠️ 贡献值系统不可用")

# 注册商家功能蓝图
try:
    from routes.merchant import merchant_bp
    app.register_blueprint(merchant_bp)
    print("✅ 商家功能 API 已注册")
except ImportError:
    print("⚠️ 商家功能不可用")

# 注册专家功能蓝图
try:
    from routes.expert import expert_bp
    app.register_blueprint(expert_bp)
    print("✅ 专家功能 API 已注册")
except ImportError:
    print("⚠️ 专家功能不可用")

# 注册文化圣地蓝图
try:
    from routes.sacred_sites import sacred_bp
    app.register_blueprint(sacred_bp)
    print("✅ 文化圣地 API 已注册")
except Exception as e:
    print(f"⚠️ 文化圣地功能不可用: {str(e)}")

# 注册美学侦探任务蓝图
try:
    from routes.aesthetic_tasks import aesthetic_bp
    app.register_blueprint(aesthetic_bp)
    print("✅ 美学侦探任务 API 已注册")
except Exception as e:
    print(f"⚠️ 美学侦探任务功能不可用: {str(e)}")

# 注册数字资产蓝图
try:
    from routes.digital_assets import assets_bp
    app.register_blueprint(assets_bp)
    print("✅ 数字资产 API 已注册")
except Exception as e:
    print(f"⚠️ 数字资产功能不可用: {str(e)}")

# 注册用户反馈蓝图
try:
    from routes.feedback import feedback_bp
    app.register_blueprint(feedback_bp, url_prefix='/api')
    print("✅ 用户反馈 API 已注册")
except ImportError:
    print("⚠️ 用户反馈功能不可用")

# 注册数据分析蓝图
try:
    from routes.analytics import analytics_bp
    app.register_blueprint(analytics_bp, url_prefix='/api')
    print("✅ 数据分析 API 已注册")
except ImportError:
    print("⚠️ 数据分析功能不可用")

# 注册导航配置蓝图
try:
    from routes.navigation_config import navigation_config_bp
    app.register_blueprint(navigation_config_bp, url_prefix='/api')
    print("✅ 导航配置 API 已注册")
except ImportError:
    print("⚠️ 导航配置功能不可用")

# 注册用户引导文档蓝图
try:
    from routes.user_guide import user_guide_bp
    app.register_blueprint(user_guide_bp, url_prefix='/api')
    print("✅ 用户引导文档 API 已注册")
except ImportError:
    print("⚠️ 用户引导文档功能不可用")

# 注册智能体聊天蓝图
try:
    from routes.agent import agent_bp
    app.register_blueprint(agent_bp)
    print("✅ 智能体聊天 API 已注册")
except ImportError:
    print("⚠️ 智能体聊天功能不可用")

# 注册知识库蓝图
try:
    from routes.knowledge import knowledge_bp
    app.register_blueprint(knowledge_bp)
    print("✅ 知识库 API 已注册")
except ImportError:
    print("⚠️ 知识库功能不可用")

# 注册用户系统蓝图
try:
    from routes.user_system import user_bp
    app.register_blueprint(user_bp)
    print("✅ 用户系统 API 已注册")
except ImportError:
    print("⚠️ 用户系统功能不可用")

# 注册综合功能蓝图
try:
    from routes.complete_apis import complete_bp
    app.register_blueprint(complete_bp)
    print("✅ 综合功能 API 已注册")
except ImportError:
    print("⚠️ 综合功能不可用")

# 注册微信小程序登录蓝图
try:
    from routes.wechat_login import wechat_bp
    app.register_blueprint(wechat_bp)
    print("✅ 微信小程序登录 API 已注册")
except Exception as e:
    print(f"⚠️ 微信小程序登录功能不可用: {str(e)}")

# 注册对话计费蓝图
try:
    from routes.conversation_billing import conversation_billing_bp
    app.register_blueprint(conversation_billing_bp)
    print("✅ 对话计费 API 已注册")
except Exception as e:
    print(f"⚠️ 对话计费功能不可用: {str(e)}")

# 注册动态资讯蓝图
try:
    from news_articles import news_bp
    app.register_blueprint(news_bp)
    print("✅ 动态资讯 API 已注册")
except Exception as e:
    print(f"⚠️ 动态资讯功能不可用: {str(e)}")

# 注册中视频项目蓝图
try:
    from medium_video_api import medium_video_bp
    app.register_blueprint(medium_video_bp)
    print("✅ 中视频项目 API 已注册")
except Exception as e:
    print(f"⚠️ 中视频项目功能不可用: {str(e)}")

# 注册推荐关系网络蓝图
try:
    from referral_network_api import referral_network_bp
    app.register_blueprint(referral_network_bp)
    print("✅ 推荐关系网络 API 已注册")
except Exception as e:
    print(f"⚠️ 推荐关系网络功能不可用: {str(e)}")

# 注册合伙人招募蓝图
try:
    from partner_api import partner_bp
    app.register_blueprint(partner_bp)
    print("✅ 合伙人招募 API 已注册")
except Exception as e:
    print(f"⚠️ 合伙人招募功能不可用: {str(e)}")

# 配置静态文件路径
# 根据环境变量选择静态文件目录
ENV = os.getenv('ENV', 'development')
if ENV == 'production':
    # 生产环境：使用 Nginx 或反向代理提供静态文件
    public_dir = os.getenv('STATIC_DIR', '/var/www/meiyueart.com')
else:
    # 开发环境：使用本地 public 目录
    public_dir = os.path.join(os.path.dirname(__file__), '../public')

if os.path.exists(public_dir):
    app.static_folder = public_dir
    app.static_url_path = '/'
    print(f"静态文件目录: {public_dir}")

# 配置CORS，允许所有来源
CORS(app, resources={r"/*": {"origins": "*"}})

# 从配置模块获取配置（已在文件顶部导入）
# SECRET_KEY, DATABASE, OLD_DATABASE, JWT_SECRET, JWT_EXPIRATION 已通过 config 模块加载

# 打印配置信息（调试）
print(f"[配置] BASE_DIR: {os.path.dirname(__file__)}")

# 微信开放平台配置
WECHAT_APP_ID = os.getenv('WECHAT_APP_ID', '')
WECHAT_APP_SECRET = os.getenv('WECHAT_APP_SECRET', '')
WECHAT_REDIRECT_URI = os.getenv('WECHAT_REDIRECT_URI', 'http://localhost:3000/wechat/callback')

# 验证码存储（模拟短信验证码）
verification_codes = {}  # {phone: {'code': '123456', 'expire_at': timestamp}}

def init_db():
    """初始化数据库"""
    try:
        conn = sqlite3.connect(DATABASE)
        cursor = conn.cursor()

        # 安全执行SQL的辅助函数
        def safe_execute(sql, params=None):
            """安全执行SQL，忽略索引创建错误"""
            try:
                if params:
                    cursor.execute(sql, params)
                else:
                    cursor.execute(sql)
            except sqlite3.OperationalError as e:
                # 如果是索引相关错误，忽略
                if 'no such column' in str(e) or 'no such table' in str(e):
                    pass
                else:
                    raise

        # 用户表
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT,
            phone TEXT,
            password_hash TEXT NOT NULL,
            total_lingzhi INTEGER DEFAULT 0,
            status TEXT DEFAULT 'active',
            last_login_at TIMESTAMP,
            avatar_url TEXT,
            real_name TEXT,
            is_verified BOOLEAN DEFAULT 0,
            login_type TEXT DEFAULT 'phone',
            wechat_openid TEXT,
            wechat_unionid TEXT,
            wechat_nickname TEXT,
            wechat_avatar TEXT,
            referrer_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        ''')

        # 添加新字段（如果表已存在）
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN status TEXT DEFAULT 'active'")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN avatar_url TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN real_name TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN is_verified BOOLEAN DEFAULT 0")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN login_type TEXT DEFAULT 'phone'")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_openid TEXT UNIQUE")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_unionid TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_nickname TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN wechat_avatar TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN referrer_id INTEGER")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN location TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN bio TEXT")
        except:
            pass
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN website TEXT")
        except:
            pass

        # 注册尝试次数跟踪表（用于推荐人3次逻辑）
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS registration_attempts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ip_address TEXT NOT NULL,
                attempt_count INTEGER DEFAULT 1,
                last_attempt_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(ip_address)
            )
        ''')

        # 用户详细信息表（用于完善信息）
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_profiles (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER UNIQUE NOT NULL,
                real_name TEXT,
                phone TEXT UNIQUE,
                email TEXT UNIQUE,
                id_card TEXT,
                bank_account TEXT,
                bank_name TEXT,
                address TEXT,
                is_completed BOOLEAN DEFAULT 0,
                completed_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 签到记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS checkin_records (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                checkin_date DATE NOT NULL,
                lingzhi_earned INTEGER DEFAULT 10,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                UNIQUE(user_id, checkin_date)
            )
        ''')

        # 会话表（用于用户旅程）
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS sessions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                conversation_id TEXT,
                stage TEXT DEFAULT 'new',
                progress INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 合伙人申请表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS partner_applications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                user_name TEXT,
                phone TEXT,
                current_lingzhi INTEGER,
                reason TEXT,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 后台管理员表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS admins (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password_hash TEXT NOT NULL,
                role TEXT DEFAULT 'admin',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # 智能体表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS agents (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                system_prompt TEXT,
                model_config TEXT,
                tools TEXT,
                status TEXT DEFAULT 'active',
                avatar_url TEXT,
                created_by INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (created_by) REFERENCES admins(id)
            )
        ''')

        # 知识库表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS knowledge_bases (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                vector_db_id TEXT,
                document_count INTEGER DEFAULT 0,
                created_by INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (created_by) REFERENCES admins(id)
            )
        ''')

        # 知识库文档表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS knowledge_documents (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                knowledge_base_id INTEGER NOT NULL,
                title TEXT NOT NULL,
                content TEXT,
                file_path TEXT,
                file_type TEXT,
                file_size INTEGER,
                embedding_status TEXT DEFAULT 'pending',
                embedding_error TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (knowledge_base_id) REFERENCES knowledge_bases(id)
            )
        ''')

        # 智能体-知识库关联表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS agent_knowledge_bases (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                agent_id INTEGER NOT NULL,
                knowledge_base_id INTEGER NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (agent_id) REFERENCES agents(id),
                FOREIGN KEY (knowledge_base_id) REFERENCES knowledge_bases(id),
                UNIQUE(agent_id, knowledge_base_id)
            )
        ''')

        # 对话记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS conversations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                agent_id INTEGER,
                user_id INTEGER,
                conversation_id TEXT,
                messages TEXT,
                title TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (agent_id) REFERENCES agents(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 确保 conversations 表有 messages 字段（兼容旧数据库）
        try:
            cursor.execute("SELECT messages FROM conversations LIMIT 1")
        except sqlite3.OperationalError:
            print("添加 conversations.messages 字段")
            cursor.execute("ALTER TABLE conversations ADD COLUMN messages TEXT")

        # 反馈表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS feedback (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                conversation_id INTEGER,
                agent_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                type TEXT NOT NULL,
                rating INTEGER,
                question TEXT,
                comment TEXT,
                contribution_value INTEGER DEFAULT 5,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (conversation_id) REFERENCES conversations(id),
                FOREIGN KEY (agent_id) REFERENCES agents(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 充值档位表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS recharge_tiers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                price DECIMAL(10,2) NOT NULL,
                base_lingzhi INTEGER NOT NULL,
                bonus_lingzhi INTEGER NOT NULL,
                bonus_percentage INTEGER NOT NULL,
                partner_level INTEGER DEFAULT 0,
                benefits TEXT,
                status TEXT DEFAULT 'active',
                sort_order INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # 充值记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS recharge_records (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                tier_id INTEGER NOT NULL,
                order_no TEXT UNIQUE NOT NULL,
                amount DECIMAL(10,2) NOT NULL,
                base_lingzhi INTEGER NOT NULL,
                bonus_lingzhi INTEGER NOT NULL,
                total_lingzhi INTEGER NOT NULL,
                payment_method VARCHAR(20) DEFAULT 'online',
                payment_status VARCHAR(20) DEFAULT 'pending',
                payment_time TIMESTAMP,
                transaction_id TEXT,
                voucher_id INTEGER,
                audit_status VARCHAR(20),
                bank_info TEXT,
                status TEXT DEFAULT 'active',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (tier_id) REFERENCES recharge_tiers(id)
            )
        ''')

        # 灵值消费记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS lingzhi_consumption_records (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                consumption_type TEXT NOT NULL,
                consumption_item TEXT NOT NULL,
                lingzhi_amount INTEGER NOT NULL,
                item_id INTEGER,
                description TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 用户权益表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_benefits (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                benefit_type TEXT NOT NULL,
                benefit_name TEXT NOT NULL,
                benefit_count INTEGER DEFAULT 0,
                benefit_expiry TIMESTAMP,
                source TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')

        # 公司收款账户表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS company_accounts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                account_name VARCHAR(200) NOT NULL,
                account_number VARCHAR(50) NOT NULL,
                bank_name VARCHAR(200) NOT NULL,
                bank_branch VARCHAR(200),
                company_name VARCHAR(200) NOT NULL,
                company_credit_code VARCHAR(50),
                account_type VARCHAR(20) NOT NULL DEFAULT 'primary',
                is_active BOOLEAN DEFAULT 1,
                sort_order INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # 转账凭证表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS transfer_vouchers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                recharge_record_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                image_url VARCHAR(500) NOT NULL,
                transfer_amount DECIMAL(10, 2) NOT NULL,
                transfer_time TIMESTAMP,
                transfer_account VARCHAR(200),
                remark TEXT,
                audit_status VARCHAR(20) DEFAULT 'pending',
                audit_user_id INTEGER,
                audit_time TIMESTAMP,
                audit_remark TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (recharge_record_id) REFERENCES recharge_records(id),
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (audit_user_id) REFERENCES admins(id)
            )
        ''')

        # 系统通知表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS system_notifications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                notification_type TEXT DEFAULT 'info',
                is_read BOOLEAN DEFAULT 0,
                target_user_id INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (target_user_id) REFERENCES users(id)
            )
        ''')

        # 用户已读通知记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_read_notifications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                notification_id INTEGER NOT NULL,
                read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(user_id, notification_id),
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (notification_id) REFERENCES system_notifications(id)
            )
        ''')

        # ============ v9.0 生态系统升级 - 开始 ============

        # 推荐关系表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS referral_relationships (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                referrer_id INTEGER NOT NULL,
                referee_id INTEGER NOT NULL UNIQUE,
                level INTEGER NOT NULL DEFAULT 1,
                status TEXT DEFAULT 'active',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (referrer_id) REFERENCES users(id),
                FOREIGN KEY (referee_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_referral_referrer ON referral_relationships(referrer_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_referral_referee ON referral_relationships(referee_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_referral_level ON referral_relationships(level)")

        # 推荐分润记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS referral_commissions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                referrer_id INTEGER NOT NULL,
                referee_id INTEGER NOT NULL,
                level INTEGER NOT NULL,
                transaction_id INTEGER,
                transaction_type TEXT NOT NULL,
                original_amount REAL NOT NULL,
                commission_rate REAL NOT NULL,
                commission_amount REAL NOT NULL,
                status TEXT DEFAULT 'pending',
                settled_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (referrer_id) REFERENCES users(id),
                FOREIGN KEY (referee_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_commission_referrer ON referral_commissions(referrer_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_commission_referee ON referral_commissions(referee_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_commission_status ON referral_commissions(status)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_commission_created_at ON referral_commissions(created_at)")

        # 用户资源表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_resources (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                resource_type TEXT NOT NULL,
                resource_name TEXT NOT NULL,
                description TEXT,
                availability TEXT DEFAULT 'available',
                estimated_value REAL,
                status TEXT DEFAULT 'active',
                tags TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_resource_user ON user_resources(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_resource_type ON user_resources(resource_type)")
        try:
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_resource_status ON user_resources(status)")
        except:
            pass  # 如果status列不存在，跳过

        # 资源匹配记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS resource_matches (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                project_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                resource_id INTEGER NOT NULL,
                match_score REAL NOT NULL,
                match_reason TEXT,
                status TEXT DEFAULT 'pending',
                user_response TEXT,
                response_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (project_id) REFERENCES projects(id),
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (resource_id) REFERENCES user_resources(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_match_project ON resource_matches(project_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_match_user ON resource_matches(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_match_score ON resource_matches(match_score)")

        # 项目表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS projects (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                description TEXT,
                project_type TEXT NOT NULL,
                budget REAL,
                required_skills TEXT,
                required_assets TEXT,
                duration INTEGER,
                location TEXT,
                status TEXT DEFAULT 'open',
                creator_id INTEGER,
                deadline TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (creator_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_project_type ON projects(project_type)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_project_status ON projects(status)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_project_budget ON projects(budget)")

        # 项目参与者表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS project_participants (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                project_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                role TEXT NOT NULL,
                contribution TEXT,
                reward REAL,
                reward_status TEXT DEFAULT 'pending',
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                FOREIGN KEY (project_id) REFERENCES projects(id),
                FOREIGN KEY (user_id) REFERENCES users(id),
                UNIQUE(project_id, user_id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_participant_project ON project_participants(project_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_participant_user ON project_participants(user_id)")

        # 资源变现记录表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS resource_realization (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                resource_id INTEGER NOT NULL,
                project_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                transaction_type TEXT NOT NULL,
                original_reward REAL NOT NULL,
                actual_reward REAL NOT NULL,
                realization_status TEXT DEFAULT 'pending',
                completed_at TIMESTAMP,
                FOREIGN KEY (resource_id) REFERENCES user_resources(id),
                FOREIGN KEY (project_id) REFERENCES projects(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_realization_user ON resource_realization(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_realization_resource ON resource_realization(resource_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_realization_project ON resource_realization(project_id)")

        # 数字资产表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS digital_assets (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                asset_type TEXT NOT NULL,
                asset_name TEXT NOT NULL,
                description TEXT,
                image_url TEXT,
                metadata TEXT,
                rarity TEXT DEFAULT 'common',
                value REAL,
                is_transferable BOOLEAN DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_asset_user ON digital_assets(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_asset_type ON digital_assets(asset_type)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_asset_rarity ON digital_assets(rarity)")

        # 资产交易表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS asset_transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                asset_id INTEGER NOT NULL,
                from_user_id INTEGER NOT NULL,
                to_user_id INTEGER NOT NULL,
                transaction_type TEXT NOT NULL,
                price REAL NOT NULL,
                fee REAL DEFAULT 0,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                FOREIGN KEY (asset_id) REFERENCES digital_assets(id),
                FOREIGN KEY (from_user_id) REFERENCES users(id),
                FOREIGN KEY (to_user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_tx_asset ON asset_transactions(asset_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_tx_from ON asset_transactions(from_user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_tx_to ON asset_transactions(to_user_id)")

        # 资产收益表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS asset_earnings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                asset_id INTEGER,
                user_id INTEGER NOT NULL,
                earning_type TEXT NOT NULL,
                amount REAL NOT NULL,
                source_type TEXT,
                source_id INTEGER,
                status TEXT DEFAULT 'confirmed',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (asset_id) REFERENCES digital_assets(id),
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_earnings_user ON asset_earnings(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_earnings_asset ON asset_earnings(asset_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_earnings_type ON asset_earnings(earning_type)")

        # ============ v9.0 生态系统升级 - 结束 ============

        # ============ 公司生态模块 - 开始 ============
        # 公司动态表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS company_news (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                category TEXT NOT NULL,
                summary TEXT,
                image_url TEXT,
                author TEXT,
                status TEXT DEFAULT 'published',
                view_count INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_news_category ON company_news(category)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_news_status ON company_news(status)")

        # 项目动态表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS company_projects (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                project_name TEXT NOT NULL,
                description TEXT,
                category TEXT,
                status TEXT DEFAULT 'active',
                progress INTEGER DEFAULT 0,
                priority TEXT DEFAULT 'normal',
                start_date DATE,
                end_date DATE,
                budget REAL,
                actual_cost REAL,
                team_size INTEGER,
                tags TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_projects_category ON company_projects(category)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_projects_status ON company_projects(status)")

        # 信息动态表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS company_info (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                info_type TEXT NOT NULL,
                title TEXT NOT NULL,
                content TEXT NOT NULL,
                priority TEXT DEFAULT 'normal',
                target_audience TEXT,
                is_public BOOLEAN DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_info_type ON company_info(info_type)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_info_public ON company_info(is_public)")

        # 用户动态表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS company_users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                activity_type TEXT NOT NULL,
                description TEXT,
                metadata TEXT,
                ip_address TEXT,
                device_type TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id)
            )
        ''')
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_activity ON company_users(activity_type)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_user ON company_users(user_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_created ON company_users(created_at)")
        # ============ 公司生态模块 - 结束 ============

        conn.commit()
        conn.close()
    except sqlite3.OperationalError as e:
        print(f"⚠️ 数据库初始化遇到错误（已忽略）: {e}")
        pass  # 忽略索引创建等非致命错误

# 简单的内存速率限制器（防止暴力破解）
from collections import defaultdict
from datetime import datetime, timedelta

login_attempts = defaultdict(list)

def check_rate_limit(identifier, max_attempts=5, window_minutes=15):
    """
    检查速率限制
    
    Args:
        identifier: 唯一标识符（IP地址或用户名）
        max_attempts: 最大尝试次数
        window_minutes: 时间窗口（分钟）
    
    Returns:
        (is_allowed, remaining_attempts, retry_after_seconds)
    """
    now = datetime.now()
    window_start = now - timedelta(minutes=window_minutes)
    
    # 清理过期的尝试记录
    login_attempts[identifier] = [
        attempt_time for attempt_time in login_attempts[identifier]
        if attempt_time > window_start
    ]
    
    attempts = login_attempts[identifier]
    
    if len(attempts) >= max_attempts:
        # 计算需要等待的时间
        oldest_attempt = attempts[0]
        retry_after = int((oldest_attempt + timedelta(minutes=window_minutes) - now).total_seconds())
        return (False, 0, retry_after)
    
    return (True, max_attempts - len(attempts), 0)

def record_login_attempt(identifier):
    """记录一次登录尝试"""
    login_attempts[identifier].append(datetime.now())

def get_db():
    """获取数据库连接"""
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

from contextlib import contextmanager

@contextmanager
def get_db_context():
    """数据库上下文管理器，确保连接总是被关闭"""
    conn = get_db()
    try:
        yield conn
    finally:
        conn.close()

def hash_password(password):
    """密码哈希（统一使用bcrypt）"""
    salt = bcrypt.gensalt()
    return bcrypt.hashpw(password.encode('utf-8'), salt).decode('utf-8')

# 保留旧函数名以兼容，实际使用hash_password
def hash_password_bcrypt(password):
    """密码哈希（bcrypt）- 保留以兼容"""
    return hash_password(password)

def verify_password(password, password_hash):
    """验证密码（优先bcrypt，兼容SHA256和scrypt）"""
    if not password_hash:
        print(f"[密码验证] 密码hash为空，验证失败")
        return False
    
    # 优先尝试 bcrypt（新的统一格式）
    try:
        if password_hash.startswith('$2b$') or password_hash.startswith('$2a$'):
            result = bcrypt.checkpw(password.encode('utf-8'), password_hash.encode('utf-8'))
            if not result:
                print(f"[密码验证] bcrypt验证失败")
            return result
    except Exception as e:
        print(f"[密码验证] bcrypt验证异常: {e}")
    
    # 兼容 scrypt (werkzeug 默认)
    try:
        from werkzeug.security import check_password_hash as werkzeug_check
        result = werkzeug_check(password_hash, password)
        if result:
            print(f"[密码验证] scrypt验证成功")
            return result
    except Exception as e:
        print(f"[密码验证] scrypt验证异常: {e}")
    
    # 兼容 SHA256（旧格式，建议迁移到bcrypt）
    try:
        sha256_hash = hashlib.sha256(password.encode()).hexdigest()
        result = (password_hash == sha256_hash)
        if result:
            print(f"[密码验证] SHA256验证成功（建议迁移到bcrypt）")
        return result
    except Exception as e:
        print(f"[密码验证] SHA256验证异常: {e}")
    
    print(f"[密码验证] 所有验证方式均失败")
    return False
    return False

def generate_token(user_id, role=None):
    """生成JWT token"""
    payload = {
        'user_id': user_id,
        'exp': datetime.utcnow().timestamp() + JWT_EXPIRATION
    }
    # 如果提供了 role，添加到 payload
    if role:
        payload['role'] = role
    return jwt.encode(payload, JWT_SECRET, algorithm='HS256')

def generate_referral_code(username):
    """生成推荐码（基于用户名+随机数）"""
    import random
    import string
    # 取用户名的前3个字符 + 5位随机数字
    prefix = username[:3].upper() if len(username) >= 3 else username.upper()
    random_num = ''.join(random.choices(string.digits, k=5))
    return f"{prefix}{random_num}"

def verify_token(token):
    """验证JWT token"""
    try:
        if token and token.startswith('Bearer '):
            token = token[7:]  # 去掉 'Bearer ' 前缀
        payload = jwt.decode(token, JWT_SECRET, algorithms=['HS256'])
        return payload['user_id']
    except:
        return None

def is_super_admin(user_id):
    """检查用户是否为超级管理员（检查 admins 表和 user_roles 表）"""
    conn = get_db()
    cursor = conn.cursor()

    # 检查 admins 表中的 role 字段
    cursor.execute("SELECT role FROM admins WHERE id = ?", (user_id,))
    admin = cursor.fetchone()

    if admin and admin['role'] == 'super_admin':
        conn.close()
        return True

    # 检查 user_roles 表中的角色
    cursor.execute("""
        SELECT r.name FROM user_roles ur
        JOIN roles r ON ur.role_id = r.id
        WHERE ur.user_id = ? AND r.name = 'super_admin'
    """, (user_id,))

    if cursor.fetchone():
        conn.close()
        return True

    conn.close()
    return False

def format_user_data(user_row):
    """格式化用户数据 - 直接返回数据库字段名（自主可控方案）"""
    if not user_row:
        return None

    # 转换为字典，直接返回数据库字段名
    user_dict = dict(user_row)

    # 直接返回数据库字段，不进行转换
    return user_dict

# 初始化数据库
init_db()

# 创建默认管理员账号（如果不存在）
def create_default_admin():
    """创建默认管理员账号（同时在 admins 和 users 表中创建）"""
    import time
    
    max_retries = 5
    retry_delay = 0.5
    
    for attempt in range(max_retries):
        try:
            conn = get_db()
            cursor = conn.cursor()
            
            # 统一密码
            admin_password = '123'
            
            # 在 admins 表中创建管理员
            cursor.execute("SELECT * FROM admins WHERE username = 'admin'")
            if not cursor.fetchone():
                # 使用 bcrypt 进行密码哈希
                password_hash = hash_password_bcrypt(admin_password)
                cursor.execute(
                    "INSERT INTO admins (username, password_hash, role) VALUES (?, ?, ?)",
                    ('admin', password_hash, 'admin')
                )
                print(f"默认管理员账号已创建: admin / {admin_password}")
            else:
                # 如果已存在，更新密码为统一密码
                password_hash = hash_password_bcrypt(admin_password)
                cursor.execute(
                    "UPDATE admins SET password_hash = ? WHERE username = ?",
                    (password_hash, 'admin')
                )
                print(f"管理员账号密码已更新: admin / {admin_password}")

            # 在 users 表中也创建一个管理员账号（用于登录）
            cursor.execute("SELECT * FROM users WHERE username = 'admin'")
            if not cursor.fetchone():
                # 使用 bcrypt 进行密码哈希（与admins表保持一致）
                password_hash_user = hash_password(admin_password)
                cursor.execute(
                    """INSERT INTO users (username, password_hash, email, phone, status, is_verified)
                       VALUES (?, ?, ?, ?, ?, ?)""",
                    ('admin', password_hash_user, 'admin@meiyueart.com', '', 'active', 1)
                )
                print(f"默认用户登录账号已创建: admin / {admin_password}")
            else:
                # 如果已存在，更新密码为统一密码
                password_hash_user = hash_password(admin_password)
                cursor.execute(
                    "UPDATE users SET password_hash = ? WHERE username = ?",
                    (password_hash_user, 'admin')
                )
                print(f"用户登录账号密码已更新: admin / {admin_password}")

            conn.commit()
            conn.close()
            return  # 成功完成
            
        except sqlite3.OperationalError as e:
            if "database is locked" in str(e):
                print(f"[警告] 数据库锁定，第 {attempt + 1}/{max_retries} 次重试...")
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    retry_delay *= 2  # 指数退避
                    continue
                else:
                    print(f"[警告] 无法更新admin账号密码（数据库锁定），服务继续启动")
                    print(f"[警告] 请手动执行: UPDATE admins SET password_hash = bcrypt('123456') WHERE username = 'admin'")
                    return  # 不再抛出异常，让服务继续启动
            else:
                print(f"[错误] 创建管理员账号失败: {str(e)}")
                raise
        except Exception as e:
            print(f"[错误] 创建管理员账号失败: {str(e)}")
            raise

# 数据库初始化
try:
    from database_init import init_database
    if init_database():
        print("✅ 数据库初始化成功")
    else:
        print("⚠️  数据库初始化失败，将在启动时继续")
except ImportError:
    print("⚠️  database_init 模块未找到，跳过初始化")
except Exception as e:
    import traceback
    print(f"⚠️  数据库初始化异常: {e}")
    traceback.print_exc()

# 创建默认管理员
create_default_admin()

# 迁移旧用户数据（仅在首次启动时执行）
MIGRATED = False

def backup_database():
    """备份数据库"""
    try:
        import shutil
        from datetime import datetime
        
        # 创建备份目录
        backup_dir = os.path.join(os.path.dirname(__file__), 'backups')
        if not os.path.exists(backup_dir):
            os.makedirs(backup_dir)
        
        # 备份文件名
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_file = os.path.join(backup_dir, f'lingzhi_ecosystem_backup_{timestamp}.db')
        
        # 复制数据库
        shutil.copy2(DATABASE, backup_file)
        print(f"数据库备份成功: {backup_file}")
        
        # 清理旧备份（保留最近 7 天）
        import time
        current_time = time.time()
        for filename in os.listdir(backup_dir):
            file_path = os.path.join(backup_dir, filename)
            file_time = os.path.getmtime(file_path)
            if current_time - file_time > 7 * 24 * 3600:  # 7天
                os.remove(file_path)
                print(f"删除旧备份: {filename}")
        
        return True
    except Exception as e:
        print(f"数据库备份失败: {e}")
        return False

def migrate_old_users():
    """从旧数据库迁移用户数据"""
    global MIGRATED
    
    # 防止重复迁移
    if MIGRATED:
        print("用户数据已迁移，跳过")
        return
    
    old_db_path = os.path.join(os.path.dirname(__file__), OLD_DATABASE)
    if not os.path.exists(old_db_path):
        print("旧数据库不存在，跳过迁移")
        MIGRATED = True
        return
    
    # 检查新数据库是否已有用户
    conn_new = get_db()
    cursor_new = conn_new.cursor()
    cursor_new.execute("SELECT COUNT(*) FROM users")
    new_user_count = cursor_new.fetchone()[0]
    conn_new.close()
    
    if new_user_count > 0:
        print(f"新数据库已有 {new_user_count} 个用户，跳过迁移")
        MIGRATED = True
        return
    
    print("开始迁移用户数据...")
    
    conn_old = sqlite3.connect(old_db_path)
    cursor_old = conn_old.cursor()
    
    # 查询旧用户
    cursor_old.execute("SELECT id, name, email, phone, password_hash, created_at FROM users")
    old_users = cursor_old.fetchall()
    
    if not old_users:
        print("旧数据库中没有用户数据")
        conn_old.close()
        MIGRATED = True
        return
    
    conn_new = get_db()
    cursor_new = conn_new.cursor()
    
    migrated_count = 0
    for old_user in old_users:
        old_id, name, email, phone, password_hash, created_at = old_user
        
        # 处理重复邮箱：添加后缀
        username = name
        if email:
            # 检查是否已存在相同邮箱的用户
            cursor_new.execute("SELECT COUNT(*) FROM users WHERE email = ?", (email,))
            email_count = cursor_new.fetchone()[0]
            if email_count > 0:
                # 添加序号后缀
                username = f"{name}_{old_id}"
        
        # 检查是否已存在相同用户名的用户
        cursor_new.execute("SELECT id FROM users WHERE username = ?", (username,))
        if cursor_new.fetchone():
            continue
        
        # 插入新用户（使用 name 作为 username）
        try:
            cursor_new.execute(
                """INSERT INTO users 
                   (username, email, phone, password_hash, total_lingzhi, status, login_type, created_at) 
                   VALUES (?, ?, ?, ?, 0, 'active', 'phone', ?)""",
                (username, email or '', phone or '', password_hash, created_at)
            )
            migrated_count += 1
            print(f"迁移用户: {username} ({email or '无邮箱'})")
        except Exception as e:
            print(f"迁移用户失败 {username}: {e}")
    
    conn_new.commit()
    conn_new.close()
    conn_old.close()
    
    MIGRATED = True
    
    if migrated_count > 0:
        print(f"成功迁移 {migrated_count} 个用户")
    else:
        print("没有新用户需要迁移")

# 执行迁移
migrate_old_users()

# ============ 路由定义 ============

@app.route('/')
def serve_index():
    """提供主页"""
    index_file = os.path.join(public_dir, 'index.html')
    if os.path.exists(index_file):
        with open(index_file, 'r', encoding='utf-8') as f:
            return f.read(), 200, {
                'Content-Type': 'text/html; charset=utf-8',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            }
    return jsonify({'error': 'index.html not found'}), 404

@app.route('/<path:filename>')
def serve_static(filename):
    """提供静态文件"""
    # 不处理API路径
    if filename.startswith('api/'):
        return jsonify({'error': 'Not Found'}), 404

    file_path = os.path.join(public_dir, filename)
    if os.path.exists(file_path) and os.path.isfile(file_path):
        # 对于有内容哈希的文件，使用长期缓存
        # 文件名包含哈希的模式：index-*.js, index-*.css 等
        import re
        if re.search(r'-[a-zA-Z0-9]{8,10}\.(js|css|woff2?|ttf)$', filename):
            # 有内容哈希的文件，缓存1年
            return send_from_directory(public_dir, filename, max_age=31536000)
        else:
            # 其他文件，不缓存
            return send_from_directory(public_dir, filename, max_age=0)
    return jsonify({'error': 'File not found'}), 404

@app.route('/api/status')
def index():
    """健康检查 - 支持浏览器访问返回HTML页面"""
    # 检查是否是浏览器请求
    user_agent = request.headers.get('User-Agent', '')
    accept = request.headers.get('Accept', '')
    
    # 如果User-Agent包含浏览器关键字，或者Accept包含text/html，返回HTML
    browser_keywords = ['Mozilla', 'Chrome', 'Safari', 'Firefox', 'Edge', 'Opera']
    is_browser = any(keyword in user_agent for keyword in browser_keywords)
    wants_html = 'text/html' in accept
    
    if is_browser or wants_html:
        # 返回HTML页面
        index_file = os.path.join(public_dir, 'index.html')
        if os.path.exists(index_file):
            with open(index_file, 'r', encoding='utf-8') as f:
                return f.read(), 200, {'Content-Type': 'text/html; charset=utf-8'}
    
    # 返回JSON
    return jsonify({
        'status': 'success',
        'message': '灵值生态园 API 服务正常运行',
        'version': '1.0.0'
    })

@app.route('/api/health')
def health():
    """健康检查"""
    return jsonify({'status': 'ok'})

# ============ 用户认证 ============

@app.route('/api/register', methods=['POST'])
def register():
    """用户注册（v12.1升级：简化注册流程，推荐码可选，自动获取）"""
    try:
        data = request.json
        username = data.get('username', '').strip()
        email = data.get('email', '').strip()
        phone = data.get('phone', '').strip()
        password = data.get('password', '')
        referral_code_input = data.get('referral_code', '').strip()  # 推荐码（自动获取，可选）

        # 记录注册请求日志
        print(f"[注册] 收到注册请求 - username={username}, phone={phone}, ip={request.remote_addr}")

        # 验证必填字段
        if not username or not password:
            print(f"[注册] 用户名或密码为空 - username={username}")
            return jsonify({
                'success': False,
                'message': '用户名和密码不能为空',
                'error_code': 'MISSING_CREDENTIALS'
            }), 400

        # 验证手机号不为空
        if not phone:
            print(f"[注册] 手机号为空 - username={username}")
            return jsonify({
                'success': False,
                'message': '手机号不能为空',
                'error_code': 'MISSING_PHONE'
            }), 400

        # 验证手机号格式（11位数字，以1开头）
        import re
        phone_pattern = r'^1[3-9]\d{9}$'
        if not re.match(phone_pattern, phone):
            print(f"[注册] 手机号格式不正确 - username={username}, phone={phone}")
            return jsonify({
                'success': False,
                'message': '手机号格式不正确，请输入11位手机号',
                'error_code': 'INVALID_PHONE_FORMAT'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 检查用户名是否已存在
        cursor.execute("SELECT id FROM users WHERE username = ?", (username,))
        if cursor.fetchone():
            print(f"[注册] 用户名已存在 - username={username}")
            conn.close()
            return jsonify({
                'success': False,
                'message': '用户名已存在',
                'error_code': 'USERNAME_EXISTS'
            }), 400

        # 检查手机号是否已存在
        cursor.execute("SELECT id FROM users WHERE phone = ?", (phone,))
        if cursor.fetchone():
            print(f"[注册] 手机号已被使用 - phone={phone}")
            conn.close()
            return jsonify({
                'success': False,
                'message': '手机号已被使用',
                'error_code': 'PHONE_EXISTS'
            }), 400

        # 处理推荐人逻辑（推荐码可选，自动验证）
        referrer_id = None

        # 如果提供了推荐码，验证推荐码并获取推荐人ID
        if referral_code_input:
            cursor.execute("SELECT id FROM users WHERE referral_code = ?", (referral_code_input,))
            referrer = cursor.fetchone()
            if referrer:
                referrer_id = referrer['id']
                print(f"[注册] 推荐码有效 - referrer_id={referrer_id}")
            # 如果推荐码无效，也不返回错误，只是不设置推荐人
            else:
                print(f"[注册] 推荐码无效 - referral_code={referral_code_input}")

        # 生成推荐码
        new_referral_code = generate_referral_code(username)
        # 确保推荐码唯一
        while True:
            cursor.execute("SELECT id FROM users WHERE referral_code = ?", (new_referral_code,))
            if not cursor.fetchone():
                break
            new_referral_code = generate_referral_code(username)

        # 创建用户
        password_hash = hash_password(password)
        cursor.execute(
            """INSERT INTO users (username, email, phone, password_hash, referrer_id, referral_code)
               VALUES (?, ?, ?, ?, ?, ?)""",
            (username, email, phone, password_hash, referrer_id, new_referral_code)
        )
        user_id = cursor.lastrowid

        # 创建推荐关系
        if referrer_id:
            try:
                cursor.execute(
                    """INSERT INTO referral_relationships
                       (referrer_id, referee_id, level, status)
                       VALUES (?, ?, 1, 'active')""",
                    (referrer_id, user_id)
                )
                print(f"[注册] 推荐关系创建成功 - referrer_id={referrer_id}, referee_id={user_id}")
            except Exception as e:
                print(f"[注册] 警告：无法创建referral_relationships记录: {e}")
                pass

        conn.commit()

        # 获取新创建的用户数据
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        new_user = cursor.fetchone()

        conn.close()

        print(f"[注册] 用户注册成功 - user_id={user_id}, username={username}, phone={phone}")

        # 生成token
        token = generate_token(user_id)

        return jsonify({
            'success': True,
            'message': '注册成功',
            'data': {
                'token': token,
                'user': format_user_data(new_user)
            }
        })

    except Exception as e:
        import traceback
        error_msg = str(e)
        print(f"[注册] 注册失败: {error_msg}")
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'注册失败: {error_msg}',
            'error_code': 'INTERNAL_ERROR'
        }), 500

@app.route('/api/login', methods=['POST'])
def login():
    """用户登录"""
    # 获取客户端标识符（优先使用用户名，其次是IP）
    data = request.json
    username = data.get('username', '') if data else ''
    ip_address = request.remote_addr
    identifier = username if username else ip_address
    
    # 速率限制检查（防止暴力破解）
    is_allowed, remaining, retry_after = check_rate_limit(identifier)
    if not is_allowed:
        return jsonify({
            'success': False,
            'message': f'登录尝试次数过多，请{retry_after // 60}分钟后再试',
            'error_code': 'TOO_MANY_ATTEMPTS',
            'retry_after': retry_after
        }), 429
    
    # 添加请求日志
    print(f"[LOGIN_DEBUG] 收到登录请求: {ip_address}, {request.headers.get('User-Agent')}")
    print(f"[LOGIN_DEBUG] 请求数据: {request.json if request.is_json else 'No JSON'}")

    try:
        data = request.json
        username = data.get('username')
        password = data.get('password')

        if not username or not password:
            return jsonify({
                'success': False,
                'message': '用户名和密码不能为空',
                'error_code': 'MISSING_CREDENTIALS'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 支持手机号或用户名登录（优化：只选择必要字段）
        cursor.execute(
            "SELECT id, username, password_hash, status, avatar_url FROM users WHERE username = ? OR phone = ?",
            (username, username)
        )
        user = cursor.fetchone()

        if not user:
            conn.close()
            record_login_attempt(identifier)  # 记录失败的登录尝试
            print(f"[登录] 用户不存在: {username}")
            return jsonify({
                'success': False,
                'message': '用户名或密码错误',
                'error_code': 'USER_NOT_FOUND'
            }), 401

        # 验证密码（安全：不打印密码hash）
        is_valid = verify_password(password, user['password_hash'])
        print(f"[登录] 密码验证结果: {'成功' if is_valid else '失败'}")
        
        if not is_valid:
            conn.close()
            record_login_attempt(identifier)  # 记录失败的登录尝试
            return jsonify({
                'success': False,
                'message': '用户名或密码错误',
                'error_code': 'INVALID_PASSWORD'
            }), 401

        # 生成token（允许多设备登录，不删除旧会话）
        token = generate_token(user['id'])

        # 获取客户端信息
        ip_address = request.remote_addr
        user_agent = request.headers.get('User-Agent', '')

        # 生成设备ID
        device_id = hashlib.md5(f"{user['id']}_{ip_address}_{user_agent}".encode()).hexdigest()[:32]

        # 记录登录会话
        expires_at = datetime.now() + timedelta(seconds=JWT_EXPIRATION)
        cursor.execute(
            """INSERT INTO login_sessions (user_id, token, device_id, ip_address, user_agent, expires_at)
               VALUES (?, ?, ?, ?, ?, ?)""",
            (user['id'], token, device_id, ip_address, user_agent, expires_at)
        )

        # 记录或更新设备信息
        cursor.execute(
            """SELECT id FROM user_devices WHERE user_id = ? AND device_id = ?""",
            (user['id'], device_id)
        )
        existing_device = cursor.fetchone()

        device_name = f"设备-{device_id[:8]}"
        device_type = "Unknown"

        # 简单识别设备类型
        if 'iPhone' in user_agent or 'iPad' in user_agent:
            device_type = "iOS"
            device_name = "iPhone/iPad"
        elif 'Android' in user_agent:
            device_type = "Android"
            device_name = "Android设备"
        elif 'Mac' in user_agent:
            device_type = "Mac"
            device_name = "Mac电脑"
        elif 'Windows' in user_agent:
            device_type = "Windows"
            device_name = "Windows电脑"

        if existing_device:
            # 更新现有设备
            cursor.execute(
                """UPDATE user_devices
                   SET is_current = 1, last_active_at = CURRENT_TIMESTAMP,
                       ip_address = ?, user_agent = ?, device_name = ?, device_type = ?
                   WHERE user_id = ? AND device_id = ?""",
                (ip_address, user_agent, device_name, device_type, user['id'], device_id)
            )
        else:
            # 记录新设备
            cursor.execute(
                """INSERT INTO user_devices
                   (user_id, device_id, device_name, device_type, user_agent, ip_address, is_current, last_active_at)
                   VALUES (?, ?, ?, ?, ?, ?, 1, CURRENT_TIMESTAMP)""",
                (user['id'], device_id, device_name, device_type, user_agent, ip_address)
            )

        # 将其他设备标记为非当前
        cursor.execute(
            """UPDATE user_devices SET is_current = 0 WHERE user_id = ? AND device_id != ?""",
            (user['id'], device_id)
        )

        # 更新用户最后登录时间
        cursor.execute(
            "UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?",
            (user['id'],)
        )

        # 记录安全日志
        cursor.execute(
            """INSERT INTO security_logs (user_id, event_type, ip_address, user_agent, details)
               VALUES (?, 'login', ?, ?, ?)""",
            (user['id'], ip_address, user_agent, json.dumps({'device_id': device_id, 'device_name': device_name}))
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '登录成功',
            'data': {
                'token': token,
                'user': format_user_data(user),
                'device': {
                    'device_id': device_id,
                    'device_name': device_name,
                    'device_type': device_type
                }
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'登录失败: {str(e)}'
        }), 500
# ============ 找回密码 ============

@app.route('/api/send-code', methods=['POST'])
def send_code():
    """发送短信验证码"""
    try:
        data = request.json
        phone = data.get('phone')

        if not phone:
            return jsonify({
                'success': False,
                'message': '手机号不能为空'
            }), 400

        # 检查手机号格式
        if not phone.isdigit() or len(phone) != 11 or not phone.startswith('1'):
            return jsonify({
                'success': False,
                'message': '手机号格式不正确'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 检查手机号是否已注册
        cursor.execute("SELECT id FROM users WHERE phone = ?", (phone,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({
                'success': False,
                'message': '该手机号未注册，请使用"用户名+邮箱"方式找回密码'
            }), 400

        # 生成6位验证码
        code = ''.join(random.choices(string.digits, k=6))

        # 存储验证码（5分钟有效期）
        verification_codes[phone] = {
            'code': code,
            'expire_at': datetime.now().timestamp() + 300
        }

        print(f"[调试] 手机号 {phone} 验证码: {code}")

        # TODO: 实际项目中需要调用短信服务发送验证码
        # 这里为了演示，直接返回成功

        conn.close()
        return jsonify({
            'success': True,
            'message': '验证码已发送',
            'data': {
                'code': code  # 仅用于测试，生产环境需要删除
            }
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'发送验证码失败: {str(e)}'
        }), 500

@app.route('/api/verify-code', methods=['POST'])
def verify_code():
    """验证验证码"""
    try:
        data = request.json
        phone = data.get('phone')
        code = data.get('code')

        if not phone or not code:
            return jsonify({
                'success': False,
                'message': '手机号和验证码不能为空'
            }), 400

        # 检查验证码
        if phone not in verification_codes:
            return jsonify({
                'success': False,
                'message': '验证码不存在或已过期'
            }), 400

        stored = verification_codes[phone]

        # 检查是否过期
        if datetime.now().timestamp() > stored['expire_at']:
            del verification_codes[phone]
            return jsonify({
                'success': False,
                'message': '验证码已过期'
            }), 400

        # 验证码校验
        if stored['code'] != code:
            return jsonify({
                'success': False,
                'message': '验证码错误'
            }), 400

        return jsonify({
            'success': True,
            'message': '验证码验证成功'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'验证失败: {str(e)}'
        }), 500

@app.route('/api/verify-user', methods=['POST'])
def verify_user():
    """通过用户名和邮箱验证用户（用于老用户找回密码）"""
    try:
        data = request.json
        username = data.get('username')
        email = data.get('email')

        if not username or not email:
            return jsonify({
                'success': False,
                'message': '用户名和邮箱不能为空'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 查询用户
        cursor.execute(
            "SELECT id, username, email FROM users WHERE username = ? AND email = ?",
            (username, email)
        )
        user = cursor.fetchone()
        conn.close()

        if not user:
            return jsonify({
                'success': False,
                'message': '用户名或邮箱不正确'
            }), 400

        return jsonify({
            'success': True,
            'message': '验证成功',
            'data': {
                'id': user['id'],
                'username': user['username'],
                'email': user['email']
            }
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'验证失败: {str(e)}'
        }), 500

@app.route('/api/send-verify-code', methods=['POST'])
def send_verify_code():
    """发送验证码到手机"""
    try:
        data = request.json
        phone = data.get('phone')

        if not phone:
            return jsonify({
                'success': False,
                'message': '手机号不能为空'
            }), 400

        # 验证手机号格式
        if not phone.isdigit() or len(phone) != 11:
            return jsonify({
                'success': False,
                'message': '手机号格式不正确'
            }), 400

        # 检查用户是否存在
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT id FROM users WHERE phone = ?", (phone,))
        user = cursor.fetchone()
        conn.close()

        if not user:
            return jsonify({
                'success': False,
                'message': '该手机号未注册'
            }), 400

        # 生成6位随机验证码
        import random
        verify_code = str(random.randint(100000, 999999))

        # 这里应该调用短信服务商API发送验证码
        # 暂时只记录到日志，实际应用中需要集成短信服务
        print(f"[验证码] 发送到 {phone}: {verify_code}")

        # TODO: 将验证码存储到Redis或数据库，设置过期时间（5分钟）
        # 暂时直接返回成功，用于测试

        return jsonify({
            'success': True,
            'message': '验证码已发送',
            # 测试模式下返回验证码，生产环境必须删除
            'verify_code': verify_code  # 仅用于测试，生产环境必须删除
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'发送验证码失败: {str(e)}'
        }), 500


@app.route('/api/reset-password', methods=['POST'])
def reset_password():
    """通过手机号和验证码重置密码"""
    try:
        data = request.json
        phone = data.get('phone')
        code = data.get('code')
        newPassword = data.get('newPassword')

        if not phone or not code or not newPassword:
            return jsonify({
                'success': False,
                'message': '参数不完整'
            }), 400

        # 再次验证验证码
        if phone not in verification_codes:
            return jsonify({
                'success': False,
                'message': '请先获取验证码'
            }), 400

        stored = verification_codes[phone]

        # 检查是否过期
        if datetime.now().timestamp() > stored['expire_at']:
            del verification_codes[phone]
            return jsonify({
                'success': False,
                'message': '验证码已过期'
            }), 400

        # 验证码校验
        if stored['code'] != code:
            return jsonify({
                'success': False,
                'message': '验证码错误'
            }), 400

        # 更新密码
        conn = get_db()
        cursor = conn.cursor()

        password_hash = hash_password(newPassword)
        cursor.execute(
            "UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE phone = ?",
            (password_hash, phone)
        )

        conn.commit()
        affected = cursor.rowcount
        conn.close()

        if affected == 0:
            return jsonify({
                'success': False,
                'message': '用户不存在'
            }), 400

        # 清除验证码
        del verification_codes[phone]

        return jsonify({
            'success': True,
            'message': '密码重置成功'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'重置密码失败: {str(e)}'
        }), 500

@app.route('/api/reset-password-by-username', methods=['POST'])
def reset_password_by_username():
    """通过用户名和邮箱重置密码"""
    try:
        data = request.json
        username = data.get('username')
        email = data.get('email')
        newPassword = data.get('newPassword')

        if not username or not email or not newPassword:
            return jsonify({
                'success': False,
                'message': '参数不完整'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 查询用户
        cursor.execute(
            "SELECT id FROM users WHERE username = ? AND email = ?",
            (username, email)
        )
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({
                'success': False,
                'message': '用户名或邮箱不正确'
            }), 400

        # 更新密码
        password_hash = hash_password(newPassword)
        cursor.execute(
            "UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (password_hash, user['id'])
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '密码重置成功'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'重置密码失败: {str(e)}'
        }), 500

@app.route('/api/test/simple', methods=['GET'])
def test_simple():
    """简单测试路由"""
    return jsonify({
        'success': True,
        'message': 'Simple test works',
        'data': {'test': 'value'}
    })

@app.route('/api/test/debug', methods=['GET'])
def test_debug():
    """测试路由"""
    print(f"[DEBUG] test_debug called")
    try:
        return jsonify({
            'success': True,
            'message': 'Test route works'
        })
    except Exception as e:
        print(f"[ERROR] test_debug error: {e}")
        import traceback
        print(f"[ERROR] traceback: {traceback.format_exc()}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/user/info', methods=['GET'])
def get_user_info():
    """获取用户信息"""
    import json
    try:
        print(f"[DEBUG] get_user_info called")
        print(f"[DEBUG] json module: {json}")
        auth_header = request.headers.get('Authorization')
        print(f"[DEBUG] auth_header: {auth_header[:20] if auth_header else None}")
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        print(f"[DEBUG] user_id: {user_id}")

        if not user_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()

        # 检查用户是否存在
        if not user:
            conn.close()
            return jsonify({
                'success': False,
                'message': '用户不存在'
            }), 401

        # 将Row对象转换为字典
        user_dict = dict(user)

        # 确保total_lingzhi字段存在且不为null
        if 'total_lingzhi' not in user_dict or user_dict['total_lingzhi'] is None:
            user_dict['total_lingzhi'] = 0

        # 为了兼容性，添加lingzhi字段（与total_lingzhi相同）
        user_dict['lingzhi'] = user_dict['total_lingzhi']

        # 获取推荐人信息
        if user_dict.get('referee_id'):
            cursor.execute("SELECT username FROM users WHERE id = ?", (user_dict['referee_id'],))
            referee = cursor.fetchone()
            if referee:
                user_dict['referee_username'] = referee['username']

        conn.close()

        # 构建响应数据
        response_data = {
            'success': True,
            'data': user_dict
        }

        # 使用jsonify返回JSON（Flask内置）
        return jsonify(response_data)

    except Exception as e:
        error_data = {
            'success': False,
            'error': str(e),
            'message': f'获取用户信息失败: {str(e)}'
        }
        return jsonify(error_data), 500

# ============ 推荐功能 ============

@app.route('/api/user/referral-stats', methods=['GET'])
def get_referral_stats():
    """获取用户推荐统计"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 查询推荐总数
        cursor.execute('''
            SELECT COUNT(*) as total
            FROM users
            WHERE referrer_id = ?
        ''', (user_id,))
        total_referrals = cursor.fetchone()['total']

        # 查询活跃推荐数（最近30天有登录的）
        thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d %H:%M:%S')
        cursor.execute('''
            SELECT COUNT(*) as active
            FROM users
            WHERE referrer_id = ? AND last_login_at > ?
        ''', (user_id, thirty_days_ago))
        active_referrals = cursor.fetchone()['active']

        # 查询总奖励
        cursor.execute('''
            SELECT COALESCE(SUM(referral_reward), 0) as total_rewards
            FROM user_transactions
            WHERE user_id = ? AND transaction_type = 'referral'
        ''', (user_id,))
        total_rewards = cursor.fetchone()['total_rewards']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'totalReferrals': total_referrals,
                'activeReferrals': active_referrals,
                'totalRewards': total_rewards
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取推荐统计失败: {str(e)}'}), 500

@app.route('/api/user/referrals', methods=['GET'])
def get_referrals():
    """获取用户推荐列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, username, email, phone, created_at, last_login_at
            FROM users
            WHERE referrer_id = ?
            ORDER BY created_at DESC
            LIMIT 20
        ''', (user_id,))
        referrals = cursor.fetchall()

        thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d %H:%M:%S')

        referral_list = []
        for referral in referrals:
            is_active = referral['last_login_at'] and referral['last_login_at'] > thirty_days_ago
            referral_list.append({
                'id': referral['id'],
                'username': referral['username'],
                'email': referral['email'],
                'phone': referral['phone'],
                'createdAt': referral['created_at'],
                'status': 'active' if is_active else 'inactive'
            })

        conn.close()

        return jsonify({
            'success': True,
            'data': referral_list
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取推荐列表失败: {str(e)}'}), 500

@app.route('/api/user/referral/validate', methods=['POST'])
def validate_referral_code_post():
    """验证推荐码"""
    try:
        data = request.get_json()
        referral_code = data.get('code')

        if not referral_code:
            return jsonify({'success': False, 'message': '推荐码不能为空'}), 400

        # 解析推荐码
        # 推荐码格式：LZ{user_id}{random}{timestamp}
        if not referral_code.startswith('LZ'):
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        code_body = referral_code[2:]  # 去掉 LZ 前缀
        if len(code_body) < 6:
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        # 提取用户ID（前部分）
        user_id_str = code_body[:8]
        try:
            user_id = int(user_id_str, 36)
        except:
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        if user_id <= 0:
            return jsonify({'success': False, 'message': '推荐码无效'}), 400

        # 查询推荐人信息
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute('''
            SELECT id, username, avatar_url
            FROM users
            WHERE id = ?
        ''', (user_id,))
        referrer = cursor.fetchone()
        conn.close()

        if not referrer:
            return jsonify({'success': False, 'message': '推荐人不存在'}), 400

        return jsonify({
            'success': True,
            'data': {
                'valid': True,
                'referrerId': referrer['id'],
                'referrerUsername': referrer['username'],
                'referrerAvatar': referrer.get('avatar_url', '')
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'验证推荐码失败: {str(e)}'}), 500

@app.route('/api/user/referral/apply', methods=['POST'])
def apply_referral_code():
    """应用推荐码"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        referral_code = data.get('code')

        if not referral_code:
            return jsonify({'success': False, 'message': '推荐码不能为空'}), 400

        # 解析推荐码
        if not referral_code.startswith('LZ'):
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        code_body = referral_code[2:]
        if len(code_body) < 6:
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        user_id_str = code_body[:8]
        try:
            referrer_id = int(user_id_str, 36)
        except:
            return jsonify({'success': False, 'message': '推荐码格式无效'}), 400

        if referrer_id <= 0:
            return jsonify({'success': False, 'message': '推荐码无效'}), 400

        if referrer_id == user_id:
            return jsonify({'success': False, 'message': '不能使用自己的推荐码'}), 400

        # 检查用户是否已经有推荐人
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute('SELECT referrer_id FROM users WHERE id = ?', (user_id,))
        current_referrer = cursor.fetchone()

        if current_referrer and current_referrer['referrer_id']:
            conn.close()
            return jsonify({
                'success': False,
                'message': '您已经使用了推荐码'
            }), 400

        # 验证推荐人是否存在
        cursor.execute('SELECT id, username FROM users WHERE id = ?', (referrer_id,))
        referrer = cursor.fetchone()

        if not referrer:
            conn.close()
            return jsonify({'success': False, 'message': '推荐人不存在'}), 400

        # 更新用户的推荐人
        reward = 10  # 推荐奖励
        cursor.execute('''
            UPDATE users
            SET referrer_id = ?, total_lingzhi = total_lingzhi + ?
            WHERE id = ?
        ''', (referrer_id, reward, user_id))

        # 记录交易
        cursor.execute('''
            INSERT INTO user_transactions (user_id, transaction_type, amount, description, created_at)
            VALUES (?, 'referral', ?, '推荐奖励', CURRENT_TIMESTAMP)
        ''', (referrer_id, reward))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'applied': True,
                'reward': reward,
                'message': f'成功使用推荐码，获得 {reward} 灵值'
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'应用推荐码失败: {str(e)}'}), 500

# ============ 签到功能 ============

@app.route('/api/checkin', methods=['POST'])
def checkin():
    """签到"""
    try:
        print(f"[DEBUG] 签到请求开始")
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        print(f"[DEBUG] Token: {token[:20] if token else 'None'}...")
        user_id = verify_token(token)

        if not user_id:
            print(f"[DEBUG] Token验证失败")
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        print(f"[DEBUG] 用户ID: {user_id}")
        today = date.today()

        conn = get_db()
        cursor = conn.cursor()
        print(f"[DEBUG] 数据库连接成功")

        # 检查是否已签到
        cursor.execute(
            "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
            (user_id, today)
        )
        if cursor.fetchone():
            conn.close()
            return jsonify({
                'success': False,
                'message': '今天已经签到过了'
            }), 400

        # 计算连续签到天数
        streak = 1

        for i in range(1, 8):  # 检查前7天
            check_date = today - timedelta(days=i)
            cursor.execute(
                "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
                (user_id, check_date)
            )
            record = cursor.fetchone()
            if record:
                streak += 1
            else:
                break

        # 从系统配置中读取签到奖励
        cursor.execute("SELECT config_value FROM system_configs WHERE config_key = 'checkin_reward'")
        config_row = cursor.fetchone()
        rewards = int(config_row['config_value']) if config_row else 10

        # 每次签到都给相同的奖励
        next_rewards = rewards

        # 生成奖励说明（固定奖励）
        reward_tips = [f"每日签到: {rewards}灵值"]

        # 执行签到
        cursor.execute(
            "INSERT INTO checkin_records (user_id, checkin_date, lingzhi_earned) VALUES (?, ?, ?)",
            (user_id, today, rewards)
        )

        # 更新用户总灵值
        cursor.execute(
            "UPDATE users SET total_lingzhi = total_lingzhi + ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (rewards, user_id)
        )

        # 获取用户更新后的总灵值
        cursor.execute("SELECT total_lingzhi FROM users WHERE id = ?", (user_id,))
        user_data = cursor.fetchone()
        total_lingzhi = user_data['total_lingzhi'] if user_data else 0

        conn.commit()
        conn.close()

        # 构建详细消息
        message = f"🎉 签到成功！已连续签到 {streak} 天，获得 {rewards} 灵值"
        message += f"\n\n💡 每日签到可获得 {rewards} 灵值"
        message += f"\n   📅 连续签到保持好习惯哦"

        return jsonify({
            'success': True,
            'message': message,
            'data': {
                'streak': streak,
                'rewards': rewards,  # 本次获得的灵值
                'total_lingzhi': total_lingzhi,  # 总灵值
                'todayLingzhi': rewards,  # 今日获得的灵值（本次）
                'reward': rewards,  # 奖励值
                'rewardSchedule': reward_tips,  # 奖励说明
                'rewardTip': f"每日签到奖励：{rewards} 灵值"
            }
        })

    except Exception as e:
        print(f"签到错误: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'签到失败: {str(e)}'
        }), 500

@app.route('/api/checkin/status', methods=['GET'])
def checkin_status():
    """获取今日签到状态"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权',
                'data': {
                    'hasCheckedIn': False,
                    'streak': 0,
                    'todayLingzhi': 0
                }
            }), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({
                'success': False,
                'message': 'token无效',
                'data': {
                    'hasCheckedIn': False,
                    'streak': 0,
                    'todayLingzhi': 0
                }
            }), 401

        today = date.today()

        conn = get_db()
        cursor = conn.cursor()

        # 检查今日是否已签到
        cursor.execute(
            "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
            (user_id, today)
        )
        today_record = cursor.fetchone()
        has_checked_in = today_record is not None
        today_lingzhi = today_record['lingzhi_earned'] if today_record else 0

        # 计算连续签到天数
        streak = 0
        if has_checked_in:
            streak = 1
            # 计算连续签到天数（包括今天）
            for i in range(1, 8):  # 检查前7天
                check_date = today - timedelta(days=i)
                cursor.execute(
                    "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
                    (user_id, check_date)
                )
                record = cursor.fetchone()
                if record:
                    streak += 1
                else:
                    break

        # 如果今天没有签到，检查昨天的签到记录来计算连续天数
        if not has_checked_in:
            yesterday = today - timedelta(days=1)
            cursor.execute(
                "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
                (user_id, yesterday)
            )
            yesterday_record = cursor.fetchone()
            if yesterday_record:
                streak = 1
                # 检查昨天之前的连续天数
                for i in range(2, 8):  # 检查前2-7天
                    check_date = today - timedelta(days=i)
                    cursor.execute(
                        "SELECT * FROM checkin_records WHERE user_id = ? AND checkin_date = ?",
                        (user_id, check_date)
                    )
                    record = cursor.fetchone()
                    if record:
                        streak += 1
                    else:
                        break

        # 从系统配置中读取签到奖励
        cursor.execute("SELECT config_value FROM system_configs WHERE config_key = 'checkin_reward'")
        config_row = cursor.fetchone()
        rewards = int(config_row['config_value']) if config_row else 10

        # 每次签到都给相同的奖励
        next_rewards = rewards

        # 生成奖励说明（固定奖励）
        reward_tips = [f"每日签到: {rewards}灵值"]

        conn.close()

        # 构建详细消息
        if has_checked_in:
            message = f"今日已签到，连续 {streak} 天，获得 {today_lingzhi} 灵值"
            message += f"\n\n💡 每日签到可获得 {rewards} 灵值"
            message += f"\n   📅 连续签到保持好习惯哦"
        else:
            message = f"今日尚未签到，签到可获得 {next_rewards} 灵值"
            message += f"\n\n💡 签到福利说明："
            message += f"\n   💰 每日签到可获得 {rewards} 灵值"

        return jsonify({
            'success': True,
            'message': message,
            'data': {
                'canCheckIn': not has_checked_in,
                'checkedIn': has_checked_in,
                'today': has_checked_in,
                'streak': streak,
                'lingzhi': today_lingzhi,  # 今日获得的灵值
                'todayLingzhi': today_lingzhi,
                'nextRewards': next_rewards,
                'nextDay': streak + 1,
                'reward': rewards,
                'rewardSchedule': reward_tips,
                'rewardTip': f"每日签到奖励：{rewards} 灵值"
            }
        })

    except Exception as e:
        print(f"获取签到状态错误: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'获取签到状态失败: {str(e)}',
            'data': {
                'hasCheckedIn': False,
                'streak': 0,
                'todayLingzhi': 0
            }
        }), 500

# ============ 用户反馈 ============

# 敏感词列表（可根据需要扩展）
SENSITIVE_WORDS = [
    '测试', 'test', '123', 'abc', 'xxx', '啊啊啊', '呵呵', '哈哈', 
    '哈哈哈哈', '嘻嘻', '嘿嘿', '不错', '好的', 'ok', 'OK',
    '111', '222', '333', '444', '555', '666', '777', '888', '999', '000'
]

def is_valid_feedback_content(content: str) -> tuple[bool, str]:
    """
    验证反馈内容的有效性
    
    返回: (是否有效, 错误信息)
    """
    if not content or not content.strip():
        return False, "内容不能为空"
    
    content = content.strip()
    
    # 长度检查
    if len(content) < 10:
        return False, "反馈内容太短，请至少输入10个字符"
    
    if len(content) > 1000:
        return False, "反馈内容太长，请控制在1000字以内"
    
    # 检查纯数字
    if content.isdigit():
        return False, "反馈内容不能为纯数字"
    
    # 检查纯符号
    if all(not c.isalnum() for c in content):
        return False, "反馈内容不能为纯符号"
    
    # 检查敏感词
    for word in SENSITIVE_WORDS:
        if word in content:
            return False, "反馈内容包含无效信息"
    
    # 检查重复字符（超过80%是同一个字符）
    if content and content[0] * len(content) == content:
        return False, "反馈内容不能为重复字符"
    
    # 检查内容质量：至少包含一定比例的汉字或字母
    alnum_count = sum(1 for c in content if c.isalnum())
    if alnum_count / len(content) < 0.3:
        return False, "反馈内容质量太低"
    
    return True, ""

def check_duplicate_feedback(conn, user_id: int, comment: str) -> bool:
    """检查用户是否在24小时内提交过相同内容的反馈"""
    cursor = conn.cursor()
    
    # 获取24小时内的反馈
    from datetime import datetime, timedelta
    yesterday = datetime.now() - timedelta(hours=24)
    
    cursor.execute("""
        SELECT comment FROM feedback 
        WHERE user_id = ? AND created_at > ?
    """, (user_id, yesterday))
    
    recent_comments = cursor.fetchall()
    
    for recent in recent_comments:
        # 简单的相似度检查：如果内容完全相同
        if recent['comment'] == comment:
            return True
    
    return False

@app.route('/api/feedback', methods=['POST'])
def submit_feedback():
    """提交用户反馈"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        data = request.json
        agent_id = data.get('agent_id', 1)  # 默认智能体ID为1
        feedback_type = data.get('type')  # bug / feature / suggestion / navigation / other
        question = data.get('question', '')  # 主题
        comment = data.get('comment', '')  # 描述
        rating = data.get('rating')  # 可选，评分

        # 验证主题
        if not question or len(question.strip()) < 2:
            return jsonify({
                'success': False,
                'message': '主题不能为空且至少需要2个字符'
            }), 400
        
        # 验证反馈类型
        if not feedback_type:
            return jsonify({
                'success': False,
                'message': '反馈类型不能为空'
            }), 400

        # 验证描述内容
        is_valid, error_msg = is_valid_feedback_content(comment)
        if not is_valid:
            return jsonify({
                'success': False,
                'message': error_msg
            }), 400

        # 确定贡献值
        contribution_value = 5  # 默认5灵值
        if feedback_type == 'bug':
            contribution_value = 5
        elif feedback_type == 'feature':
            contribution_value = 10  # 功能建议最有价值
        elif feedback_type == 'suggestion':
            contribution_value = 10  # 建议很有价值
        elif feedback_type == 'navigation':
            contribution_value = 5
        elif feedback_type == 'other':
            contribution_value = 3

        conn = get_db()
        cursor = conn.cursor()

        # 检查重复反馈
        if check_duplicate_feedback(conn, user_id, comment):
            conn.close()
            return jsonify({
                'success': False,
                'message': '您在24小时内已提交过相同的反馈，请勿重复提交'
            }), 400

        # 插入反馈记录
        cursor.execute(
            """INSERT INTO feedback (agent_id, user_id, type, question, comment, rating, contribution_value)
               VALUES (?, ?, ?, ?, ?, ?, ?)""",
            (agent_id, user_id, feedback_type, question, comment, rating, contribution_value)
        )

        # 增加用户灵值
        cursor.execute(
            "UPDATE users SET total_lingzhi = total_lingzhi + ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (contribution_value, user_id)
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'反馈提交成功，获得 {contribution_value} 灵值',
            'data': {
                'contribution_value': contribution_value
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'message': f'提交反馈失败: {str(e)}'
        }), 500

@app.route('/api/feedback', methods=['GET'])
def get_user_feedback():
    """获取用户反馈历史"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        conn = get_db()
        cursor = conn.cursor()

        # 获取用户的反馈历史
        cursor.execute(
            """SELECT id, type, question, comment, rating, contribution_value, created_at
               FROM feedback WHERE user_id = ? ORDER BY created_at DESC LIMIT 20""",
            (user_id,)
        )
        feedback_list = cursor.fetchall()
        conn.close()

        return jsonify({
            'success': True,
            'data': [dict(f) for f in feedback_list]
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'获取反馈历史失败: {str(e)}'
        }), 500


# ============ 设备管理和安全设置 API ============

@app.route('/api/user/devices', methods=['GET'])
def get_user_devices():
    """获取用户的设备列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            """SELECT id, device_id, device_name, device_type, ip_address,
                      location, is_current, last_active_at, created_at
               FROM user_devices WHERE user_id = ?
               ORDER BY is_current DESC, last_active_at DESC""",
            (user_id,)
        )
        devices = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': [dict(d) for d in devices]
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取设备列表失败: {str(e)}'}), 500

@app.route('/api/user/devices/<device_id>', methods=['DELETE'])
def remove_device(device_id):
    """移除设备"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 不能删除当前设备
        cursor.execute(
            "SELECT is_current FROM user_devices WHERE user_id = ? AND device_id = ?",
            (user_id, device_id)
        )
        device = cursor.fetchone()

        if not device:
            conn.close()
            return jsonify({'success': False, 'message': '设备不存在'}), 404

        if device['is_current']:
            conn.close()
            return jsonify({'success': False, 'message': '不能移除当前设备'}), 400

        # 删除设备
        cursor.execute(
            "DELETE FROM user_devices WHERE user_id = ? AND device_id = ?",
            (user_id, device_id)
        )

        # 删除该设备的登录会话
        cursor.execute(
            "DELETE FROM login_sessions WHERE user_id = ? AND device_id = ?",
            (user_id, device_id)
        )

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '设备已移除'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'移除设备失败: {str(e)}'}), 500

@app.route('/api/user/security/settings', methods=['GET'])
def get_security_settings():
    """获取用户安全设置"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            "SELECT require_phone_verification, single_login_enabled FROM users WHERE id = ?",
            (user_id,)
        )
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'require_phone_verification': bool(user['require_phone_verification'] if 'require_phone_verification' in user.keys() else 1),
                'single_login_enabled': bool(user['single_login_enabled'] if 'single_login_enabled' in user.keys() else 1)
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取安全设置失败: {str(e)}'}), 500

@app.route('/api/user/security/settings', methods=['PUT'])
def update_security_settings():
    """更新用户安全设置"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        require_phone_verification = data.get('require_phone_verification')
        single_login_enabled = data.get('single_login_enabled')

        conn = get_db()
        cursor = conn.cursor()

        # 更新设置
        if require_phone_verification is not None:
            cursor.execute(
                "UPDATE users SET require_phone_verification = ? WHERE id = ?",
                (1 if require_phone_verification else 0, user_id)
            )

        if single_login_enabled is not None:
            cursor.execute(
                "UPDATE users SET single_login_enabled = ? WHERE id = ?",
                (1 if single_login_enabled else 0, user_id)
            )

        # 如果启用了单点登录，删除所有旧的会话
        if single_login_enabled:
            # 保留当前会话
            current_token = request.headers.get('Authorization', '').replace('Bearer ', '')
            cursor.execute(
                """DELETE FROM login_sessions WHERE user_id = ? AND token != ?""",
                (user_id, current_token)
            )

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '安全设置已更新'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'更新安全设置失败: {str(e)}'}), 500

@app.route('/api/user/security/logs', methods=['GET'])
def get_security_logs():
    """获取用户安全日志"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            """SELECT id, event_type, ip_address, user_agent, details, created_at
               FROM security_logs WHERE user_id = ?
               ORDER BY created_at DESC LIMIT 50""",
            (user_id,)
        )
        logs = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': [dict(l) for l in logs]
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取安全日志失败: {str(e)}'}), 500

@app.route('/api/user/devices/revoke-all', methods=['POST'])
def revoke_all_other_devices():
    """移除所有其他设备（仅保留当前设备）"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 获取当前设备的ID
        cursor.execute(
            "SELECT device_id FROM login_sessions WHERE token = ?",
            (token,)
        )
        session = cursor.fetchone()

        if not session:
            conn.close()
            return jsonify({'success': False, 'message': '会话不存在'}), 404

        current_device_id = session['device_id']

        # 删除所有其他设备和会话
        cursor.execute(
            """DELETE FROM login_sessions WHERE user_id = ? AND device_id != ?""",
            (user_id, current_device_id)
        )
        deleted_sessions = cursor.rowcount

        cursor.execute(
            """DELETE FROM user_devices WHERE user_id = ? AND device_id != ?""",
            (user_id, current_device_id)
        )
        deleted_devices = cursor.rowcount

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'已移除 {deleted_devices} 个设备和 {deleted_sessions} 个会话'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'操作失败: {str(e)}'}), 500


# ============ 后台管理 ============

@app.route('/api/admin/login', methods=['POST'])
def admin_login():
    """管理员登录"""
    # 获取客户端标识符（优先使用用户名，其次是IP）
    data = request.json
    username = data.get('username', '') if data else ''
    ip_address = request.remote_addr
    identifier = f"admin_{username}" if username else f"admin_{ip_address}"
    
    # 速率限制检查（防止暴力破解）
    is_allowed, remaining, retry_after = check_rate_limit(identifier)
    if not is_allowed:
        return jsonify({
            'success': False,
            'message': f'登录尝试次数过多，请{retry_after // 60}分钟后再试',
            'error_code': 'TOO_MANY_ATTEMPTS',
            'retry_after': retry_after
        }), 429
    
    try:
        data = request.json
        username = data.get('username')
        password = data.get('password')

        if not username or not password:
            return jsonify({
                'success': False,
                'message': '用户名和密码不能为空'
            }), 400

        conn = get_db()
        cursor = conn.cursor()

        # 查询管理员（优化：只选择必要字段）
        cursor.execute(
            "SELECT id, username, password_hash, role FROM admins WHERE username = ?",
            (username,)
        )
        admin = cursor.fetchone()

        if not admin:
            # 记录登录失败日志
            ip_address = request.remote_addr
            user_agent = request.headers.get('User-Agent', '')
            cursor.execute(
                """INSERT INTO security_logs (user_id, event_type, ip_address, user_agent, details)
                   VALUES (?, 'admin_login_failed', ?, ?, ?)""",
                (None, ip_address, user_agent, json.dumps({'username': username, 'reason': '用户不存在'}))
            )
            conn.commit()
            conn.close()
            record_login_attempt(identifier)  # 记录失败的登录尝试
            return jsonify({
                'success': False,
                'message': '用户名或密码错误',
                'error_code': 'ADMIN_NOT_FOUND'
            }), 401

        if not verify_password(password, admin['password_hash']):
            # 记录登录失败日志
            ip_address = request.remote_addr
            user_agent = request.headers.get('User-Agent', '')
            cursor.execute(
                """INSERT INTO security_logs (user_id, event_type, ip_address, user_agent, details)
                   VALUES (?, 'admin_login_failed', ?, ?, ?)""",
                (admin['id'], ip_address, user_agent, json.dumps({'username': username, 'reason': '密码错误'}))
            )
            conn.commit()
            conn.close()
            record_login_attempt(identifier)  # 记录失败的登录尝试
            return jsonify({
                'success': False,
                'message': '用户名或密码错误',
                'error_code': 'INVALID_ADMIN_PASSWORD'
            }), 401

        # 生成token
        token = generate_token(admin['id'], role=admin['role'])

        # 记录登录成功日志
        ip_address = request.remote_addr
        user_agent = request.headers.get('User-Agent', '')
        cursor.execute(
            """INSERT INTO security_logs (user_id, event_type, ip_address, user_agent, details)
               VALUES (?, 'admin_login_success', ?, ?, ?)""",
            (admin['id'], ip_address, user_agent, json.dumps({'username': username, 'role': admin['role']}))
        )
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '登录成功',
            'data': {
                'token': token,
                'admin': {
                    'id': admin['id'],
                    'username': admin['username'],
                    'role': admin['role']
                }
            }
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'登录失败: {str(e)}'
        }), 500

# ============ 用户管理 ============

@app.route('/api/admin/users/batch', methods=['POST'])
def admin_batch_update_users():
    """批量更新用户"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        data = request.json
        user_ids = data.get('user_ids', [])
        action = data.get('action')
        value = data.get('value')

        if not user_ids or not action:
            conn.close()
            return jsonify({'success': False, 'message': '参数不完整'}), 400

        # 验证用户是否存在
        placeholders = ','.join(['?' for _ in user_ids])
        cursor.execute(f"SELECT id FROM users WHERE id IN ({placeholders})", user_ids)
        existing_ids = [row[0] for row in cursor.fetchall()]
        missing_ids = set(user_ids) - set(existing_ids)

        if missing_ids:
            conn.close()
            return jsonify({
                'success': False,
                'message': f'用户不存在: {list(missing_ids)}'
            }), 404

        # 执行批量操作
        if action == 'status':
            # 批量更新状态
            if value not in ['active', 'inactive', 'banned']:
                conn.close()
                return jsonify({'success': False, 'message': '无效的状态值'}), 400

            cursor.execute(f"""
                UPDATE users SET status = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id IN ({placeholders})
            """, [value] + user_ids)
            conn.commit()
            conn.close()

            return jsonify({
                'success': True,
                'message': f'已更新 {len(user_ids)} 个用户的状态'
            })

        elif action == 'user_type':
            # 批量更新用户类型
            cursor.execute(f"""
                UPDATE users SET user_type_id = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id IN ({placeholders})
            """, [value] + user_ids)
            conn.commit()
            conn.close()

            return jsonify({
                'success': True,
                'message': f'已更新 {len(user_ids)} 个用户的类型'
            })

        elif action == 'delete':
            # 批量删除
            for user_id in user_ids:
                cursor.execute("DELETE FROM checkin_records WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM sessions WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM partner_applications WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM user_roles WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))

            conn.commit()
            conn.close()

            return jsonify({
                'success': True,
                'message': f'已删除 {len(user_ids)} 个用户'
            })

        elif action == 'delete':
            # 批量删除 - 保护超级管理员
            # 获取要删除的用户名
            placeholders = ','.join(['?' for _ in user_ids])
            cursor.execute(f"SELECT id, username FROM users WHERE id IN ({placeholders})", user_ids)
            users_to_delete = cursor.fetchall()

            # 检查是否包含 admin 用户
            admin_users = [u for u in users_to_delete if u['username'] == 'admin']
            if admin_users:
                conn.close()
                return jsonify({
                    'success': False,
                    'message': '超级管理员不能被删除'
                }), 403

            # 执行批量删除
            for user_id in user_ids:
                cursor.execute("DELETE FROM checkin_records WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM sessions WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM partner_applications WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM user_roles WHERE user_id = ?", (user_id,))
                cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))

            conn.commit()
            conn.close()

            return jsonify({
                'success': True,
                'message': f'已删除 {len(user_ids)} 个用户'
            })

        else:
            conn.close()
            return jsonify({'success': False, 'message': '不支持的操作'}), 400

    except Exception as e:
        return jsonify({'success': False, 'message': f'批量操作失败: {str(e)}'}), 500


@app.route('/api/admin/users', methods=['POST'])
def admin_create_user():
    """管理员创建用户"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        data = request.json
        username = data.get('username')
        password = data.get('password')
        email = data.get('email', '')
        phone = data.get('phone', '')
        real_name = data.get('real_name', '')
        user_type_id = data.get('user_type_id', 1)
        total_lingzhi = data.get('total_lingzhi', 0)
        status = data.get('status', 'active')
        is_verified = data.get('is_verified', 1)
        referrer_id = data.get('referrer_id')  # 推荐人ID

        # 验证必填字段
        if not username or not password:
            conn.close()
            return jsonify({'success': False, 'message': '用户名和密码不能为空'}), 400

        # 验证推荐人是否存在
        if referrer_id:
            cursor.execute("SELECT id FROM users WHERE id = ?", (referrer_id,))
            if not cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '推荐人不存在'}), 400

        # 检查用户名是否已存在
        cursor.execute("SELECT id FROM users WHERE username = ?", (username,))
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '用户名已存在'}), 400

        # 检查邮箱是否已存在
        if email:
            cursor.execute("SELECT id FROM users WHERE email = ?", (email,))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '邮箱已被使用'}), 400

        # 检查手机号是否已存在
        if phone:
            cursor.execute("SELECT id FROM users WHERE phone = ?", (phone,))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '手机号已被使用'}), 400

        # 密码加密
        password_hash = hash_password(password)

        # 创建用户
        cursor.execute("""
            INSERT INTO users (
                username, password_hash, email, phone, real_name,
                user_type_id, total_lingzhi, status, is_verified,
                referrer_id, login_type, created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'admin', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        """, (username, password_hash, email, phone, real_name,
              user_type_id, total_lingzhi, status, is_verified, referrer_id))

        user_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '用户创建成功',
            'data': {
                'id': user_id,
                'username': username
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建用户失败: {str(e)}'}), 500


@app.route('/api/admin/users', methods=['GET'])
def admin_get_users():
    """获取用户列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({
                'success': False,
                'message': '无权限'
            }), 403

        # 获取分页参数和筛选参数
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 10))
        search = request.args.get('search', '')
        status = request.args.get('status', '')
        user_type_id = request.args.get('user_type_id', '')
        min_lingzhi = request.args.get('min_lingzhi', '')
        max_lingzhi = request.args.get('max_lingzhi', '')
        start_date = request.args.get('start_date', '')
        end_date = request.args.get('end_date', '')
        sort_by = request.args.get('sort_by', 'id')
        sort_order = request.args.get('sort_order', 'DESC')

        offset = (page - 1) * limit

        # 构建 WHERE 子句
        where_conditions = []
        params = []

        if search:
            search_pattern = f'%{search}%'
            where_conditions.append("(username LIKE ? OR email LIKE ? OR phone LIKE ? OR real_name LIKE ?)")
            params.extend([search_pattern, search_pattern, search_pattern, search_pattern])

        if status:
            where_conditions.append("status = ?")
            params.append(status)

        if user_type_id:
            where_conditions.append("user_type_id = ?")
            params.append(user_type_id)

        if min_lingzhi:
            where_conditions.append("total_lingzhi >= ?")
            params.append(min_lingzhi)

        if max_lingzhi:
            where_conditions.append("total_lingzhi <= ?")
            params.append(max_lingzhi)

        if start_date:
            where_conditions.append("created_at >= ?")
            params.append(start_date)

        if end_date:
            where_conditions.append("created_at <= ?")
            params.append(end_date)

        where_clause = ''
        if where_conditions:
            where_clause = 'WHERE ' + ' AND '.join(where_conditions)

        # 验证排序字段
        valid_sort_fields = ['id', 'username', 'total_lingzhi', 'created_at', 'last_login_at']
        if sort_by not in valid_sort_fields:
            sort_by = 'id'

        if sort_order.upper() not in ['ASC', 'DESC']:
            sort_order = 'DESC'

        # 查询总数
        count_sql = f"SELECT COUNT(*) as total FROM users {where_clause}"
        cursor.execute(count_sql, params)
        total = cursor.fetchone()['total']

        # 查询用户列表
        list_sql = f"SELECT * FROM users {where_clause} ORDER BY {sort_by} {sort_order} LIMIT ? OFFSET ?"
        cursor.execute(list_sql, params + [limit, offset])
        users = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'users': [dict(row) for row in users],
                'total': total,
                'page': page,
                'limit': limit,
                'totalPages': (total + limit - 1) // limit
            }
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'获取用户列表失败: {str(e)}'
        }), 500

@app.route('/api/admin/users/<int:user_id>', methods=['PUT'])
def admin_update_user(user_id):
    """更新用户信息 - 允许修改除系统字段外的所有字段"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({
                'success': False,
                'message': '无权限'
            }), 403

        # 检查用户是否存在
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({
                'success': False,
                'message': '用户不存在'
            }), 404

        data = request.json

        # 系统字段不允许修改：id, created_at, password_hash
        # 可修改字段：username, email, phone, real_name, avatar_url, status, is_verified,
        #             user_type_id, total_lingzhi, total_contribution, cumulative_contribution,
        #             current_stage, journey_progress, account_status, verification_status,
        #             gender, title, position, permission, etc.

        update_fields = []
        update_values = []

        # 用户名（需要检查唯一性）
        if 'username' in data:
            new_username = data['username']
            if new_username != user['username']:
                cursor.execute("SELECT id FROM users WHERE username = ? AND id != ?",
                             (new_username, user_id))
                if cursor.fetchone():
                    conn.close()
                    return jsonify({
                        'success': False,
                        'message': '用户名已存在'
                    }), 400
                update_fields.append("username = ?")
                update_values.append(new_username)

        # 邮箱
        if 'email' in data and data['email'] != user['email']:
            new_email = data['email']
            if new_email:
                cursor.execute("SELECT id FROM users WHERE email = ? AND id != ?",
                             (new_email, user_id))
                if cursor.fetchone():
                    conn.close()
                    return jsonify({
                        'success': False,
                        'message': '邮箱已被使用'
                    }), 400
            update_fields.append("email = ?")
            update_values.append(new_email)

        # 手机号
        if 'phone' in data and data['phone'] != user['phone']:
            new_phone = data['phone']
            if new_phone:
                cursor.execute("SELECT id FROM users WHERE phone = ? AND id != ?",
                             (new_phone, user_id))
                if cursor.fetchone():
                    conn.close()
                    return jsonify({
                        'success': False,
                        'message': '手机号已被使用'
                    }), 400
            update_fields.append("phone = ?")
            update_values.append(new_phone)

        # 其他字段
        editable_fields = [
            'real_name', 'avatar_url', 'status', 'is_verified',
            'user_type_id', 'total_lingzhi', 'total_contribution',
            'cumulative_contribution', 'current_stage', 'journey_progress',
            'account_status', 'verification_status', 'gender', 'title',
            'position', 'permission', 'level', 'referee_id', 'referrer_id'
        ]

        for field in editable_fields:
            if field in data:
                update_fields.append(f"{field} = ?")
                update_values.append(data[field])

        # 密码修改（如果提供）
        if 'password' in data and data['password']:
            new_password_hash = hash_password(data['password'])
            update_fields.append("password_hash = ?")
            update_values.append(new_password_hash)

        if not update_fields:
            conn.close()
            return jsonify({
                'success': False,
                'message': '没有需要更新的字段'
            }), 400

        # 添加更新时间
        update_fields.append("updated_at = CURRENT_TIMESTAMP")
        update_values.append(user_id)

        # 执行更新
        update_sql = f"UPDATE users SET {', '.join(update_fields)} WHERE id = ?"
        cursor.execute(update_sql, update_values)

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '用户信息更新成功'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'更新用户失败: {str(e)}'
        }), 500

@app.route('/api/admin/users/<int:user_id>', methods=['DELETE'])
def admin_delete_user(user_id):
    """删除用户 - 超级管理员（admin）不能被删除"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({
                'success': False,
                'message': '无权限'
            }), 403

        # 检查用户是否存在
        cursor.execute("SELECT username FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({
                'success': False,
                'message': '用户不存在'
            }), 404

        # 保护超级管理员：admin 用户不能被删除
        if user['username'] == 'admin':
            conn.close()
            return jsonify({
                'success': False,
                'message': '超级管理员不能被删除'
            }), 403

        # 删除用户相关数据（级联删除）
        # 注意：需要先删除依赖数据
        cursor.execute("DELETE FROM checkin_records WHERE user_id = ?", (user_id,))
        cursor.execute("DELETE FROM sessions WHERE user_id = ?", (user_id,))
        cursor.execute("DELETE FROM partner_applications WHERE user_id = ?", (user_id,))
        cursor.execute("DELETE FROM conversations WHERE user_id = ?", (user_id,))
        cursor.execute("DELETE FROM user_roles WHERE user_id = ?", (user_id,))
        cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '用户删除成功'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'删除用户失败: {str(e)}'
        }), 500


@app.route('/api/admin/users/<int:user_id>', methods=['GET'])
def admin_get_user_detail(user_id):
    """获取用户详情"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取用户详情
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()

        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 获取用户签到统计
        cursor.execute("SELECT COUNT(*) as count FROM checkin_records WHERE user_id = ?", (user_id,))
        checkin_count = cursor.fetchone()['count']

        # 获取用户充值记录
        cursor.execute("""
            SELECT COUNT(*) as count, COALESCE(SUM(amount), 0) as total_amount 
            FROM recharge_records 
            WHERE user_id = ? AND payment_status = 'paid'
        """, (user_id,))
        recharge_stats = cursor.fetchone()

        # 获取用户消费记录
        cursor.execute("""
            SELECT COUNT(*) as count, COALESCE(SUM(lingzhi_amount), 0) as total_lingzhi 
            FROM lingzhi_consumption_records 
            WHERE user_id = ?
        """, (user_id,))
        consumption_stats = cursor.fetchone()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'id': user['id'],
                'username': user['username'],
                'email': user['email'],
                'phone': user['phone'],
                'total_lingzhi': user['total_lingzhi'],
                'status': user.get('status', 'active'),
                'last_login_at': user.get('last_login_at'),
                'avatar_url': user.get('avatar_url'),
                'real_name': user.get('real_name'),
                'is_verified': user.get('is_verified', 0),
                'created_at': user['created_at'],
                'updated_at': user['updated_at'],
                'stats': {
                    'checkin_count': checkin_count,
                    'recharge_count': recharge_stats['count'],
                    'recharge_amount': float(recharge_stats['total_amount']),
                    'consumption_count': consumption_stats['count'],
                    'consumption_lingzhi': consumption_stats['total_lingzhi']
                }
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取用户详情失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/status', methods=['PUT'])
def admin_update_user_status(user_id):
    """更新用户状态"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        data = request.json
        status = data.get('status')

        if status not in ['active', 'inactive', 'banned']:
            return jsonify({'success': False, 'message': '无效的状态'}), 400

        # 检查用户是否存在
        cursor.execute("SELECT id FROM users WHERE id = ?", (user_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 更新用户状态
        cursor.execute(
            "UPDATE users SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (status, user_id)
        )
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '用户状态更新成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'更新用户状态失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/lingzhi', methods=['POST'])
def admin_adjust_user_lingzhi(user_id):
    """调整用户灵值"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        data = request.json
        amount = data.get('amount')
        reason = data.get('reason', '管理员调整')

        if not amount:
            return jsonify({'success': False, 'message': '调整金额不能为空'}), 400

        # 检查用户是否存在
        cursor.execute("SELECT id, total_lingzhi FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 调整灵值
        new_lingzhi = user['total_lingzhi'] + amount
        if new_lingzhi < 0:
            conn.close()
            return jsonify({'success': False, 'message': '灵值余额不足'}), 400

        cursor.execute(
            "UPDATE users SET total_lingzhi = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (new_lingzhi, user_id)
        )
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '灵值调整成功',
            'data': {
                'old_lingzhi': user['total_lingzhi'],
                'new_lingzhi': new_lingzhi,
                'adjustment': amount
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'调整灵值失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/password', methods=['PUT'])
def admin_change_user_password(user_id):
    """用户修改密码（无需管理员权限，通过手机验证码验证）"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        token_user_id = verify_token(token)
        if not token_user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 只能修改自己的密码
        if token_user_id != user_id:
            return jsonify({'success': False, 'message': '无权限修改他人密码'}), 403

        data = request.json
        phone = data.get('phone')
        verify_code = data.get('verify_code')
        new_password = data.get('new_password')

        # 验证必填字段
        if not phone or not verify_code or not new_password:
            return jsonify({'success': False, 'message': '手机号、验证码和新密码不能为空'}), 400

        # 检查密码长度
        if len(new_password) < 6:
            return jsonify({'success': False, 'message': '密码长度不能少于6位'}), 400

        # 检查用户是否存在
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT id, username, phone FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 验证手机号
        if user['phone'] != phone:
            conn.close()
            return jsonify({'success': False, 'message': '手机号不匹配'}), 400

        # 验证验证码（这里简化处理，实际应用中应该验证验证码的有效性和时效性）
        # 暂时允许任何6位数字验证码通过
        if len(verify_code) != 6 or not verify_code.isdigit():
            conn.close()
            return jsonify({'success': False, 'message': '验证码格式不正确'}), 400

        # 更新密码
        new_password_hash = hash_password(new_password)
        cursor.execute(
            "UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (new_password_hash, user_id)
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '密码修改成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'修改密码失败: {str(e)}'}), 500


@app.route('/api/admin/users/<int:user_id>/avatar', methods=['POST'])
def admin_upload_user_avatar(user_id):
    """上传用户头像"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 检查是否有上传文件
        if 'avatar' not in request.files:
            conn.close()
            return jsonify({'success': False, 'message': '请上传头像文件'}), 400

        file = request.files['avatar']
        if file.filename == '':
            conn.close()
            return jsonify({'success': False, 'message': '文件名为空'}), 400

        # 验证文件类型
        allowed_extensions = {'jpg', 'jpeg', 'png', 'gif', 'webp'}
        file_ext = file.filename.split('.')[-1].lower() if '.' in file.filename else ''
        if file_ext not in allowed_extensions:
            conn.close()
            return jsonify({'success': False, 'message': '仅支持JPG、PNG、GIF、WEBP格式的图片'}), 400

        # 验证文件大小（最大5MB）
        file.seek(0, os.SEEK_END)
        file_size = file.tell()
        file.seek(0)
        
        if file_size > 5 * 1024 * 1024:
            conn.close()
            return jsonify({'success': False, 'message': '图片大小不能超过5MB'}), 400

        # 检查用户是否存在
        cursor.execute("SELECT id FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 保存文件到上传目录
        upload_dir = '/tmp/avatars'
        if not os.path.exists(upload_dir):
            os.makedirs(upload_dir)
        
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        filename = f"user_{user_id}_{timestamp}_{random.randint(1000, 9999)}.{file_ext}"
        file_path = os.path.join(upload_dir, filename)
        file.save(file_path)
        
        # 生成文件URL
        avatar_url = f"/uploads/avatars/{filename}"

        # 更新数据库中的头像URL
        cursor.execute(
            "UPDATE users SET avatar_url = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
            (avatar_url, user_id)
        )
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '头像上传成功',
            'data': {
                'avatar_url': avatar_url
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'上传头像失败: {str(e)}'}), 500


@app.route('/api/admin/users/search', methods=['GET'])
def admin_search_users():
    """搜索用户"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        keyword = request.args.get('keyword', '')
        limit = int(request.args.get('limit', 10))

        if not keyword:
            conn.close()
            return jsonify({'success': False, 'message': '搜索关键词不能为空'}), 400

        # 搜索用户
        search_pattern = f'%{keyword}%'
        cursor.execute("""
            SELECT id, username, email, phone, total_lingzhi, status, created_at
            FROM users
            WHERE username LIKE ? OR email LIKE ? OR phone LIKE ?
            ORDER BY id DESC
            LIMIT ?
        """, (search_pattern, search_pattern, search_pattern, limit))
        users = cursor.fetchall()
        conn.close()

        return jsonify({
            'success': True,
            'data': [dict(user) for user in users]
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'搜索用户失败: {str(e)}'}), 500

@app.route('/api/admin/users/export', methods=['GET'])
def admin_export_users():
    """导出用户列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取所有用户
        cursor.execute("""
            SELECT id, username, email, phone, total_lingzhi, status, created_at
            FROM users
            ORDER BY id DESC
        """)
        users = cursor.fetchall()
        conn.close()

        # 生成CSV
        import csv
        import io
        output = io.StringIO()
        writer = csv.writer(output)
        writer.writerow(['ID', '用户名', '邮箱', '手机', '灵值', '状态', '注册时间'])
        
        for user in users:
            writer.writerow([
                user['id'],
                user['username'],
                user['email'] if user['email'] else '',
                user['phone'] if user['phone'] else '',
                user['total_lingzhi'],
                user['status'],
                user['created_at']
            ])

        # 返回CSV文件
        output.seek(0)
        from flask import Response
        response = Response(
            output.getvalue(),
            mimetype='text/csv',
            headers={
                'Content-Disposition': 'attachment; filename=users.csv'
            }
        )
        return response

    except Exception as e:
        return jsonify({'success': False, 'message': f'导出用户列表失败: {str(e)}'}), 500


@app.route('/api/admin/users/import', methods=['POST'])
def admin_import_users():
    """导入用户列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 检查文件
        if 'file' not in request.files:
            conn.close()
            return jsonify({'success': False, 'message': '请选择文件'}), 400

        file = request.files['file']
        if file.filename == '':
            conn.close()
            return jsonify({'success': False, 'message': '请选择文件'}), 400

        if not file.filename.endswith('.csv'):
            conn.close()
            return jsonify({'success': False, 'message': '仅支持CSV文件'}), 400

        # 读取CSV文件
        import csv
        import io
        stream = io.StringIO(file.stream.read().decode('UTF-8'))
        reader = csv.DictReader(stream)

        # 验证CSV格式
        required_fields = ['username', 'password']
        if not all(field in reader.fieldnames for field in required_fields):
            conn.close()
            return jsonify({
                'success': False,
                'message': f'CSV文件必须包含以下字段: {", ".join(required_fields)}'
            }), 400

        # 导入用户
        success_count = 0
        error_count = 0
        errors = []

        for row_num, row in enumerate(reader, start=2):  # 从第2行开始（跳过标题行）
            try:
                username = row.get('username', '').strip()
                password = row.get('password', '').strip()
                email = row.get('email', '').strip() or None
                phone = row.get('phone', '').strip() or None

                if not username or not password:
                    errors.append(f'第{row_num}行: 用户名和密码不能为空')
                    error_count += 1
                    continue

                # 检查用户名是否已存在
                cursor.execute("SELECT id FROM users WHERE username = ?", (username,))
                if cursor.fetchone():
                    errors.append(f'第{row_num}行: 用户名 "{username}" 已存在')
                    error_count += 1
                    continue

                # 生成密码哈希
                from werkzeug.security import generate_password_hash
                password_hash = generate_password_hash(password)

                # 插入用户
                cursor.execute("""
                    INSERT INTO users (username, password_hash, email, phone, status, is_verified)
                    VALUES (?, ?, ?, ?, 'active', 1)
                """, (username, password_hash, email, phone))

                success_count += 1

            except Exception as e:
                errors.append(f'第{row_num}行: {str(e)}')
                error_count += 1

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': f'导入完成: 成功 {success_count} 条, 失败 {error_count} 条',
            'data': {
                'success_count': success_count,
                'error_count': error_count,
                'errors': errors[:10]  # 只返回前10个错误
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'导入用户失败: {str(e)}'}), 500

# ============ 用户详细信息管理 API ============

@app.route('/api/admin/users/<int:user_id>/referrals', methods=['GET'])
def admin_get_user_referrals(user_id):
    """获取用户推荐列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取推荐的用户列表
        cursor.execute("""
            SELECT id, username, email, phone, total_lingzhi, status, created_at
            FROM users
            WHERE referrer_id = ?
            ORDER BY created_at DESC
        """, (user_id,))
        referrals = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'user_id': user_id,
                'referral_count': len(referrals),
                'referrals': [dict(row) for row in referrals]
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取推荐列表失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/recharges', methods=['GET'])
def admin_get_user_recharges(user_id):
    """获取用户充值记录"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取分页参数
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 10))
        offset = (page - 1) * limit

        # 获取充值记录
        cursor.execute("""
            SELECT * FROM recharge_records
            WHERE user_id = ?
            ORDER BY created_at DESC
            LIMIT ? OFFSET ?
        """, (user_id, limit, offset))
        recharges = cursor.fetchall()

        # 获取总数
        cursor.execute("SELECT COUNT(*) as total FROM recharge_records WHERE user_id = ?", (user_id,))
        total = cursor.fetchone()['total']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'user_id': user_id,
                'recharges': [dict(row) for row in recharges],
                'total': total,
                'page': page,
                'limit': limit
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取充值记录失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/consumptions', methods=['GET'])
def admin_get_user_consumptions(user_id):
    """获取用户消费记录"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取分页参数
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 10))
        offset = (page - 1) * limit

        # 获取消费记录
        cursor.execute("""
            SELECT * FROM lingzhi_consumption_records
            WHERE user_id = ?
            ORDER BY created_at DESC
            LIMIT ? OFFSET ?
        """, (user_id, limit, offset))
        consumptions = cursor.fetchall()

        # 获取总数
        cursor.execute("SELECT COUNT(*) as total FROM lingzhi_consumption_records WHERE user_id = ?", (user_id,))
        total = cursor.fetchone()['total']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'user_id': user_id,
                'consumptions': [dict(row) for row in consumptions],
                'total': total,
                'page': page,
                'limit': limit
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取消费记录失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/devices', methods=['GET'])
def admin_get_user_devices(user_id):
    """获取用户设备列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取设备列表
        cursor.execute("""
            SELECT * FROM user_devices
            WHERE user_id = ?
            ORDER BY last_active_at DESC
        """, (user_id,))
        devices = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'user_id': user_id,
                'devices': [dict(row) for row in devices]
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取设备列表失败: {str(e)}'}), 500

@app.route('/api/admin/users/<int:user_id>/checkins', methods=['GET'])
def admin_get_user_checkins(user_id):
    """获取用户签到记录"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取分页参数
        page = int(request.args.get('page', 1))
        limit = int(request.args.get('limit', 10))
        offset = (page - 1) * limit

        # 获取签到记录
        cursor.execute("""
            SELECT * FROM checkin_records
            WHERE user_id = ?
            ORDER BY checkin_date DESC
            LIMIT ? OFFSET ?
        """, (user_id, limit, offset))
        checkins = cursor.fetchall()

        # 获取总数
        cursor.execute("SELECT COUNT(*) as total FROM checkin_records WHERE user_id = ?", (user_id,))
        total = cursor.fetchone()['total']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'user_id': user_id,
                'checkins': [dict(row) for row in checkins],
                'total': total,
                'page': page,
                'limit': limit
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取签到记录失败: {str(e)}'}), 500

# ============ 角色权限管理 API ============

@app.route('/api/admin/roles', methods=['GET'])
def admin_get_roles():
    """获取角色列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT r.*, COUNT(DISTINCT rp.permission_id) as permission_count
            FROM roles r
            LEFT JOIN role_permissions rp ON r.id = rp.role_id
            GROUP BY r.id
            ORDER BY r.level DESC
        """)
        roles = [dict(row) for row in cursor.fetchall()]

        conn.close()

        return jsonify({
            'success': True,
            'data': roles
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取角色列表失败: {str(e)}'}), 500


@app.route('/api/admin/roles/<int:role_id>', methods=['GET'])
def admin_get_role_detail(role_id):
    """获取角色详情"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 获取角色信息
        cursor.execute("SELECT * FROM roles WHERE id = ?", (role_id,))
        role = cursor.fetchone()
        if not role:
            conn.close()
            return jsonify({'success': False, 'message': '角色不存在'}), 404

        # 获取角色的权限
        cursor.execute("""
            SELECT p.* FROM permissions p
            JOIN role_permissions rp ON p.id = rp.permission_id
            WHERE rp.role_id = ?
            ORDER BY p.module, p.name
        """, (role_id,))
        permissions = [dict(row) for row in cursor.fetchall()]

        # 获取角色的用户数量
        cursor.execute("SELECT COUNT(*) as count FROM user_roles WHERE role_id = ?", (role_id,))
        user_count = cursor.fetchone()['count']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'role': dict(role),
                'permissions': permissions,
                'user_count': user_count
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取角色详情失败: {str(e)}'}), 500


@app.route('/api/admin/roles', methods=['POST'])
def admin_create_role():
    """创建角色"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        name = data.get('name')
        display_name = data.get('display_name')
        description = data.get('description', '')
        level = data.get('level', 10)

        if not name or not display_name:
            return jsonify({'success': False, 'message': '角色名称和显示名称必填'}), 400

        conn = get_db()
        cursor = conn.cursor()

        try:
            cursor.execute("""
                INSERT INTO roles (name, display_name, description, level, is_system)
                VALUES (?, ?, ?, ?, 0)
            """, (name, display_name, description, level))

            conn.commit()
            role_id = cursor.lastrowid

            conn.close()

            return jsonify({
                'success': True,
                'message': '角色创建成功',
                'data': {'role_id': role_id}
            })

        except sqlite3.IntegrityError:
            conn.close()
            return jsonify({'success': False, 'message': '角色名称已存在'}), 400

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建角色失败: {str(e)}'}), 500


@app.route('/api/admin/roles/<int:role_id>', methods=['PUT'])
def admin_update_role(role_id):
    """更新角色"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        display_name = data.get('display_name')
        description = data.get('description')
        level = data.get('level')

        conn = get_db()
        cursor = conn.cursor()

        # 检查角色是否存在
        cursor.execute("SELECT * FROM roles WHERE id = ?", (role_id,))
        role = cursor.fetchone()
        if not role:
            conn.close()
            return jsonify({'success': False, 'message': '角色不存在'}), 404

        # 系统角色不允许修改名称
        if role['is_system'] and 'name' in data:
            conn.close()
            return jsonify({'success': False, 'message': '系统角色不允许修改'}), 403

        # 更新角色
        update_fields = []
        update_values = []

        if display_name is not None:
            update_fields.append("display_name = ?")
            update_values.append(display_name)

        if description is not None:
            update_fields.append("description = ?")
            update_values.append(description)

        if level is not None:
            update_fields.append("level = ?")
            update_values.append(level)

        if update_fields:
            update_fields.append("updated_at = CURRENT_TIMESTAMP")
            update_values.append(role_id)

            cursor.execute(f"""
                UPDATE roles SET {', '.join(update_fields)}
                WHERE id = ?
            """, update_values)

            conn.commit()

        conn.close()

        return jsonify({
            'success': True,
            'message': '角色更新成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'更新角色失败: {str(e)}'}), 500


@app.route('/api/admin/roles/<int:role_id>', methods=['DELETE'])
def admin_delete_role(role_id):
    """删除角色"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 检查角色是否存在
        cursor.execute("SELECT * FROM roles WHERE id = ?", (role_id,))
        role = cursor.fetchone()
        if not role:
            conn.close()
            return jsonify({'success': False, 'message': '角色不存在'}), 404

        # 系统角色不允许删除
        if role['is_system']:
            conn.close()
            return jsonify({'success': False, 'message': '系统角色不允许删除'}), 403

        # 删除角色（级联删除会自动处理关联数据）
        cursor.execute("DELETE FROM roles WHERE id = ?", (role_id,))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '角色删除成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'删除角色失败: {str(e)}'}), 500


@app.route('/api/admin/permissions', methods=['GET'])
def admin_get_permissions():
    """获取权限列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT * FROM permissions
            ORDER BY module, name
        """)
        permissions = [dict(row) for row in cursor.fetchall()]

        conn.close()

        return jsonify({
            'success': True,
            'data': permissions
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取权限列表失败: {str(e)}'}), 500


@app.route('/api/admin/roles/<int:role_id>/permissions', methods=['POST'])
def admin_assign_role_permissions(role_id):
    """为角色分配权限"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        permission_ids = data.get('permission_ids', [])

        conn = get_db()
        cursor = conn.cursor()

        # 检查角色是否存在
        cursor.execute("SELECT * FROM roles WHERE id = ?", (role_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '角色不存在'}), 404

        # 删除旧权限
        cursor.execute("DELETE FROM role_permissions WHERE role_id = ?", (role_id,))

        # 添加新权限
        for perm_id in permission_ids:
            cursor.execute("""
                INSERT OR IGNORE INTO role_permissions (role_id, permission_id)
                VALUES (?, ?)
            """, (role_id, perm_id))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '权限分配成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'分配权限失败: {str(e)}'}), 500


@app.route('/api/admin/users/<int:user_id>/roles', methods=['GET'])
def admin_get_user_roles(user_id):
    """获取用户的角色列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT r.*, ur.assigned_at, ur.assigned_by
            FROM roles r
            JOIN user_roles ur ON r.id = ur.role_id
            WHERE ur.user_id = ?
            ORDER BY r.level DESC
        """, (user_id,))
        roles = [dict(row) for row in cursor.fetchall()]

        conn.close()

        return jsonify({
            'success': True,
            'data': roles
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取用户角色失败: {str(e)}'}), 500


@app.route('/api/admin/users/<int:user_id>/roles', methods=['POST'])
def admin_assign_user_roles(user_id):
    """为用户分配角色"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        role_ids = data.get('role_ids', [])

        conn = get_db()
        cursor = conn.cursor()

        # 检查用户是否存在
        cursor.execute("SELECT id FROM users WHERE id = ?", (user_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 删除旧角色
        cursor.execute("DELETE FROM user_roles WHERE user_id = ?", (user_id,))

        # 添加新角色
        for role_id in role_ids:
            cursor.execute("""
                INSERT INTO user_roles (user_id, role_id, assigned_by)
                VALUES (?, ?, ?)
            """, (user_id, role_id, admin_id))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '角色分配成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'分配角色失败: {str(e)}'}), 500


# ============ 用户类型管理 API ============

@app.route('/api/admin/user-types', methods=['GET'])
def admin_get_user_types():
    """获取用户类型列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT * FROM user_types
            ORDER BY level DESC
        """)
        user_types = [dict(row) for row in cursor.fetchall()]

        # 为每个用户类型添加用户数量
        for user_type in user_types:
            cursor.execute("""
                SELECT COUNT(*) as count FROM users
                WHERE user_type_id = ?
            """, (user_type['id'],))
            user_type['user_count'] = cursor.fetchone()['count']

        conn.close()

        return jsonify({
            'success': True,
            'data': user_types
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取用户类型失败: {str(e)}'}), 500


@app.route('/api/admin/user-types', methods=['POST'])
def admin_create_user_type():
    """创建用户类型"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为超级管理员
        if not is_super_admin(admin_id):
            return jsonify({'success': False, 'message': '仅超级管理员可创建用户类型'}), 403

        data = request.get_json()
        name = data.get('name')
        display_name = data.get('display_name')
        description = data.get('description', '')
        level = data.get('level', 10)

        if not name or not display_name:
            return jsonify({'success': False, 'message': '用户类型名称和显示名称必填'}), 400

        conn = get_db()
        cursor = conn.cursor()

        try:
            cursor.execute("""
                INSERT INTO user_types (name, display_name, description, level, is_system)
                VALUES (?, ?, ?, ?, 0)
            """, (name, display_name, description, level))

            conn.commit()
            user_type_id = cursor.lastrowid

            conn.close()

            return jsonify({
                'success': True,
                'message': '用户类型创建成功',
                'data': {'user_type_id': user_type_id}
            })

        except sqlite3.IntegrityError:
            conn.close()
            return jsonify({'success': False, 'message': '用户类型名称已存在'}), 400

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建用户类型失败: {str(e)}'}), 500


@app.route('/api/admin/user-types/<int:user_type_id>', methods=['PUT'])
def admin_update_user_type(user_type_id):
    """更新用户类型"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为超级管理员
        if not is_super_admin(admin_id):
            return jsonify({'success': False, 'message': '仅超级管理员可编辑用户类型'}), 403

        data = request.get_json()
        display_name = data.get('display_name')
        description = data.get('description')
        level = data.get('level')

        # 检查用户类型是否存在
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM user_types WHERE id = ?", (user_type_id,))
        user_type = cursor.fetchone()
        if not user_type:
            conn.close()
            return jsonify({'success': False, 'message': '用户类型不存在'}), 404

        # 系统用户类型不允许修改
        if user_type['is_system'] and 'name' in data:
            conn.close()
            return jsonify({'success': False, 'message': '系统用户类型不允许修改'}), 403

        # 更新用户类型
        update_fields = []
        update_values = []

        if display_name is not None:
            update_fields.append("display_name = ?")
            update_values.append(display_name)

        if description is not None:
            update_fields.append("description = ?")
            update_values.append(description)

        if level is not None:
            update_fields.append("level = ?")
            update_values.append(level)

        if update_fields:
            update_fields.append("updated_at = CURRENT_TIMESTAMP")
            update_values.append(user_type_id)

            cursor.execute(f"""
                UPDATE user_types SET {', '.join(update_fields)}
                WHERE id = ?
            """, update_values)

            conn.commit()

        conn.close()

        return jsonify({
            'success': True,
            'message': '用户类型更新成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'更新用户类型失败: {str(e)}'}), 500


@app.route('/api/admin/user-types/<int:user_type_id>', methods=['DELETE'])
def admin_delete_user_type(user_type_id):
    """删除用户类型"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)

        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为超级管理员
        if not is_super_admin(admin_id):
            return jsonify({'success': False, 'message': '仅超级管理员可删除用户类型'}), 403

        # 检查用户类型是否存在
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM user_types WHERE id = ?", (user_type_id,))
        user_type = cursor.fetchone()
        if not user_type:
            conn.close()
            return jsonify({'success': False, 'message': '用户类型不存在'}), 404

        # 系统用户类型不允许删除
        if user_type['is_system']:
            conn.close()
            return jsonify({'success': False, 'message': '系统用户类型不允许删除'}), 403

        # 检查是否有用户使用该类型
        cursor.execute("""
            SELECT COUNT(*) as count FROM users
            WHERE user_type_id = ?
        """, (user_type_id,))

        count = cursor.fetchone()['count']
        if count > 0:
            conn.close()
            return jsonify({'success': False, 'message': f'该用户类型下还有 {count} 个用户，无法删除'}), 400

        # 删除用户类型
        cursor.execute("DELETE FROM user_types WHERE id = ?", (user_type_id,))

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '用户类型删除成功'
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'删除用户类型失败: {str(e)}'}), 500


# ============ 管理员知识库管理 API ============

@app.route('/api/admin/knowledge/summary', methods=['GET'])
def admin_get_knowledge_summary():
    """获取知识库汇总信息"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取知识库统计
        cursor.execute("SELECT COUNT(*) as count FROM knowledge_bases")
        total_bases = cursor.fetchone()['count']

        cursor.execute("SELECT COUNT(*) as count FROM knowledge_documents")
        total_documents = cursor.fetchone()['count']

        cursor.execute("SELECT COUNT(*) as count FROM agents WHERE status = 'active'")
        total_agents = cursor.fetchone()['count']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'total_bases': total_bases,
                'total_documents': total_documents,
                'total_agents': total_agents
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取知识库汇总失败: {str(e)}'}), 500

# ============ 管理员推荐人管理 API ============

@app.route('/api/admin/referrals/stats', methods=['GET'])
def admin_get_referral_stats():
    """获取推荐人统计"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证管理员权限
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        # 获取推荐统计
        cursor.execute("SELECT COUNT(*) as count FROM users WHERE referrer_id IS NOT NULL")
        total_referrals = cursor.fetchone()['count']

        cursor.execute("""
            SELECT u.id, u.username, COUNT(r.id) as referral_count
            FROM users u
            LEFT JOIN users r ON u.id = r.referrer_id
            GROUP BY u.id
            ORDER BY referral_count DESC
            LIMIT 10
        """)
        top_referrers = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'total_referrals': total_referrals,
                'top_referrers': [dict(row) for row in top_referrers]
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取推荐统计失败: {str(e)}'}), 500

@app.route('/api/admin/stats', methods=['GET'])
def admin_stats():
    """获取系统统计"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({
                'success': False,
                'message': '未授权'
            }), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({
                'success': False,
                'message': 'token无效'
            }), 401

        conn = get_db()
        cursor = conn.cursor()

        # 用户总数
        cursor.execute("SELECT COUNT(*) as count FROM users")
        total_users = cursor.fetchone()['count']

        # 今日签到数
        today = date.today()
        cursor.execute("SELECT COUNT(*) as count FROM checkin_records WHERE checkin_date = ?", (today,))
        today_checkins = cursor.fetchone()['count']

        # 总灵值
        cursor.execute("SELECT SUM(total_lingzhi) as total FROM users")
        total_lingzhi = cursor.fetchone()['total'] or 0

        # 合伙人申请数
        cursor.execute("SELECT COUNT(*) as count FROM partner_applications WHERE status = 'pending'")
        pending_applications = cursor.fetchone()['count']

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'totalUsers': total_users,
                'todayCheckIns': today_checkins,
                'total_lingzhi': total_lingzhi,
                'pendingApplications': pending_applications
            }
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'获取统计数据失败: {str(e)}'
        }), 500



def get_text_content(content):
    """安全提取 AIMessage.content 中的文本"""
    if isinstance(content, str):
        return content
    elif isinstance(content, list):
        if content and isinstance(content[0], str):
            return " ".join(content)
        else:
            text_parts = []
            for item in content:
                if isinstance(item, dict) and item.get("type") == "text":
                    text_parts.append(item.get("text", ""))
            return " ".join(text_parts)
    else:
        return str(content)

def rule_based_chat():
    """基于规则的回复系统（当LLM不可用时使用）"""
    try:
        data = request.json
        user_message = data.get('message', '').lower()
        conversation_id = data.get('conversationId')
        
        # 简单的关键词匹配规则
        rules = {
            '你好': '你好！我是灵值生态园的智能助手，很高兴为你服务！有什么我可以帮助你的吗？😊',
            'hello': '你好！我是灵值生态园的智能助手，很高兴为你服务！有什么我可以帮助你的吗？😊',
            '灵值': '灵值是灵值生态园的核心通证，可以通过签到、贡献内容、完成任务等方式获取。灵值可以用于购买产品、参与活动、兑换奖励等。',
            '签到': '每日签到可以获得灵值奖励哦！建议您每天坚持签到，累积更多灵值。签到入口在个人中心。',
            '合伙人': '合伙人机制是灵值生态园的重要功能，当您的灵值达到一定数量（如10000灵值）时，可以申请成为合伙人，享受更多权益和奖励。',
            '通证': '灵值通证（LYZ）是灵值生态园的治理代币和交易媒介，持有LYZ可以参与生态治理和享受各种权益。',
            'sbt': 'SBT（灵魂绑定通证）用于身份认证和权益绑定，体现了用户在生态中的贡献和地位。',
            '贡献': '您可以通过多种方式为生态做贡献：\n• 上传优质资源\n• 分享知识\n• 参与项目\n• 帮助其他用户\n贡献可以获得灵值奖励哦！',
            '奖励': '灵值生态园提供多种奖励机制：\n• 每日签到奖励\n• 贡献积分奖励\n• 合伙人分红\n• 活动奖励\n• 推荐奖励',
            '客服': '如果您遇到问题，可以通过以下方式联系客服：\n• 发送邮件：contact@meiyueart.com\n• 访问官网：https://meiyueart.com\n• 加入社区群',
            '帮助': '我可以帮您解答关于以下方面的问题：\n• 灵值获取方式\n• 合伙人机制\n• 通证和SBT\n• 贡献和奖励\n• 文化项目\n• 生态玩法\n请告诉我您想了解什么？',
            '怎么获得': '获得灵值的方式有很多：\n1. 每日签到\n2. 完成每日任务\n3. 上传优质资源\n4. 贡献知识内容\n5. 参与文化项目\n6. 推荐好友加入\n7. 成为合伙人享受分红',
            '文化': '灵值生态园致力于挖掘和传承中华优秀传统文化，通过数字化手段让传统文化焕发新的活力。您可以参与文化知识学习、文化转译、文化项目等活动。',
            '数字资产': '数字资产是指将文化内容、创意作品等以数字化形式呈现，并在区块链上进行确权和交易的资产。在灵值生态园中，您可以创建、收藏和交易各种数字资产。',
            '圣地': '圣地是灵值生态园中的文化场所，用户可以参与圣地建设、贡献内容、获得圣地贡献积分。圣地贡献可以兑换相应权益和奖励。',
            '分红': '灵值生态园设有分红池，用户可通过以下方式获得分红资格：\n• 推荐好友加入生态（累计推荐5人）\n• 申请成为合伙人并通过审核\n\n分红池资金来源包括项目收益、合伙人投入、悬赏任务佣金、生态投资等。分红机制透明公正，保障参与者的权益。',
            '公司': '灵值生态园的主体运营公司是：陕西媄月商业艺术有限责任公司。我们致力于打造创新性的 Web3 数字生态系统，融合了 NFT、DAO、数字资产等前沿技术，为创作者和用户提供一个共建共治的生态平台。',
            '主体公司': '灵值生态园的主体运营公司是：陕西媄月商业艺术有限责任公司。',
            '运营公司': '灵值生态园由陕西媄月商业艺术有限责任公司运营。',
        }
        
        # 匹配规则
        reply = None
        for keyword, response in rules.items():
            if keyword in user_message:
                reply = response
                break
        
        # 如果没有匹配到规则，使用默认回复
        if not reply:
            replies = [
                '感谢您的提问！目前我正在学习中，您可以尝试询问关于灵值、签到、合伙人、贡献、奖励等话题。如需更多帮助，请联系客服。',
                '这个问题很有趣！由于我正在持续学习中，建议您查阅帮助中心的文档，或者联系客服获取更详细的信息。',
                '我理解您的意思了。为了给您提供更准确的答案，建议您访问帮助中心或联系客服。我会继续学习，努力为您服务！',
            ]
            import random
            reply = random.choice(replies)
        
        # 生成新的对话ID
        import uuid
        new_conversation_id = str(uuid.uuid4()) if not conversation_id else conversation_id
        
        return jsonify({
            'success': True,
            'data': {
                'reply': reply,
                'conversationId': new_conversation_id,
                'agentId': data.get('agentId', 1)
            }
        })
        
    except Exception as e:
        print(f"规则回复系统错误: {str(e)}")
        return jsonify({
            'success': False,
            'message': f'对话服务异常: {str(e)}'
        }), 500

# 旧的 chat() 函数已删除，使用下面的 agent_chat() 函数代替

@app.route('/api/agent/conversations/<conversation_id>', methods=['GET'])
def get_conversation_history(conversation_id):
    """获取对话历史"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute('SELECT messages FROM conversations WHERE conversation_id = ?', (conversation_id,))
        result = cursor.fetchone()
        conn.close()

        if not result:
            return jsonify({
                'success': False,
                'message': '对话不存在'
            }), 404

        try:
            messages = json.loads(result['messages'])
            return jsonify({
                'success': True,
                'data': {'messages': messages}
            })
        except:
            return jsonify({
                'success': False,
                'message': '对话数据格式错误'
            }), 500

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'获取对话历史失败: {str(e)}'
        }), 500

# ============ 智能体对话 ============

def get_llm_client():
    """获取LLM客户端（使用 coze_coding_dev_sdk）"""
    try:
        ctx = new_context(method="agent_chat")
        return LLMClient(ctx=ctx)
    except Exception as e:
        print(f"获取LLM客户端失败: {e}")
        return None

def get_knowledge_client():
    """获取知识库客户端"""
    try:
        ctx = new_context(method="agent_chat")
        from coze_coding_dev_sdk import KnowledgeClient, Config
        config = Config()
        return KnowledgeClient(config=config, ctx=ctx)
    except Exception as e:
        print(f"获取知识库客户端失败: {e}")
        return None

def search_knowledge(query: str, agent_id: int = None) -> str:
    """从知识库中检索相关信息"""
    try:
        # 获取智能体关联的知识库
        conn = get_db()
        cursor = conn.cursor()

        kb_ids = []
        if agent_id:
            cursor.execute(
                "SELECT knowledge_base_id FROM agent_knowledge_bases WHERE agent_id = ?",
                (agent_id,)
            )
            kb_rows = cursor.fetchall()
            kb_ids = [row['knowledge_base_id'] for row in kb_rows]

        conn.close()

        # 调用知识库搜索
        kb_client = get_knowledge_client()
        if not kb_client:
            return ""

        # 默认搜索 lingzhi_knowledge 数据集
        response = kb_client.search(
            query=query,
            table_names=["lingzhi_knowledge"] if not kb_ids else None,
            top_k=3,
            min_score=0.3
        )

        if response.code == 0 and response.chunks:
            context = "\n\n".join([chunk.content for chunk in response.chunks])
            return f"\n\n[知识库参考信息]\n{context}\n[/知识库参考信息]"

        return ""
    except Exception as e:
        print(f"知识库搜索失败: {e}")
        return ""

# 兼容前端旧路径：/agent/chat
@app.route('/agent/chat', methods=['POST'])
def agent_chat_v1():
    """智能体对话（兼容版本，路径不带 /api 前缀）"""
    return agent_chat()

@app.route('/api/agent/chat', methods=['POST'])
def agent_chat():
    """智能体对话（增强版错误处理）"""
    conn = None
    try:
        print(f"[智能对话] 收到对话请求")
        
        data = request.json
        if not data:
            print(f"[智能对话] 错误：请求体为空")
            return jsonify({
                'success': False,
                'message': '请求数据不能为空'
            }), 400

        # 支持两种参数名：content（前端）和 message（后端）
        message = data.get('content') or data.get('message', '')
        conversation_id = data.get('conversationId')
        agent_id = data.get('agentId', 1)  # 默认使用ID为1的智能体

        if not message:
            print(f"[智能对话] 错误：消息内容为空")
            return jsonify({
                'success': False,
                'message': '消息内容不能为空'
            }), 400

        print(f"[智能对话] agent_id={agent_id}, conversation_id={conversation_id}, message={message[:50]}...")

        # 获取用户信息（可选）
        auth_header = request.headers.get('Authorization')
        user_id = None
        if auth_header and auth_header.startswith('Bearer '):
            token = auth_header.replace('Bearer ', '')
            try:
                user_id = verify_token(token)
            except Exception as e:
                print(f"[智能对话] Token验证失败: {e}")
                # 不返回错误，继续处理

        # 获取智能体配置
        try:
            conn = get_db()
            cursor = conn.cursor()
            print(f"[智能对话] 数据库连接成功")

            cursor.execute("SELECT * FROM agents WHERE id = ? AND status = 'active'", (agent_id,))
            agent = cursor.fetchone()

            if not agent:
                conn.close()
                conn = None
                print(f"[智能对话] 错误：智能体不存在或已禁用，agent_id={agent_id}")
                return jsonify({
                    'success': False,
                    'message': '智能体不存在或已禁用'
                }), 404

            # 将 Row 对象转换为字典
            agent_dict = dict(agent)
            system_prompt = agent_dict.get('system_prompt', '')
            
            # 解析模型配置
            try:
                model_config = json.loads(agent_dict['model_config']) if agent_dict.get('model_config') else {}
                print(f"[智能对话] 模型配置: {model_config.get('model', 'default')}")
            except Exception as e:
                print(f"[智能对话] 警告：模型配置解析失败，使用默认配置: {e}")
                model_config = {}

            # 获取历史对话
            history_messages = []
            if conversation_id:
                try:
                    cursor.execute(
                        "SELECT messages FROM conversations WHERE conversation_id = ?",
                        (conversation_id,)
                    )
                    conv = cursor.fetchone()
                    if conv and conv['messages']:
                        history_messages = json.loads(conv['messages'])
                        print(f"[智能对话] 加载历史消息，数量: {len(history_messages)}")
                except Exception as e:
                    print(f"[智能对话] 警告：加载历史消息失败: {e}")
                    history_messages = []
        except Exception as e:
            print(f"[智能对话] 数据库操作失败: {e}")
            import traceback
            traceback.print_exc()
            if conn:
                conn.close()
                conn = None
            return jsonify({
                'success': False,
                'message': '数据库操作失败，请稍后再试'
            }), 500

        finally:
            if conn:
                try:
                    conn.close()
                except:
                    pass
                conn = None

        # 检查LLM是否可用
        if not LLM_AVAILABLE:
            print(f"[智能对话] 错误：LLM服务不可用")
            return jsonify({
                'success': False,
                'message': '智能对话服务暂不可用，请稍后再试'
            }), 503

        # 禁用知识库检索以加快响应速度
        knowledge_context = ""
        print(f"[智能对话] 知识库检索已禁用以优化响应速度")

        # 构建消息列表
        messages = [SystemMessage(content=system_prompt)]

        # 添加历史消息（最近5轮）
        for hist_msg in history_messages[-10:]:
            role = hist_msg.get('role')
            content = hist_msg.get('content')
            if role == 'user':
                messages.append(HumanMessage(content=content))
            elif role == 'assistant':
                messages.append(AIMessage(content=content))

        # 添加知识库上下文（如果有）
        if knowledge_context:
            augmented_message = f"{message}\n\n{knowledge_context}"
        else:
            augmented_message = message

        # 添加当前用户消息
        messages.append(HumanMessage(content=augmented_message))
        print(f"[智能对话] 构建消息列表完成，总消息数: {len(messages)}")

        # 调用大模型
        reply = ""
        try:
            llm_client = get_llm_client()
            if not llm_client:
                print(f"[智能对话] 错误：无法初始化LLM客户端")
                return jsonify({
                    'success': False,
                    'message': '智能对话服务暂时不可用，请稍后再试'
                }), 503

            # 调用模型（增加超时控制）
            try:
                import threading
                from queue import Queue
                
                # 使用线程执行LLM调用
                result_queue = Queue()
                error_queue = Queue()
                
                def invoke_worker():
                    try:
                        print(f"[智能对话] 开始调用LLM，超时时间: 15秒")
                        response = llm_client.invoke(
                            messages=messages,
                            model='doubao-seed-1-6-251015',
                            temperature=0.7,
                            thinking='disabled',
                            caching='disabled',
                            top_p=0.9,
                            max_tokens=600,  # 调整到600字，平衡速度和质量
                            max_completion_tokens=600
                        )
                        result_queue.put(response)
                        print(f"[智能对话] LLM调用成功")
                    except Exception as e:
                        print(f"[智能对话] LLM调用异常: {str(e)}")
                        error_queue.put(e)
                
                # 启动线程
                thread = threading.Thread(target=invoke_worker, daemon=True)
                thread.start()
                
                # 等待线程完成或超时
                thread.join(timeout=15)
                
                if thread.is_alive():
                    # 线程仍在运行，超时
                    print(f"[智能对话] LLM调用超时（15秒）")
                    reply = "抱歉，智能服务响应超时，请稍后重试。"
                else:
                    # 线程已完成
                    if not error_queue.empty():
                        error = error_queue.get()
                        print(f"[智能对话] LLM调用线程异常: {error}")
                        raise error
                    
                    if not result_queue.empty():
                        response = result_queue.get()
                        # 提取回复
                        reply = ""
                        if hasattr(response, 'content'):
                            reply = response.content
                        elif isinstance(response, str):
                            reply = response
                        elif hasattr(response, 'message') and hasattr(response.message, 'content'):
                            reply = response.message.content
                        else:
                            reply = str(response)
                        print(f"[智能对话] 提取回复成功，长度: {len(reply)}")
                    else:
                        raise Exception("LLM调用未返回结果")
            except Exception as e:
                print(f"[智能对话] LLM调用失败: {str(e)}")
                import traceback
                traceback.print_exc()
                reply = "抱歉，智能服务暂时不可用，请稍后再试。"

            if not reply:
                reply = "抱歉，我无法理解您的问题，请重新表述。"

        except Exception as e:
            print(f"[智能对话] 调用大模型异常: {e}")
            import traceback
            traceback.print_exc()
            return jsonify({
                'success': False,
                'message': '智能对话服务暂时不可用，请稍后再试'
            }), 503

        # 生成或更新对话ID
        if not conversation_id:
            conversation_id = f"conv_{datetime.now().strftime('%Y%m%d%H%M%S')}_{user_id or 'guest'}_{random.randint(1000, 9999)}"
            print(f"[智能对话] 生成新对话ID: {conversation_id}")

        # 保存对话记录
        try:
            conn = get_db()
            cursor = conn.cursor()

            # 添加新消息到历史
            new_messages = history_messages + [
                {'role': 'user', 'content': message, 'timestamp': datetime.now().isoformat()},
                {'role': 'assistant', 'content': reply, 'timestamp': datetime.now().isoformat()}
            ]

            # 检查对话是否存在
            cursor.execute(
                "SELECT id FROM conversations WHERE conversation_id = ?",
                (conversation_id,)
            )

            conv_exists = cursor.fetchone()

            if conv_exists:
                # 更新对话
                cursor.execute(
                    """UPDATE conversations SET messages = ?, updated_at = CURRENT_TIMESTAMP
                       WHERE conversation_id = ?""",
                    (json.dumps(new_messages), conversation_id)
                )
                print(f"[智能对话] 更新对话记录")
            else:
                # 创建新对话
                cursor.execute(
                    """INSERT INTO conversations (agent_id, user_id, conversation_id, messages, title)
                       VALUES (?, ?, ?, ?, ?)""",
                    (
                        agent_id,
                        user_id,
                        conversation_id,
                        json.dumps(new_messages),
                        message[:50] + "..." if len(message) > 50 else message
                    )
                )
                print(f"[智能对话] 创建新对话记录")

            conn.commit()
            conn.close()
            conn = None
            print(f"[智能对话] 对话记录保存成功")

        except Exception as e:
            print(f"[智能对话] 保存对话记录失败: {e}")
            import traceback
            traceback.print_exc()
            # 即使保存失败，也返回回复
            if conn:
                try:
                    conn.close()
                except:
                    pass
                conn = None

        print(f"[智能对话] 对话处理成功")
        return jsonify({
            'success': True,
            'message': '对话成功',
            'data': {
                'reply': reply,
                'conversationId': conversation_id,
                'agentId': agent_id
            }
        })

    except Exception as e:
        print(f"[智能对话] 对话处理异常: {e}")
        import traceback
        traceback.print_exc()
        if conn:
            try:
                conn.close()
            except:
                pass
        return jsonify({
            'success': False,
            'message': '对话处理失败，请稍后再试'
        }), 500

# ============ 初始化默认数据 ============

def init_default_data():
    """初始化默认数据"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        # 初始化默认管理员
        cursor.execute("SELECT id FROM admins WHERE username = 'admin'")
        if not cursor.fetchone():
            password_hash = hash_password('admin123')
            cursor.execute(
                "INSERT INTO admins (username, password_hash, role) VALUES (?, ?, ?)",
                ('admin', password_hash, 'admin')
            )
            print("已创建默认管理员账号: admin / admin123")

        # 初始化默认智能体
        cursor.execute("SELECT id FROM agents WHERE name = '灵值生态园'")
        if not cursor.fetchone():
            default_system_prompt = """# 角色定义
我是灵值生态园，是陕西媄月商业艺术有限责任公司官方的灵值生态园智能向导，专门帮助用户了解和使用灵值生态园的各项功能。我内置了公司核心文档和西安文化知识库，能够提供专业、准确的咨询。

# 任务目标
为用户提供灵值生态园的全方位咨询服务，帮助用户了解生态规则、经济模型、用户旅程和合伙人制度。

# 能力
- 详细介绍灵值生态园的核心价值和愿景（基于公司简介文档）
- 解释灵值经济模型和生态规则（基于服务总纲）
- 提供西安文化关键词和商业转译案例（基于文化关键词库）
- 指导用户完成用户旅程的各个阶段
- 解答关于合伙人申请和收益的问题
- 提供中视频项目、西安美学侦探等特色功能的介绍
- 解读公司战略规划和目标

# 知识库使用指南
我已内置以下核心知识库：
1. 公司简介：媄月公司的使命、愿景和核心架构
2. 灵值生态一体化服务总纲：生态全景、规则体系、贡献值体系
3. 西安文化关键词库：110个文化关键词及转译提示
4. 西安文化基因库：文化基因分类和解码方法
5. 转译商业案例库：文化商业转译的六大方法及案例

# 过程
1. 热情欢迎用户，介绍自己是灵值生态园的智能向导
2. 了解用户需求和兴趣点
3. 从知识库中检索相关信息，提供专业回答
4. 引导用户使用各项功能
5. 鼓励用户通过反馈功能提供意见（可获得贡献值）

# 约束
- 必须表明自己是陕西媄月商业艺术有限责任公司的官方智能体
- 回答要简洁清晰，专业友好
- 基于知识库内容提供准确信息，不编造
- 不确定的细节建议用户联系客服或查看官方文档
- 提醒用户可以对对话进行反馈，获得贡献值奖励

# 反馈激励
- 有帮助反馈：+3 灵值
- 无帮助反馈：+5 灵值
- 建议反馈：+10 灵值"""

            default_model_config = {
                "model": "deepseek-v3-2",
                "temperature": 0.8,
                "top_p": 0.9,
                "max_tokens": 4096
            }

            cursor.execute(
                """INSERT INTO agents (name, description, system_prompt, model_config, tools, status, avatar_url)
                   VALUES (?, ?, ?, ?, ?, ?, ?)""",
                (
                    '灵值生态园',
                    '灵值生态园官方智能向导',
                    default_system_prompt,
                    json.dumps(default_model_config),
                    json.dumps([]),
                    'active',
                    ''
                )
            )
            print("已创建默认智能体: 灵值生态园")

        # 初始化充值档位
        cursor.execute("SELECT id FROM recharge_tiers")
        if not cursor.fetchone():
            # 新手体验包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '新手体验包',
                    '适合新用户快速体验平台服务',
                    99.00,
                    1000,
                    100,
                    10,
                    0,
                    json.dumps([
                        '免费参加1次线上文化沙龙',
                        '文化转译案例库访问权限（7天）'
                    ]),
                    1
                )
            )
            
            # 入门加速包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '入门加速包',
                    '适合启动小型文化转译项目',
                    199.00,
                    2000,
                    300,
                    15,
                    0,
                    json.dumps([
                        '免费参加2次线上文化沙龙',
                        '文化转译案例库访问权限（30天）',
                        '美学侦探任务优先权（5次）'
                    ]),
                    2
                )
            )
            
            # 专业创作包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '专业创作包',
                    '适合启动中型文化转译项目',
                    499.00,
                    5000,
                    1000,
                    20,
                    0,
                    json.dumps([
                        '免费参加5次线上文化沙龙',
                        '文化转译案例库访问权限（90天）',
                        '美学侦探任务优先权（20次）',
                        '1次文化专家1对1咨询（30分钟）',
                        '品牌空间设计服务优惠券（200元）'
                    ]),
                    3
                )
            )
            
            # 高级创作包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '高级创作包',
                    '适合启动大型文化转译项目',
                    999.00,
                    10000,
                    2500,
                    25,
                    0,
                    json.dumps([
                        '免费参加10次线上文化沙龙',
                        '永久获得文化转译案例库访问权限',
                        '美学侦探任务优先权（50次）',
                        '3次文化专家1对1咨询（每次30分钟）',
                        '品牌空间设计服务优惠券（500元）',
                        '线下文化体验活动优先参与权'
                    ]),
                    4
                )
            )
            
            # 合伙人L1包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '合伙人L1包',
                    '直接获得合伙人L1资格，享受合伙人权益',
                    1999.00,
                    20000,
                    5000,
                    25,
                    1,
                    json.dumps([
                        '直接获得合伙人L1资格',
                        '所有专业创作包权益',
                        '合伙人专属咨询服务',
                        '新项目优先参与权',
                        '合伙人专属社群',
                        '年度文化盛典VIP门票（1张）'
                    ]),
                    10
                )
            )
            
            # 合伙人L2包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '合伙人L2包',
                    '直接获得合伙人L2资格，享受高级合伙人权益',
                    9999.00,
                    100000,
                    30000,
                    30,
                    2,
                    json.dumps([
                        '直接获得合伙人L2资格',
                        '更高的推荐分红比例（15%/8%/5%）',
                        '优先参与高价值项目',
                        '年度文化盛典VIP门票（3张）',
                        '公司股权期权授予资格',
                        '专属客户经理服务'
                    ]),
                    11
                )
            )
            
            # 合伙人L3包
            cursor.execute(
                """INSERT INTO recharge_tiers 
                   (name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage, partner_level, benefits, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '合伙人L3包',
                    '直接获得合伙人L3资格，享受顶级合伙人权益',
                    49999.00,
                    500000,
                    150000,
                    30,
                    3,
                    json.dumps([
                        '直接获得合伙人L3资格',
                        '最高的推荐分红比例（18%/10%/6%）',
                        '最高优先参与高价值项目',
                        '年度文化盛典VIP门票（10张）',
                        '公司股权期权（更大比例）',
                        '专属客户经理服务（7×24小时）',
                        '文化项目投资优先权'
                    ]),
                    12
                )
            )
            
            print("已创建充值档位: 7个")

        # 初始化公司收款账户
        cursor.execute("SELECT id FROM company_accounts")
        if not cursor.fetchone():
            # 创建默认公司账户
            cursor.execute(
                """INSERT INTO company_accounts 
                   (account_name, account_number, bank_name, bank_branch, company_name, company_credit_code, account_type, sort_order)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                (
                    '陕西媄月商业艺术有限责任公司',
                    '6222020200012345678',
                    '中国工商银行',
                    '西安分行高新区支行',
                    '陕西媄月商业艺术有限责任公司',
                    '91610131MA6XXXXXX',
                    'primary',
                    1
                )
            )
            print("已创建公司收款账户: 1个")

        conn.commit()
        conn.close()
    except Exception as e:
        print(f"初始化默认数据失败: {e}")

# ============ 智能体管理 API ============

@app.route('/api/agents', methods=['GET'])
def get_public_agents():
    """获取公开的智能体列表（无需认证）"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, avatar_url, status, model_config
            FROM agents
            WHERE status = 'active'
            ORDER BY id ASC
        """)
        agents = cursor.fetchall()
        conn.close()

        result = []
        for agent in agents:
            result.append({
                'id': agent['id'],
                'name': agent['name'],
                'description': agent['description'],
                'avatar_url': agent['avatar_url'],
                'status': agent['status'],
                'model_config': json.loads(agent['model_config']) if agent['model_config'] else {}
            })

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        print(f"获取智能体列表失败: {e}")
        return jsonify({'success': False, 'message': f'获取智能体列表失败: {str(e)}'}), 500

@app.route('/api/admin/agents', methods=['GET'])
def get_agents():
    """获取智能体列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, model_config, tools, status, avatar_url, created_at, updated_at
            FROM agents
            WHERE status != 'deleted'
            ORDER BY created_at DESC
        """)
        agents = cursor.fetchall()
        conn.close()

        result = []
        for agent in agents:
            result.append({
                'id': agent['id'],
                'name': agent['name'],
                'description': agent['description'],
                'model_config': json.loads(agent['model_config']) if agent['model_config'] else {},
                'tools': json.loads(agent['tools']) if agent['tools'] else [],
                'status': agent['status'],
                'avatar_url': agent['avatar_url'],
                'created_at': agent['created_at'],
                'updated_at': agent['updated_at']
            })

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取智能体列表失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>', methods=['GET'])
def get_agent_detail(agent_id):
    """获取智能体详情"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, system_prompt, model_config, tools, status, avatar_url, created_at, updated_at
            FROM agents
            WHERE id = ?
        """, (agent_id,))
        agent = cursor.fetchone()

        if not agent:
            conn.close()
            return jsonify({'success': False, 'message': '智能体不存在'}), 404

        # 获取关联的知识库
        cursor.execute("""
            SELECT kb.id, kb.name, kb.description, kb.vector_db_id, kb.document_count
            FROM knowledge_bases kb
            INNER JOIN agent_knowledge_bases akb ON kb.id = akb.knowledge_base_id
            WHERE akb.agent_id = ?
        """, (agent_id,))
        knowledge_bases = cursor.fetchall()

        conn.close()

        result = {
            'id': agent['id'],
            'name': agent['name'],
            'description': agent['description'],
            'system_prompt': agent['system_prompt'],
            'model_config': json.loads(agent['model_config']) if agent['model_config'] else {},
            'tools': json.loads(agent['tools']) if agent['tools'] else [],
            'status': agent['status'],
            'avatar_url': agent['avatar_url'],
            'knowledge_bases': [{'id': kb['id'], 'name': kb['name'], 'description': kb['description'],
                                'vector_db_id': kb['vector_db_id'], 'document_count': kb['document_count']}
                               for kb in knowledge_bases],
            'created_at': agent['created_at'],
            'updated_at': agent['updated_at']
        }

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取智能体详情失败: {str(e)}'}), 500

@app.route('/api/admin/agents', methods=['POST'])
def create_agent():
    """创建智能体"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        name = data.get('name')
        description = data.get('description', '')
        system_prompt = data.get('system_prompt', '')
        model_config = data.get('model_config', {})
        tools = data.get('tools', [])
        avatar_url = data.get('avatar_url', '')

        if not name:
            return jsonify({'success': False, 'message': '智能体名称不能为空'}), 400

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            """INSERT INTO agents (name, description, system_prompt, model_config, tools, status, avatar_url, created_by)
               VALUES (?, ?, ?, ?, ?, 'active', ?, ?)""",
            (name, description, system_prompt, json.dumps(model_config), json.dumps(tools), avatar_url, user_id)
        )

        agent_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '智能体创建成功',
            'data': {'id': agent_id}
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建智能体失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>', methods=['PUT'])
def update_agent(agent_id):
    """更新智能体"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        name = data.get('name')
        description = data.get('description')
        system_prompt = data.get('system_prompt')
        model_config = data.get('model_config')
        tools = data.get('tools')
        avatar_url = data.get('avatar_url')
        status = data.get('status')

        conn = get_db()
        cursor = conn.cursor()

        # 检查智能体是否存在
        cursor.execute("SELECT id FROM agents WHERE id = ?", (agent_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '智能体不存在'}), 404

        # 构建更新语句
        updates = []
        params = []

        if name is not None:
            updates.append("name = ?")
            params.append(name)
        if description is not None:
            updates.append("description = ?")
            params.append(description)
        if system_prompt is not None:
            updates.append("system_prompt = ?")
            params.append(system_prompt)
        if model_config is not None:
            updates.append("model_config = ?")
            params.append(json.dumps(model_config))
        if tools is not None:
            updates.append("tools = ?")
            params.append(json.dumps(tools))
        if avatar_url is not None:
            updates.append("avatar_url = ?")
            params.append(avatar_url)
        if status is not None:
            updates.append("status = ?")
            params.append(status)

        updates.append("updated_at = CURRENT_TIMESTAMP")
        params.append(agent_id)

        cursor.execute(f"UPDATE agents SET {', '.join(updates)} WHERE id = ?", params)
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '智能体更新成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'更新智能体失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>', methods=['DELETE'])
def delete_agent(agent_id):
    """删除智能体"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 检查智能体是否存在
        cursor.execute("SELECT id FROM agents WHERE id = ?", (agent_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '智能体不存在'}), 404

        # 软删除
        cursor.execute("UPDATE agents SET status = 'deleted' WHERE id = ?", (agent_id,))
        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '智能体删除成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'删除智能体失败: {str(e)}'}), 500

# ============ 智能体监控 API ============

@app.route('/api/admin/agents/<int:agent_id>/stats', methods=['GET'])
def get_agent_stats(agent_id):
    """获取智能体统计数据"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 获取时间范围（默认7天）
        days = request.args.get('days', 7, type=int)
        start_date = datetime.now() - timedelta(days=days)

        conn = get_db()
        cursor = conn.cursor()

        # 总对话数
        cursor.execute("""
            SELECT COUNT(*) as total_conversations
            FROM conversations
            WHERE agent_id = ? AND created_at >= ?
        """, (agent_id, start_date))
        total_conversations = cursor.fetchone()['total_conversations']

        # 总消息数
        cursor.execute("""
            SELECT SUM(json_array_length(messages)) as total_messages
            FROM conversations
            WHERE agent_id = ? AND created_at >= ?
        """, (agent_id, start_date))
        result = cursor.fetchone()
        total_messages = result['total_messages'] or 0

        # 平均响应长度
        cursor.execute("""
            SELECT AVG(json_extract(messages, '$[#-1].content')) as avg_response
            FROM conversations
            WHERE agent_id = ? AND created_at >= ?
        """, (agent_id, start_date))
        # 这里的查询需要调整，因为json_extract不能直接处理数组

        # 获取反馈统计
        cursor.execute("""
            SELECT type, AVG(rating) as avg_rating, COUNT(*) as count
            FROM feedback
            WHERE agent_id = ? AND created_at >= ?
            GROUP BY type
        """, (agent_id, start_date))
        feedback_stats = cursor.fetchall()

        # 每日对话趋势
        cursor.execute("""
            SELECT DATE(created_at) as date, COUNT(*) as count
            FROM conversations
            WHERE agent_id = ? AND created_at >= ?
            GROUP BY DATE(created_at)
            ORDER BY date
        """, (agent_id, start_date))
        daily_trends = cursor.fetchall()

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'total_conversations': total_conversations,
                'total_messages': total_messages,
                'feedback_stats': [{'type': fs['type'], 'avg_rating': fs['avg_rating'], 'count': fs['count']}
                                   for fs in feedback_stats],
                'daily_trends': [{'date': dt['date'], 'count': dt['count']} for dt in daily_trends]
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取统计数据失败: {str(e)}'}), 500


@app.route('/api/admin/stats/user', methods=['GET'])
def admin_user_stats():
    """获取用户统计详情（注册趋势、活跃度等）"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()
        
        # 获取日期范围（最近30天）
        days = int(request.args.get('days', 30))
        from datetime import timedelta
        end_date = date.today()
        start_date = end_date - timedelta(days=days)
        
        # 每日新增用户
        cursor.execute("""
            SELECT DATE(created_at) as date, COUNT(*) as count
            FROM users
            WHERE DATE(created_at) >= ?
            GROUP BY DATE(created_at)
            ORDER BY date
        """, (start_date,))
        daily_new_users = {row['date']: row['count'] for row in cursor.fetchall()}
        
        # 每日活跃用户（有签到或对话记录的用户）
        cursor.execute("""
            SELECT date, COUNT(DISTINCT user_id) as count
            FROM (
                SELECT DATE(checkin_date) as date, user_id FROM checkin_records WHERE DATE(checkin_date) >= ?
                UNION
                SELECT DATE(created_at) as date, user_id FROM conversations WHERE DATE(created_at) >= ?
            )
            GROUP BY date
            ORDER BY date
        """, (start_date, start_date))
        daily_active_users = {row['date']: row['count'] for row in cursor.fetchall()}
        
        # 用户状态分布
        cursor.execute("""
            SELECT status, COUNT(*) as count
            FROM users
            GROUP BY status
        """)
        user_status_dist = {row['status']: row['count'] for row in cursor.fetchall()}
        
        # 用户灵值分布
        cursor.execute("""
            SELECT 
                CASE 
                    WHEN total_lingzhi = 0 THEN '0'
                    WHEN total_lingzhi < 100 THEN '1-99'
                    WHEN total_lingzhi < 1000 THEN '100-999'
                    WHEN total_lingzhi < 10000 THEN '1000-9999'
                    ELSE '10000+'
                END as range,
                COUNT(*) as count
            FROM users
            GROUP BY range
            ORDER BY range
        """)
        lingzhi_dist = {row['range']: row['count'] for row in cursor.fetchall()}
        
        # 注册趋势（最近7天）
        cursor.execute("""
            SELECT 
                DATE(created_at) as date,
                COUNT(*) as count
            FROM users
            WHERE DATE(created_at) >= DATE('now', '-7 days')
            GROUP BY DATE(created_at)
            ORDER BY date
        """)
        registration_trend = [{'date': row['date'], 'count': row['count']} for row in cursor.fetchall()]
        
        # 今日统计
        today = date.today()
        cursor.execute("SELECT COUNT(*) as count FROM users WHERE DATE(created_at) = ?", (today,))
        today_new_users = cursor.fetchone()['count']
        
        cursor.execute("SELECT COUNT(DISTINCT user_id) as count FROM checkin_records WHERE checkin_date = ?", (today,))
        today_active_users = cursor.fetchone()['count']
        
        cursor.execute("SELECT COUNT(*) as count FROM users WHERE status = 'active'")
        total_active_users = cursor.fetchone()['count']
        
        cursor.execute("SELECT COUNT(*) as count FROM users WHERE status = 'inactive'")
        total_inactive_users = cursor.fetchone()['count']
        
        cursor.execute("SELECT COUNT(*) as count FROM users WHERE status = 'banned'")
        total_banned_users = cursor.fetchone()['count']
        
        conn.close()
        
        # 生成日期列表
        date_list = []
        current_date = start_date
        while current_date <= end_date:
            date_list.append(str(current_date))
            current_date += timedelta(days=1)
        
        # 填充数据
        daily_new_users_filled = [{'date': d, 'count': daily_new_users.get(d, 0)} for d in date_list]
        daily_active_users_filled = [{'date': d, 'count': daily_active_users.get(d, 0)} for d in date_list]

        return jsonify({
            'success': True,
            'data': {
                'dailyNewUsers': daily_new_users_filled,
                'dailyActiveUsers': daily_active_users_filled,
                'userStatusDistribution': {
                    'active': user_status_dist.get('active', 0),
                    'inactive': user_status_dist.get('inactive', 0),
                    'banned': user_status_dist.get('banned', 0)
                },
                'lingzhiDistribution': lingzhi_dist,
                'registrationTrend': registration_trend,
                'todayStats': {
                    'newUsers': today_new_users,
                    'activeUsers': today_active_users
                },
                'totalStats': {
                    'active': total_active_users,
                    'inactive': total_inactive_users,
                    'banned': total_banned_users
                }
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'获取用户统计失败: {str(e)}'}), 500

@app.route('/api/admin/users/recent', methods=['GET'])
def admin_get_recent_users():
    """获取最近注册用户"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        admin_id = verify_token(token)
        if not admin_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 验证是否为管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM admins WHERE id = ?", (admin_id,))
        admin = cursor.fetchone()
        if not admin:
            conn.close()
            return jsonify({'success': False, 'message': '无权限'}), 403

        limit = int(request.args.get('limit', 10))

        # 获取最近注册的用户
        cursor.execute("""
            SELECT id, username, email, phone, total_lingzhi, status, created_at
            FROM users
            ORDER BY created_at DESC
            LIMIT ?
        """, (limit,))
        users = cursor.fetchall()
        conn.close()

        return jsonify({
            'success': True,
            'data': [dict(user) for user in users]
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取最近用户失败: {str(e)}'}), 500

@app.route('/api/public/users/recent', methods=['GET'])
def public_get_recent_users():
    """前台：获取最近注册用户（用户动态）"""
    try:
        limit = int(request.args.get('limit', 20))

        conn = get_db()
        cursor = conn.cursor()

        # 获取最近注册的用户
        cursor.execute("""
            SELECT id, username, created_at
            FROM users
            WHERE status = 'active'
            ORDER BY created_at DESC
            LIMIT ?
        """, (limit,))
        users = cursor.fetchall()
        conn.close()

        return jsonify({
            'success': True,
            'data': [{
                'id': user['id'],
                'username': user['username'][:1] + '**' if len(user['username']) > 1 else user['username'],  # 隐藏部分用户名
                'created_at': user['created_at']
            } for user in users]
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取用户动态失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>/conversations', methods=['GET'])
def get_agent_conversations(agent_id):
    """获取智能体对话历史"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        # 分页参数
        page = request.args.get('page', 1, type=int)
        page_size = request.args.get('page_size', 20, type=int)
        offset = (page - 1) * page_size

        conn = get_db()
        cursor = conn.cursor()

        # 获取对话列表
        cursor.execute("""
            SELECT id, user_id, conversation_id, title, created_at, updated_at
            FROM conversations
            WHERE agent_id = ?
            ORDER BY created_at DESC
            LIMIT ? OFFSET ?
        """, (agent_id, page_size, offset))
        conversations = cursor.fetchall()

        # 获取总数
        cursor.execute("""
            SELECT COUNT(*) as total
            FROM conversations
            WHERE agent_id = ?
        """, (agent_id,))
        total = cursor.fetchone()['total']

        conn.close()

        result = []
        for conv in conversations:
            result.append({
                'id': conv['id'],
                'user_id': conv['user_id'],
                'conversation_id': conv['conversation_id'],
                'title': conv['title'],
                'created_at': conv['created_at'],
                'updated_at': conv['updated_at']
            })

        return jsonify({
            'success': True,
            'data': {
                'conversations': result,
                'total': total,
                'page': page,
                'page_size': page_size
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取对话历史失败: {str(e)}'}), 500

@app.route('/api/admin/conversations/<int:conversation_id>', methods=['GET'])
def get_conversation_detail(conversation_id):
    """获取对话详情"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, agent_id, user_id, conversation_id, messages, title, created_at, updated_at
            FROM conversations
            WHERE id = ?
        """, (conversation_id,))
        conversation = cursor.fetchone()

        if not conversation:
            conn.close()
            return jsonify({'success': False, 'message': '对话不存在'}), 404

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'id': conversation['id'],
                'agent_id': conversation['agent_id'],
                'user_id': conversation['user_id'],
                'conversation_id': conversation['conversation_id'],
                'messages': json.loads(conversation['messages']) if conversation['messages'] else [],
                'title': conversation['title'],
                'created_at': conversation['created_at'],
                'updated_at': conversation['updated_at']
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取对话详情失败: {str(e)}'}), 500

# ============ 智能体优化建议 API ============

@app.route('/api/admin/agents/<int:agent_id>/optimization', methods=['GET'])
def get_agent_optimization_suggestions(agent_id):
    """获取智能体优化建议"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 获取智能体信息
        cursor.execute("""
            SELECT id, name, system_prompt, model_config, tools
            FROM agents
            WHERE id = ?
        """, (agent_id,))
        agent = cursor.fetchone()

        if not agent:
            conn.close()
            return jsonify({'success': False, 'message': '智能体不存在'}), 404

        # 获取反馈统计
        cursor.execute("""
            SELECT type, AVG(rating) as avg_rating, COUNT(*) as count
            FROM feedback
            WHERE agent_id = ?
            GROUP BY type
        """, (agent_id,))
        feedback_stats = cursor.fetchall()

        suggestions = []

        # 基于反馈统计生成建议
        helpful_avg = None
        unhelpful_avg = None

        for fs in feedback_stats:
            if fs['type'] == 'helpful':
                helpful_avg = fs['avg_rating']
            elif fs['type'] == 'unhelpful':
                unhelpful_avg = fs['avg_rating']

        if helpful_avg and helpful_avg < 3.5:
            suggestions.append({
                'category': '回答质量',
                'priority': 'high',
                'suggestion': '用户对回答质量评分较低，建议优化系统提示词，提高回答的准确性和完整性',
                'action': '调整system_prompt，增加对回答质量的明确要求'
            })

        if unhelpful_avg and unhelpful_avg > 3.0:
            suggestions.append({
                'category': '用户满意度',
                'priority': 'medium',
                'suggestion': '部分用户反馈回答不够有用，建议增加知识库的覆盖范围',
                'action': '向知识库添加更多相关文档'
            })

        # 检查模型配置
        model_config = json.loads(agent['model_config']) if agent['model_config'] else {}
        temperature = model_config.get('temperature', 0.7)

        if temperature > 0.9:
            suggestions.append({
                'category': '模型配置',
                'priority': 'low',
                'suggestion': '当前温度设置较高，可能导致回答不够稳定',
                'action': '考虑将temperature调整为0.7-0.8之间'
            })

        # 检查工具配置
        tools = json.loads(agent['tools']) if agent['tools'] else []
        if not tools:
            suggestions.append({
                'category': '工具配置',
                'priority': 'medium',
                'suggestion': '智能体未配置任何工具，建议添加知识库搜索等工具以增强能力',
                'action': '为智能体添加相关工具'
            })

        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'suggestions': suggestions,
                'agent_name': agent['name']
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取优化建议失败: {str(e)}'}), 500

# ============ 知识库管理 API ============

@app.route('/api/admin/knowledge-bases', methods=['GET'])
def get_knowledge_bases():
    """获取知识库列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, vector_db_id, document_count, created_at, updated_at
            FROM knowledge_bases
            ORDER BY created_at DESC
        """)
        kbs = cursor.fetchall()
        conn.close()

        result = []
        for kb in kbs:
            result.append({
                'id': kb['id'],
                'name': kb['name'],
                'description': kb['description'],
                'vector_db_id': kb['vector_db_id'],
                'document_count': kb['document_count'],
                'created_at': kb['created_at'],
                'updated_at': kb['updated_at']
            })

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取知识库列表失败: {str(e)}'}), 500

@app.route('/api/admin/knowledge-bases', methods=['POST'])
def create_knowledge_base():
    """创建知识库"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        name = data.get('name')
        description = data.get('description', '')

        if not name:
            return jsonify({'success': False, 'message': '知识库名称不能为空'}), 400

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            """INSERT INTO knowledge_bases (name, description, created_by)
               VALUES (?, ?, ?)""",
            (name, description, user_id)
        )

        kb_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '知识库创建成功',
            'data': {'id': kb_id}
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建知识库失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>/knowledge-bases/<int:kb_id>', methods=['POST'])
def bind_knowledge_base(agent_id, kb_id):
    """绑定知识库到智能体"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 检查是否已绑定
        cursor.execute(
            "SELECT id FROM agent_knowledge_bases WHERE agent_id = ? AND knowledge_base_id = ?",
            (agent_id, kb_id)
        )
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '知识库已绑定'}), 400

        cursor.execute(
            """INSERT INTO agent_knowledge_bases (agent_id, knowledge_base_id)
               VALUES (?, ?)""",
            (agent_id, kb_id)
        )

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '知识库绑定成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'绑定知识库失败: {str(e)}'}), 500

@app.route('/api/admin/agents/<int:agent_id>/knowledge-bases/<int:kb_id>', methods=['DELETE'])
def unbind_knowledge_base(agent_id, kb_id):
    """解绑知识库"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            "DELETE FROM agent_knowledge_bases WHERE agent_id = ? AND knowledge_base_id = ?",
            (agent_id, kb_id)
        )

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '知识库解绑成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'解绑知识库失败: {str(e)}'}), 500


# ============ v9 版本的知识库管理 API ============

@app.route('/api/v9/knowledge/bases', methods=['GET'])
def v9_get_knowledge_bases():
    """获取知识库列表 (v9 版本)"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, vector_db_id, document_count, created_at, updated_at
            FROM knowledge_bases
            ORDER BY created_at DESC
        """)
        kbs = cursor.fetchall()
        conn.close()

        result = []
        for kb in kbs:
            result.append({
                'id': kb['id'],
                'name': kb['name'],
                'description': kb['description'],
                'vector_db_id': kb['vector_db_id'],
                'document_count': kb['document_count'],
                'created_at': kb['created_at'],
                'updated_at': kb['updated_at']
            })

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取知识库列表失败: {str(e)}'}), 500


@app.route('/api/v9/knowledge/bases', methods=['POST'])
def v9_create_knowledge_base():
    """创建知识库 (v9 版本)"""
    try:
        data = request.json
        name = data.get('name')
        description = data.get('description', '')
        created_by = data.get('created_by')

        if not name:
            return jsonify({'success': False, 'message': '知识库名称不能为空'}), 400

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            """INSERT INTO knowledge_bases (name, description, created_by)
               VALUES (?, ?, ?)""",
            (name, description, created_by)
        )

        kb_id = cursor.lastrowid
        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '知识库创建成功',
            'data': {'id': kb_id, 'name': name}
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建知识库失败: {str(e)}'}), 500


@app.route('/api/v9/agent/<int:agent_id>/bind-kb/<int:kb_id>', methods=['POST'])
def v9_bind_knowledge_base(agent_id, kb_id):
    """绑定知识库到智能体 (v9 版本)"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        # 检查是否已绑定
        cursor.execute(
            "SELECT id FROM agent_knowledge_bases WHERE agent_id = ? AND knowledge_base_id = ?",
            (agent_id, kb_id)
        )
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '知识库已绑定'}), 400

        cursor.execute(
            """INSERT INTO agent_knowledge_bases (agent_id, knowledge_base_id)
               VALUES (?, ?)""",
            (agent_id, kb_id)
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '知识库绑定成功',
            'data': {'agent_id': agent_id, 'kb_id': kb_id}
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'绑定知识库失败: {str(e)}'}), 500


@app.route('/api/v9/agent/<int:agent_id>/unbind-kb/<int:kb_id>', methods=['DELETE'])
def v9_unbind_knowledge_base(agent_id, kb_id):
    """解绑知识库 (v9 版本)"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute(
            "DELETE FROM agent_knowledge_bases WHERE agent_id = ? AND knowledge_base_id = ?",
            (agent_id, kb_id)
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '知识库解绑成功',
            'data': {'agent_id': agent_id, 'kb_id': kb_id}
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'解绑知识库失败: {str(e)}'}), 500


@app.route('/api/v9/knowledge/items', methods=['GET'])
def v9_get_knowledge_items():
    """获取知识库条目列表 (所有用户可见)"""
    try:
        category = request.args.get('category', 'all')
        search = request.args.get('search', '')
        
        conn = get_db()
        cursor = conn.cursor()
        
        if category == 'all':
            if search:
                cursor.execute("""
                    SELECT id, title, content, category, source, tags, created_at, updated_at, access_count
                    FROM knowledge
                    WHERE is_public = 1 AND (title LIKE ? OR content LIKE ?)
                    ORDER BY created_at DESC
                """, (f'%{search}%', f'%{search}%'))
            else:
                cursor.execute("""
                    SELECT id, title, content, category, source, tags, created_at, updated_at, access_count
                    FROM knowledge
                    WHERE is_public = 1
                    ORDER BY created_at DESC
                """)
        else:
            if search:
                cursor.execute("""
                    SELECT id, title, content, category, source, tags, created_at, updated_at, access_count
                    FROM knowledge
                    WHERE is_public = 1 AND category = ? AND (title LIKE ? OR content LIKE ?)
                    ORDER BY created_at DESC
                """, (category, f'%{search}%', f'%{search}%'))
            else:
                cursor.execute("""
                    SELECT id, title, content, category, source, tags, created_at, updated_at, access_count
                    FROM knowledge
                    WHERE is_public = 1 AND category = ?
                    ORDER BY created_at DESC
                """, (category,))
        
        items = cursor.fetchall()
        conn.close()
        
        result = []
        for item in items:
            result.append({
                'id': item['id'],
                'title': item['title'],
                'content': item['content'],
                'category': item['category'],
                'source': item['source'],
                'tags': item['tags'].split(',') if item['tags'] else [],
                'created_at': item['created_at'],
                'updated_at': item['updated_at'],
                'access_count': item['access_count']
            })
        
        return jsonify({'success': True, 'data': result})
    
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取知识库条目失败: {str(e)}'}), 500


@app.route('/api/v9/knowledge/items/<int:item_id>/view', methods=['POST'])
def v9_view_knowledge_item(item_id):
    """浏览知识库条目并扣费 (每次1点灵值)"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 检查知识库条目是否存在
        cursor.execute("SELECT * FROM knowledge WHERE id = ?", (item_id,))
        item = cursor.fetchone()
        if not item:
            conn.close()
            return jsonify({'success': False, 'message': '知识库条目不存在'}), 404
        
        # 检查用户灵值是否足够
        cursor.execute("SELECT total_lingzhi FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        if not user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404
        
        if user['total_lingzhi'] < 1:
            conn.close()
            return jsonify({'success': False, 'message': '灵值不足，无法浏览'}), 400
        
        # 扣除1点灵值
        cursor.execute("UPDATE users SET total_lingzhi = total_lingzhi - 1 WHERE id = ?", (user_id,))
        
        # 更新浏览次数
        cursor.execute("UPDATE knowledge SET access_count = access_count + 1 WHERE id = ?", (item_id,))
        
        # 记录消费记录
        cursor.execute("""
            INSERT INTO lingzhi_consumption_records (user_id, lingzhi_amount, consumption_type, consumption_item, item_id, description)
            VALUES (?, -1, 'knowledge_view', '知识库浏览', ?, '浏览知识库条目')
        """, (user_id, item_id))
        
        conn.commit()
        
        # 获取更新后的数据
        cursor.execute("SELECT total_lingzhi FROM users WHERE id = ?", (user_id,))
        updated_user = cursor.fetchone()
        
        # 获取知识库条目详情
        cursor.execute("SELECT * FROM knowledge WHERE id = ?", (item_id,))
        updated_item = cursor.fetchone()
        
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '浏览成功',
            'data': {
                'item': {
                    'id': updated_item['id'],
                    'title': updated_item['title'],
                    'content': updated_item['content'],
                    'category': updated_item['category'],
                    'source': updated_item['source'],
                    'tags': updated_item['tags'].split(',') if updated_item['tags'] else [],
                    'created_at': updated_item['created_at'],
                    'updated_at': updated_item['updated_at'],
                    'access_count': updated_item['access_count']
                },
                'user_lingzhi': updated_user['total_lingzhi'],
                'consumed': 1
            }
        })
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'浏览失败: {str(e)}'}), 500


# ============ 智能体对话 API ============

@app.route('/api/chat', methods=['POST'])
def chat_with_agent():
    """与智能体对话"""
    try:
        data = request.json
        message = data.get('message')
        conversation_id = data.get('conversation_id')
        agent_id = data.get('agent_id', 1)  # 默认使用第一个智能体

        if not message:
            return jsonify({'success': False, 'message': '消息内容不能为空'}), 400

        # 可选：验证用户身份
        auth_header = request.headers.get('Authorization')
        user_id = None
        if auth_header and auth_header.startswith('Bearer '):
            token = auth_header.replace('Bearer ', '')
            user_id = verify_token(token)

        conn = get_db()
        cursor = conn.cursor()

        # 获取智能体配置
        cursor.execute("SELECT * FROM agents WHERE id = ?", (agent_id,))
        agent = cursor.fetchone()

        if not agent:
            conn.close()
            return jsonify({'success': False, 'message': '智能体不存在'}), 404

        # 调用大模型
        if LLM_AVAILABLE:
            ctx = new_context(method="chat")
            llm_client = LLMClient(ctx=ctx)

            model_config = json.loads(agent['model_config'])

            messages = [
                SystemMessage(content=agent['system_prompt']),
                HumanMessage(content=message)
            ]

            # 调用模型（增加超时控制）
            try:
                import signal
                import threading
                from queue import Queue
                
                # 使用线程执行LLM调用
                result_queue = Queue()
                error_queue = Queue()
                
                def invoke_worker():
                    try:
                        print(f"[智能体聊天] 开始调用LLM，超时时间: 30秒")
                        response = llm_client.invoke(
                            messages=messages,
                            model=model_config.get('model', 'deepseek-v3-2'),
                            temperature=model_config.get('temperature', 0.7),
                            thinking=model_config.get('thinking', 'disabled'),
                            max_completion_tokens=model_config.get('max_tokens', 8000)
                        )
                        result_queue.put(response)
                        print(f"[智能体聊天] LLM调用成功")
                    except Exception as e:
                        print(f"[智能体聊天] LLM调用异常: {str(e)}")
                        error_queue.put(e)
                
                # 启动线程
                thread = threading.Thread(target=invoke_worker, daemon=True)
                thread.start()
                
                # 等待线程完成或超时
                thread.join(timeout=30)
                
                if thread.is_alive():
                    # 线程仍在运行，超时
                    print(f"[智能体聊天] LLM调用超时（30秒）")
                    ai_message = "抱歉，智能服务响应超时，请稍后重试。"
                else:
                    # 线程已完成
                    if not error_queue.empty():
                        error = error_queue.get()
                        raise error
                    
                    if not result_queue.empty():
                        response = result_queue.get()
                        if response and hasattr(response, 'content'):
                            ai_message = response.content
                        else:
                            ai_message = "抱歉，我现在无法回答您的问题。"
                    else:
                        raise Exception("LLM调用未返回结果")
            except Exception as e:
                print(f"[智能体聊天] LLM调用失败: {str(e)}")
                import traceback
                traceback.print_exc()
                ai_message = "抱歉，服务暂时不可用，请稍后再试。"
        else:
            ai_message = f"智能体已收到您的消息：{message}"

        # 保存对话记录
        if conversation_id:
            cursor.execute("SELECT messages FROM conversations WHERE conversation_id = ?", (conversation_id,))
            conv = cursor.fetchone()
            if conv:
                messages = json.loads(conv['messages']) if conv['messages'] else []
                messages.append({
                    'role': 'user',
                    'content': message,
                    'timestamp': datetime.now().isoformat()
                })
                messages.append({
                    'role': 'assistant',
                    'content': ai_message,
                    'timestamp': datetime.now().isoformat()
                })
                cursor.execute(
                    "UPDATE conversations SET messages = ?, updated_at = CURRENT_TIMESTAMP WHERE conversation_id = ?",
                    (json.dumps(messages), conversation_id)
                )
            else:
                messages = [
                    {
                        'role': 'user',
                        'content': message,
                        'timestamp': datetime.now().isoformat()
                    },
                    {
                        'role': 'assistant',
                        'content': ai_message,
                        'timestamp': datetime.now().isoformat()
                    }
                ]
                cursor.execute(
                    """INSERT INTO conversations (agent_id, user_id, conversation_id, messages, title)
                       VALUES (?, ?, ?, ?, ?)""",
                    (agent_id, user_id, conversation_id, json.dumps(messages), message[:50])
                )
        else:
            # 创建新对话
            conversation_id = str(int(datetime.now().timestamp()))
            messages = [
                {
                    'role': 'user',
                    'content': message,
                    'timestamp': datetime.now().isoformat()
                },
                {
                    'role': 'assistant',
                    'content': ai_message,
                    'timestamp': datetime.now().isoformat()
                }
            ]
            cursor.execute(
                """INSERT INTO conversations (agent_id, user_id, conversation_id, messages, title)
                   VALUES (?, ?, ?, ?, ?)""",
                (agent_id, user_id, conversation_id, json.dumps(messages), message[:50])
            )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'data': {
                'message': ai_message,
                'conversation_id': conversation_id
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'对话失败: {str(e)}'}), 500

# ============ 充值管理 API ============

@app.route('/api/recharge/tiers', methods=['GET'])
def get_recharge_tiers():
    """获取充值档位列表"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT id, name, description, price, base_lingzhi, bonus_lingzhi, bonus_percentage,
                   partner_level, benefits, status, sort_order
            FROM recharge_tiers
            WHERE status = 'active'
            ORDER BY sort_order, price
        """)
        tiers = cursor.fetchall()
        conn.close()

        result = []
        for tier in tiers:
            result.append({
                'id': tier['id'],
                'name': tier['name'],
                'description': tier['description'],
                'price': float(tier['price']),
                'base_lingzhi': tier['base_lingzhi'],
                'bonus_lingzhi': tier['bonus_lingzhi'],
                'total_lingzhi': tier['base_lingzhi'] + tier['bonus_lingzhi'],
                'bonus_percentage': tier['bonus_percentage'],
                'partner_level': tier['partner_level'],
                'benefits': json.loads(tier['benefits']) if tier['benefits'] else [],
                'sort_order': tier['sort_order']
            })

        return jsonify({'success': True, 'data': result})

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取充值档位失败: {str(e)}'}), 500

@app.route('/api/recharge/create-order', methods=['POST'])
def create_recharge_order():
    """创建充值订单"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        tier_id = data.get('tier_id')
        payment_method = data.get('payment_method', 'online')

        if not tier_id:
            return jsonify({'success': False, 'message': '档位ID不能为空'}), 400

        if payment_method not in ['online', 'bank_transfer']:
            return jsonify({'success': False, 'message': '支付方式无效'}), 400

        conn = get_db()
        cursor = conn.cursor()

        # 获取档位信息
        cursor.execute("SELECT * FROM recharge_tiers WHERE id = ? AND status = 'active'", (tier_id,))
        tier = cursor.fetchone()

        if not tier:
            conn.close()
            return jsonify({'success': False, 'message': '充值档位不存在或已下架'}), 404

        # 生成订单号
        order_no = f"R{datetime.now().strftime('%Y%m%d%H%M%S')}{random.randint(1000, 9999)}"

        # 创建订单
        cursor.execute(
            """INSERT INTO recharge_records (user_id, tier_id, order_no, amount, base_lingzhi, bonus_lingzhi, total_lingzhi, payment_method)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
            (
                user_id,
                tier_id,
                order_no,
                tier['price'],
                tier['base_lingzhi'],
                tier['bonus_lingzhi'],
                tier['base_lingzhi'] + tier['bonus_lingzhi'],
                payment_method
            )
        )

        order_id = cursor.lastrowid
        conn.commit()

        # 如果是公司公户转账，获取公司账户信息
        company_accounts = []
        transfer_remark = ""
        
        if payment_method == 'bank_transfer':
            # 获取用户手机号
            cursor.execute("SELECT phone FROM users WHERE id = ?", (user_id,))
            user = cursor.fetchone()
            user_phone = user['phone'] if user else ""
            
            # 生成转账备注
            transfer_remark = f"LZ充值-{user_phone}-{order_no}"
            
            # 获取公司账户信息
            cursor.execute("SELECT * FROM company_accounts WHERE is_active = 1 ORDER BY sort_order, id")
            accounts = cursor.fetchall()
            
            for account in accounts:
                company_accounts.append({
                    'account_name': account['account_name'],
                    'account_number': account['account_number'],
                    'bank_name': account['bank_name'],
                    'bank_branch': account['bank_branch'],
                    'company_name': account['company_name']
                })
        
        conn.close()

        response_data = {
            'order_id': order_id,
            'order_no': order_no,
            'amount': float(tier['price']),
            'total_lingzhi': tier['base_lingzhi'] + tier['bonus_lingzhi'],
            'payment_method': payment_method
        }
        
        # 如果是公司公户转账，添加账户信息和转账备注
        if payment_method == 'bank_transfer':
            response_data['company_accounts'] = company_accounts
            response_data['transfer_remark'] = transfer_remark

        return jsonify({
            'success': True,
            'message': '订单创建成功',
            'data': response_data
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'创建订单失败: {str(e)}'}), 500

@app.route('/api/recharge/complete-payment', methods=['POST'])
def complete_recharge_payment():
    """完成充值支付（模拟支付回调）"""
    try:
        data = request.json
        order_no = data.get('order_no')
        transaction_id = data.get('transaction_id')

        if not order_no:
            return jsonify({'success': False, 'message': '订单号不能为空'}), 400

        conn = get_db()
        cursor = conn.cursor()

        # 获取订单信息
        cursor.execute("""
            SELECT id, user_id, total_lingzhi, base_lingzhi, bonus_lingzhi, payment_status
            FROM recharge_records
            WHERE order_no = ? AND status = 'active'
        """, (order_no,))
        order = cursor.fetchone()

        if not order:
            conn.close()
            return jsonify({'success': False, 'message': '订单不存在'}), 404

        if order['payment_status'] == 'paid':
            conn.close()
            return jsonify({'success': False, 'message': '订单已支付'}), 400

        # 更新订单状态
        cursor.execute(
            """UPDATE recharge_records
               SET payment_status = 'paid',
                   payment_time = CURRENT_TIMESTAMP,
                   transaction_id = ?
               WHERE id = ?""",
            (transaction_id, order['id'])
        )

        # 增加用户灵值
        cursor.execute(
            """UPDATE users
               SET total_lingzhi = total_lingzhi + ?,
                   updated_at = CURRENT_TIMESTAMP
               WHERE id = ?""",
            (order['total_lingzhi'], order['user_id'])
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '充值成功',
            'data': {
                'total_lingzhi': order['total_lingzhi']
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'充值失败: {str(e)}'}), 500

@app.route('/api/company/accounts', methods=['GET'])
def get_company_accounts():
    """获取公司收款账户信息"""
    try:
        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("SELECT * FROM company_accounts WHERE is_active = 1 ORDER BY sort_order, id")
        accounts = cursor.fetchall()
        conn.close()

        result = []
        for account in accounts:
            result.append({
                'id': account['id'],
                'account_name': account['account_name'],
                'account_number': account['account_number'],
                'bank_name': account['bank_name'],
                'bank_branch': account['bank_branch'],
                'company_name': account['company_name'],
                'company_credit_code': account['company_credit_code'],
                'account_type': account['account_type']
            })

        return jsonify({
            'success': True,
            'data': result
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取公司账户信息失败: {str(e)}'}), 500

@app.route('/api/recharge/upload-voucher', methods=['POST'])
def upload_transfer_voucher():
    """上传转账凭证"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        order_no = request.form.get('order_no')
        transfer_amount = request.form.get('transfer_amount')
        transfer_time = request.form.get('transfer_time')
        transfer_account = request.form.get('transfer_account', '')
        remark = request.form.get('remark', '')

        if not order_no:
            return jsonify({'success': False, 'message': '订单号不能为空'}), 400

        if not transfer_amount:
            return jsonify({'success': False, 'message': '转账金额不能为空'}), 400

        # 检查是否有上传文件
        if 'voucher_file' not in request.files:
            return jsonify({'success': False, 'message': '请上传转账凭证'}), 400

        file = request.files['voucher_file']
        if file.filename == '':
            return jsonify({'success': False, 'message': '文件名为空'}), 400

        # 简单的文件验证
        allowed_extensions = {'jpg', 'jpeg', 'png', 'pdf'}
        file_ext = file.filename.split('.')[-1].lower() if '.' in file.filename else ''
        if file_ext not in allowed_extensions:
            return jsonify({'success': False, 'message': '仅支持JPG、PNG、PDF格式'}), 400

        # 保存文件到临时目录
        import os
        upload_dir = '/tmp/vouchers'
        if not os.path.exists(upload_dir):
            os.makedirs(upload_dir)
        
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        filename = f"{order_no}_{timestamp}_{random.randint(1000, 9999)}.{file_ext}"
        file_path = os.path.join(upload_dir, filename)
        file.save(file_path)
        
        # 生成文件URL（这里使用相对路径，实际应该是上传到对象存储）
        image_url = f"/uploads/vouchers/{filename}"

        conn = get_db()
        cursor = conn.cursor()

        # 获取充值记录
        cursor.execute("SELECT id, user_id, amount FROM recharge_records WHERE order_no = ?", (order_no,))
        recharge_record = cursor.fetchone()

        if not recharge_record:
            conn.close()
            return jsonify({'success': False, 'message': '订单不存在'}), 404

        # 验证用户权限
        if recharge_record['user_id'] != user_id:
            conn.close()
            return jsonify({'success': False, 'message': '无权操作此订单'}), 403

        # 验证转账金额
        try:
            amount = float(transfer_amount)
            if abs(amount - float(recharge_record['amount'])) > 0.01:
                conn.close()
                return jsonify({'success': False, 'message': '转账金额与订单金额不符'}), 400
        except:
            conn.close()
            return jsonify({'success': False, 'message': '转账金额格式错误'}), 400

        # 解析转账时间
        parsed_transfer_time = None
        if transfer_time:
            try:
                parsed_transfer_time = datetime.strptime(transfer_time, '%Y-%m-%d %H:%M:%S')
            except:
                pass

        # 插入转账凭证
        cursor.execute(
            """INSERT INTO transfer_vouchers (recharge_record_id, user_id, image_url, transfer_amount, transfer_time, transfer_account, remark)
               VALUES (?, ?, ?, ?, ?, ?, ?)""",
            (
                recharge_record['id'],
                user_id,
                image_url,
                amount,
                parsed_transfer_time,
                transfer_account,
                remark
            )
        )

        voucher_id = cursor.lastrowid

        # 更新充值记录状态
        cursor.execute(
            """UPDATE recharge_records
               SET voucher_id = ?, audit_status = 'pending', payment_status = 'pending'
               WHERE id = ?""",
            (voucher_id, recharge_record['id'])
        )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '凭证上传成功，等待审核',
            'data': {
                'voucher_id': voucher_id,
                'audit_status': 'pending'
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'上传凭证失败: {str(e)}'}), 500

@app.route('/api/recharge/voucher/<int:voucher_id>', methods=['GET'])
def get_voucher_detail(voucher_id):
    """获取转账凭证详情"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("""
            SELECT tv.*, rr.order_no, rr.amount as order_amount
            FROM transfer_vouchers tv
            LEFT JOIN recharge_records rr ON tv.recharge_record_id = rr.id
            WHERE tv.id = ? AND tv.user_id = ?
        """, (voucher_id, user_id))
        voucher = cursor.fetchone()
        conn.close()

        if not voucher:
            return jsonify({
                'success': False,
                'message': '凭证不存在'
            }), 404

        return jsonify({
            'success': True,
            'data': {
                'id': voucher['id'],
                'recharge_record_id': voucher['recharge_record_id'],
                'order_no': voucher['order_no'],
                'image_url': voucher['image_url'],
                'transfer_amount': float(voucher['transfer_amount']),
                'transfer_time': voucher['transfer_time'],
                'transfer_account': voucher['transfer_account'],
                'remark': voucher['remark'],
                'audit_status': voucher['audit_status'],
                'audit_remark': voucher['audit_remark'],
                'created_at': voucher['created_at']
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取凭证详情失败: {str(e)}'}), 500

@app.route('/api/admin/vouchers/pending', methods=['GET'])
def get_pending_vouchers():
    """管理员获取待审核凭证列表"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        page = request.args.get('page', 1, type=int)
        page_size = request.args.get('page_size', 20, type=int)
        offset = (page - 1) * page_size

        conn = get_db()
        cursor = conn.cursor()

        # 获取待审核凭证
        cursor.execute("""
            SELECT tv.*, u.username, u.phone, rr.order_no, rr.amount as order_amount, rt.name as tier_name
            FROM transfer_vouchers tv
            LEFT JOIN users u ON tv.user_id = u.id
            LEFT JOIN recharge_records rr ON tv.recharge_record_id = rr.id
            LEFT JOIN recharge_tiers rt ON rr.tier_id = rt.id
            WHERE tv.audit_status = 'pending'
            ORDER BY tv.created_at DESC
            LIMIT ? OFFSET ?
        """, (page_size, offset))
        vouchers = cursor.fetchall()

        # 获取总数
        cursor.execute("SELECT COUNT(*) as total FROM transfer_vouchers WHERE audit_status = 'pending'")
        total = cursor.fetchone()['total']

        conn.close()

        result = []
        for voucher in vouchers:
            result.append({
                'id': voucher['id'],
                'user_id': voucher['user_id'],
                'username': voucher['username'],
                'user_phone': voucher['phone'],
                'recharge_record_id': voucher['recharge_record_id'],
                'order_no': voucher['order_no'],
                'tier_name': voucher['tier_name'],
                'order_amount': float(voucher['order_amount']),
                'image_url': voucher['image_url'],
                'transfer_amount': float(voucher['transfer_amount']),
                'transfer_time': voucher['transfer_time'],
                'transfer_account': voucher['transfer_account'],
                'remark': voucher['remark'],
                'created_at': voucher['created_at']
            })

        return jsonify({
            'success': True,
            'data': {
                'total': total,
                'page': page,
                'page_size': page_size,
                'records': result
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取待审核凭证列表失败: {str(e)}'}), 500

@app.route('/api/admin/vouchers/<int:voucher_id>/audit', methods=['POST'])
def audit_voucher(voucher_id):
    """管理员审核转账凭证"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        audit_status = data.get('audit_status')
        audit_remark = data.get('audit_remark', '')

        if audit_status not in ['approved', 'rejected']:
            return jsonify({'success': False, 'message': '审核状态无效'}), 400

        conn = get_db()
        cursor = conn.cursor()

        # 获取凭证信息
        cursor.execute("""
            SELECT tv.*, rr.user_id, rr.total_lingzhi, rr.id as record_id
            FROM transfer_vouchers tv
            LEFT JOIN recharge_records rr ON tv.recharge_record_id = rr.id
            WHERE tv.id = ?
        """, (voucher_id,))
        voucher = cursor.fetchone()

        if not voucher:
            conn.close()
            return jsonify({'success': False, 'message': '凭证不存在'}), 404

        # 更新凭证审核状态
        cursor.execute(
            """UPDATE transfer_vouchers
               SET audit_status = ?, audit_user_id = ?, audit_time = CURRENT_TIMESTAMP, audit_remark = ?
               WHERE id = ?""",
            (audit_status, user_id, audit_remark, voucher_id)
        )

        # 更新充值记录状态
        if audit_status == 'approved':
            # 审核通过，充值到账
            cursor.execute(
                """UPDATE recharge_records
                   SET audit_status = 'approved', payment_status = 'paid', payment_time = CURRENT_TIMESTAMP
                   WHERE id = ?""",
                (voucher['record_id'],)
            )
            
            # 增加用户灵值
            cursor.execute(
                """UPDATE users
                   SET total_lingzhi = total_lingzhi + ?
                   WHERE id = ?""",
                (voucher['total_lingzhi'], voucher['user_id'])
            )
        else:
            # 审核不通过
            cursor.execute(
                """UPDATE recharge_records
                   SET audit_status = 'rejected'
                   WHERE id = ?""",
                (voucher['record_id'],)
            )

        conn.commit()
        conn.close()

        return jsonify({
            'success': True,
            'message': '审核成功',
            'data': {
                'voucher_id': voucher_id,
                'audit_status': audit_status,
                'user_lingzhi': voucher['total_lingzhi'] if audit_status == 'approved' else 0
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'审核失败: {str(e)}'}), 500

@app.route('/api/admin/vouchers', methods=['GET'])
def get_all_vouchers():
    """管理员获取所有转账凭证"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        page = request.args.get('page', 1, type=int)
        page_size = request.args.get('page_size', 20, type=int)
        audit_status = request.args.get('audit_status')
        offset = (page - 1) * page_size

        conn = get_db()
        cursor = conn.cursor()

        # 构建查询条件
        where_clause = ""
        params = []
        
        if audit_status:
            where_clause = "WHERE tv.audit_status = ?"
            params.append(audit_status)

        # 获取凭证列表
        cursor.execute(f"""
            SELECT tv.*, u.username, u.phone, rr.order_no, rr.amount as order_amount
            FROM transfer_vouchers tv
            LEFT JOIN users u ON tv.user_id = u.id
            LEFT JOIN recharge_records rr ON tv.recharge_record_id = rr.id
            {where_clause}
            ORDER BY tv.created_at DESC
            LIMIT ? OFFSET ?
        """, params + [page_size, offset])
        vouchers = cursor.fetchall()

        # 获取总数
        cursor.execute(f"SELECT COUNT(*) as total FROM transfer_vouchers {where_clause}", params)
        total = cursor.fetchone()['total']

        conn.close()

        result = []
        for voucher in vouchers:
            result.append({
                'id': voucher['id'],
                'user_id': voucher['user_id'],
                'username': voucher['username'],
                'user_phone': voucher['phone'],
                'recharge_record_id': voucher['recharge_record_id'],
                'order_no': voucher['order_no'],
                'order_amount': float(voucher['order_amount']),
                'image_url': voucher['image_url'],
                'transfer_amount': float(voucher['transfer_amount']),
                'transfer_time': voucher['transfer_time'],
                'transfer_account': voucher['transfer_account'],
                'audit_status': voucher['audit_status'],
                'audit_time': voucher['audit_time'],
                'audit_remark': voucher['audit_remark'],
                'created_at': voucher['created_at']
            })

        return jsonify({
            'success': True,
            'data': {
                'total': total,
                'page': page,
                'page_size': page_size,
                'records': result
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取凭证列表失败: {str(e)}'}), 500

@app.route('/api/recharge/records', methods=['GET'])
def get_recharge_records():
    """获取充值记录"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        page = request.args.get('page', 1, type=int)
        page_size = request.args.get('page_size', 20, type=int)
        offset = (page - 1) * page_size

        conn = get_db()
        cursor = conn.cursor()

        # 获取充值记录
        cursor.execute("""
            SELECT rr.id, rr.order_no, rr.amount, rr.base_lingzhi, rr.bonus_lingzhi,
                   rr.total_lingzhi, rr.payment_status, rr.payment_time, rt.name as tier_name
            FROM recharge_records rr
            LEFT JOIN recharge_tiers rt ON rr.tier_id = rt.id
            WHERE rr.user_id = ?
            ORDER BY rr.created_at DESC
            LIMIT ? OFFSET ?
        """, (user_id, page_size, offset))
        records = cursor.fetchall()

        # 获取总数
        cursor.execute("SELECT COUNT(*) as total FROM recharge_records WHERE user_id = ?", (user_id,))
        total = cursor.fetchone()['total']

        conn.close()

        result = []
        for record in records:
            result.append({
                'id': record['id'],
                'order_no': record['order_no'],
                'amount': float(record['amount']),
                'base_lingzhi': record['base_lingzhi'],
                'bonus_lingzhi': record['bonus_lingzhi'],
                'total_lingzhi': record['total_lingzhi'],
                'payment_status': record['payment_status'],
                'payment_time': record['payment_time'],
                'tier_name': record['tier_name']
            })

        return jsonify({
            'success': True,
            'data': {
                'records': result,
                'total': total,
                'page': page,
                'page_size': page_size
            }
        })

    except Exception as e:
        return jsonify({'success': False, 'message': f'获取充值记录失败: {str(e)}'}), 500

# ============ 微信登录接口 ============

@app.route('/api/wechat/login', methods=['GET'])
def wechat_login():
    """获取微信登录授权URL"""
    try:
        print(f"[微信登录] 收到微信登录请求，IP: {request.remote_addr}")
        
        # 模拟模式：如果未配置微信 AppID，返回模拟回调 URL
        if not WECHAT_APP_ID:
            print("[微信登录] ⚠️ 微信 AppID 未配置，使用模拟模式")
            
            # 生成模拟用户数据
            mock_user_id = random.randint(10000, 99999)
            mock_token = jwt.encode({
                'user_id': mock_user_id,
                'exp': datetime.utcnow() + timedelta(days=7)
            }, JWT_SECRET)
            
            mock_user = {
                'id': mock_user_id,
                'username': f'微信用户{mock_user_id}',
                'avatar_url': 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + str(mock_user_id)
            }
            
            # 构造模拟回调 URL
            callback_url = f"{WECHAT_REDIRECT_URI}?token={mock_token}&user={quote(json.dumps(mock_user))}&simulate=true"
            
            print(f"[微信登录] 模拟模式回调URL已生成: {callback_url[:100]}...")
            
            return jsonify({
                'success': True,
                'data': {
                    'auth_url': callback_url,
                    'state': 'mock_state',
                    'simulate': True
                }
            })

        # 正常模式：调用微信授权接口
        print(f"[微信登录] 使用真实微信登录模式")
        # 生成state参数用于防止CSRF
        state = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
        print(f"[微信登录] 生成state参数: {state}")
        
        # 构造微信授权URL
        params = {
            'appid': WECHAT_APP_ID,
            'redirect_uri': WECHAT_REDIRECT_URI,
            'response_type': 'code',
            'scope': 'snsapi_userinfo',
            'state': state
        }
        
        auth_url = f"https://open.weixin.qq.com/connect/qrconnect?{urlencode(params)}#wechat_redirect"
        print(f"[微信登录] 微信授权URL已生成")
        
        return jsonify({
            'success': True,
            'data': {
                'auth_url': auth_url,
                'state': state,
                'simulate': False
            }
        })
    except Exception as e:
        import traceback
        print(f"[微信登录] 错误: {str(e)}")
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'获取微信登录URL失败: {str(e)}'}), 500

@app.route('/api/wechat/callback', methods=['GET'])
def wechat_callback():
    """微信登录回调处理 - 智能判断注册/登录
    
    逻辑：
    1. 获取微信信息
    2. 检查用户是否已存在
    3. 已存在：直接登录，返回token
    4. 不存在：返回微信信息，前端弹出手机号补充表单
    """
    try:
        print(f"[微信回调] 收到微信回调请求，IP: {request.remote_addr}")
        
        # 检查是否为模拟模式
        simulate = request.args.get('simulate')
        token_param = request.args.get('token')
        user_param = request.args.get('user')
        
        print(f"[微信回调] simulate={simulate}, has_token={bool(token_param)}, has_user={bool(user_param)}")
        
        if simulate == 'true' and token_param and user_param:
            # 模拟模式：返回模拟的微信信息
            print("[微信回调] 处理模拟模式")
            try:
                # URL 解码用户数据
                user_data = json.loads(unquote(user_param))
                # 验证 token
                decoded = jwt.decode(token_param, JWT_SECRET, algorithms=['HS256'])
                openid = f'mock_{decoded["user_id"]}'
                print(f"[微信回调] 模拟用户openid: {openid}, username: {user_data['username']}")
                
                # 检查用户是否存在
                conn = get_db()
                cursor = conn.cursor()
                cursor.execute("SELECT * FROM users WHERE wechat_openid = ?", (openid,))
                user = cursor.fetchone()
                conn.close()
                
                if user:
                    print(f"[微信回调] 模拟用户已存在，用户ID: {user['id']}")
                    # 用户已存在，直接登录
                    # 生成token
                    token = jwt.encode({
                        'user_id': user['id'],
                        'exp': datetime.utcnow() + timedelta(days=7)
                    }, JWT_SECRET)
                    
                    return jsonify({
                        'success': True,
                        'message': '登录成功',
                        'data': {
                            'token': token,
                            'user': {
                                'id': user['id'],
                                'username': user['username'],
                                'email': user['email'],
                                'phone': user['phone'],
                                'avatar_url': user['avatar_url'],
                                'total_lingzhi': user['total_lingzhi'],
                                'level': user['level']
                            },
                            'is_new_user': False
                        }
                    })
                else:
                    print(f"[微信回调] 模拟用户不存在，返回注册信息")
                    # 用户不存在，返回微信信息
                    return jsonify({
                        'success': True,
                        'message': '获取微信信息成功',
                        'data': {
                            'wechat_openid': openid,
                            'wechat_nickname': user_data['username'],
                            'wechat_avatar': user_data['avatar_url'],
                            'is_new_user': True
                        }
                    })
            except Exception as e:
                print(f"[微信回调] 模拟登录失败: {str(e)}")
                import traceback
                traceback.print_exc()
                return jsonify({'success': False, 'message': f'模拟登录失败: {str(e)}'}), 400
        
        # 正常模式：处理微信授权回调
        print("[微信回调] 处理真实微信授权")
        code = request.args.get('code')
        state = request.args.get('state')
        
        print(f"[微信回调] code={code[:10] if code else None}..., state={state}")
        
        if not code:
            print("[微信回调] 错误: 未获取到授权码")
            return jsonify({'success': False, 'message': '未获取到授权码'}), 400

        # 第一步：通过code获取access_token
        token_url = f"https://api.weixin.qq.com/sns/oauth2/access_token?appid={WECHAT_APP_ID}&secret={WECHAT_APP_SECRET}&code={code}&grant_type=authorization_code"
        print(f"[微信回调] 请求微信access_token...")
        
        token_response = requests.get(token_url, timeout=10)
        token_data = token_response.json()
        
        print(f"[微信回调] 微信响应: {token_data}")
        
        if 'errcode' in token_data:
            print(f"[微信回调] 微信授权失败: {token_data.get('errmsg')}")
            return jsonify({'success': False, 'message': f'微信授权失败: {token_data.get("errmsg")}'}), 400
        
        access_token = token_data.get('access_token')
        openid = token_data.get('openid')
        unionid = token_data.get('unionid')
        
        print(f"[微信回调] 获取到access_token, openid={openid}, unionid={unionid}")
        
        # 第二步：获取用户信息
        user_info_url = f"https://api.weixin.qq.com/sns/userinfo?access_token={access_token}&openid={openid}"
        print(f"[微信回调] 请求微信用户信息...")
        
        user_info_response = requests.get(user_info_url, timeout=10)
        user_info = user_info_response.json()
        
        print(f"[微信回调] 用户信息响应: {user_info}")
        
        if 'errcode' in user_info:
            print(f"[微信回调] 获取用户信息失败: {user_info.get('errmsg')}")
            return jsonify({'success': False, 'message': f'获取用户信息失败: {user_info.get("errmsg")}'}), 400
        
        wechat_nickname = user_info.get('nickname', '')
        wechat_avatar = user_info.get('headimgurl', '')
        
        print(f"[微信回调] 用户昵称: {wechat_nickname}, 头像: {wechat_avatar[:50]}...")
        
        # 第三步：检查用户是否存在
        conn = get_db()
        cursor = conn.cursor()
        
        # 通过openid查找用户
        cursor.execute("SELECT * FROM users WHERE wechat_openid = ?", (openid,))
        user = cursor.fetchone()
        
        if user:
            print(f"[微信回调] 用户已存在，用户ID: {user['id']}")
            # 用户已存在，直接登录
            # 更新最后登录时间
            cursor.execute(
                "UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?",
                (user['id'],)
            )
            conn.commit()
            
            # 生成token
            token = jwt.encode({
                'user_id': user['id'],
                'exp': datetime.utcnow() + timedelta(days=7)
            }, JWT_SECRET)
            
            conn.close()
            
            return jsonify({
                'success': True,
                'message': '登录成功',
                'data': {
                    'token': token,
                    'user': {
                        'id': user['id'],
                        'username': user['username'],
                        'email': user['email'],
                        'phone': user['phone'],
                        'avatar_url': user['avatar_url'],
                        'total_lingzhi': user['total_lingzhi'],
                        'level': user['level']
                    },
                    'is_new_user': False
                }
            })
        else:
            # 用户不存在，返回微信信息
            conn.close()
            
            return jsonify({
                'success': True,
                'message': '获取微信信息成功',
                'data': {
                    'wechat_openid': openid,
                    'wechat_unionid': unionid,
                    'wechat_nickname': wechat_nickname,
                    'wechat_avatar': wechat_avatar,
                    'is_new_user': True
                }
            })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'获取微信信息失败: {str(e)}'}), 500

@app.route('/api/wechat/register', methods=['POST'])
def wechat_register():
    """微信用户注册 - 支持自动锁定推荐人"""
    try:
        data = request.get_json()
        
        # 获取必要参数
        wechat_openid = data.get('wechat_openid')
        wechat_unionid = data.get('wechat_unionid')
        wechat_nickname = data.get('wechat_nickname')
        wechat_avatar = data.get('wechat_avatar')
        username = data.get('username')
        email = data.get('email', '')
        phone = data.get('phone', '')
        password = data.get('password', '')
        referrer_id = data.get('referrer_id')  # 推荐人ID
        
        if not wechat_openid:
            return jsonify({'success': False, 'message': '微信openid不能为空'}), 400
        
        if not username:
            return jsonify({'success': False, 'message': '用户名不能为空'}), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 检查用户名是否已存在
        cursor.execute("SELECT id FROM users WHERE username = ?", (username,))
        if cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '用户名已存在'}), 400
        
        # 检查邮箱是否已存在
        if email:
            cursor.execute("SELECT id FROM users WHERE email = ?", (email,))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '邮箱已被注册'}), 400
        
        # 检查手机号是否已存在
        if phone:
            cursor.execute("SELECT id FROM users WHERE phone = ?", (phone,))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '手机号已被注册'}), 400
        
        # 验证推荐人是否存在
        if referrer_id:
            cursor.execute("SELECT id FROM users WHERE id = ?", (referrer_id,))
            if not cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '推荐人不存在'}), 400
        
        # 生成密码hash（如果没有提供密码，使用随机密码）
        if password:
            password_hash = hash_password(password)
        else:
            # 生成随机密码
            random_password = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
            password_hash = hash_password(random_password)
        
        # 创建用户
        cursor.execute("""
            INSERT INTO users (
                username, email, phone, password_hash, 
                login_type, wechat_openid, wechat_unionid,
                wechat_nickname, wechat_avatar, avatar_url,
                referrer_id, last_login_at
            ) VALUES (?, ?, ?, ?, 'wechat', ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        """, (username, email, phone, password_hash, wechat_openid, wechat_unionid, 
              wechat_nickname, wechat_avatar, wechat_avatar, referrer_id))
        
        user_id = cursor.lastrowid
        
        # 如果有推荐人，尝试创建推荐关系
        if referrer_id:
            try:
                cursor.execute(
                    """INSERT INTO referral_relationships 
                       (referrer_id, referee_id, level, status) 
                       VALUES (?, ?, 1, 'active')""",
                    (referrer_id, user_id)
                )
            except Exception as e:
                print(f"警告：无法创建referral_relationships记录: {e}")
        
        # 更新最后登录时间
        cursor.execute(
            "UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?",
            (user_id,)
        )
        
        conn.commit()
        
        # 获取新创建的用户数据
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        new_user = cursor.fetchone()
        
        conn.close()
        
        # 生成token
        token = generate_token(user_id)
        
        return jsonify({
            'success': True,
            'message': '微信注册成功',
            'data': {
                'token': token,
                'user': format_user_data(new_user)
            }
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'微信注册失败: {str(e)}'}), 500

@app.route('/api/user/profile', methods=['GET'])
def get_user_profile():
    """获取用户详细信息 - 修复：返回完整的用户信息字段"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()

        # 获取完整的用户信息（包括所有重要字段）
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()

        # 获取用户详细信息
        cursor.execute("SELECT * FROM user_profiles WHERE user_id = ?", (user_id,))
        profile = cursor.fetchone()

        conn.close()

        # 合并用户信息，确保返回完整字段（使用snake_case，自主可控方案）
        user_data = dict(user) if user else {}
        profile_data = dict(profile) if profile else {}

        # 将profile中的非空字段合并到user_data
        for key in profile_data:
            if key not in ['user_id', 'id'] and profile_data[key] is not None:
                user_data[key] = profile_data[key]

        return jsonify({
            'success': True,
            'data': {
                'user': user_data,
                'profile': dict(profile) if profile else None,
                'is_completed': profile['is_completed'] if profile else False
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'获取用户信息失败: {str(e)}'}), 500

@app.route('/api/user/profile', methods=['PUT'])
def update_user_profile():
    """更新用户基本信息 - 支持更新更多字段"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)

        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.json
        username = data.get('username')
        email = data.get('email')
        phone = data.get('phone')
        real_name = data.get('real_name')
        avatar_url = data.get('avatar_url')
        title = data.get('title')
        position = data.get('position')
        gender = data.get('gender')
        bio = data.get('bio')
        location = data.get('location')
        website = data.get('website')

        # 验证性别字段（只允许"男"或"女"）
        if gender is not None and gender not in ['男', '女']:
            return jsonify({'success': False, 'message': '性别只能选择"男"或"女"'}), 400

        # 验证至少更新一个字段（忽略推荐码字段）
        if not any([username, email, phone, real_name, avatar_url, title, position,
                    gender, bio, location, website]):
            return jsonify({'success': False, 'message': '至少需要更新一个字段'}), 400

        conn = get_db()
        cursor = conn.cursor()

        cursor.execute("SELECT username, email, phone, real_name FROM users WHERE id = ?", (user_id,))
        current_user = cursor.fetchone()

        if not current_user:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在'}), 404

        # 验证唯一性
        if username and username != current_user['username']:
            cursor.execute("SELECT id FROM users WHERE username = ? AND id != ?", (username, user_id))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '用户名已被使用'}), 400

        if email and email != current_user['email']:
            cursor.execute("SELECT id FROM users WHERE email = ? AND id != ?", (email, user_id))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '邮箱已被使用'}), 400

        if phone and phone != current_user['phone']:
            cursor.execute("SELECT id FROM users WHERE phone = ? AND id != ?", (phone, user_id))
            if cursor.fetchone():
                conn.close()
                return jsonify({'success': False, 'message': '手机号已被使用'}), 400

        # 构建更新语句
        update_fields = []
        update_values = []

        if username:
            update_fields.append("username = ?")
            update_values.append(username)
        if email is not None:
            update_fields.append("email = ?")
            update_values.append(email)
        if phone is not None:
            update_fields.append("phone = ?")
            update_values.append(phone)
        if real_name is not None:
            update_fields.append("real_name = ?")
            update_values.append(real_name)
        if avatar_url is not None:
            update_fields.append("avatar_url = ?")
            update_values.append(avatar_url)
        if title is not None:
            update_fields.append("title = ?")
            update_values.append(title)
        if position is not None:
            update_fields.append("position = ?")
            update_values.append(position)
        if gender is not None:
            update_fields.append("gender = ?")
            update_values.append(gender)
        if bio is not None:
            update_fields.append("bio = ?")
            update_values.append(bio)
        if location is not None:
            update_fields.append("location = ?")
            update_values.append(location)
        if website is not None:
            update_fields.append("website = ?")
            update_values.append(website)

        update_fields.append("updated_at = CURRENT_TIMESTAMP")
        update_values.append(user_id)

        update_sql = f"UPDATE users SET {', '.join(update_fields)} WHERE id = ?"
        cursor.execute(update_sql, update_values)

        conn.commit()

        # 获取更新后的完整用户数据
        cursor.execute("""
            SELECT id, username, email, phone, avatar_url, real_name, wechat_nickname, wechat_avatar,
                   total_lingzhi, is_verified, login_type, created_at, updated_at,
                   title, position, gender, bio, location, website
            FROM users WHERE id = ?
        """, (user_id,))
        updated_user = cursor.fetchone()

        conn.close()

        return jsonify({
            'success': True,
            'message': '用户信息更新成功',
            'data': format_user_data(updated_user)
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'更新用户信息失败: {str(e)}'}), 500

@app.route('/api/user/profile', methods=['POST'])
def complete_user_profile():
    """完善用户信息"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        data = request.get_json()
        
        real_name = data.get('real_name', '')
        phone = data.get('phone', '')
        email = data.get('email', '')
        id_card = data.get('id_card', '')
        bank_account = data.get('bank_account', '')
        bank_name = data.get('bank_name', '')
        address = data.get('address', '')
        
        # 验证必填字段
        if not real_name or not phone:
            return jsonify({'success': False, 'message': '真实姓名和手机号为必填项'}), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 检查是否已存在profile
        cursor.execute("SELECT id FROM user_profiles WHERE user_id = ?", (user_id,))
        existing_profile = cursor.fetchone()
        
        if existing_profile:
            # 更新
            cursor.execute("""
                UPDATE user_profiles 
                SET real_name = ?, phone = ?, email = ?, id_card = ?,
                    bank_account = ?, bank_name = ?, address = ?,
                    is_completed = 1, completed_at = CURRENT_TIMESTAMP,
                    updated_at = CURRENT_TIMESTAMP
                WHERE user_id = ?
            """, (real_name, phone, email, id_card, bank_account, bank_name, address, user_id))
        else:
            # 插入
            cursor.execute("""
                INSERT INTO user_profiles (
                    user_id, real_name, phone, email, id_card,
                    bank_account, bank_name, address, is_completed, completed_at
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, CURRENT_TIMESTAMP)
            """, (user_id, real_name, phone, email, id_card, bank_account, bank_name, address))
        
        # 同时更新users表
        cursor.execute("""
            UPDATE users 
            SET phone = ?, real_name = ?, is_verified = 1, updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        """, (phone, real_name, user_id))
        
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '用户信息完善成功'
        })
        
    except sqlite3.IntegrityError as e:
        return jsonify({'success': False, 'message': '手机号已被使用'}), 400
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'完善用户信息失败: {str(e)}'}), 500

@app.route('/api/user/require-complete', methods=['GET'])
def check_require_complete():
    """检查用户是否需要完善信息"""
    try:
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401

        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401

        conn = get_db()
        cursor = conn.cursor()
        
        # 获取用户详细信息
        cursor.execute("SELECT is_completed FROM user_profiles WHERE user_id = ?", (user_id,))
        profile = cursor.fetchone()
        
        # 获取登录类型
        cursor.execute("SELECT login_type FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        
        conn.close()
        
        login_type = user['login_type'] if user else 'phone'
        is_completed = profile['is_completed'] if profile else False
        
        # 只有微信登录且未完善信息的用户才需要完善信息
        need_complete = (login_type == 'wechat' and not is_completed)
        
        return jsonify({
            'success': True,
            'data': {
                'need_complete': need_complete,
                'login_type': login_type,
                'is_completed': is_completed
            }
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'检查失败: {str(e)}'}), 500

# ============ 推荐码二维码 ============

@app.route('/api/qrcode', methods=['GET'])
def get_referral_qrcode():
    """生成/获取推荐码二维码"""
    try:
        # 验证用户身份
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        token = auth_header.replace('Bearer ', '')
        user_id = verify_token(token)
        
        if not user_id:
            return jsonify({'success': False, 'message': 'token无效'}), 401
        
        # 获取用户推荐码
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT referral_code, username FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        
        if not user or not user['referral_code']:
            conn.close()
            return jsonify({'success': False, 'message': '用户不存在或推荐码未生成'}), 404
        
        referral_code = user['referral_code']
        
        # 生成推荐链接
        base_url = request.host_url.rstrip('/')
        referral_url = f"{base_url}/register?ref={referral_code}"
        
        # 生成二维码
        import qrcode
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_H,
            box_size=10,
            border=4,
        )
        qr.add_data(referral_url)
        qr.make(fit=True)

        # 创建二维码图片（使用更简单的方式避免版本兼容问题）
        img = qr.make_image()
        # 手动设置前景色和背景色
        from PIL import Image
        img = img.convert("RGB")
        pixels = img.load()
        for i in range(img.size[0]):
            for j in range(img.size[1]):
                if pixels[i, j] == 0:  # 黑色像素
                    pixels[i, j] = (102, 126, 234)  # #667eea in RGB
                else:  # 白色像素
                    pixels[i, j] = (255, 255, 255)
        
        # 添加标题
        from PIL import Image, ImageDraw, ImageFont
        # 计算需要的画布大小
        qr_width, qr_height = img.size
        title_height = 60
        total_height = qr_height + title_height
        canvas = Image.new('RGB', (qr_width, total_height), 'white')
        
        # 绘制二维码
        canvas.paste(img, (0, title_height))
        
        # 绘制标题
        draw = ImageDraw.Draw(canvas)
        try:
            # 尝试使用系统字体
            font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 20)
        except:
            # 如果系统字体不可用，使用默认字体
            font = ImageFont.load_default()
        
        title_text = f"{user['username']}的推荐码"
        subtitle_text = f"推荐码: {referral_code}"
        
        # 计算文本位置（居中）
        text_bbox = draw.textbbox((0, 0), title_text, font=font)
        title_x = (qr_width - (text_bbox[2] - text_bbox[0])) // 2
        
        text_bbox2 = draw.textbbox((0, 0), subtitle_text, font=font)
        subtitle_x = (qr_width - (text_bbox2[2] - text_bbox2[0])) // 2
        
        # 绘制文本
        draw.text((title_x, 10), title_text, fill="#333333", font=font)
        draw.text((subtitle_x, 35), subtitle_text, fill="#666666", font=font)
        
        conn.close()
        
        # 检查是否需要下载
        download = request.args.get('download', 'false').lower() == 'true'
        
        if download:
            # 保存到内存并返回文件
            from io import BytesIO
            img_io = BytesIO()
            canvas.save(img_io, 'PNG')
            img_io.seek(0)
            
            from flask import send_file
            return send_file(
                img_io,
                mimetype='image/png',
                as_attachment=True,
                download_name=f'referral_qrcode_{user_id}.png'
            )
        else:
            # 返回base64编码的图片
            from io import BytesIO
            img_io = BytesIO()
            canvas.save(img_io, 'PNG')
            img_io.seek(0)
            import base64
            img_base64 = base64.b64encode(img_io.getvalue()).decode('utf-8')
            
            return jsonify({
                'success': True,
                'data': {
                    'qrcode': f'data:image/png;base64,{img_base64}',
                    'referral_code': referral_code,
                    'referral_url': referral_url
                }
            })
            
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'生成二维码失败: {str(e)}'}), 500

@app.route('/api/referral/validate', methods=['GET'])
def validate_referral_code():
    """验证推荐码有效性"""
    try:
        referral_code = request.args.get('code')
        
        if not referral_code:
            return jsonify({'success': False, 'message': '推荐码不能为空'}), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 查询推荐码对应的用户
        cursor.execute("SELECT id, username, avatar_url FROM users WHERE referral_code = ?", (referral_code,))
        referrer = cursor.fetchone()
        
        conn.close()
        
        if not referrer:
            return jsonify({
                'success': False,
                'valid': False,
                'message': '推荐码无效'
            }), 404
        
        return jsonify({
            'success': True,
            'valid': True,
            'data': {
                'referrer_id': referrer['id'],
                'referrer_username': referrer['username'],
                'referrer_avatar': referrer['avatar_url']
            }
        })
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'验证失败: {str(e)}'}), 500

# ============ 系统通知 ============

@app.route('/api/notifications', methods=['GET'])
def get_notifications():
    """获取用户的通知"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401

        conn = get_db()
        cursor = conn.cursor()
        
        # 获取全局通知和用户专属通知
        cursor.execute('''
            SELECT n.id, n.title, n.content, n.notification_type, n.created_at,
                   CASE WHEN r.read_at IS NOT NULL THEN 1 ELSE 0 END as is_read
            FROM system_notifications n
            LEFT JOIN user_read_notifications r ON n.id = r.notification_id AND r.user_id = ?
            WHERE n.target_user_id IS NULL OR n.target_user_id = ?
            ORDER BY n.created_at DESC
            LIMIT 50
        ''', (user_id, user_id))
        
        notifications = cursor.fetchall()
        
        result = []
        for notif in notifications:
            result.append({
                'id': notif['id'],
                'title': notif['title'],
                'content': notif['content'],
                'type': notif['notification_type'],
                'isRead': bool(notif['is_read']),
                'createdAt': notif['created_at']
            })
        
        # 统计未读数量
        cursor.execute('''
            SELECT COUNT(*)
            FROM system_notifications n
            LEFT JOIN user_read_notifications r ON n.id = r.notification_id AND r.user_id = ?
            WHERE (n.target_user_id IS NULL OR n.target_user_id = ?) 
              AND r.read_at IS NULL
        ''', (user_id, user_id))
        
        unread_count = cursor.fetchone()[0]
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': {
                'notifications': result,
                'unreadCount': unread_count
            }
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取通知失败: {str(e)}'}), 500

@app.route('/api/notifications/<int:notification_id>/read', methods=['POST'])
def mark_notification_read(notification_id):
    """标记通知为已读"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401

        conn = get_db()
        cursor = conn.cursor()
        
        # 检查通知是否存在
        cursor.execute("SELECT id FROM system_notifications WHERE id = ?", (notification_id,))
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '通知不存在'}), 404
        
        # 标记为已读
        cursor.execute('''
            INSERT OR IGNORE INTO user_read_notifications (user_id, notification_id)
            VALUES (?, ?)
        ''', (user_id, notification_id))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True, 'message': '已标记为已读'})
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'操作失败: {str(e)}'}), 500

@app.route('/api/notifications/read-all', methods=['POST'])
def mark_all_notifications_read():
    """标记所有通知为已读"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401

        conn = get_db()
        cursor = conn.cursor()
        
        # 获取所有未读通知
        cursor.execute('''
            SELECT n.id
            FROM system_notifications n
            LEFT JOIN user_read_notifications r ON n.id = r.notification_id AND r.user_id = ?
            WHERE (n.target_user_id IS NULL OR n.target_user_id = ?) 
              AND r.read_at IS NULL
        ''', (user_id, user_id))
        
        notifications = cursor.fetchall()
        
        # 标记为已读
        for notif in notifications:
            cursor.execute('''
                INSERT OR IGNORE INTO user_read_notifications (user_id, notification_id)
                VALUES (?, ?)
            ''', (user_id, notif['id']))
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True, 'message': '已全部标记为已读'})
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'操作失败: {str(e)}'}), 500

# ============ v9.0 生态系统升级 ============

# 推荐分润系统工具函数
def calculate_commission(user_id, amount, transaction_type, transaction_id=None, conn=None):
    """
    计算推荐分润（支持3级分润：5%/3%/2%）
    
    Args:
        user_id: 用户ID（被推荐人）
        amount: 原始金额
        transaction_type: 交易类型
        transaction_id: 交易ID
        conn: 数据库连接（可选）
    
    Returns:
        分润记录列表
    """
    should_close = False
    if conn is None:
        conn = get_db()
        should_close = True
    
    try:
        cursor = conn.cursor()
        commissions = []
        
        # 查找推荐关系链（最多3级）
        current_referee_id = user_id
        for level in range(1, 4):  # 1-3级
            # 查找当前层级的推荐人
            cursor.execute(
                "SELECT referrer_id FROM referral_relationships WHERE referee_id = ? AND status = 'active'",
                (current_referee_id,)
            )
            result = cursor.fetchone()
            
            if not result:
                break
            
            referrer_id = result['referrer_id']
            
            # 计算分润金额
            commission_rates = {
                1: 0.05,  # 5%
                2: 0.03,  # 3%
                3: 0.02   # 2%
            }
            
            rate = commission_rates.get(level, 0)
            commission_amount = amount * rate
            
            # 创建分润记录
            cursor.execute('''
                INSERT INTO referral_commissions
                (referrer_id, referee_id, level, transaction_id, transaction_type, 
                 original_amount, commission_rate, commission_amount, status)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')
            ''', (referrer_id, current_referee_id, level, transaction_id, transaction_type,
                  amount, rate, commission_amount))
            
            commissions.append({
                'referrer_id': referrer_id,
                'referee_id': current_referee_id,
                'level': level,
                'commission_amount': commission_amount
            })
            
            # 继续查找上一级推荐人
            current_referee_id = referrer_id
        
        if should_close:
            conn.commit()
        
        return commissions
    finally:
        if should_close:
            conn.close()

def settle_commission(commission_id, conn=None):
    """
    结算分润
    
    Args:
        commission_id: 分润记录ID
        conn: 数据库连接（可选）
    """
    should_close = False
    if conn is None:
        conn = get_db()
        should_close = True
    
    try:
        cursor = conn.cursor()
        
        # 获取分润记录
        cursor.execute(
            "SELECT * FROM referral_commissions WHERE id = ? AND status = 'pending'",
            (commission_id,)
        )
        commission = cursor.fetchone()
        
        if not commission:
            if should_close:
                conn.close()
            return False
        
        # 更新推荐人灵值
        cursor.execute('''
            UPDATE users 
            SET total_lingzhi = total_lingzhi + ?
            WHERE id = ?
        ''', (int(commission['commission_amount']), commission['referrer_id']))
        
        # 更新分润状态
        cursor.execute('''
            UPDATE referral_commissions 
            SET status = 'settled', settled_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (commission_id,))
        
        if should_close:
            conn.commit()
        
        return True
    finally:
        if should_close:
            conn.close()

# v9.0 推荐分润系统API
@app.route('/api/v9/referrals', methods=['GET'])
def get_user_referrals():
    """获取用户推荐列表"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 获取推荐的直推用户列表
        cursor.execute('''
            SELECT u.id, u.username, u.email, u.phone, u.created_at,
                   r.level, r.created_at as referral_created_at
            FROM referral_relationships r
            JOIN users u ON r.referee_id = u.id
            WHERE r.referrer_id = ?
            ORDER BY r.created_at DESC
        ''', (user_id,))
        
        referrals = [dict(ref) for ref in cursor.fetchall()]
        
        # 计算分润总额
        cursor.execute('''
            SELECT SUM(commission_amount) as total_commission,
                   COUNT(*) as total_count
            FROM referral_commissions
            WHERE referrer_id = ? AND status = 'settled'
        ''', (user_id,))
        stats = cursor.fetchone()
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': {
                'referrals': referrals,
                'total_commission': stats['total_commission'] or 0,
                'total_count': stats['total_count'] or 0
            }
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

@app.route('/api/v9/commissions', methods=['GET'])
def get_commissions():
    """获取分润记录"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 获取分润记录
        cursor.execute('''
            SELECT c.*, u1.username as referrer_name, u2.username as referee_name
            FROM referral_commissions c
            JOIN users u1 ON c.referrer_id = u1.id
            JOIN users u2 ON c.referee_id = u2.id
            WHERE c.referrer_id = ?
            ORDER BY c.created_at DESC
            LIMIT 50
        ''', (user_id,))
        
        commissions = [dict(com) for com in cursor.fetchall()]
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': commissions
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

# v9.0 用户资源库系统API
@app.route('/api/v9/resources', methods=['POST'])
def add_user_resource():
    """添加用户资源"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        data = request.json
        resource_type = data.get('resource_type')  # skill, asset, connection, time, data, brand
        resource_name = data.get('resource_name')
        description = data.get('description', '')
        estimated_value = data.get('estimated_value')
        tags = data.get('tags', '')
        
        if not resource_type or not resource_name:
            return jsonify({
                'success': False,
                'message': '资源类型和资源名称不能为空'
            }), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO user_resources
            (user_id, resource_type, resource_name, description, estimated_value, tags)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (user_id, resource_type, resource_name, description, estimated_value, tags))
        
        resource_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '资源添加成功',
            'data': {'resource_id': resource_id}
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'添加失败: {str(e)}'}), 500

@app.route('/api/user/resources', methods=['GET'])
def get_user_resources_frontend():
    """获取用户资源库（前端版本）- 所有用户共享"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        # 返回所有共享资源
        cursor.execute('''
            SELECT * FROM user_resources
            WHERE status = 'active'
            ORDER BY created_at DESC
        ''')
        
        db_resources = cursor.fetchall()
        
        # 转换为前端期望的格式
        resources = []
        for res in db_resources:
            res_dict = dict(res)
            # 根据 resource_type 映射为前端期望的 type
            type_mapping = {
                '文化资源': 'document',
                '内容资源': 'video',
                '语言资源': 'document',
                '设计资源': 'image',
                '技术资源': 'other',
                '其他': 'other'
            }
            
            resource_type = type_mapping.get(res_dict.get('resource_type', '其他'), 'other')
            
            # 处理tags字段，确保返回数组
            tags_value = res_dict.get('tags')
            if tags_value:
                try:
                    import json
                    tags = json.loads(tags_value) if isinstance(tags_value, str) else tags_value
                except:
                    tags = []
            else:
                tags = []
            
            resources.append({
                'id': str(res_dict['id']),
                'name': res_dict.get('resource_name', '未命名资源'),
                'type': resource_type,
                'size': int(res_dict.get('estimated_value', 0) * 1024),  # 估算文件大小
                'url': '',  # 暂时没有实际文件
                'created_at': res_dict.get('created_at', ''),
                'is_favorite': False,
                'is_public': True,  # 所有用户共享
                'tags': tags if isinstance(tags, list) else []  # 确保tags是数组
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'resources': resources
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

@app.route('/api/projects', methods=['GET'])
def get_project_list_frontend():
    """获取项目列表（前端版本）"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            # 允许匿名访问项目列表
            pass
        
        status = request.args.get('status', 'all')
        category = request.args.get('category')
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 构建查询条件
        conditions = []
        params = []
        
        if status and status != 'all':
            conditions.append("status = ?")
            params.append(status)
        
        if category:
            conditions.append("project_type = ?")
            params.append(category)
        
        # 获取项目列表
        where_clause = f"WHERE {' AND '.join(conditions)}" if conditions else ""
        cursor.execute(f'''
            SELECT * FROM projects
            {where_clause}
            ORDER BY created_at DESC
            LIMIT 50
        ''', params)
        
        db_projects = cursor.fetchall()
        
        # 转换为前端期望的格式
        projects = []
        for proj in db_projects:
            proj_dict = dict(proj)
            
            # 解析 requirements JSON 字符串
            requirements = []
            if proj_dict.get('required_skills'):
                try:
                    import json
                    requirements = json.loads(proj_dict['required_skills'])
                except:
                    requirements = []
            
            projects.append({
                'id': str(proj_dict['id']),
                'title': proj_dict.get('title', '未命名项目'),
                'description': proj_dict.get('description', ''),
                'category': proj_dict.get('project_type', 'other'),
                'budget': proj_dict.get('budget', 0),
                'deadline': proj_dict.get('deadline', ''),
                'participants': proj_dict.get('participants', 0),
                'status': proj_dict.get('status', 'open'),
                'lingzhi_reward': proj_dict.get('lingzhi_reward', 0),
                'requirements': requirements
            })
        
        conn.close()
        
        return jsonify(projects)
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

@app.route('/api/knowledge', methods=['GET'])
def get_user_knowledge_list():
    """获取用户知识库列表（前端版本）- 所有用户共享"""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        # 返回所有共享知识库
        cursor.execute('''
            SELECT kb.*, 1 as is_system
            FROM knowledge_bases kb
            ORDER BY kb.id
        ''')
        
        db_knowledge = cursor.fetchall()
        
        # 转换为前端期望的格式
        knowledge_items = []
        for item in db_knowledge:
            item_dict = dict(item)
            
            # 类别映射
            category_map = {
                '灵值生态园使用指南': 'general',
                '常见问题解答': 'general',
                'API文档': 'tech',
                '数字资产说明': 'business',
                '项目创建指南': 'general'
            }
            
            category = category_map.get(item_dict.get('name', '通用'), 'general')
            
            knowledge_items.append({
                'id': str(item_dict['id']),
                'title': item_dict.get('name', '未命名知识库'),
                'content': item_dict.get('description', ''),
                'category': category,
                'tags': [item_dict.get('name', '')],
                'created_at': item_dict.get('created_at', ''),
                'updated_at': item_dict.get('updated_at', ''),
                'is_favorite': False,
                'is_public': True  # 所有用户共享
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': knowledge_items
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500


@app.route('/api/knowledge/<int:knowledge_id>', methods=['DELETE'])
def delete_knowledge_item(knowledge_id):
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        # 检查是否是管理员
        conn = get_db()
        cursor = conn.cursor()
        cursor.execute("SELECT id FROM users WHERE id = ? AND username = 'admin'", (user_id,))
        is_admin = cursor.fetchone()
        
        if not is_admin:
            conn.close()
            return jsonify({'success': False, 'message': '只有管理员才能删除知识库'}), 403

        cursor.execute('SELECT ukb.is_system FROM user_knowledge_bases ukb WHERE ukb.knowledge_base_id = ? AND ukb.user_id = ?', (knowledge_id, user_id))

        knowledge = cursor.fetchone()

        if not knowledge:
            conn.close()
            return jsonify({'success': False, 'message': '知识库不存在或无权删除'}), 404

        is_system = knowledge[0] if knowledge[0] is not None else 0

        if is_system == 1:
            conn.close()
            return jsonify({'success': False, 'message': '系统知识库不能删除'}), 403

        cursor.execute('DELETE FROM user_knowledge_bases WHERE knowledge_base_id = ? AND user_id = ?', (knowledge_id, user_id))

        cursor.execute('SELECT COUNT(*) FROM user_knowledge_bases WHERE knowledge_base_id = ?', (knowledge_id,))
        other_users = cursor.fetchone()[0]

        if other_users == 0:
            cursor.execute('DELETE FROM knowledge_bases WHERE id = ?', (knowledge_id,))

        conn.commit()
        conn.close()

        return jsonify({'success': True, 'message': '删除成功'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'删除失败: {str(e)}'}), 500

@app.route('/api/v9/resources', methods=['GET'])
def get_user_resources():
    """获取用户资源库"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 如果用户未登录，返回示例数据
        if not user_id:
            cursor.execute('''
                SELECT * FROM user_resources
                WHERE status = 'active'
                LIMIT 5
            ''')
        else:
            cursor.execute('''
                SELECT * FROM user_resources
                WHERE user_id = ? AND status = 'active'
                ORDER BY created_at DESC
            ''', (user_id,))
        
        resources = [dict(res) for res in cursor.fetchall()]
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': resources
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

@app.route('/api/v9/resources/<int:resource_id>', methods=['PUT'])
def update_user_resource(resource_id):
    """更新用户资源"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        data = request.json
        conn = get_db()
        cursor = conn.cursor()
        
        # 检查资源归属
        cursor.execute(
            "SELECT * FROM user_resources WHERE id = ? AND user_id = ?",
            (resource_id, user_id)
        )
        if not cursor.fetchone():
            conn.close()
            return jsonify({'success': False, 'message': '资源不存在或无权操作'}), 404
        
        # 更新资源
        update_fields = []
        update_values = []
        
        if 'resource_name' in data:
            update_fields.append('resource_name = ?')
            update_values.append(data['resource_name'])
        if 'description' in data:
            update_fields.append('description = ?')
            update_values.append(data['description'])
        if 'estimated_value' in data:
            update_fields.append('estimated_value = ?')
            update_values.append(data['estimated_value'])
        if 'tags' in data:
            update_fields.append('tags = ?')
            update_values.append(data['tags'])
        if 'availability' in data:
            update_fields.append('availability = ?')
            update_values.append(data['availability'])
        
        if update_fields:
            update_fields.append('updated_at = CURRENT_TIMESTAMP')
            update_values.append(resource_id)
            
            cursor.execute(f'''
                UPDATE user_resources
                SET {', '.join(update_fields)}
                WHERE id = ?
            ''', update_values)
            conn.commit()
        
        conn.close()
        
        return jsonify({'success': True, 'message': '更新成功'})
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'更新失败: {str(e)}'}), 500

# v9.0 项目系统API
@app.route('/api/v9/projects', methods=['POST'])
def create_project():
    """创建项目"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        data = request.json
        title = data.get('title')
        description = data.get('description', '')
        project_type = data.get('project_type')
        budget = data.get('budget')
        required_skills = data.get('required_skills', '')
        required_assets = data.get('required_assets', '')
        duration = data.get('duration')
        location = data.get('location', '')
        deadline = data.get('deadline')
        
        if not title or not project_type:
            return jsonify({
                'success': False,
                'message': '项目标题和项目类型不能为空'
            }), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO projects
            (title, description, project_type, budget, required_skills, required_assets,
             duration, location, creator_id, deadline)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (title, description, project_type, budget, required_skills, required_assets,
              duration, location, user_id, deadline))
        
        project_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '项目创建成功',
            'data': {'project_id': project_id}
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'创建失败: {str(e)}'}), 500

@app.route('/api/v9/projects', methods=['GET'])
def get_project_list():
    """获取项目列表"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        project_type = request.args.get('project_type')
        status = request.args.get('status', 'open')
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 构建查询条件
        conditions = ["status = ?"]
        params = [status]

        if project_type:
            conditions.append("project_type = ?")
            params.append(project_type)

        # 获取项目列表
        cursor.execute(f'''
            SELECT *
            FROM projects
            WHERE {' AND '.join(conditions)}
            ORDER BY created_at DESC
            LIMIT 50
        ''', params)
        
        projects = [dict(proj) for proj in cursor.fetchall()]
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': projects
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

@app.route('/api/v9/projects/<int:project_id>/match', methods=['POST'])
def match_resources(project_id):
    """资源智能匹配"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 获取项目信息
        cursor.execute(
            "SELECT * FROM projects WHERE id = ? AND creator_id = ?",
            (project_id, user_id)
        )
        project = cursor.fetchone()
        
        if not project:
            conn.close()
            return jsonify({'success': False, 'message': '项目不存在或无权操作'}), 404
        
        # 获取项目需求
        required_skills = project['required_skills'].split(',') if project['required_skills'] else []
        required_assets = project['required_assets'].split(',') if project['required_assets'] else []
        
        # 获取所有可用资源
        cursor.execute('''
            SELECT * FROM user_resources
            WHERE availability = 'available' AND status = 'active'
        ''')
        all_resources = cursor.fetchall()
        
        # 计算匹配度
        matches = []
        for resource in all_resources:
            match_score = 0.0
            match_reasons = []
            
            # 技能匹配
            if resource['resource_type'] == 'skill':
                resource_skills = resource['tags'].split(',') if resource['tags'] else []
                for skill in required_skills:
                    if skill.strip() in resource_skills:
                        match_score += 0.3
                        match_reasons.append(f"技能匹配: {skill}")
            
            # 资产匹配
            elif resource['resource_type'] == 'asset':
                resource_assets = resource['tags'].split(',') if resource['tags'] else []
                for asset in required_assets:
                    if asset.strip() in resource_assets:
                        match_score += 0.4
                        match_reasons.append(f"资产匹配: {asset}")
            
            # 限制最大匹配度
            match_score = min(match_score, 1.0)
            
            # 保存匹配结果
            if match_score > 0.3:  # 最低匹配度30%
                cursor.execute('''
                    INSERT INTO resource_matches
                    (project_id, user_id, resource_id, match_score, match_reason)
                    VALUES (?, ?, ?, ?, ?)
                ''', (project_id, resource['user_id'], resource['id'], match_score,
                      ', '.join(match_reasons)))
                
                matches.append({
                    'project_id': project_id,
                    'user_id': resource['user_id'],
                    'resource_id': resource['id'],
                    'match_score': match_score,
                    'match_reason': ', '.join(match_reasons)
                })
        
        # 按匹配度排序
        matches.sort(key=lambda x: x['match_score'], reverse=True)
        
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': f'匹配到 {len(matches)} 个资源',
            'data': matches
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'匹配失败: {str(e)}'}), 500

@app.route('/api/v9/projects/<int:project_id>/join', methods=['POST'])
def join_project(project_id):
    """参与项目"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        data = request.json
        resource_id = data.get('resource_id')
        role = data.get('role', 'participant')
        
        if not resource_id:
            return jsonify({
                'success': False,
                'message': '请指定使用的资源'
            }), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 检查项目状态
        cursor.execute("SELECT * FROM projects WHERE id = ?", (project_id,))
        project = cursor.fetchone()
        
        if not project or project['status'] != 'open':
            conn.close()
            return jsonify({
                'success': False,
                'message': '项目不存在或已关闭'
            }), 404
        
        # 添加参与者
        cursor.execute('''
            INSERT INTO project_participants
            (project_id, user_id, role, contribution)
            VALUES (?, ?, ?, ?)
        ''', (project_id, user_id, role, f'使用资源ID: {resource_id}'))
        
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '参与项目成功'
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'参与失败: {str(e)}'}), 500

# v9.0 数字资产系统API
@app.route('/api/v9/assets', methods=['POST'])
def create_digital_asset():
    """创建数字资产"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        data = request.json
        asset_type = data.get('asset_type')
        asset_name = data.get('asset_name')
        description = data.get('description', '')
        image_url = data.get('image_url', '')
        metadata = data.get('metadata', '{}')
        rarity = data.get('rarity', 'common')
        value = data.get('value')
        
        if not asset_type or not asset_name:
            return jsonify({
                'success': False,
                'message': '资产类型和资产名称不能为空'
            }), 400
        
        conn = get_db()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO digital_assets
            (user_id, asset_type, asset_name, description, image_url, metadata, rarity, value)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (user_id, asset_type, asset_name, description, image_url, metadata, rarity, value))
        
        asset_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        return jsonify({
            'success': True,
            'message': '资产创建成功',
            'data': {'asset_id': asset_id}
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'创建失败: {str(e)}'}), 500

@app.route('/api/v9/assets', methods=['GET'])
def get_user_assets():
    """获取用户资产列表"""
    try:
        user_id = verify_token(request.headers.get('Authorization'))
        if not user_id:
            return jsonify({'success': False, 'message': '未授权'}), 401
        
        conn = get_db()
        cursor = conn.cursor()
        
        # 获取用户资产列表
        cursor.execute('''
            SELECT * FROM digital_assets
            WHERE user_id = ?
            ORDER BY created_at DESC
        ''', (user_id,))
        
        assets = [dict(ast) for ast in cursor.fetchall()]
        
        conn.close()
        
        return jsonify({
            'success': True,
            'data': assets
        })
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

# ============ v9.0 生态系统升级结束 ============

# 需要导入requests和urlencode
from urllib.parse import urlencode, quote, unquote
import requests
from urllib.parse import urlencode

# ============ 扩展功能初始化 ============
try:
    from extension_features import init_extension_features
    EXTENSION_AVAILABLE = True
except ImportError:
    EXTENSION_AVAILABLE = False
    print("警告: extension_features 模块未找到")

# ============ 启动服务 ============

if __name__ == '__main__':
    # 初始化扩展功能
    if EXTENSION_AVAILABLE:
        try:
            init_extension_features(app, get_db, verify_token)
            print("✅ 扩展功能初始化成功")
        except Exception as e:
            print(f"❌ 扩展功能初始化失败: {e}")

    # 使用8080端口（内部服务），Coze平台9000端口会转发到8080，配置所有CORS头部
    port = int(os.getenv('PORT', '8080'))
    
    print("=" * 50)
    print("灵值生态园 API 服务启动中...")
    print("=" * 50)
    print(f"服务地址: http://0.0.0.0:{port}")
    print("默认管理员账号: admin / admin123")
    print("=" * 50)

    # 备份数据库
    print("正在备份数据库...")
    backup_database()

    # 初始化默认数据
    init_default_data()

    # ============ 公司生态API - 开始 ============
    
    # 公司动态API
    @app.route('/api/company/news', methods=['GET'])
    def get_company_news():
        """获取公司动态列表"""
        try:
            page = request.args.get('page', 1, type=int)
            per_page = request.args.get('per_page', 10, type=int)
            category = request.args.get('category', '')
            search = request.args.get('search', '')
            
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 构建查询条件
            where_conditions = ["status = 'published'"]
            params = []
            
            if category:
                where_conditions.append("category = ?")
                params.append(category)
            
            if search:
                where_conditions.append("(title LIKE ? OR content LIKE ? OR summary LIKE ?)")
                params.extend([f'%{search}%', f'%{search}%', f'%{search}%'])
            
            where_clause = " AND ".join(where_conditions)
            
            # 获取总数
            cursor.execute(f"SELECT COUNT(*) as total FROM company_news WHERE {where_clause}", params)
            total = cursor.fetchone()['total']
            
            # 获取数据
            offset = (page - 1) * per_page
            cursor.execute(f'''
                SELECT * FROM company_news 
                WHERE {where_clause} 
                ORDER BY created_at DESC 
                LIMIT ? OFFSET ?
            ''', params + [per_page, offset])
            
            news = [dict(row) for row in cursor.fetchall()]
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': news,
                'pagination': {
                    'total': total,
                    'page': page,
                    'per_page': per_page,
                    'pages': (total + per_page - 1) // per_page
                }
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    @app.route('/api/company/news/<int:news_id>', methods=['GET'])
    def get_company_news_detail(news_id):
        """获取公司动态详情"""
        try:
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            cursor.execute("SELECT * FROM company_news WHERE id = ?", (news_id,))
            news = cursor.fetchone()
            
            if news:
                # 增加浏览量
                cursor.execute("UPDATE company_news SET view_count = view_count + 1 WHERE id = ?", (news_id,))
                conn.commit()
                return jsonify({'success': True, 'data': dict(news)})
            else:
                return jsonify({'success': False, 'message': '动态不存在'}), 404
            
            conn.close()
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    # 项目动态API
    @app.route('/api/company/projects', methods=['GET'])
    def get_company_projects():
        """获取项目动态列表"""
        try:
            page = request.args.get('page', 1, type=int)
            per_page = request.args.get('per_page', 10, type=int)
            category = request.args.get('category', '')
            status = request.args.get('status', '')
            search = request.args.get('search', '')
            
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 构建查询条件
            where_conditions = []
            params = []
            
            if category:
                where_conditions.append("category = ?")
                params.append(category)
            
            if status:
                where_conditions.append("status = ?")
                params.append(status)
            
            if search:
                where_conditions.append("(project_name LIKE ? OR description LIKE ?)")
                params.extend([f'%{search}%', f'%{search}%'])
            
            where_clause = " AND ".join(where_conditions) if where_conditions else "1=1"
            
            # 获取总数
            cursor.execute(f"SELECT COUNT(*) as total FROM company_projects WHERE {where_clause}", params)
            total = cursor.fetchone()['total']
            
            # 获取数据
            offset = (page - 1) * per_page
            cursor.execute(f'''
                SELECT * FROM company_projects 
                WHERE {where_clause} 
                ORDER BY created_at DESC 
                LIMIT ? OFFSET ?
            ''', params + [per_page, offset])
            
            projects = [dict(row) for row in cursor.fetchall()]
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': projects,
                'pagination': {
                    'total': total,
                    'page': page,
                    'per_page': per_page,
                    'pages': (total + per_page - 1) // per_page
                }
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    @app.route('/api/company/projects/stats', methods=['GET'])
    def get_project_stats():
        """获取项目统计数据"""
        try:
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 获取项目总数
            cursor.execute("SELECT COUNT(*) as total FROM company_projects")
            total = cursor.fetchone()['total']
            
            # 获取各状态项目数
            cursor.execute("""
                SELECT status, COUNT(*) as count 
                FROM company_projects 
                GROUP BY status
            """)
            status_stats = {row['status']: row['count'] for row in cursor.fetchall()}
            
            # 获取各分类项目数
            cursor.execute("""
                SELECT category, COUNT(*) as count 
                FROM company_projects 
                GROUP BY category
            """)
            category_stats = {row['category']: row['count'] for row in cursor.fetchall()}
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': {
                    'total': total,
                    'by_status': status_stats,
                    'by_category': category_stats
                }
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    # 信息动态API
    @app.route('/api/company/info', methods=['GET'])
    def get_company_info():
        """获取信息动态列表"""
        try:
            info_type = request.args.get('type', '')
            is_public = request.args.get('public', 'true').lower() == 'true'
            
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 构建查询条件
            where_conditions = ["is_public = ?"]
            params = [is_public]
            
            if info_type:
                where_conditions.append("info_type = ?")
                params.append(info_type)
            
            where_clause = " AND ".join(where_conditions)
            
            cursor.execute(f'''
                SELECT * FROM company_info 
                WHERE {where_clause} 
                ORDER BY priority DESC, created_at DESC
            ''', params)
            
            info_list = [dict(row) for row in cursor.fetchall()]
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': info_list
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    # 用户动态API
    @app.route('/api/company/users', methods=['GET'])
    def get_user_activities():
        """获取用户动态列表"""
        try:
            page = request.args.get('page', 1, type=int)
            per_page = request.args.get('per_page', 20, type=int)
            activity_type = request.args.get('type', '')
            user_id = request.args.get('user_id', '', type=int)
            
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 构建查询条件
            where_conditions = []
            params = []
            
            if activity_type:
                where_conditions.append("activity_type = ?")
                params.append(activity_type)
            
            if user_id:
                where_conditions.append("user_id = ?")
                params.append(user_id)
            
            where_clause = " AND ".join(where_conditions) if where_conditions else "1=1"
            
            # 获取总数
            cursor.execute(f"SELECT COUNT(*) as total FROM company_users WHERE {where_clause}", params)
            total = cursor.fetchone()['total']
            
            # 获取数据（关联用户信息）
            offset = (page - 1) * per_page
            cursor.execute(f'''
                SELECT cu.*, u.username, u.avatar_url 
                FROM company_users cu
                LEFT JOIN users u ON cu.user_id = u.id
                WHERE {where_clause} 
                ORDER BY cu.created_at DESC 
                LIMIT ? OFFSET ?
            ''', params + [per_page, offset])
            
            activities = [dict(row) for row in cursor.fetchall()]
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': activities,
                'pagination': {
                    'total': total,
                    'page': page,
                    'per_page': per_page,
                    'pages': (total + per_page - 1) // per_page
                }
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    @app.route('/api/company/users/stats', methods=['GET'])
    def get_user_activity_stats():
        """获取用户活动统计"""
        try:
            conn = sqlite3.connect(DATABASE)
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            
            # 获取总活动数
            cursor.execute("SELECT COUNT(*) as total FROM company_users")
            total = cursor.fetchone()['total']
            
            # 获取各类型活动数
            cursor.execute("""
                SELECT activity_type, COUNT(*) as count 
                FROM company_users 
                GROUP BY activity_type
            """)
            type_stats = {row['activity_type']: row['count'] for row in cursor.fetchall()}
            
            # 获取最近7天的活动趋势
            cursor.execute("""
                SELECT DATE(created_at) as date, COUNT(*) as count 
                FROM company_users 
                WHERE created_at >= DATE('now', '-7 days')
                GROUP BY DATE(created_at)
                ORDER BY date
            """)
            trend_stats = {row['date']: row['count'] for row in cursor.fetchall()}
            
            conn.close()
            
            return jsonify({
                'success': True,
                'data': {
                    'total': total,
                    'by_type': type_stats,
                    'trend': trend_stats
                }
            })
        except Exception as e:
            return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

    # ============ 公司生态API - 结束 ============

    # ============ 分红池 API ============
    try:
        from dividend_pool_api import register_dividend_pool_routes
        register_dividend_pool_routes(app)
    except ImportError as e:
        print(f"⚠️  分红池 API 加载失败: {e}")

    # ============ 商家资源池 API ============
    if MERCHANT_AVAILABLE:
        # 获取商家列表
        @app.route('/api/merchants', methods=['GET'])
        def api_get_merchants():
            """获取商家列表"""
            try:
                search = request.args.get('search', '')
                category = request.args.get('category', '')
                status = request.args.get('status', '')
                limit = int(request.args.get('limit', 50))

                merchants = get_merchant_list(search=search, category=category, status=status, limit=limit)
                return jsonify(merchants)
            except Exception as e:
                return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

        # 获取商家详情
        @app.route('/api/merchants/<int:merchant_id>', methods=['GET'])
        def api_get_merchant_detail(merchant_id):
            """获取商家详情"""
            try:
                merchant = get_merchant_by_id(merchant_id)
                if merchant:
                    return jsonify(merchant)
                return jsonify({'success': False, 'message': '商家不存在'}), 404
            except Exception as e:
                return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

        # 添加商家评价
        @app.route('/api/merchants/<int:merchant_id>/reviews', methods=['POST'])
        def api_add_merchant_review(merchant_id):
            """添加商家评价"""
            try:
                user_id = verify_token(request.headers.get('Authorization'))
                if not user_id:
                    return jsonify({'success': False, 'message': '未授权'}), 401

                data = request.get_json()
                rating = data.get('rating')
                review = data.get('review', '')

                if not rating or rating < 1 or rating > 5:
                    return jsonify({'success': False, 'message': '评分必须在1-5之间'}), 400

                if not review:
                    return jsonify({'success': False, 'message': '评价内容不能为空'}), 400

                success = add_merchant_review(merchant_id, user_id, rating, review)
                if success:
                    return jsonify({'success': True, 'message': '评价成功'})
                return jsonify({'success': False, 'message': '评价失败'}), 500
            except Exception as e:
                return jsonify({'success': False, 'message': f'评价失败: {str(e)}'}), 500

        # 切换收藏状态
        @app.route('/api/merchants/<int:merchant_id>/favorite', methods=['POST'])
        def api_toggle_favorite(merchant_id):
            """切换收藏状态"""
            try:
                user_id = verify_token(request.headers.get('Authorization'))
                if not user_id:
                    return jsonify({'success': False, 'message': '未授权'}), 401

                result = toggle_favorite(merchant_id, user_id)
                if result:
                    return jsonify({'success': True, **result})
                return jsonify({'success': False, 'message': '操作失败'}), 500
            except Exception as e:
                return jsonify({'success': False, 'message': f'操作失败: {str(e)}'}), 500

        # 获取用户收藏的商家
        @app.route('/api/user/merchants/favorites', methods=['GET'])
        def api_get_user_favorites():
            """获取用户收藏的商家"""
            try:
                user_id = verify_token(request.headers.get('Authorization'))
                if not user_id:
                    return jsonify({'success': False, 'message': '未授权'}), 401

                favorites = get_user_favorites(user_id)
                return jsonify(favorites)
            except Exception as e:
                return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

        # 提交合作申请
        @app.route('/api/merchants/<int:merchant_id>/collaborations', methods=['POST'])
        def api_submit_collaboration(merchant_id):
            """提交合作申请"""
            try:
                user_id = verify_token(request.headers.get('Authorization'))
                if not user_id:
                    return jsonify({'success': False, 'message': '未授权'}), 401

                data = request.get_json()
                project_title = data.get('project_title', '')
                project_description = data.get('project_description', '')
                budget = data.get('budget', 0)
                contact_method = data.get('contact_method', '')

                if not project_title:
                    return jsonify({'success': False, 'message': '项目标题不能为空'}), 400

                if not project_description:
                    return jsonify({'success': False, 'message': '项目描述不能为空'}), 400

                if not contact_method:
                    return jsonify({'success': False, 'message': '联系方式不能为空'}), 400

                success = submit_collaboration(merchant_id, user_id, project_title, project_description, budget, contact_method)
                if success:
                    return jsonify({'success': True, 'message': '合作申请已提交'})
                return jsonify({'success': False, 'message': '提交失败'}), 500
            except Exception as e:
                return jsonify({'success': False, 'message': f'提交失败: {str(e)}'}), 500

        # 获取商家数据分析
        @app.route('/api/merchants/analytics', methods=['GET'])
        def api_get_merchant_analytics():
            """获取商家数据分析"""
            try:
                analytics = get_merchant_analytics()
                return jsonify(analytics)
            except Exception as e:
                return jsonify({'success': False, 'message': f'获取失败: {str(e)}'}), 500

        print("✅ 商家资源池 API 已注册")
    else:
        print("⚠️  商家资源池 API 不可用")

    # ============ 安全推荐码 API ============
    try:
        from secure_referral_api import register_secure_referral_routes
        register_secure_referral_routes(app)
    except ImportError as e:
        print(f"⚠️  安全推荐码 API 加载失败: {e}")

    # ============ 文档管理 API ============
    try:
        from docs_api import register_docs_routes
        register_docs_routes(app)
    except ImportError as e:
        print(f"⚠️  文档管理 API 加载失败: {e}")

    # 添加自定义响应头
    @app.after_request
    def after_request(response):
        response.headers.add('Access-Control-Allow-Origin', '*')
        response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')
        response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
        response.headers.add('Access-Control-Max-Age', '86400')
        response.headers.add('X-Content-Type-Options', 'nosniff')
        response.headers.add('X-Frame-Options', 'SAMEORIGIN')
        return response

    # 全局错误处理器
    @app.errorhandler(400)
    def bad_request(error):
        return jsonify({
            'success': False,
            'message': '请求参数错误',
            'error_code': 'BAD_REQUEST'
        }), 400

    @app.errorhandler(401)
    def unauthorized(error):
        return jsonify({
            'success': False,
            'message': '未授权访问',
            'error_code': 'UNAUTHORIZED'
        }), 401

    @app.errorhandler(403)
    def forbidden(error):
        return jsonify({
            'success': False,
            'message': '无权限访问',
            'error_code': 'FORBIDDEN'
        }), 403

    @app.errorhandler(404)
    def not_found(error):
        return jsonify({
            'success': False,
            'message': '资源不存在',
            'error_code': 'NOT_FOUND'
        }), 404

    @app.errorhandler(429)
    def too_many_requests(error):
        return jsonify({
            'success': False,
            'message': '请求过于频繁，请稍后再试',
            'error_code': 'TOO_MANY_REQUESTS'
        }), 429

    @app.errorhandler(500)
    def internal_error(error):
        print(f"[ERROR] 内部服务器错误: {error}")
        import traceback
        print(f"[ERROR] 堆栈跟踪:\n{traceback.format_exc()}")
        return jsonify({
            'success': False,
            'message': '服务器内部错误',
            'error_code': 'INTERNAL_ERROR'
        }), 500

    @app.errorhandler(503)
    def service_unavailable(error):
        return jsonify({
            'success': False,
            'message': '服务暂时不可用',
            'error_code': 'SERVICE_UNAVAILABLE'
        }), 503

    # ============ 资源变现系统 ============
    try:
        from resources_market_api import register_resources_market_api, init_resources_market_tables
        
        # 初始化表
        print("[资源变现系统] 初始化数据库表...")
        init_resources_market_tables()
        
        # 注册API
        register_resources_market_api(app)
        print("✅ 资源变现系统已加载")
    except Exception as e:
        print(f"⚠️ 资源变现系统加载失败: {e}")
        import traceback
        traceback.print_exc()

    # 配置端口
    port = 8080

    app.run(host='0.0.0.0', port=port, debug=False)
