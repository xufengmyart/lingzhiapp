# 智能体路径修复文档（2026-02-15）

## 问题诊断

从用户提供的浏览器控制台日志中，发现了以下问题：

### 问题 1: 智能体列表 404 错误
```
[API] GET /api/agents
XHRGET https://meiyueart.com/api/api/agents 404
```

**原因分析**：
- 前端 Chat.tsx 中使用了错误的路径：`api.get('/api/agents')`
- 由于 axios 的 baseURL 已经是 `/api`，导致实际请求变成 `/api/api/agents`（双前缀）
- 后端没有定义 `/api/api/agents` 路由，所以返回 404

**修复方案**：
- 将 `api.get('/api/agents')` 改为 `agentApi.getAgents()`
- `agentApi.getAgents()` 请求 `/admin/agents`，结合 baseURL 变成 `/api/admin/agents`
- 后端已有 `/api/admin/agents` 路由定义

### 问题 2: 智能体聊天 404 错误
```
[API] POST /api/agent/chat
XHRPOST https://meiyueart.com/api/agent/chat 404
```

**原因分析**：
- 前端请求 `/api/agent/chat` 是正确的
- 后端应该有 `/api/agent/chat` 路由定义
- 可能是生产环境的代码没有正确更新，或者路由定义有问题

**检查后端路由**：
```python
# Line 5593: 兼容路由（无 /api 前缀）
@app.route('/agent/chat', methods=['POST'])
def agent_chat_v1():
    return agent_chat()

# Line 5598: 标准路由（有 /api 前缀）
@app.route('/api/agent/chat', methods=['POST'])
def agent_chat():
    """智能体对话"""
    # ...
```

**路由定义正确**，问题可能是：
1. 生产环境代码没有更新
2. 代码有语法错误导致路由未注册
3. nginx 配置有问题

## 修复内容

### 1. 前端修复（web-app/src/pages/Chat.tsx）

**修改前**：
```typescript
const loadAgents = async () => {
  try {
    const response = await api.get('/api/agents')  // ❌ 错误：导致 /api/api/agents
    if (response.data.success) {
      const activeAgents = response.data.data.agents.filter((a: any) => a.status === 'active')
      setAgents(activeAgents)
      if (activeAgents.length > 0 && !selectedAgent) {
        setSelectedAgent(activeAgents[0])
      }
    }
  } catch (error) {
    console.error('加载智能体列表失败:', error)
  }
}
```

**修改后**：
```typescript
const loadAgents = async () => {
  try {
    const response = await agentApi.getAgents()  // ✅ 正确：请求 /api/admin/agents
    if (response.success) {
      const activeAgents = response.data.filter((a: any) => a.status === 'active')
      setAgents(activeAgents)
      if (activeAgents.length > 0 && !selectedAgent) {
        setSelectedAgent(activeAgents[0])
      }
    }
  } catch (error) {
    console.error('加载智能体列表失败:', error)
  }
}
```

**关键变化**：
1. 使用 `agentApi.getAgents()` 替代 `api.get('/api/agents')`
2. 响应数据结构从 `response.data.data` 改为 `response.data`（因为 agentApi 已经处理了响应）
3. 数据过滤从 `response.data.data.agents` 改为 `response.data`

### 2. 后端验证（admin-backend/app.py）

**确认路由定义**：
- ✅ `/agent/chat` (Line 5593) - 兼容前端旧路径
- ✅ `/api/agent/chat` (Line 5598) - 标准API路径
- ✅ `/api/agents` (Line 6079) - 智能体列表（公共）
- ✅ `/api/admin/agents` (Line 6112) - 智能体列表（管理端）

## 部署步骤

### 方法 1: 使用部署脚本（推荐）

```bash
cd /workspace/projects/admin-backend/scripts

# 1. 赋予脚本执行权限
chmod +x deploy_fix_20260215.sh

# 2. 执行部署脚本
./deploy_fix_20260215.sh
```

**部署脚本会自动**：
1. 备份生产环境的 app.py 和 Chat.tsx
2. 部署工作环境的修复代码
3. 重新构建前端
4. 重启后端服务
5. 验证服务状态

### 方法 2: 手动部署

#### 步骤 1: 备份生产环境
```bash
# 创建备份目录
mkdir -p /opt/lingzhi-ecosystem/backup_$(date +%Y%m%d_%H%M%S)

# 备份后端
cp /opt/lingzhi-ecosystem/backend/app.py /opt/lingzhi-ecosystem/backup_$(date +%Y%m%d_%H%M%S)/app.py.backup

# 备份前端
cp /opt/lingzhi-ecosystem/frontend/src/pages/Chat.tsx /opt/lingzhi-ecosystem/backup_$(date +%Y%m%d_%H%M%S)/Chat.tsx.backup
```

#### 步骤 2: 部署后端
```bash
# 复制工作环境的 app.py 到生产环境
cp /workspace/projects/admin-backend/app.py /opt/lingzhi-ecosystem/backend/app.py
```

#### 步骤 3: 部署前端
```bash
# 复制工作环境的 Chat.tsx 到生产环境
cp /workspace/projects/web-app/src/pages/Chat.tsx /opt/lingzhi-ecosystem/frontend/src/pages/Chat.tsx
```

#### 步骤 4: 重新构建前端
```bash
cd /opt/lingzhi-ecosystem/frontend

# 安装依赖（如果需要）
npm install

# 构建生产版本
npm run build
```

#### 步骤 5: 重启后端服务
```bash
cd /opt/lingzhi-ecosystem/backend

# 方法 1: 使用 gunicorn.ctl
echo "reload" > gunicorn.ctl

# 方法 2: 使用 systemctl
systemctl restart lingzhi-backend
```

#### 步骤 6: 验证服务
```bash
# 检查后端路由
curl -X GET http://127.0.0.1:8080/api/admin/agents

# 检查智能体聊天
curl -X POST http://127.0.0.1:8080/api/agent/chat \
  -H "Content-Type: application/json" \
  -d '{"content":"测试","agentId":2}'
```

## 测试验证

### 自动测试脚本
```bash
cd /workspace/projects/admin-backend/scripts

# 赋予脚本执行权限
chmod +x test_fix_20260215.sh

# 执行测试脚本
./test_fix_20260215.sh
```

**测试内容**：
1. ✅ 用户登录
2. ✅ 获取用户信息
3. ✅ 获取智能体列表
4. ✅ 智能体聊天（/api/agent/chat）
5. ✅ 智能体聊天（/agent/chat - 兼容路径）

### 手动测试

#### 测试 1: 智能体列表
```bash
# 获取登录 token
TOKEN=$(curl -s -X POST https://meiyueart.com/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}' | jq -r '.data.token')

# 获取智能体列表
curl -X GET https://meiyueart.com/api/admin/agents \
  -H "Authorization: Bearer $TOKEN"
```

**预期结果**：
```json
{
  "success": true,
  "data": [
    {
      "id": 2,
      "name": "灵值智能助手",
      "status": "active",
      ...
    }
  ]
}
```

#### 测试 2: 智能体聊天
```bash
# 智能体聊天（标准路径）
curl -X POST https://meiyueart.com/api/agent/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"content":"你好","agentId":2,"enableThinking":false}'
```

**预期结果**：
```json
{
  "success": true,
  "data": {
    "reply": "你好！我是灵值智能助手...",
    "conversationId": "conv_xxx",
    "agentId": 2
  }
}
```

## 故障排查

### 问题 1: 前端构建失败
**错误**：`npm run build` 失败

**解决方案**：
```bash
cd /opt/lingzhi-ecosystem/frontend

# 清理缓存
rm -rf node_modules package-lock.json
rm -rf dist

# 重新安装依赖
npm install

# 重新构建
npm run build
```

### 问题 2: 后端服务启动失败
**错误**：后端服务无法启动

**解决方案**：
```bash
# 查看后端日志
cd /opt/lingzhi-ecosystem/backend
tail -f server.log

# 检查 Python 语法
python -m py_compile app.py

# 检查依赖
pip list | grep -E "flask|coze"
```

### 问题 3: 仍然返回 404
**错误**：部署后仍然返回 404

**解决方案**：
```bash
# 1. 检查路由是否注册
grep -n "@app.route.*agent" /opt/lingzhi-ecosystem/backend/app.py

# 2. 检查 nginx 配置
nginx -t

# 3. 重启 nginx
systemctl reload nginx

# 4. 清理浏览器缓存
# - 打开浏览器开发者工具
# - 右键点击刷新按钮
# - 选择"清空缓存并硬性重新加载"
```

## 路径对照表

| 功能 | 前端代码 | 实际请求 | 后端路由 | 状态 |
|------|---------|---------|---------|------|
| 智能体列表 | `agentApi.getAgents()` | GET /api/admin/agents | @app.route('/api/admin/agents') | ✅ 正确 |
| 智能体聊天 | `agentApi.sendMessage()` | POST /api/agent/chat | @app.route('/api/agent/chat') | ✅ 正确 |
| 智能体聊天（兼容） | - | POST /agent/chat | @app.route('/agent/chat') | ✅ 正确 |
| 用户登录 | `userApi.login()` | POST /api/login | @app.route('/login') | ✅ 正确 |

## 预期结果

部署完成后，生产环境应该能够：

1. ✅ 用户正常登录
2. ✅ 获取智能体列表（无 404 错误）
3. ✅ 智能体聊天功能正常（无 404 错误）
4. ✅ 智能体返回详细回复（约 800+ 字符）
5. ✅ 支持深度思考模式（可选）

## 联系与支持

如果遇到问题，请提供以下信息：

1. 完整的错误日志（浏览器控制台 + 服务器日志）
2. 部署脚本执行结果
3. `test_fix_20260215.sh` 的输出
4. 使用的部署方法（自动脚本 / 手动部署）

---

**最后更新**: 2026-02-15
**版本**: v1.0
