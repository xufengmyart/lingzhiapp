# 灵值生态园智能体 v3.0 - 知识库增强版

## 版本信息
- **版本号**: v3.0
- **发布日期**: 2026年2月15日
- **版本名称**: 知识库增强版

## 主要改进

### 1. 知识库检索功能
- 新增 `agent_enhanced.py` 模块，提供知识库检索能力
- 支持从 `knowledge_documents` 和 `knowledge` 表中搜索相关信息
- 根据用户查询动态检索相关文档，集成到系统提示词中

### 2. 增强系统提示词
- 系统提示词长度从 v2.0 的 2633 字符进一步提升
- 增加了"核心知识"章节，明确列出智能体的知识范围
- 增加了"回答标准"章节，明确详细程度要求
- 增强了对重要功能的说明要求

### 3. 智能体回复质量提升
- 回复更加详细、专业、准确
- 支持深度解释（如：灵值获取的5种方式）
- 提供实际操作指导和实例
- 语气更加友好、亲切

## 技术架构

### 文件结构
```
admin-backend/
├── routes/
│   ├── agent.py              # 智能体主逻辑（已更新）
│   └── agent_enhanced.py     # 知识库增强模块（新增）
├── scripts/
│   ├── deploy_agent_v3.sh    # v3.0 部署脚本（新增）
│   └── README.md             # 脚本说明文档
└── lingzhi_ecosystem.db      # 数据库（包含知识库）
```

### 核心功能
1. **知识库检索**
   - 关键词匹配搜索
   - 支持多表查询（knowledge_documents、knowledge）
   - 动态集成到系统提示词

2. **智能体对话**
   - 支持对话历史记忆（可选）
   - 自动检索相关知识
   - 详细的回复生成

3. **系统提示词增强**
   - 动态构建提示词
   - 知识库内容前置
   - 保持原始提示词结构

## 知识库内容

### knowledge_documents 表（30个文档）
1. 陕西媄月商业艺术有限责任公司简介
2. 西安文化基因库
3. 灵值智能体v9.0全面升级设计方案
4. 灵值生态园完整体系梳理
5. 灵值生态园完整生态闭环战略规划
6. ... （共30个文档，约16.5万字符）

### knowledge 表（17条记录）
1. 公司信息（陕西媄月商业艺术有限责任公司）
2. 灵值生态园介绍
3. 灵值获取方式
4. 合伙人制度
5. ... （共17条常见问题）

## 测试验证

### 测试用例

#### 测试1: 公司信息查询
**用户提问**: "公司是谁开发的？"
**预期结果**:
- 明确回答"陕西媄月商业艺术有限责任公司"
- 详细介绍公司背景、核心能力、业务方向
- 说明公司的文化使命和精神价值
- 提供下一步参与引导

**实际结果**: ✅ 通过
- 回复详细、专业
- 正确的公司名称
- 深入的解释

#### 测试2: 灵值获取方式
**用户提问**: "如何获取灵值？"
**预期结果**:
- 列出5种获取灵值的方式
- 每种方式都有详细说明
- 提供实际操作步骤
- 解释灵值的文化意义

**实际结果**: ✅ 通过
- 完整的5种方式
- 详细的操作指导
- 深层价值解释

#### 测试3: 通用问候
**用户提问**: "你好，请介绍一下灵值生态园"
**预期结果**:
- 友好的开场白
- 详细的生态园介绍
- 核心价值和愿景说明
- 参与引导

**实际结果**: ✅ 通过
- 详细的介绍
- 清晰的结构
- 友好的语气

### API 性能
- 平均响应时间: 20-40秒（首次请求可能更长）
- 支持并发请求
- 自动知识库检索
- 智能缓存机制

## 部署指南

### 前置条件
1. 数据库已创建并初始化
2. 知识库数据已导入（knowledge_documents、knowledge表）
3. Python 3.x 环境已配置
4. 依赖包已安装（Flask, sqlite3, coze_coding_dev_sdk）

### 部署步骤
1. 停止现有服务：
   ```bash
   pkill -f "python.*app.py"
   ```

2. 部署新版本：
   ```bash
   cd admin-backend/scripts
   bash deploy_agent_v3.sh
   ```

3. 验证部署：
   ```bash
   curl -X POST http://localhost:8080/api/chat \
     -H "Content-Type: application/json" \
     -d '{"message": "你好", "enable_memory": false}'
   ```

### 回滚方案
如果部署失败，可以手动回滚：
```bash
# 从备份目录恢复
cp /tmp/lingzhi_backup_*/agent.py.bak admin-backend/routes/agent.py

# 重启服务
cd admin-backend
python app.py
```

## 使用指南

### API 端点
**URL**: `POST /api/chat`

**请求参数**:
```json
{
  "message": "用户消息",
  "enable_memory": true/false
}
```

**响应格式**:
```json
{
  "data": {
    "agentId": 1,
    "conversationId": "6",
    "message": "用户消息",
    "reply": "智能体回复"
  },
  "success": true
}
```

### 测试脚本
```bash
cd admin-backend
python test_agent.py
```

### 推荐提问
1. "公司是谁开发的？"
2. "如何获取灵值？"
3. "什么是合伙人？"
4. "西安文化有哪些特色？"
5. "请介绍一下灵值生态园"

## 监控与日志

### 日志位置
- 服务日志: `admin-backend/server.log`
- 部署日志: `workspace/projects/deploy_agent_v3.log`

### 监控指标
- API 响应时间
- 错误率
- 知识库检索命中率
- 用户满意度

## 已知问题
1. 首次请求响应时间较长（约40-60秒）
   - 原因：知识库检索和LLM初始化
   - 解决方案：考虑实现缓存机制

2. 复杂问题可能导致超时
   - 原因：LLM生成内容较多
   - 解决方案：增加超时时间或优化提示词

## 未来规划
1. 实现向量检索，提高知识库搜索准确度
2. 添加对话历史优化，减少重复检索
3. 实现多轮对话上下文管理
4. 添加智能体个性化配置
5. 支持多智能体协作

## 联系方式
- 技术支持：[待补充]
- 问题反馈：[待补充]
- 更新日志：见本文档

---

**版本历史**:
- v3.0 (2026-02-15): 知识库增强版
- v2.0 (2026-02-14): 提示词增强版
- v1.0 (2026-02-13): 初始版本
