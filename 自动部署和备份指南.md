# 灵值生态园 - 自动部署和备份指南

## 📋 概述

本文档说明如何使用自动部署和备份系统，将本地代码自动同步到服务器。

---

## 🚀 快速开始

### 1. 首次设置

```bash
# 1. 给脚本添加执行权限
chmod +x deploy.sh
chmod +x quick-deploy.sh
chmod +x .git/hooks/pre-commit

# 2. 配置服务器 SSH 密钥登录（推荐）
ssh-copy-id root@123.56.142.143
```

---

## 📦 部署脚本说明

### 脚本 1: deploy.sh（完整部署）

**功能**：
- ✅ 本地备份
- ✅ 服务器备份
- ✅ 推送到 GitHub
- ✅ 同步到服务器
- ✅ 重启 Nginx
- ✅ 验证部署

**使用方法**：

```bash
# 完整部署（所有步骤）
./deploy.sh

# 仅备份
./deploy.sh backup

# 仅构建
./deploy.sh build

# 仅同步
./deploy.sh sync
```

---

### 脚本 2: quick-deploy.sh（快速部署）

**功能**：
- ✅ 快速备份 public 目录
- ✅ 推送到 GitHub
- ✅ 同步到服务器
- ✅ 重启 Nginx

**使用方法**：

```bash
# 快速部署
./quick-deploy.sh
```

**适用场景**：
- 日常快速更新
- 代码改动较小
- 不需要完整备份

---

### 脚本 3: .git/hooks/pre-commit（提交前检查）

**功能**：
- ✅ TypeScript 类型检查
- ✅ ESLint 代码风格检查
- ✅ 运行测试
- ✅ 尝试构建

**自动触发**：
- 每次执行 `git commit` 时自动运行

**跳过检查**（如果需要）：
```bash
git commit --no-verify -m "跳过检查的提交"
```

---

## 🔧 配置说明

### 修改服务器配置

编辑 `deploy.sh` 文件，修改以下配置：

```bash
# 服务器配置
SERVER_HOST="123.56.142.143"              # 服务器 IP
SERVER_USER="root"                        # 服务器用户名
SERVER_PROJECT_PATH="/var/www/lingzhiapp" # 服务器项目路径
SERVER_BACKUP_PATH="/var/backups/lingzhiapp" # 服务器备份路径
```

### 修改本地配置

```bash
# 本地配置
LOCAL_PROJECT_PATH="/workspace/projects"  # 本地项目路径
BUILD_OUTPUT_PATH="$LOCAL_PROJECT_PATH/public"
LOCAL_BACKUP_PATH="/workspace/projects/backups"
```

---

## 📊 备份说明

### 本地备份

**备份路径**：`/workspace/projects/backups/`

**备份内容**：
- 源代码
- 配置文件
- 构建产物

**清理策略**：自动删除 7 天前的备份

---

### 服务器备份

**备份路径**：`/var/backups/lingzhiapp/`

**备份内容**：
- 源代码
- 配置文件

**清理策略**：自动删除 7 天前的备份

---

## 🔄 工作流程

### 完整部署流程

```
1. 修改代码
   ↓
2. git add && git commit
   ↓
3. ./deploy.sh
   ↓
4. 自动执行：
   - 本地备份
   - 服务器备份
   - 推送到 GitHub
   - 同步到服务器
   - 重启 Nginx
   - 验证部署
   ↓
5. 完成 ✅
```

### 快速部署流程

```
1. 修改代码
   ↓
2. ./quick-deploy.sh
   ↓
3. 自动执行：
   - 快速备份
   - 推送到 GitHub
   - 同步到服务器
   - 重启 Nginx
   ↓
4. 完成 ✅
```

---

## ⚠️ 注意事项

### 1. 首次部署

首次部署前，需要：

```bash
# 1. 在服务器上安装 Nginx
ssh root@123.56.142.143
yum install nginx -y
systemctl start nginx
systemctl enable nginx

# 2. 创建项目目录
mkdir -p /var/www/lingzhiapp
mkdir -p /var/backups/lingzhiapp

# 3. 配置 Nginx
nano /etc/nginx/conf.d/meiyueart.com.conf
```

### 2. Git 推送失败

如果 `git push` 失败，可能需要输入 GitHub 凭证：

```bash
# 方式 1: 使用 Personal Access Token
git remote set-url origin https://YOUR_TOKEN@github.com/xufengmyart/lingzhiapp.git

# 方式 2: 使用 SSH（推荐）
git remote set-url origin git@github.com:xufengmyart/lingzhiapp.git
```

### 3. 服务器 SSH 连接失败

如果 SSH 连接失败，检查：

```bash
# 检查服务器是否可访问
ping 123.56.142.143

# 检查 SSH 端口是否开放
telnet 123.56.142.143 22

# 使用密码连接测试
ssh root@123.56.142.143
```

---

## 🔍 故障排查

### 问题 1: 备份失败

**原因**：备份目录不存在或权限不足

**解决**：
```bash
# 创建备份目录
mkdir -p /workspace/projects/backups

# 在服务器上创建备份目录
ssh root@123.56.142.143
sudo mkdir -p /var/backups/lingzhiapp
sudo chown -R root:root /var/backups
```

---

### 问题 2: Git 推送失败

**原因**：没有权限或凭证过期

**解决**：
```bash
# 更新 Git 凭证
git config --global credential.helper store
git push origin main
# 输入用户名和密码（或 token）
```

---

### 问题 3: 服务器同步失败

**原因**：服务器上的 Nginx 配置错误

**解决**：
```bash
# 检查 Nginx 配置
ssh root@123.56.142.143
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

---

### 问题 4: Pre-Commit 检查失败

**原因**：代码有错误或未通过测试

**解决**：
```bash
# 查看具体错误
cd web-app
npm run type-check
npm run lint
npm test

# 修复错误后重试
git add .
git commit -m "修复错误"
```

---

## 📝 日常使用建议

### 推荐工作流程

**大改动（完整部署）**：
```bash
1. 修改代码
2. 运行测试
3. ./deploy.sh
```

**小改动（快速部署）**：
```bash
1. 修改代码
2. ./quick-deploy.sh
```

**仅同步到 GitHub（不部署到服务器）**：
```bash
1. 修改代码
2. git add .
3. git commit -m "提交信息"
4. git push origin main
```

---

## 🎯 最佳实践

### 1. 提交前检查

每次提交代码前，确保：
- ✅ 代码通过测试
- ✅ TypeScript 类型检查通过
- ✅ ESLint 检查通过
- ✅ 构建成功

### 2. 定期检查备份

```bash
# 查看本地备份
ls -lh backups/

# 查看服务器备份
ssh root@123.56.142.143
ls -lh /var/backups/lingzhiapp/
```

### 3. 监控部署状态

```bash
# 检查 Nginx 状态
ssh root@123.56.142.143
systemctl status nginx

# 查看访问日志
tail -f /var/log/nginx/access.log

# 查看错误日志
tail -f /var/log/nginx/error.log
```

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. 执行的命令
2. 错误信息
3. 使用的脚本

---

## ✅ 总结

### 自动化部署的优势

| 优势 | 说明 |
|------|------|
| 🚀 快速 | 一键部署，节省时间 |
| 📦 安全 | 自动备份，防止数据丢失 |
| 🔍 可靠 | 自动检查，减少错误 |
| 🔄 便捷 | 简化流程，提高效率 |

### 推荐使用场景

| 场景 | 推荐脚本 |
|------|---------|
| 日常快速更新 | quick-deploy.sh |
| 重要改动 | deploy.sh |
| 首次部署 | 手动配置 + deploy.sh |

---

**祝部署顺利！** 🎉
