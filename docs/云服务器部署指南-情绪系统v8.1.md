# 灵值智能体 v8.1 - 云服务器部署指南

**版本**: v8.1（数据库持久化版）
**更新日期**: 2025年1月15日
**主体公司**: 陕西媄月商业艺术有限责任公司

---

## 一、部署概述

本次部署将**情绪系统数据库持久化**的代码同步到云服务器。

---

## 二、需要同步的文件清单

### 1. 修改的文件（3个）

| 序号 | 文件路径 | 说明 |
|------|---------|------|
| 1 | `src/storage/database/shared/model.py` | 添加情绪表ORM模型 |
| 2 | `src/tools/emotion_tools.py` | 集成数据库持久化 |

### 2. 新增的文件（3个）

| 序号 | 文件路径 | 说明 |
|------|---------|------|
| 1 | `src/storage/database/emotion_manager.py` | 情绪管理器 |
| 2 | `scripts/test_emotion_database.py` | 数据库测试脚本 |

### 3. 无需修改的文件

| 序号 | 文件路径 | 说明 |
|------|---------|------|
| 1 | `config/agent_llm_config.json` | 已包含情绪工具（无需修改） |
| 2 | `requirements.txt` | 已包含所有依赖（无需修改） |
| 3 | `src/agents/agent.py` | 已导入情绪工具（无需修改） |

---

## 三、部署步骤

### 方案A：使用Git（推荐）

```bash
# 1. 在本地执行
cd /workspace/projects
git add .
git commit -m "feat: 实现情绪系统数据库持久化（PostgreSQL）"
git push origin main

# 2. 在云服务器上执行
cd /var/www/backend
git pull origin main

# 3. 重启服务
sudo systemctl restart your-service-name
```

### 方案B：手动上传文件

```bash
# 1. 打包文件
cd /workspace/projects
tar -czf emotion_system_v8.1.tar.gz \
  src/storage/database/shared/model.py \
  src/storage/database/emotion_manager.py \
  src/tools/emotion_tools.py \
  scripts/test_emotion_database.py

# 2. 上传到云服务器
scp emotion_system_v8.1.tar.gz user@your-server:/var/www/backend/

# 3. 在云服务器上解压
ssh user@your-server
cd /var/www/backend
tar -xzf emotion_system_v8.1.tar.gz

# 4. 验证文件权限
chmod 644 src/storage/database/shared/model.py
chmod 644 src/storage/database/emotion_manager.py
chmod 644 src/tools/emotion_tools.py
chmod 644 scripts/test_emotion_database.py
```

### 方案C：逐个文件上传

```bash
# 上传修改的文件
scp src/storage/database/shared/model.py user@your-server:/var/www/backend/src/storage/database/shared/
scp src/storage/database/emotion_manager.py user@your-server:/var/www/backend/src/storage/database/
scp src/tools/emotion_tools.py user@your-server:/var/www/backend/src/tools/
scp scripts/test_emotion_database.py user@your-server:/var/www/backend/scripts/
```

---

## 四、数据库表创建

### 1. 创建情绪记录表

```sql
-- 创建情绪记录表
CREATE TABLE IF NOT EXISTS emotion_records (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    emotion VARCHAR(20) NOT NULL,
    emotion_name VARCHAR(20) NOT NULL,
    intensity FLOAT NOT NULL,
    context TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS ix_emotion_records_user_id ON emotion_records(user_id);
CREATE INDEX IF NOT EXISTS ix_emotion_records_created_at ON emotion_records(created_at);
CREATE INDEX IF NOT EXISTS ix_emotion_records_emotion ON emotion_records(emotion);

-- 添加表注释
COMMENT ON TABLE emotion_records IS '情绪记录表';
```

### 2. 创建情绪日记表

```sql
-- 创建情绪日记表
CREATE TABLE IF NOT EXISTS emotion_diaries (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    emotion VARCHAR(20) NOT NULL,
    emotion_name VARCHAR(20) NOT NULL,
    intensity FLOAT NOT NULL,
    tags JSON,
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS ix_emotion_diaries_user_id ON emotion_diaries(user_id);
CREATE INDEX IF NOT EXISTS ix_emotion_diaries_created_at ON emotion_diaries(created_at);

-- 添加表注释
COMMENT ON TABLE emotion_diaries IS '情绪日记表';
```

### 3. 验证表创建

```sql
-- 检查表是否存在
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('emotion_records', 'emotion_diaries');

-- 检查索引是否存在
SELECT indexname FROM pg_indexes
WHERE tablename IN ('emotion_records', 'emotion_diaries');
```

---

## 五、重启服务

### 1. 查找服务名称

```bash
# 查看Python进程
ps aux | grep python

# 或查看systemd服务
systemctl list-units --type=service | grep -i backend
```

### 2. 重启服务

```bash
# 假设服务名称为 lingzhi-backend
sudo systemctl restart lingzhi-backend

# 或使用supervisor
sudo supervisorctl restart lingzhi-backend

# 或手动重启
# 1. 停止旧进程
pkill -f "python.*main.py"

# 2. 启动新进程
cd /var/www/backend
nohup python -u src/main.py > logs/app.log 2>&1 &
```

### 3. 验证服务状态

```bash
# 查看服务状态
systemctl status lingzhi-backend

# 或查看进程
ps aux | grep python

# 查看日志
tail -f logs/app.log
```

---

## 六、功能验证

### 1. 运行测试脚本

```bash
cd /var/www/backend
python scripts/test_emotion_database.py
```

### 2. 验证数据库连接

```bash
python -c "from coze_coding_dev_sdk.database import get_session; db = get_session(); print('Database connected successfully')"
```

### 3. 验证情绪工具

```bash
python -c "from tools.emotion_tools import record_emotion; print('Emotion tools imported successfully')"
```

---

## 七、回滚方案

### 如果部署失败

1. **停止服务**
   ```bash
   sudo systemctl stop lingzhi-backend
   ```

2. **回滚代码**
   ```bash
   git checkout HEAD~1
   # 或恢复备份文件
   cp model.py.bak model.py
   cp emotion_tools.py.bak emotion_tools.py
   ```

3. **删除新增的表（可选）**
   ```sql
   DROP TABLE IF EXISTS emotion_diaries;
   DROP TABLE IF EXISTS emotion_records;
   ```

4. **重启服务**
   ```bash
   sudo systemctl start lingzhi-backend
   ```

---

## 八、监控与维护

### 1. 监控数据库连接

```bash
# 查看当前连接数
SELECT count(*) FROM pg_stat_activity;

# 查看活跃连接
SELECT * FROM pg_stat_activity WHERE state = 'active';
```

### 2. 监控表大小

```bash
# 查看表大小
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename IN ('emotion_records', 'emotion_diaries');
```

### 3. 监控索引使用

```bash
# 查看索引使用情况
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename IN ('emotion_records', 'emotion_diaries');
```

---

## 九、常见问题

### 1. 服务启动失败

**问题**: 服务启动后立即退出

**排查步骤**:
```bash
# 查看错误日志
tail -n 50 logs/app.log | grep -i error

# 检查端口占用
netstat -tulnp | grep <port>

# 检查Python环境
which python
python --version
```

**常见原因**:
- 依赖包缺失：`pip install -r requirements.txt`
- 端口被占用：修改端口或停止占用进程
- 环境变量未设置：检查 `.env` 文件

### 2. 数据库连接失败

**问题**: 无法连接到数据库

**排查步骤**:
```bash
# 检查数据库服务
systemctl status postgresql

# 测试数据库连接
psql -h localhost -U username -d database_name

# 检查环境变量
echo $DATABASE_URL
```

### 3. 表创建失败

**问题**: 执行CREATE TABLE失败

**排查步骤**:
```bash
# 检查表是否已存在
SELECT table_name FROM information_schema.tables
WHERE table_name = 'emotion_records';

# 检查外键约束
SELECT * FROM users LIMIT 1;
```

### 4. 工具导入失败

**问题**: 导入情绪工具失败

**排查步骤**:
```bash
# 检查文件是否存在
ls -la src/tools/emotion_tools.py

# 检查Python路径
echo $PYTHONPATH

# 检查依赖包
pip list | grep sqlalchemy
```

---

## 十、数据备份

### 备份策略

```bash
# 每日备份情绪相关表
pg_dump -h localhost -U username -d database_name \
  -t emotion_records -t emotion_diaries \
  -f emotion_backup_$(date +%Y%m%d).sql

# 压缩备份
gzip emotion_backup_$(date +%Y%m%d).sql
```

### 恢复数据

```bash
# 解压备份
gunzip emotion_backup_20250115.sql.gz

# 恢复数据
psql -h localhost -U username -d database_name \
  -f emotion_backup_20250115.sql
```

---

## 十一、性能优化

### 1. 索引优化

```sql
-- 查看未使用的索引
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND tablename IN ('emotion_records', 'emotion_diaries');
```

### 2. 查询优化

```sql
-- 分析查询性能
EXPLAIN ANALYZE
SELECT * FROM emotion_records
WHERE user_id = 1
ORDER BY created_at DESC
LIMIT 100;
```

---

## 十二、部署检查清单

### 部署前检查

- [ ] 备份现有代码
- [ ] 备份数据库
- [ ] 准备回滚方案
- [ ] 通知相关人员

### 部署中检查

- [ ] 文件上传成功
- [ ] 文件权限正确
- [ ] 数据库表创建成功
- [ ] 依赖包已安装

### 部署后检查

- [ ] 服务启动成功
- [ ] 测试脚本通过
- [ ] 功能验证通过
- [ ] 日志无错误
- [ ] 监控正常

---

## 十三、联系方式

- **技术支持**: 待定
- **紧急联系**: 待定

---

**文档版本**: v1.0
**创建日期**: 2025年1月15日
**维护团队**: 陕西媄月商业艺术有限责任公司技术部
