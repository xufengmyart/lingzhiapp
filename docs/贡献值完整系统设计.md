# 贡献值完整系统设计

## 一、系统概述

贡献值系统是灵值生态园的核心驱动力，用于衡量用户在平台上的贡献程度，并作为获取奖励、参与活动、享受服务的凭证。

## 二、数据库设计

### 2.1 贡献值规则表 (contribution_rules)

```sql
CREATE TABLE IF NOT EXISTS contribution_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_type TEXT NOT NULL,  -- 'earn' | 'consume'
    rule_name TEXT NOT NULL,  -- 规则名称
    rule_code TEXT UNIQUE NOT NULL,  -- 规则代码（用于程序调用）
    description TEXT,  -- 规则描述
    target_role TEXT,  -- 目标角色（'all', 'merchant', 'expert', 'user'）
    contribution_value INTEGER NOT NULL,  -- 贡献值变化量（正数为赚取，负数为消耗）
    lingzhi_value INTEGER DEFAULT 0,  -- 灵值变化量（可选）
    max_daily_times INTEGER DEFAULT NULL,  -- 每日最大次数（NULL为无限制）
    max_total_times INTEGER DEFAULT NULL,  -- 总最大次数（NULL为无限制）
    conditions TEXT,  -- 触发条件（JSON格式）
    rewards TEXT,  -- 额外奖励（JSON格式）
    status TEXT DEFAULT 'active',  -- 'active' | 'inactive' | 'archived'
    priority INTEGER DEFAULT 0,  -- 优先级（数值越大优先级越高）
    start_time TIMESTAMP,  -- 规则生效时间
    end_time TIMESTAMP,  -- 规则失效时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER  -- 创建人ID
);
```

### 2.2 贡献值交易记录表 (contribution_transactions)

```sql
CREATE TABLE IF NOT EXISTS contribution_transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    rule_id INTEGER,
    rule_code TEXT NOT NULL,  -- 规则代码
    rule_name TEXT,  -- 规则名称
    transaction_type TEXT NOT NULL,  -- 'earn' | 'consume' | 'transfer' | 'adjust'
    contribution_change INTEGER NOT NULL,  -- 贡献值变化量
    balance_before INTEGER NOT NULL,  -- 变化前余额
    balance_after INTEGER NOT NULL,  -- 变化后余额
    lingzhi_change INTEGER DEFAULT 0,  -- 灵值变化量
    lingzhi_balance_before INTEGER DEFAULT 0,  -- 灵值变化前余额
    lingzhi_balance_after INTEGER DEFAULT 0,  -- 灵值变化后余额
    related_user_id INTEGER,  -- 关联用户ID（如推荐人）
    related_entity_type TEXT,  -- 关联实体类型（'task', 'project', 'merchant', 'expert'）
    related_entity_id INTEGER,  -- 关联实体ID
    description TEXT,  -- 交易描述
    metadata TEXT,  -- 元数据（JSON格式）
    status TEXT DEFAULT 'completed',  -- 'pending' | 'completed' | 'failed' | 'reverted'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (rule_id) REFERENCES contribution_rules(id)
);
```

### 2.3 贡献值流转日志表 (contribution_logs)

```sql
CREATE TABLE IF NOT EXISTS contribution_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    transaction_id INTEGER,
    user_id INTEGER NOT NULL,
    action TEXT NOT NULL,  -- 'check_in', 'publish_content', 'complete_task', 'recommend_merchant', etc.
    action_detail TEXT,  -- 动作详情
    contribution_change INTEGER DEFAULT 0,  -- 贡献值变化
    lingzhi_change INTEGER DEFAULT 0,  -- 灵值变化
    rule_applied TEXT,  -- 应用的规则
    ip_address TEXT,
    user_agent TEXT,
    device_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (transaction_id) REFERENCES contribution_transactions(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2.4 角色推荐关系表 (role_referrals)

```sql
CREATE TABLE IF NOT EXISTS role_referrals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_id INTEGER NOT NULL,  -- 推荐人ID
    referee_id INTEGER NOT NULL,  -- 被推荐人ID
    referrer_role TEXT NOT NULL,  -- 推荐人角色（'merchant', 'expert'）
    referee_role TEXT,  -- 被推荐人角色
    referral_code TEXT,  -- 推荐码
    referral_status TEXT DEFAULT 'pending',  -- 'pending' | 'confirmed' | 'completed' | 'expired'
    reward_contribution INTEGER DEFAULT 0,  -- 贡献值奖励
    reward_lingzhi INTEGER DEFAULT 0,  -- 灵值奖励
    reward_status TEXT DEFAULT 'unclaimed',  -- 'unclaimed' | 'claimed' | 'expired'
    confirmed_at TIMESTAMP,
    completed_at TIMESTAMP,
    claimed_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES users(id),
    FOREIGN KEY (referee_id) REFERENCES users(id),
    UNIQUE(referrer_id, referee_id)
);
```

### 2.5 商家客户群表 (merchant_customer_groups)

```sql
CREATE TABLE IF NOT EXISTS merchant_customer_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    merchant_id INTEGER NOT NULL,  -- 商家ID
    group_name TEXT NOT NULL,  -- 客户群名称
    group_type TEXT DEFAULT 'wechat',  -- 'wechat' | 'offline' | 'online'
    group_size INTEGER DEFAULT 0,  -- 客户群大小
    group_source TEXT,  -- 客户群来源
    contact_person TEXT,  -- 联系人
    contact_phone TEXT,  -- 联系电话
    description TEXT,  -- 描述
    verification_status TEXT DEFAULT 'pending',  -- 'pending' | 'verified' | 'rejected'
    verification_evidence TEXT,  -- 验证凭证（JSON或图片URL）
    verified_at TIMESTAMP,
    verified_by INTEGER,  -- 验证人ID
    contribution_reward INTEGER DEFAULT 0,  -- 贡献值奖励
    reward_claimed BOOLEAN DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (merchant_id) REFERENCES users(id),
    FOREIGN KEY (verified_by) REFERENCES users(id)
);
```

### 2.6 商家推荐记录表 (merchant_referrals)

```sql
CREATE TABLE IF NOT EXISTS merchant_referrals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_merchant_id INTEGER NOT NULL,  -- 推荐商家ID
    referee_merchant_id INTEGER NOT NULL,  -- 被推荐商家ID
    referral_code TEXT,  -- 推荐码
    referral_status TEXT DEFAULT 'pending',  -- 'pending' | 'confirmed' | 'completed'
    relationship_type TEXT,  -- 'partnership', 'cooperation', 'other'
    relationship_description TEXT,  -- 关系描述
    contribution_reward INTEGER DEFAULT 0,  -- 贡献值奖励
    reward_status TEXT DEFAULT 'unclaimed',  -- 'unclaimed' | 'claimed'
    confirmed_at TIMESTAMP,
    completed_at TIMESTAMP,
    claimed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_merchant_id) REFERENCES users(id),
    FOREIGN KEY (referee_merchant_id) REFERENCES users(id),
    UNIQUE(referrer_merchant_id, referee_merchant_id)
);
```

### 2.7 优惠券表 (coupons)

```sql
CREATE TABLE IF NOT EXISTS coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    coupon_code TEXT UNIQUE NOT NULL,  -- 优惠券代码
    coupon_name TEXT NOT NULL,  -- 优惠券名称
    coupon_type TEXT NOT NULL,  -- 'discount' | 'cash' | 'free' | 'lingzhi'
    discount_value REAL,  -- 折扣值
    min_purchase_amount REAL DEFAULT 0,  -- 最低消费金额
    max_discount_amount REAL,  -- 最大折扣金额
    lingzhi_cost INTEGER DEFAULT 0,  -- 灵值成本
    contribution_cost INTEGER DEFAULT 0,  -- 贡献值成本
    valid_days INTEGER,  -- 有效天数
    start_time TIMESTAMP,  -- 开始时间
    end_time TIMESTAMP,  -- 结束时间
    total_quantity INTEGER DEFAULT 0,  -- 总数量
    remaining_quantity INTEGER DEFAULT 0,  -- 剩余数量
    per_user_limit INTEGER DEFAULT 1,  -- 每用户限领数量
    usage_count INTEGER DEFAULT 0,  -- 已使用次数
    description TEXT,  -- 描述
    terms TEXT,  -- 使用条款
    status TEXT DEFAULT 'active',  -- 'active' | 'inactive' | 'expired'
    created_by INTEGER,  -- 创建人ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 2.8 用户优惠券表 (user_coupons)

```sql
CREATE TABLE IF NOT EXISTS user_coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    coupon_id INTEGER NOT NULL,
    coupon_code TEXT NOT NULL,
    status TEXT DEFAULT 'unused',  -- 'unused' | 'used' | 'expired'
    used_at TIMESTAMP,
    used_amount REAL,  -- 使用金额
    order_id INTEGER,  -- 关联订单ID
    received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (coupon_id) REFERENCES coupons(id)
);
```

## 三、默认贡献值规则

### 3.1 赚取规则

| 规则代码 | 规则名称 | 目标角色 | 贡献值 | 灵值 | 每日限制 |
|---------|---------|---------|--------|------|---------|
| daily_checkin | 每日签到 | all | 10 | 5 | 1 |
| publish_content | 发布优质内容 | all | 50 | 20 | 3 |
| complete_profile | 完善个人资料 | all | 30 | 0 | 1 |
| bind_wechat | 绑定微信 | all | 20 | 0 | 1 |
| merchant_register_group | 商家登记客户群 | merchant | 100 | 0 | 5 |
| merchant_recommend | 商家推荐商家 | merchant | 200 | 50 | 10 |
| merchant_coupon_verify | 优惠券核销 | merchant | 30 | 10 | 50 |
| expert_complete_task | 专家完成任务 | expert | 100 | 50 | 10 |
| expert_aigc_work | 专家AIGC作品 | expert | 150 | 80 | 5 |
| user_recommended | 被推荐注册 | all | 50 | 20 | 1 |

### 3.2 消耗规则

| 规则代码 | 规则名称 | 目标角色 | 贡献值 | 灵值 | 每日限制 |
|---------|---------|---------|--------|------|---------|
| get_coupon | 获取优惠券 | all | -50 | -100 | 10 |
| expert_consultation | 专家咨询 | all | -100 | -200 | 5 |
| resource_match | 资源匹配 | all | -150 | -300 | 3 |

## 四、API设计

### 4.1 贡献值规则API

```
GET    /api/admin/contribution/rules          # 获取规则列表
POST   /api/admin/contribution/rules          # 创建规则
GET    /api/admin/contribution/rules/:id      # 获取规则详情
PUT    /api/admin/contribution/rules/:id      # 更新规则
DELETE /api/admin/contribution/rules/:id      # 删除规则
```

### 4.2 贡献值交易API

```
GET    /api/admin/contribution/transactions           # 获取交易记录列表
GET    /api/admin/contribution/transactions/:id       # 获取交易详情
GET    /api/admin/contribution/users/:id/transactions # 获取用户交易记录
POST   /api/admin/contribution/adjust                 # 调整用户贡献值
```

### 4.3 贡献值统计API

```
GET    /api/admin/contribution/stats          # 获取贡献值统计
GET    /api/admin/contribution/users/:id/stats # 获取用户贡献值统计
GET    /api/admin/contribution/leaderboard    # 获取贡献值排行榜
```

### 4.4 商家功能API

```
# 客户群管理
POST   /api/merchant/customer-groups              # 登记客户群
GET    /api/merchant/customer-groups              # 获取客户群列表
GET    /api/merchant/customer-groups/:id          # 获取客户群详情
PUT    /api/merchant/customer-groups/:id          # 更新客户群
DELETE /api/merchant/customer-groups/:id          # 删除客户群

# 商家推荐
POST   /api/merchant/referrals                    # 推荐商家
GET    /api/merchant/referrals                    # 获取推荐记录
GET    /api/merchant/referrals/:id                # 获取推荐详情
PUT    /api/merchant/referrals/:id/claim          # 领取奖励

# 优惠券核销
POST   /api/merchant/coupons/verify               # 核销优惠券
GET    /api/merchant/coupons/verified             # 获取核销记录
```

### 4.5 专家功能API

```
# 任务管理
POST   /api/expert/tasks                          # 承接任务
GET    /api/expert/tasks                          # 获取任务列表
GET    /api/expert/tasks/:id                      # 获取任务详情
PUT    /api/expert/tasks/:id/complete             # 完成任务
PUT    /api/expert/tasks/:id/submit               # 提交任务

# AIGC作品管理
POST   /api/expert/aigc-works                     # 上传AIGC作品
GET    /api/expert/aigc-works                     # 获取作品列表
GET    /api/expert/aigc-works/:id                 # 获取作品详情
PUT    /api/expert/aigc-works/:id                 # 更新作品
DELETE /api/expert/aigc-works/:id                 # 删除作品
```

## 五、前端页面设计

### 5.1 贡献值管理页面

- 规则管理（创建、编辑、删除、启用/禁用）
- 交易记录查询（支持筛选和导出）
- 贡献值统计（图表展示）
- 贡献值排行榜
- 手动调整用户贡献值

### 5.2 商家工作台

- 客户群登记管理
- 商家推荐管理
- 优惠券核销记录
- 收益统计

### 5.3 专家工作台

- 任务承接与提交
- AIGC作品管理
- 技能标签管理
- 收益统计

## 六、权限控制

### 6.1 角色权限

| 功能 | 管理员 | 商家 | 专家 | 用户 |
|-----|--------|-----|------|-----|
| 查看贡献值规则 | ✓ | ✗ | ✗ | ✗ |
| 创建/编辑规则 | ✓ | ✗ | ✗ | ✗ |
| 查看交易记录 | ✓ | 自己的 | 自己的 | 自己的 |
| 调整贡献值 | ✓ | ✗ | ✗ | ✗ |
| 登记客户群 | ✗ | ✓ | ✗ | ✗ |
| 推荐商家 | ✗ | ✓ | ✗ | ✗ |
| 核销优惠券 | ✗ | ✓ | ✗ | ✗ |
| 承接任务 | ✗ | ✗ | ✓ | ✗ |
| 上传AIGC作品 | ✗ | ✗ | ✓ | ✗ |

## 七、业务流程

### 7.1 商家登记客户群流程

1. 商家在后台填写客户群信息
2. 上传验证凭证（截图等）
3. 系统验证客户群真实性
4. 验证通过后，发放贡献值奖励
5. 商家可查看奖励记录

### 7.2 商家推荐商家流程

1. 商家生成推荐码或推荐链接
2. 被推荐商家通过推荐链接注册
3. 系统建立推荐关系
4. 被推荐商家完成注册后，推荐人获得奖励
5. 双方可持续获得推荐奖励

### 7.3 优惠券核销流程

1. 用户使用优惠券
2. 商家在后台核销优惠券
3. 系统验证优惠券有效性
4. 核销成功后，商家获得贡献值奖励
5. 记录核销信息

### 7.4 专家完成任务流程

1. 专家在任务列表中查看可用任务
2. 承接感兴趣的任务
3. 完成任务并提交
4. 管理员审核任务
5. 审核通过后，发放贡献值奖励

## 八、数据统计

### 8.1 贡献值统计指标

- 总贡献值发放量
- 总贡献值消耗量
- 贡献值活跃用户数
- 贡献值交易笔数
- 各角色贡献值分布
- 贡献值增长趋势

### 8.2 商家统计指标

- 商家数量
- 客户群总数
- 推荐商家数量
- 优惠券核销数量
- 商家贡献值总额

### 8.3 专家统计指标

- 专家数量
- 完成任务数
- AIGC作品数
- 专家贡献值总额
