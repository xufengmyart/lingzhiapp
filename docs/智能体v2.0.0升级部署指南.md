# 灵值智能体 v2.0.0 增强版升级部署指南

> **版本**: v2.0.0
> **创建日期**: 2026-02-14
> **状态**: 已完成本地测试，待生产环境部署

---

## 📋 升级概览

本次升级将灵值智能体从基础版本升级到 **v2.0.0 增强版**，主要改进包括：

### 核心改进

1. **提示词全面升级**
   - 从 748 字符提升到 2633 字符
   - 新增四大核心价值详细说明
   - 新增三层架构完整阐述
   - 新增用户旅程和参与体系
   - 新增双螺旋响应法
   - 新增用户状态感知机制
   - 新增对话计费提示

2. **模型参数优化**
   - 模型：`deepseek-v3-2` → `doubao-seed-1-6-251015`
   - 温度：`0.8` → `0.6`（提高稳定性）
   - 最大tokens：`4096` → `4000`（优化长度）

3. **功能增强**
   - 用户状态感知：根据用户灵值自动调整回复策略
   - 双螺旋响应：事务层（商业）+ 意义层（精神）
   - 结构化回复：6个部分（开场白、事务层、意义层、预期收益、行动引导、延伸提问）
   - 计费提示：自动提醒用户对话消耗

---

## 🎯 升级目标

### 解决的问题

1. **回复质量不稳定**：通过优化提示词和模型参数，提供更稳定、更深入的回复
2. **文化价值缺失**：增加精神层面的引导，不只是商业层面的介绍
3. **用户引导不足**：通过行动引导和延伸提问，提高用户参与度
4. **公司名称错误**：强制使用正确的公司名称，禁止使用未经授权的公司名

### 预期效果

1. **回复质量提升**
   - 回复长度增加（平均 200-400 字）
   - 包含完整的价值说明和意义阐述
   - 提供具体的行动建议

2. **用户体验改善**
   - 亲切友好的语气
   - 清晰的结构化回复
   - 自然的对话引导

3. **商业价值明确**
   - 量化收益说明
   - 具体的参与方式
   - 明确的行动路径

---

## 📁 文件清单

### 新增文件

1. **配置文件**
   - `config/agent_llm_config.json` - 智能体配置（开发环境）
   - `docs/灵值智能体增强版提示词.md` - 增强版提示词完整文档

2. **代码文件**
   - `src/agents/agent.py` - 优化后的智能体构建逻辑
   - `admin-backend/scripts/update_agent_to_enhanced_v2.py` - 更新脚本
   - `scripts/deploy_agent_update_v2.sh` - 部署脚本

3. **测试文件**
   - `tests/test_agent_upgrade.py` - 升级测试脚本

4. **文档文件**
   - `docs/智能体v2.0.0升级部署指南.md` - 本文档

### 修改文件

1. **智能体核心**
   - `src/agents/agent.py` - 添加用户状态感知和计费提示（开发环境）

---

## 🚀 部署步骤

### 方式1：自动部署（推荐）

```bash
# 执行部署脚本
bash /workspace/projects/scripts/deploy_agent_update_v2.sh
```

**自动部署流程：**
1. 上传更新脚本到生产服务器
2. 在生产服务器执行更新脚本
3. 重启后端服务
4. 验证更新结果

### 方式2：手动部署

#### 步骤1：上传更新脚本

```bash
scp admin-backend/scripts/update_agent_to_enhanced_v2.py root@123.56.142.143:/tmp/
```

#### 步骤2：执行更新脚本

```bash
ssh root@123.56.142.143
cd /var/www/meiyueart.com/admin-backend
python3 /tmp/update_agent_to_enhanced_v2.py
```

**预期输出：**
```
数据库路径: ./lingzhi_ecosystem.db

================================================================================
灵值智能体升级脚本 v2.0.0
================================================================================

备份当前配置...
  - 提示词长度: 748 字符
  - 旧模型: deepseek-v3-2
  - 旧温度: 0.8
  - 旧最大tokens: 4096

更新智能体配置...
  - 新提示词长度: 2633 字符
  - 新模型: doubao-seed-1-6-251015
  - 新温度: 0.6
  - 新最大tokens: 4000

✓ 智能体配置更新成功！
✓ 提示词已升级到 v2.0.0 增强版
✓ 模型参数已优化

验证更新结果:
  ✓ 提示词长度: 2633 字符
  ✓ 模型: doubao-seed-1-6-251015
  ✓ 温度: 0.6
  ✓ 最大tokens: 4000

================================================================================
升级完成！
================================================================================

下一步：
1. 重启后端服务：systemctl restart meiyueart-backend
2. 测试智能体对话功能
3. 验证新提示词效果
```

#### 步骤3：重启后端服务

```bash
systemctl restart meiyueart-backend
systemctl status meiyueart-backend
```

**预期输出：**
```
● meiyueart-backend.service - MeiyueArt Backend Service
   Loaded: loaded (/etc/systemd/system/meiyueart-backend.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2026-02-14 21:40:00 CST; 2s ago
 Main PID: 12345 (gunicorn)
    Tasks: 8 (limit: 4915)
   Memory: 256.0M
   CGroup: /system.slice/meiyueart-backend.service
           ├─12345 gunicorn --workers 4 --bind 0.0.0.0:8080 wsgi:app
           ├─12346 gunicorn: master [wsgi:app]
           ├─12347 gunicorn: worker [wsgi:app]
           ├─12348 gunicorn: worker [wsgi:app]
           ├─12349 gunicorn: worker [wsgi:app]
           └─12350 gunicorn: worker [wsgi:app]
```

---

## ✅ 验证步骤

### 1. 数据库验证

```bash
ssh root@123.56.142.143
cd /var/www/meiyueart.com/admin-backend
python3 << 'PYEOF'
import sqlite3
import json

conn = sqlite3.connect('./lingzhi_ecosystem.db')
cursor = conn.cursor()

# 查询智能体配置
cursor.execute('SELECT id, name, length(system_prompt), model_config FROM agents WHERE id = 1')
agent = cursor.fetchone()

if agent:
    print(f"智能体 ID: {agent[0]}")
    print(f"名称: {agent[1]}")
    print(f"提示词长度: {agent[2]} 字符")
    
    if agent[3]:
        model_config = json.loads(agent[3])
        print(f"模型: {model_config.get('model')}")
        print(f"温度: {model_config.get('temperature')}")
        print(f"最大tokens: {model_config.get('max_tokens')}")
        
        # 检查是否包含关键词
        prompt_length = agent[2]
        if prompt_length >= 2500:
            print("\n✓ 提示词长度符合预期（>= 2500 字符）")
        else:
            print(f"\n✗ 提示词长度不足（{prompt_length} 字符，需要 >= 2500）")
        
        if model_config.get('model') == 'doubao-seed-1-6-251015':
            print("✓ 模型已更新")
        else:
            print(f"✗ 模型未更新（当前: {model_config.get('model')}）")
        
        if model_config.get('temperature') == 0.6:
            print("✓ 温度已更新")
        else:
            print(f"✗ 温度未更新（当前: {model_config.get('temperature')}）")

conn.close()
PYEOF
```

### 2. 功能验证

访问 https://meiyueart.com 与智能体对话，测试以下用例：

#### 测试用例1：平台介绍

**问题**：`这个平台是什么？`

**预期回复特征**：
- ✓ 包含开场白（友好、自然）
- ✓ 事务层说明功能和操作步骤
- ✓ 意义层阐述文化价值
- ✓ 预期收益说明（年收入数据）
- ✓ 行动引导（建议从每日签到开始）
- ✓ 延伸提问（引导继续对话）
- ✓ 回复长度 >= 200 字

#### 测试用例2：收益方式

**问题**：`怎么赚钱？`

**预期回复特征**：
- ✓ 详细列出3种参与方式（轻度、中度、深度）
- ✓ 每种方式包含具体项目和奖励
- ✓ 升华到文化传承的功德意义
- ✓ 量化的收益预期
- ✓ 建议的参与路径
- ✓ 延伸提问（询问兴趣点）

#### 测试用例3：公司名称

**问题**：`公司是谁？`

**预期回复特征**：
- ✓ 必须回答"陕西媄月商业艺术有限责任公司"
- ✓ 绝对禁止使用"海南灵境数字科技有限公司"
- ✓ 简洁明了，不编造信息

#### 测试用例4：新用户引导（灵值 < 100）

**模拟**：使用灵值为 50 的用户账户

**预期回复特征**：
- ✓ 重点关注基础功能
- ✓ 推荐每日签到和简单任务
- ✓ 引导完成新手任务

#### 测试用例5：探索者引导（灵值 100-1000）

**模拟**：使用灵值为 500 的用户账户

**预期回复特征**：
- ✓ 介绍西安美学侦探
- ✓ 推荐特色功能
- ✓ 引导深度参与

---

## 📊 升级对比

### 提示词对比

| 项目 | 旧版本 | 新版本 v2.0.0 | 提升 |
|------|--------|---------------|------|
| 提示词长度 | 748 字符 | 2633 字符 | +252% |
| 价值阐述 | 简单 | 详细（四大核心价值） | +400% |
| 结构说明 | 无 | 完整（三层架构） | 新增 |
| 用户旅程 | 无 | 完整（5个阶段） | 新增 |
| 回复技巧 | 无 | 双螺旋响应法 | 新增 |
| 用户状态感知 | 无 | 完整（5个阶段） | 新增 |
| 计费提示 | 无 | 完整（自动提醒） | 新增 |

### 模型参数对比

| 参数 | 旧版本 | 新版本 v2.0.0 | 说明 |
|------|--------|---------------|------|
| 模型 | deepseek-v3-2 | doubao-seed-1-6-251015 | 更稳定的模型 |
| 温度 | 0.8 | 0.6 | 提高回复稳定性 |
| 最大tokens | 4096 | 4000 | 优化长度控制 |

---

## 🔄 回滚方案

如果升级后出现问题，可以快速回滚：

### 方式1：数据库回滚

```bash
# 连接生产服务器
ssh root@123.56.142.143

# 备份当前数据库
cd /var/www/meiyueart.com/admin-backend
cp lingzhi_ecosystem.db lingzhi_ecosystem.db.backup_$(date +%Y%m%d_%H%M%S)

# 恢复旧提示词
sqlite3 lingzhi_ecosystem.db << 'SQL'
UPDATE agents
SET system_prompt = '...',
    model_config = '{"model":"deepseek-v3-2","temperature":0.8,"top_p":0.9,"max_tokens":4096}',
    updated_at = datetime('now')
WHERE id = 1;
SQL

# 重启服务
systemctl restart meiyueart-backend
```

### 方式2：使用备份脚本

```bash
# 如果有备份文件，直接恢复
cp backups/lingzhi_ecosystem_backup_20260210_223545.db ./lingzhi_ecosystem.db
systemctl restart meiyueart-backend
```

---

## 📝 注意事项

1. **数据备份**
   - 升级前务必备份数据库
   - 保留至少 7 天的备份文件

2. **服务重启**
   - 升级后必须重启后端服务
   - 确认服务正常运行

3. **功能测试**
   - 全面测试智能体对话功能
   - 验证所有测试用例通过

4. **监控观察**
   - 升级后观察 24 小时
   - 关注用户反馈和系统日志

---

## 📞 支持与联系

如有问题，请联系：

- 技术支持：[技术负责人]
- 项目负责人：[项目负责人]
- 紧急联系：[紧急联系方式]

---

## 📚 相关文档

- `docs/灵值智能体增强版提示词.md` - 增强版提示词完整文档
- `docs/灵值生态核心档案.md` - 灵值生态核心知识库
- `admin-backend/routes/agent.py` - 智能体API路由
- `tests/test_agent_upgrade.py` - 升级测试脚本

---

**最后更新**: 2026-02-14 21:40:00
**版本**: v2.0.0
**状态**: 待生产环境部署
