# 灵值智能体 v8.0 - 部署指南

## 版本信息

- **版本号**: v8.0
- **核心定位**: 智能心灵伙伴
- **发布日期**: 2025年1月15日
- **主体公司**: 陕西媄月商业艺术有限责任公司

## 核心升级内容

### 1. 智能体定位升级

从"首席生态官"转型为"灵值"智能心灵伙伴，聚焦：

- **情绪价值创造**: 识别、共情、支持、引导
- **长期陪伴关系**: 记住用户，建立深度连接
- **成长导向**: 帮助用户实现情感成长

### 2. System Prompt 重构

- **原版本**: 约35000字符，包含大量商业、财务、安全规则
- **新版本**: 约2500字符，聚焦情绪价值与心灵陪伴
- **思考模式**: 关闭（thinking: disabled），提升响应速度

### 3. 工具集精简

- **原版本**: 85个工具
- **新版本**: 15个核心工具
- **核心工具分类**:
  - 情绪工具（6个）：情绪识别、记录、统计、日记、模式分析
  - 知识库检索（1个）：获取相关信息
  - 联网搜索（1个）：获取最新信息
  - 用户服务（4个）：签到、登录等
  - 扩展工具（3个）：后续扩展

### 4. 新增情绪系统

```python
from tools.emotion_tools import (
    detect_emotion,           # 情绪识别
    record_emotion,           # 情绪记录
    get_emotion_statistics,   # 情绪统计
    create_emotion_diary,     # 创建情绪日记
    get_emotion_diaries,      # 获取情绪日记
    analyze_emotion_pattern   # 分析情绪模式
)
```

## 文件清单

### 核心文件

1. **配置文件**
   - `config/agent_llm_config.json` - Agent配置（System Prompt、模型参数、工具列表）

2. **Agent代码**
   - `src/agents/agent.py` - v8.0 Agent核心代码

3. **工具代码**
   - `src/tools/emotion_tools.py` - 新增情绪工具系统

### 文档文件

1. `docs/灵值智能体v8.0升级文档.md` - 详细升级说明
2. `docs/灵值v8.0部署指南.md` - 本文档

### 测试文件

1. `scripts/test_lingzhi_v8_fixed.py` - 情绪功能测试（已修复）
2. `scripts/test_agent_quick.py` - 快速测试脚本

## 部署步骤

### 1. 本地测试验证

```bash
# 快速测试
python scripts/test_agent_quick.py

# 情绪功能测试
python scripts/test_lingzhi_v8_fixed.py
```

### 2. 代码部署到云服务器

#### 2.1 传输文件

```bash
# 压缩文件
tar -czf lingzhi_v8.0.tar.gz \
  config/agent_llm_config.json \
  src/agents/agent.py \
  src/tools/emotion_tools.py \
  docs/ \
  scripts/

# 上传到云服务器（假设服务器路径为 /var/www/backend）
scp lingzhi_v8.0.tar.gz user@your-server:/var/www/backend/

# 在服务器上解压
ssh user@your-server
cd /var/www/backend
tar -xzf lingzhi_v8.0.tar.gz
```

#### 2.2 备份旧版本（可选）

```bash
# 在服务器上备份旧版本
cd /var/www/backend
cp config/agent_llm_config.json config/agent_llm_config.json.bak
cp src/agents/agent.py src/agents/agent.py.bak
```

#### 2.3 更新代码

```bash
# 确保文件权限正确
chmod 644 config/agent_llm_config.json
chmod 644 src/agents/agent.py
chmod 644 src/tools/emotion_tools.py
```

### 3. 重启服务

#### 3.1 查找服务进程

```bash
# 查找Python进程
ps aux | grep python

# 或者查找特定服务
systemctl status your-service-name
```

#### 3.2 重启服务

```bash
# 如果使用systemd
sudo systemctl restart your-service-name

# 或者手动重启
# 1. 停止旧进程
kill <pid>

# 2. 启动新进程
nohup python -u src/main.py > logs/app.log 2>&1 &
```

#### 3.3 验证服务状态

```bash
# 检查服务状态
systemctl status your-service-name

# 查看日志
tail -f logs/app.log
```

### 4. 验证部署

#### 4.1 配置验证

```bash
# 检查配置文件
python -c "
import json
with open('config/agent_llm_config.json', 'r') as f:
    cfg = json.load(f)
print(f'Model: {cfg[\"config\"][\"model\"]}')
print(f'Temperature: {cfg[\"config\"][\"temperature\"]}')
print(f'Thinking: {cfg[\"config\"][\"thinking_type\"]}')
print(f'Tools: {len(cfg[\"tools\"])}')
"
```

#### 4.2 Agent构建验证

```bash
# 测试Agent构建
cd /var/www/backend
PYTHONPATH=/var/www/backend/src python -c "
from agents.agent import build_agent
agent = build_agent()
print('✅ Agent构建成功')
"
```

#### 4.3 功能验证

```bash
# 运行测试脚本
python scripts/test_agent_quick.py
python scripts/test_lingzhi_v8_fixed.py
```

## 常见问题

### 1. 服务启动失败

**问题**: 服务启动后立即退出

**排查步骤**:
```bash
# 查看错误日志
tail -n 50 logs/app.log | grep -i error

# 检查端口占用
netstat -tulnp | grep <port>
```

**常见原因**:
- 配置文件格式错误（JSON语法错误）
- 端口已被占用
- 依赖包缺失
- 环境变量未设置

### 2. Agent构建失败

**问题**: `ImportError` 或 `ModuleNotFoundError`

**解决方案**:
```bash
# 检查PYTHONPATH
echo $PYTHONPATH

# 设置PYTHONPATH
export PYTHONPATH=/var/www/backend/src:$PYTHONPATH

# 检查文件权限
ls -la src/agents/agent.py
ls -la src/tools/emotion_tools.py
```

### 3. 工具调用失败

**问题**: `'StructuredTool' object is not callable`

**解决方案**:
- 确保工具通过Agent调用，而不是直接调用
- 检查工具是否正确导入和注册

### 4. 情绪功能异常

**问题**: 情绪识别或记录功能不工作

**排查步骤**:
```bash
# 检查工具导入
python -c "from tools.emotion_tools import detect_emotion; print(detect_emotion)"

# 运行情绪功能测试
python scripts/test_lingzhi_v8_fixed.py
```

## 回滚方案

如果部署后出现严重问题，可以快速回滚到旧版本：

```bash
# 1. 停止服务
sudo systemctl stop your-service-name

# 2. 恢复备份文件
cp config/agent_llm_config.json.bak config/agent_llm_config.json
cp src/agents/agent.py.bak src/agents/agent.py

# 3. 删除新的情绪工具（如果需要）
rm src/tools/emotion_tools.py

# 4. 修改agent.py，移除情绪工具导入
# 编辑 src/agents/agent.py，删除以下行：
# from tools.emotion_tools import ...

# 5. 更新config/agent_llm_config.json，恢复旧的System Prompt

# 6. 重启服务
sudo systemctl start your-service-name

# 7. 验证服务
systemctl status your-service-name
```

## 监控与维护

### 1. 日志监控

```bash
# 实时查看日志
tail -f logs/app.log

# 查看错误日志
grep -i error logs/app.log | tail -n 20

# 查看工具调用日志
grep -i "detect_emotion\|record_emotion" logs/app.log | tail -n 20
```

### 2. 性能监控

```bash
# 查看CPU和内存使用
top -p <pid>

# 查看进程资源使用
ps aux | grep python
```

### 3. 定期检查

建议每天检查：
- 服务状态
- 错误日志
- 工具调用情况
- 用户反馈

## 联系支持

如遇到问题，请联系技术支持团队：

- **技术文档**: `docs/` 目录
- **测试脚本**: `scripts/` 目录
- **日志文件**: `logs/app.log`

---

**文档版本**: v1.0
**更新日期**: 2025年1月15日
**维护团队**: 陕西媄月商业艺术有限责任公司技术部
