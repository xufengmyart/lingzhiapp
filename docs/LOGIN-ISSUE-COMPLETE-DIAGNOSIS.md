# ğŸ” çµå€¼ç”Ÿæ€å›­ - ç™»å½•é—®é¢˜å®Œæ•´è¯Šæ–­å’Œä¿®å¤æ–¹æ¡ˆ

> **åˆ›å»ºæ—¶é—´**: 2026-02-11  
> **é—®é¢˜ç±»å‹**: ç™»å½• 502 Bad Gateway é”™è¯¯  
> **çŠ¶æ€**: âœ… å·²è¯Šæ–­å¹¶æä¾›å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

### ç”¨æˆ·åé¦ˆ
**ç—‡çŠ¶**: ç”¨æˆ·æ— æ³•ç™»å½•ï¼Œç™»å½•æ—¶è¿”å› 502 é”™è¯¯

### é—®é¢˜æ—¥å¿—åˆ†æ

```
[API] POST /login Object
/api/login:1 Failed to load resource: the server responded with a status of 502 ()
ç™»å½•å¤±è´¥: AxiosError: Request failed with status code 502
```

### 502 é”™è¯¯çš„å«ä¹‰

**502 Bad Gateway** è¡¨ç¤ºï¼š
- Nginx æ¥æ”¶åˆ°å‰ç«¯è¯·æ±‚
- Nginx å°è¯•å°†è¯·æ±‚è½¬å‘åˆ°åç«¯ Flask æœåŠ¡
- **Flask æœåŠ¡æœªå“åº”æˆ–æœªè¿è¡Œ**
- Nginx æ— æ³•å®Œæˆè¯·æ±‚ï¼Œè¿”å› 502 é”™è¯¯

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜æ ¹å› 
**é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆ123.56.142.143ï¼‰ä¸Šçš„ Flask åç«¯æœåŠ¡æœªè¿è¡Œ**

### è¯¦ç»†åˆ†æ

```
ç”¨æˆ·æµè§ˆå™¨
    â”‚ (POST https://meiyueart.com/api/login)
    â†“
Nginx (123.56.142.143:443)
    â”‚ âœ… æ­£å¸¸è¿è¡Œï¼Œæ¥æ”¶è¯·æ±‚
    â”‚ âœ… SSL æ­£å¸¸å·¥ä½œ
    â†“
Flask (123.56.142.143:8080)
    â”‚ âŒ æœåŠ¡æœªè¿è¡Œ
    â”‚ âŒ ç«¯å£ 8080 æœªç›‘å¬
    â†“
è¿”å› 502 Bad Gateway
```

### ç¯å¢ƒå¯¹æ¯”

| ç¯å¢ƒ | æœåŠ¡å™¨ IP | Flask æœåŠ¡ | ç™»å½•åŠŸèƒ½ |
|------|-----------|-----------|---------|
| Coze å¼€å‘ç¯å¢ƒ | 115.190.218.237 | âœ… è¿è¡Œæ­£å¸¸ | âœ… æ­£å¸¸ |
| é˜¿é‡Œäº‘ç”Ÿäº§ç¯å¢ƒ | 123.56.142.143 | âŒ æœªè¿è¡Œ | âŒ 502 é”™è¯¯ |

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **æœåŠ¡è‡ªåŠ¨åœæ­¢**: Flask æœåŠ¡å¯èƒ½å› ä¸ºå¼‚å¸¸ã€èµ„æºè€—å°½æˆ–å…¶ä»–åŸå› è‡ªåŠ¨åœæ­¢
2. **ç¼ºå°‘è‡ªåŠ¨é‡å¯**: æœªé…ç½® systemd è‡ªåŠ¨é‡å¯
3. **ç¼ºå°‘ç›‘æ§**: æ²¡æœ‰å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤æœºåˆ¶

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼Œ1 åˆ†é’Ÿï¼‰

```bash
# 1. SSH ç™»å½•åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
ssh root@123.56.142.143

# 2. è¿è¡Œç™»å½•é—®é¢˜ä¸“ç”¨ä¿®å¤è„šæœ¬
cd /var/www/meiyueart
bash scripts/fix-login-issue.sh

# 3. åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ç™»å½•
# è®¿é—®: https://meiyueart.com
# å°è¯•ç™»å½•ï¼Œåº”è¯¥ä¸å†å‡ºç° 502 é”™è¯¯
```

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨ä¿®å¤ï¼ˆ2 åˆ†é’Ÿï¼‰

```bash
# 1. SSH ç™»å½•
ssh root@123.56.142.143

# 2. æ£€æŸ¥ Flask æœåŠ¡çŠ¶æ€
systemctl status flask-app

# 3. é‡å¯ Flask æœåŠ¡
systemctl restart flask-app

# 4. ç­‰å¾… 3 ç§’
sleep 3

# 5. éªŒè¯æœåŠ¡å¯åŠ¨
systemctl status flask-app

# 6. æ£€æŸ¥ç«¯å£ç›‘å¬
lsof -i :8080

# 7. æµ‹è¯•ç™»å½• API
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{}'
```

### æ–¹æ¡ˆä¸‰ï¼šå®Œæ•´éƒ¨ç½²ï¼ˆ5 åˆ†é’Ÿï¼‰

```bash
# 1. SSH ç™»å½•
ssh root@123.56.142.143

# 2. è¿è¡Œå®Œæ•´éƒ¨ç½²è„šæœ¬
cd /var/www/meiyueart
bash scripts/complete-deploy-and-fix.sh

# 3. é…ç½®è‡ªåŠ¨ç›‘æ§
bash scripts/setup-cron.sh
```

---

## âœ… éªŒè¯ä¿®å¤

### è‡ªåŠ¨éªŒè¯

è¿è¡Œä¿®å¤è„šæœ¬åï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹éªŒè¯ï¼š

- [ ] Flask æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Flask ç«¯å£ 8080 æ­£å¸¸ç›‘å¬
- [ ] Nginx æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] HTTP è®¿é—®æ­£å¸¸
- [ ] HTTPS è®¿é—®æ­£å¸¸

### æ‰‹åŠ¨éªŒè¯

#### 1. æœåŠ¡çŠ¶æ€éªŒè¯

```bash
# æ£€æŸ¥ Flask æœåŠ¡
systemctl status flask-app

# æ£€æŸ¥ Nginx æœåŠ¡
systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep -E '80|443|8080'
```

#### 2. API éªŒè¯

```bash
# æµ‹è¯•ç™»å½• API
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{}'

# æµ‹è¯• HTTPS è®¿é—®
curl -k https://localhost/api/health
```

#### 3. æµè§ˆå™¨éªŒè¯

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `https://meiyueart.com`
2. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
3. åˆ‡æ¢åˆ° **Network** æ ‡ç­¾
4. å°è¯•ç™»å½•
5. æ£€æŸ¥ `/api/login` è¯·æ±‚
   - âœ… åº”è¯¥è¿”å› **200 OK**
   - âœ… ä¸åº”è¯¥è¿”å› **502 Bad Gateway**

---

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### 1. é…ç½®è‡ªåŠ¨é‡å¯ âœ…

**å·²é…ç½®**: systemd æœåŠ¡è‡ªåŠ¨é‡å¯

```ini
Restart=always
RestartSec=10s
StartLimitBurst=5
```

**ä½œç”¨**: Flask æœåŠ¡å´©æºƒåï¼Œ10 ç§’å†…è‡ªåŠ¨é‡å¯

### 2. é…ç½®å¥åº·æ£€æŸ¥ âœ…

**å·²åˆ›å»º**: å¥åº·æ£€æŸ¥è„šæœ¬ `scripts/health-check.sh`

**åŠŸèƒ½**:
- æ¯åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
- æ£€æµ‹åˆ°æœåŠ¡åœæ­¢è‡ªåŠ¨é‡å¯
- è®°å½•è¯¦ç»†çš„å¥åº·æ£€æŸ¥æ—¥å¿—

**é…ç½®æ–¹æ³•**:

```bash
cd /var/www/meiyueart
bash scripts/setup-cron.sh
```

### 3. é…ç½®æœåŠ¡è‡ªå¯åŠ¨ âœ…

```bash
# å¯ç”¨å¼€æœºè‡ªå¯åŠ¨
systemctl enable flask-app
systemctl enable nginx
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ¯æ—¥æ£€æŸ¥ï¼ˆ1 åˆ†é’Ÿï¼‰

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status flask-app
systemctl status nginx

# 2. æ£€æŸ¥ç«¯å£
netstat -tlnp | grep -E '80|443|8080'

# 3. æ£€æŸ¥å¥åº·æ¥å£
curl https://meiyueart.com/api/health
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# Flask æ—¥å¿—
journalctl -u flask-app -f

# Flask é”™è¯¯æ—¥å¿—
tail -f /var/log/flask-app-error.log

# Nginx é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# å¥åº·æ£€æŸ¥æ—¥å¿—
tail -f /var/log/health-check.log
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¦‚æœä¿®å¤åä»ç„¶å‡ºç° 502 é”™è¯¯

#### æ­¥éª¤ 1: æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
systemctl status flask-app
systemctl status nginx
```

#### æ­¥éª¤ 2: æ£€æŸ¥ç«¯å£ç›‘å¬

```bash
lsof -i :8080
netstat -tlnp | grep 8080
```

#### æ­¥éª¤ 3: æŸ¥çœ‹é”™è¯¯æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
journalctl -u flask-app -n 50

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
journalctl -u flask-app -f
```

#### æ­¥éª¤ 4: æ£€æŸ¥ Flask åº”ç”¨æ—¥å¿—

```bash
tail -50 /var/log/flask-app-error.log
```

#### æ­¥éª¤ 5: æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—

```bash
tail -50 /var/log/nginx/error.log
```

#### æ­¥éª¤ 6: é‡æ–°éƒ¨ç½²

```bash
cd /var/www/meiyueart
bash scripts/complete-deploy-and-fix.sh
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `scripts/fix-login-issue.sh` | ç™»å½•é—®é¢˜ä¸“ç”¨ä¿®å¤è„šæœ¬ |
| `scripts/complete-deploy-and-fix.sh` | å®Œæ•´éƒ¨ç½²å’Œä¿®å¤è„šæœ¬ |
| `scripts/health-check.sh` | å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤è„šæœ¬ |
| `scripts/setup-cron.sh` | é…ç½®è‡ªåŠ¨ç›‘æ§ |
| `docs/STANDARD-DEPLOYMENT-CONFIG.md` | æ ‡å‡†éƒ¨ç½²é…ç½®æ–‡æ¡£ |
| `docs/FINAL-SOLUTION-AND-PREVENTION.md` | å®Œæ•´è§£å†³æ–¹æ¡ˆå’Œé¢„é˜²æªæ–½ |

---

## ğŸ¯ ç»éªŒæ•™è®­

### æœ¬æ¬¡é—®é¢˜å­¦åˆ°çš„ä¸œè¥¿

1. **502 é”™è¯¯çš„å«ä¹‰**: é€šå¸¸æ˜¯åç«¯æœåŠ¡æœªè¿è¡Œ
2. **è‡ªåŠ¨é‡å¯çš„é‡è¦æ€§**: å¯ä»¥é˜²æ­¢æœåŠ¡åœæ­¢å¯¼è‡´çš„åŠŸèƒ½ä¸­æ–­
3. **å¥åº·æ£€æŸ¥çš„å¿…è¦æ€§**: åŠæ—¶å‘ç°é—®é¢˜ï¼Œè‡ªåŠ¨ä¿®å¤
4. **ç¯å¢ƒéš”ç¦»çš„é‡è¦æ€§**: å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒéœ€è¦åˆ†åˆ«ç»´æŠ¤

### é¢„é˜²æªæ–½æ€»ç»“

âœ… **å·²å®Œæˆ**:
- systemd è‡ªåŠ¨é‡å¯é…ç½®
- å¥åº·æ£€æŸ¥è„šæœ¬ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ï¼‰
- ç™»å½•é—®é¢˜ä¸“ç”¨ä¿®å¤è„šæœ¬
- å®Œæ•´çš„éƒ¨ç½²å’Œä¿®å¤æ–‡æ¡£

â³ **å»ºè®®åç»­å®Œå–„**:
- é…ç½®å¤–éƒ¨ç›‘æ§æœåŠ¡
- é…ç½®å‘Šè­¦é€šçŸ¥
- é…ç½®è‡ªåŠ¨åŒ–å¤‡ä»½
- é…ç½®è´Ÿè½½å‡è¡¡

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆ1 åˆ†é’Ÿï¼‰

1. âœ… SSH ç™»å½•åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
2. âœ… è¿è¡Œç™»å½•é—®é¢˜ä¿®å¤è„šæœ¬
3. âœ… åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ç™»å½•

### ä»Šå¤©å†…å®Œæˆ

1. âœ… ç¡®è®¤ç™»å½•åŠŸèƒ½æ­£å¸¸
2. âœ… é…ç½®è‡ªåŠ¨ç›‘æ§
3. âœ… é˜…è¯»ç›¸å…³æ–‡æ¡£

### æœ¬å‘¨å†…å®Œæˆ

1. â³ é…ç½®å¤–éƒ¨ç›‘æ§
2. â³ é…ç½®å‘Šè­¦é€šçŸ¥
3. â³ åˆ¶å®šå®šæœŸç»´æŠ¤è®¡åˆ’

---

## ğŸ”‘ å…³é”®ä¿¡æ¯

### æœåŠ¡å™¨ä¿¡æ¯

- **ç”Ÿäº§æœåŠ¡å™¨ IP**: 123.56.142.143
- **åŸŸå**: meiyueart.com
- **Flask ç«¯å£**: 8080
- **Nginx ç«¯å£**: 80 (HTTP), 443 (HTTPS)

### é‡è¦è·¯å¾„

```
åº”ç”¨ç›®å½•: /var/www/meiyueart
Flask æœåŠ¡: /var/www/meiyueart/backend
é…ç½®æ–‡ä»¶: /etc/systemd/system/flask-app.service
æ—¥å¿—ç›®å½•: /var/log/
```

### å¿«é€Ÿå‘½ä»¤

```bash
# ä¸€é”®ä¿®å¤ç™»å½•é—®é¢˜
cd /var/www/meiyueart && bash scripts/fix-login-issue.sh

# é‡å¯æœåŠ¡
systemctl restart flask-app

# æŸ¥çœ‹æ—¥å¿—
journalctl -u flask-app -f
```

---

**åˆ›å»ºè€…**: Coze Coding  
**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-02-11  
**çŠ¶æ€**: âœ… å®Œæˆ
