# 灵值智能体 v8.1 - 快速部署指南

**版本**: v8.1（数据库持久化版）
**更新日期**: 2025年1月15日

---

## 一、部署准备

### 前置条件

✅ 云服务器已安装 PostgreSQL
✅ 云服务器已安装 Python 3.8+
✅ 云服务器已部署基础后端服务
✅ 具备 SSH 访问权限

### 需要同步的文件

```
src/storage/database/shared/model.py          [修改]
src/storage/database/emotion_manager.py       [新增]
src/tools/emotion_tools.py                   [修改]
scripts/test_emotion_database.py             [新增]
```

---

## 二、三种部署方式

### 方式1️⃣: 使用自动化部署脚本（推荐）

```bash
# 1. 配置部署脚本
vi scripts/deploy_to_cloud.sh

# 修改以下变量:
REMOTE_USER="your_username"      # 改为你的服务器用户名
REMOTE_HOST="your_server_ip"     # 改为你的服务器IP
REMOTE_PATH="/var/www/backend"   # 改为你的项目路径
SERVICE_NAME="lingzhi-backend"   # 改为你的服务名称

# 2. 执行部署
./scripts/deploy_to_cloud.sh
```

---

### 方式2️⃣: 手动上传文件

```bash
# 1. 上传文件
scp src/storage/database/shared/model.py user@server:/var/www/backend/src/storage/database/shared/
scp src/storage/database/emotion_manager.py user@server:/var/www/backend/src/storage/database/
scp src/tools/emotion_tools.py user@server:/var/www/backend/src/tools/
scp scripts/test_emotion_database.py user@server:/var/www/backend/scripts/

# 2. SSH 登录服务器
ssh user@server

# 3. 创建数据库表
psql -h localhost -U postgres -d lingzhi_db -f scripts/create_emotion_tables.sql

# 4. 重启服务
sudo systemctl restart lingzhi-backend
```

---

### 方式3️⃣: 使用 Git

```bash
# 1. 本地提交
cd /workspace/projects
git add .
git commit -m "feat: 实现情绪系统数据库持久化（PostgreSQL）"
git push origin main

# 2. 服务器拉取
ssh user@server
cd /var/www/backend
git pull origin main

# 3. 创建数据库表
psql -h localhost -U postgres -d lingzhi_db -f scripts/create_emotion_tables.sql

# 4. 重启服务
sudo systemctl restart lingzhi-backend
```

---

## 三、验证部署

### 1. 检查服务状态

```bash
systemctl status lingzhi-backend
```

**预期结果**: 服务处于 `active (running)` 状态

### 2. 检查数据库表

```bash
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_records"
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_diaries"
```

**预期结果**: 显示表结构

### 3. 运行测试脚本

```bash
cd /var/www/backend
python scripts/test_emotion_database.py
```

**预期结果**: 所有测试通过

### 4. 查看日志

```bash
tail -f /var/www/backend/logs/app.log
```

**预期结果**: 无错误日志，服务正常启动

---

## 四、常见问题

### Q1: SSH 连接失败

**错误**: `ssh: connect to host ... port 22: Connection refused`

**解决**:
- 检查服务器IP是否正确
- 检查SSH服务是否启动: `systemctl status sshd`
- 检查防火墙是否开放22端口

### Q2: 数据库连接失败

**错误**: `FATAL: password authentication failed for user "postgres"`

**解决**:
- 检查数据库用户名和密码
- 检查 `~/.pgpass` 文件配置
- 或使用 `-W` 参数手动输入密码

### Q3: 表已存在

**错误**: `relation "emotion_records" already exists`

**解决**:
- SQL 已使用 `IF NOT EXISTS`，可以忽略此错误
- 或删除表重新创建: `DROP TABLE emotion_diaries, emotion_records;`

### Q4: 服务重启失败

**错误**: `Failed to restart lingzhi-backend.service`

**解决**:
- 查看详细错误: `journalctl -xe`
- 检查日志: `tail -f logs/app.log`
- 检查端口是否被占用: `netstat -tulnp`

### Q5: 测试脚本失败

**错误**: `ModuleNotFoundError: No module named 'coze_coding_dev_sdk'`

**解决**:
- 检查虚拟环境是否激活: `which python`
- 安装依赖: `pip install -r requirements.txt`
- 检查PYTHONPATH: `echo $PYTHONPATH`

---

## 五、回滚操作

如果部署失败，按以下步骤回滚:

```bash
# 1. 停止服务
sudo systemctl stop lingzhi-backend

# 2. 恢复文件（假设有备份）
cp /path/to/backup/emotion_tools.py /var/www/backend/src/tools/
# ... 恢复其他文件

# 3. 删除新增的表（可选）
psql -h localhost -U postgres -d lingzhi_db << EOF
DROP TABLE IF EXISTS emotion_diaries;
DROP TABLE IF EXISTS emotion_records;
EOF

# 4. 重启服务
sudo systemctl start lingzhi-backend
```

---

## 六、监控与维护

### 查看表数据量

```sql
SELECT
    'emotion_records' AS table_name,
    COUNT(*) AS record_count
FROM emotion_records
UNION ALL
SELECT
    'emotion_diaries' AS table_name,
    COUNT(*) AS record_count
FROM emotion_diaries;
```

### 查看表大小

```sql
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename IN ('emotion_records', 'emotion_diaries');
```

### 备份数据

```bash
pg_dump -h localhost -U postgres -d lingzhi_db \
  -t emotion_records -t emotion_diaries \
  -f emotion_backup_$(date +%Y%m%d).sql
```

---

## 七、联系方式

- **技术支持**: 待定
- **紧急联系**: 待定

---

## 八、部署检查清单

部署前:
- [ ] 已备份现有代码
- [ ] 已备份数据库
- [ ] 已准备回滚方案
- [ ] 已通知相关人员

部署后:
- [ ] 文件上传成功
- [ ] 数据库表创建成功
- [ ] 服务启动成功
- [ ] 测试脚本通过
- [ ] 功能验证通过

---

**文档版本**: v1.0
**创建日期**: 2025年1月15日
