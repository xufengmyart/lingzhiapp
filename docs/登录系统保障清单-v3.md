# 登录系统保障清单 v3.1
## 生产环境部署标准

> **核心原则**：部署指的是全面部署，生产环境是第一位的，必须保障畅通无阻，包含移动端、PC端和后台，通常采用增量方式部署

---

## 登录系统保障措施 (16项)

### 基础设施保障 (1-3)
- [ ] **1. Flask 后端运行**：确保 `python3 app.py` 在 8080 端口运行
  - 检查命令: `ps aux | grep "python3 app.py"`
  - 预期结果: 进程存在并正常运行

- [ ] **2. Nginx 服务运行**：确保 nginx 在 80 端口运行
  - 检查命令: `ps aux | grep nginx`
  - 预期结果: Nginx 进程存在并监听 80 端口

- [ ] **3. API 代理配置**：确保 `/api` → `localhost:8080` 代理正确
  - 检查命令: `cat /etc/nginx/sites-available/meiyueart.com | grep proxy_pass`
  - 预期结果: `proxy_pass http://127.0.0.1:8080`

### 数据与认证保障 (4-6)
- [ ] **4. 数据库连接**：确保 `lingzhi_ecosystem.db` 可访问
  - 检查命令: `python3 -c "import sqlite3; sqlite3.connect('lingzhi_ecosystem.db')"`
  - 预期结果: 无错误

- [ ] **5. 密码验证**：确保 bcrypt 密码验证正常
  - 检查命令: `python3 -c "import bcrypt"`
  - 预期结果: 无错误

- [ ] **6. Token 生成**：确保 JWT token 生成正常
  - 检查命令: `python3 -c "import jwt"`
  - 预期结果: 无错误

### 网络与缓存保障 (7-8)
- [ ] **7. CORS 配置**：确保跨域请求正常
  - 检查命令: `grep "Access-Control-Allow-Origin" /etc/nginx/sites-available/meiyueart.com`
  - 预期结果: 配置存在

- [ ] **8. 缓存策略**：确保 HTML 文件不被缓存
  - 检查命令: `grep "no-store, no-cache" /etc/nginx/sites-available/meiyueart.com`
  - 预期结果: 配置存在

### 版本与测试保障 (9-10)
- [ ] **9. 版本同步**：确保前端和后端版本一致
  - 检查命令: `cat /var/www/meiyueart-v2/version.json`
  - 预期结果: 版本号存在且正确

- [ ] **10. 测试账号**：确保至少一个测试账号可用
  - 检查命令: `python3 -c "import sqlite3; conn = sqlite3.connect('lingzhi_ecosystem.db'); cursor = conn.cursor(); cursor.execute('SELECT username FROM users'); print(cursor.fetchall())"`
  - 预期结果: admin 和其他用户存在

### 部署完整性保障 (11-15)
- [ ] **11. 前端文件完整性**：确保前端文件全部部署
  - 检查命令: `ls -la /var/www/meiyueart-v2/`
  - 预期结果: index.html, assets/, version.json 等文件存在

- [ ] **12. 强制刷新机制**：确保强制刷新页面可用
  - 检查命令: `ls /var/www/meiyueart-v2/force-reload.html`
  - 预期结果: 文件存在

- [ ] **13. 日志文件可写**：确保日志目录可写
  - 检查命令: `touch /tmp/test.log && rm /tmp/test.log`
  - 预期结果: 无错误

- [ ] **14. 端口监听状态**：确保端口正常监听
  - 检查命令: `netstat -tln | grep -E "80|8080"`
  - 预期结果: 80 和 8080 端口都在监听

- [ ] **15. 备份文件存在**：确保部署前已备份
  - 检查命令: `ls -la /workspace/projects/web-app/backups/`
  - 预期结果: 备份目录存在且有备份文件

### 生产环境核心保障 (16) ⭐
- [ ] **16. 部署完整性**：全面部署，生产环境优先，畅通无阻，全平台覆盖，增量方式部署
  - 检查原则:
    1. **全面部署**: 不遗漏任何环节，包括前端、后端、配置、备份
    2. **生产环境优先**: 以生产环境稳定性为最高优先级
    3. **畅通无阻**: 确保用户访问无障碍，登录功能正常
    4. **全平台覆盖**: 包含移动端、PC端和后台，确保所有平台都能正常访问
    5. **增量方式部署**: 采用增量方式部署，提高效率，降低风险
  - 验证方式: 完整执行标准部署脚本，所有检查项通过

---

## 部署检查流程

### 阶段 1: 环境检查
```bash
# 确认生产环境
# 确认系统环境 (Nginx, Python3, Flask)
# 确认服务状态
```

### 阶段 2: 功能测试
```bash
# 测试 Flask 后端直接访问
# 测试 Nginx 代理访问
# 测试用户数据库
```

### 阶段 3: 部署执行
```bash
# 备份当前部署
# 构建前端
# 部署到新目录
# 更新 Nginx 配置
# 重载 Nginx
```

### 阶段 4: 完整性检查
```bash
# 执行 16 项保障措施检查
# 逐项验证，必须全部通过
```

### 阶段 5: 最终验证
```bash
# 登录系统功能验证
# 确保生产环境畅通无阻
```

---

## 测试账号

| 用户名 | 密码 | 角色 | 状态 |
|--------|------|------|------|
| admin | admin123 | 管理员 | ✅ 可用 |
| 许锋 | 123456 | 用户 | ✅ 可用 |

---

## 常用命令

### 查看服务状态
```bash
# 查看 Flask 后端
ps aux | grep "python3 app.py"

# 查看 Nginx
ps aux | grep nginx

# 查看端口监听
netstat -tln | grep -E "80|8080"
```

### 重启服务
```bash
# 重启 Nginx
nginx -t && nginx -s reload

# 重启 Flask
pkill -f "python3 app.py"
cd /workspace/projects/admin-backend
nohup python3 app.py > /tmp/flask_backend.log 2>&1 &
```

### 查看日志
```bash
# Flask 后端日志
tail -f /tmp/flask_backend.log

# Nginx 访问日志
tail -f /var/log/nginx/access.log

# Nginx 错误日志
tail -f /var/log/nginx/error.log

# 部署日志
tail -f /var/log/meiyueart-deployment.log
```

### 测试 API
```bash
# 测试登录
curl -X POST http://localhost/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

---

## 故障排除

### 登录失败

1. **检查后端服务**
   ```bash
   ps aux | grep "python3 app.py"
   curl http://localhost:8080/api/health
   ```

2. **检查 Nginx 代理**
   ```bash
   nginx -t
   curl http://localhost/api/health
   ```

3. **检查数据库**
   ```bash
   cd /workspace/projects/admin-backend
   python3 -c "import sqlite3; conn = sqlite3.connect('lingzhi_ecosystem.db'); print(conn.execute('SELECT username FROM users').fetchall())"
   ```

4. **清除缓存**
   - 访问 `https://meiyueart.com/force-reload.html`
   - 或手动清除浏览器缓存

5. **检查日志**
   ```bash
   tail -f /tmp/flask_backend.log
   tail -f /var/log/nginx/error.log
   ```

### 部署失败

1. **检查备份**
   ```bash
   ls -la /workspace/projects/web-app/backups/
   ```

2. **回滚到备份**
   ```bash
   cp -r /workspace/projects/web-app/backups/deployment_backup_*/* /var/www/meiyueart-v2/
   ```

3. **检查构建日志**
   ```bash
   cat /tmp/frontend-build.log
   ```

---

## 部署脚本

使用标准部署脚本：
```bash
cd /workspace/projects/web-app
chmod +x deploy-standard-v3.sh
./deploy-standard-v3.sh
```

脚本特性：
- ✅ 完整的 16 项保障措施检查
- ✅ 自动备份机制
- ✅ 生产环境优先原则
- ✅ 全面部署保障
- ✅ 详细的部署日志
- ✅ 自动化验证

---

## 版本历史

- **v3.0** (2026-02-12)
  - 新增第 16 项保障措施：部署完整性
  - 强调生产环境优先原则
  - 强调全面部署和畅通无阻

- **v2.0** (2026-02-11)
  - 优化缓存策略
  - 新增强制刷新机制
  - 完善检查清单

- **v1.0** (2026-02-10)
  - 初始版本
  - 基础保障措施

---

## 维护建议

### 日常维护
1. 每日检查服务状态
2. 监控登录成功率
3. 查看错误日志
4. 定期更新测试账号

### 部署前检查
1. 执行完整备份
2. 运行测试套件
3. 确认所有保障措施
4. 准备回滚方案

### 部署后验证
1. 验证登录功能
2. 检查服务状态
3. 监控用户反馈
4. 记录部署日志

---

**记住**: 登录系统是用户访问的入口，必须确保生产环境稳定运行，畅通无阻！
