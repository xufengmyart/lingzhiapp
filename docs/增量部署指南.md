# 增量部署指南

## 概述

增量部署是指在已有部署的基础上，只部署发生变更的部分，而不是重新部署整个系统。这种方式可以提高部署效率，降低风险。

## 增量部署的优势

1. **高效**：只部署变更的部分，节省时间和带宽
2. **安全**：减少对系统的干扰，降低风险
3. **快速**：缩短部署时间，加快迭代速度
4. **可控**：可以精确控制部署的内容和范围

## 增量部署原则

### 1. 全平台覆盖
增量部署需要覆盖所有平台：
- **移动端**：响应式 Web、PWA、原生 App
- **PC端**：桌面浏览器、大屏幕适配
- **后台**：管理后台、API 服务、数据库

### 2. 版本控制
- 每次增量部署都需要版本号
- 版本号遵循语义化版本规范
- 记录每次部署的变更内容

### 3. 回滚机制
- 每次增量部署前需要备份
- 保留最近 N 个版本的备份
- 提供快速回滚机制

### 4. 灰度发布
- 新功能先在小范围内测试
- 逐步扩大发布范围
- 监控用户反馈和系统状态

## 增量部署流程

### 阶段 1：变更分析

```bash
# 1. 检查 Git 变更
git diff HEAD~1 --name-only

# 2. 分析影响范围
# - 前端变更（页面、样式、脚本）
# - 后端变更（API、数据库、业务逻辑）
# - 配置变更（环境变量、Nginx 配置）

# 3. 确定部署策略
# - 全量部署：重大变更或配置变更
# - 增量部署：小范围功能更新
```

### 阶段 2：备份当前部署

```bash
# 1. 创建备份目录
BACKUP_DIR="/workspace/projects/web-app/backups/deployment_$(date +%Y%m%d_%H%M%S)"
mkdir -p ${BACKUP_DIR}

# 2. 备份前端
cp -r /var/www/meiyueart-v2 ${BACKUP_DIR}/

# 3. 备份后端（如果需要）
# cp /workspace/projects/admin-backend/app.py ${BACKUP_DIR}/

# 4. 备份数据库（如果需要）
# cp /workspace/projects/admin-backend/lingzhi_ecosystem.db ${BACKUP_DIR}/

# 5. 备份 Nginx 配置
cp /etc/nginx/sites-available/meiyueart.com ${BACKUP_DIR}/
```

### 阶段 3：增量部署

#### 情况 1：仅前端变更

```bash
# 1. 构建前端
cd /workspace/projects/web-app
npm run build

# 2. 只部署变更的文件
cp -r dist/* /var/www/meiyueart-v2/

# 3. 更新版本号
echo '{"version":"$(date +%Y%m%d-%H%M)",...}' > /var/www/meiyueart-v2/version.json

# 4. 清除缓存
# 访问 /force-reload.html
```

#### 情况 2：仅后端变更

```bash
# 1. 更新后端代码
# git pull 或手动替换文件

# 2. 重启后端服务
pkill -f "python3 app.py"
nohup python3 app.py > /tmp/flask_backend.log 2>&1 &

# 3. 测试 API
curl http://localhost:8080/api/health
```

#### 情况 3：前后端都变更

```bash
# 按顺序执行情况 2 和情况 1
```

#### 情况 4：配置变更

```bash
# 1. 更新配置文件
# vim /etc/nginx/sites-available/meiyueart.com

# 2. 测试配置
nginx -t

# 3. 重载 Nginx
nginx -s reload
```

### 阶段 4：验证部署

```bash
# 1. 运行检查脚本
cd /workspace/projects/web-app
./check-deployment-v3.sh

# 2. 检查服务状态
ps aux | grep "python3 app.py"
ps aux | grep nginx

# 3. 测试 API
curl -X POST http://localhost/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 4. 访问前端
# 在浏览器中访问 https://meiyueart.com/
```

### 阶段 5：监控和记录

```bash
# 1. 记录部署日志
echo "$(date '+%Y-%m-%d %H:%M:%S') 增量部署完成" >> /var/log/meiyueart-deployment.log

# 2. 监控服务状态
tail -f /tmp/flask_backend.log
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 3. 监控用户反馈
# 查看用户反馈渠道
```

## 增量部署检查清单

### 部署前检查
- [ ] 分析变更范围
- [ ] 确定部署策略（全量/增量）
- [ ] 备份当前部署
- [ ] 准备回滚方案
- [ ] 通知相关人员

### 部署中检查
- [ ] 按照流程执行部署
- [ ] 实时监控部署日志
- [ ] 验证服务状态
- [ ] 测试核心功能

### 部署后检查
- [ ] 运行检查脚本
- [ ] 验证所有平台（移动端、PC端、后台）
- [ ] 监控系统性能
- [ ] 收集用户反馈
- [ ] 记录部署日志

## 回滚机制

### 快速回滚

```bash
# 1. 找到最近的备份
LATEST_BACKUP=$(ls -t /workspace/projects/web-app/backups/ | head -1)

# 2. 恢复备份
cp -r /workspace/projects/web-app/backups/${LATEST_BACKUP}/meiyueart-v2/* /var/www/meiyueart-v2/

# 3. 重启服务
nginx -s reload

# 4. 验证
curl http://localhost/api/health
```

### 选择性回滚

如果只是某个文件有问题，可以只回滚该文件：

```bash
# 回滚单个文件
cp /workspace/projects/web-app/backups/xxx/某个文件 /var/www/meiyueart-v2/

# 重启服务（如果需要）
nginx -s reload
```

## 最佳实践

### 1. 小步快跑
- 每次变更要小
- 频繁发布
- 快速反馈

### 2. 版本管理
- 使用 Git 管理代码
- 每次部署打标签
- 记录变更日志

### 3. 自动化
- 使用 CI/CD 工具
- 自动化测试
- 自动化部署

### 4. 监控告警
- 实时监控系统状态
- 设置告警阈值
- 快速响应问题

### 5. 文档记录
- 记录每次部署
- 记录问题和解决方案
- 持续改进流程

## 常见问题

### Q1: 增量部署失败怎么办？

A:
1. 查看部署日志
2. 检查服务状态
3. 尝试重新部署
4. 如果仍然失败，执行回滚

### Q2: 如何判断需要全量部署？

A: 以下情况需要全量部署：
- 重大功能变更
- 数据库结构变更
- Nginx 配置变更
- 依赖库版本变更

### Q3: 增量部署会影响用户吗？

A: 增量部署对用户的影响最小，但仍然可能有短暂的影响。建议在低峰期进行部署。

### Q4: 如何验证增量部署成功？

A:
1. 运行检查脚本
2. 测试核心功能
3. 检查日志
4. 监控系统状态

## 总结

增量部署是提高部署效率和降低风险的有效方法。在实际应用中，需要根据具体情况选择合适的部署策略，并建立完善的监控和回滚机制。

记住：
- ✅ 全平台覆盖（移动端、PC端、后台）
- ✅ 版本控制
- ✅ 备份机制
- ✅ 灰度发布
- ✅ 持续监控
