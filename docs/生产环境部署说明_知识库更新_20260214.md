# 生产环境部署说明 - 知识库更新与个人资料修复

## 部署概述
本次部署包含两个主要更新：
1. **知识库更新**：导入20个核心文档到知识库，总字符数164,892
2. **个人资料功能修复**：修复获取个人资料API的字段缺失问题

## 部署时间
- 创建时间：2026-02-14 21:57
- 预计耗时：10分钟

## 部署前准备

### 1. 备份数据库
在生产服务器上执行：
```bash
cd /var/www/meiyueart.com/admin-backend
cp lingzhi_ecosystem.db backups/lingzhi_ecosystem_db_backup_$(date +%Y%m%d_%H%M%S).db
```

### 2. 备份修改的文件
```bash
cp routes/user_system.py routes/user_system.py.backup_$(date +%Y%m%d_%H%M%S)
```

## 部署步骤

### 步骤1：上传修复后的 user_system.py
将本地文件上传到生产服务器：
```bash
# 本地执行
scp /workspace/projects/admin-backend/routes/user_system.py root@47.98.224.46:/var/www/meiyueart.com/admin-backend/routes/user_system.py
```

### 步骤2：添加 interests 字段到 users 表
在生产服务器上执行：
```bash
cd /var/www/meiyueart.com/admin-backend
sqlite3 lingzhi_ecosystem.db <<EOF
ALTER TABLE users ADD COLUMN interests TEXT DEFAULT '[]';
EOF
```

### 步骤3：重启后端服务
```bash
cd /var/www/meiyueart.com/admin-backend
pkill -f 'python app.py'
nohup python app.py > server.log 2>&1 &
```

### 步骤4：验证服务状态
```bash
# 检查进程
ps aux | grep 'python app.py' | grep -v grep

# 查看日志
tail -20 server.log
```

### 步骤5：测试 API
```bash
# 测试登录
curl -X POST http://localhost:8080/api/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"123456"}'

# 测试获取个人资料（需要先获取token）
TOKEN="<从登录响应中获取的token>"
curl -X GET http://localhost:8080/api/user/profile \
  -H "Authorization: Bearer $TOKEN"
```

## 验证清单

### 知识库更新验证
- [ ] 知识库ID为7
- [ ] 文档总数为30
- [ ] 总字符数为164,892
- [ ] 包含以下核心文档：
  - 灵值生态核心档案
  - 灵值生态园完整体系梳理（最终版）
  - 灵值生态园-生态闭环完整战略规划
  - 灵值生态园-完整生态闭环战略规划（最终融合版）
  - 陕西媄月商业艺术有限责任公司简介
  - 西安文化关键词库（110个）
  - 西安文化基因库
  - 灵值生态一体化服务总纲
  - 灵值智能体v9.0全面升级完成报告
  - 灵值智能体v9.0全面升级设计方案
  - 所有项目文档（10个）

### 个人资料功能验证
- [ ] 登录API正常
- [ ] 获取个人资料API正常
- [ ] 返回数据包含以下字段：
  - id
  - username
  - email
  - bio
  - location
  - website
  - interests
- [ ] 所有字段值正确

## 回滚方案

如果部署出现问题，执行以下回滚操作：

### 回滚 user_system.py
```bash
cd /var/www/meiyueart.com/admin-backend/routes
cp user_system.py.backup_<timestamp> user_system.py
```

### 回滚数据库
```bash
cd /var/www/meiyueart.com/admin-backend
cp backups/lingzhi_ecosystem_db_backup_<timestamp>.db lingzhi_ecosystem.db
```

### 重启服务
```bash
pkill -f 'python app.py'
nohup python app.py > server.log 2>&1 &
```

## 注意事项

1. **备份数据库**：部署前务必备份数据库
2. **服务重启**：重启服务会短暂中断，建议在低峰期执行
3. **字段添加**：ALTER TABLE 操作是幂等的，重复执行不会报错
4. **API测试**：部署完成后务必测试个人资料API

## 联系信息
如遇到问题，请联系技术支持。
