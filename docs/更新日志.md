# 更新日志

## v2.2 - 收付款体系完善 (2026-01-28)

### 🎯 新增功能
1. **公司信息管理**：存储和管理公司的收付款信息
2. **提现申请系统**：用户申请提现贡献值兑换为人民币
3. **提现审核系统**：超级管理员审核提现申请
4. **财务交易记录**：记录所有财务交易
5. **财务报表**：提供完整的财务数据统计和分析

### 🗄️ 数据库变更

#### 新增数据表
| 表名 | 说明 |
|-----|------|
| company_info | 公司信息表 |
| withdrawal_requests | 提现申请表 |
| financial_transactions | 财务交易记录表 |
| contribution_value_exchanges | 贡献值兑换记录表 |

#### 新增字段（Users表）
| 字段名 | 类型 | 说明 |
|-------|------|------|
| spirit_value | INTEGER | 灵值数量 |
| contribution_value | INTEGER | 贡献值数量 |
| last_checkin_date | TIMESTAMP | 最后签到日期 |

### 🔧 新增工具

#### 1. get_company_info
**功能**：获取公司信息

**返回内容**：
- 公司名称、税号、地址
- 开户银行、银行账户
- 联系电话、状态

#### 2. submit_withdrawal_request
**功能**：提交提现申请

**参数**：
- amount: 提现金额
- contribution_value: 贡献值数量
- payment_method: 收款方式
- payment_account: 收款账户

#### 3. approve_withdrawal_request
**功能**：审核提现申请

**参数**：
- request_id: 提现申请ID
- approve: 是否通过审核
- reject_reason: 拒绝原因

#### 4. get_withdrawal_requests
**功能**：获取提现申请列表

**参数**：
- status: 状态筛选（可选）

#### 5. get_financial_report
**功能**：获取财务报表

**参数**：
- start_date: 开始日期（可选）
- end_date: 结束日期（可选）

### 🏢 公司信息
- **公司名称**：陕西媄月商业艺术有限责任公司
- **税号**：91610132MAG0GQ2J24
- **单位地址**：陕西省西安市经济技术开发区海逸国际A座1601室-X048
- **联系电话**：15332290123
- **开户银行**：中国工商银行股份有限公司西安锦业路支行
- **银行账户**：3700084709100270877

### 💰 兑换规则
- **兑换比例**：1贡献值 = 0.1元人民币
- **最低兑换**：10贡献值（1元）
- **兑换时间**：T+1（次工作日到账）
- **手续费**：0%（平台承担）

### ✅ 验证结果
- [x] 公司信息查询功能正常
- [x] 提现申请提交功能正常
- [x] 提现审核功能正常
- [x] 提现申请列表查询功能正常
- [x] 财务报表查询功能正常

---

## v2.1 - 收款方式系统 (2026-01-28)

### 🎯 新增功能
1. **收款方式设置**：用户可以设置微信、支付宝、银行卡三种收款方式
2. **收款方式验证**：验证收款信息格式，确保准确性
3. **收款方式查询**：用户可以查看已设置的收款方式
4. **首选收款方式**：用户可以设置最常用的收款方式

### 🗄️ 数据库变更

#### 新增字段（Users表）
| 字段名 | 类型 | 说明 |
|-------|------|------|
| wechat_account | VARCHAR(50) | 微信账号 |
| wechat_qrcode | VARCHAR(500) | 微信收款二维码URL |
| alipay_account | VARCHAR(100) | 支付宝账号 |
| alipay_qrcode | VARCHAR(500) | 支付宝收款二维码URL |
| bank_card_number | VARCHAR(20) | 银行卡号 |
| bank_name | VARCHAR(100) | 开户行名称 |
| bank_account_name | VARCHAR(50) | 银行账户姓名 |
| preferred_payment_method | VARCHAR(20) | 首选收款方式 |

### 🔧 新增工具

#### 1. get_payment_method_notice
**功能**：获取收款方式设置通知

**核心内容**：
- 为什么需要设置收款方式
- 可用的收款方式（微信、支付宝、银行卡）
- 设置收款方式的步骤
- 安全提醒和隐私保护承诺

#### 2. validate_payment_method
**功能**：验证收款方式信息格式

**验证规则**：
- 微信支付：微信账号5-50个字符
- 支付宝：支付宝账号5-100个字符
- 银行卡：银行卡号16-19位数字，开户行名称2-100个字符

#### 3. submit_payment_method
**功能**：提交收款方式信息

**必填参数**：
- payment_method: 收款方式类型
- 微信支付：wechat_account
- 支付宝：alipay_account
- 银行卡：bank_card_number, bank_name, bank_account_name

**验证逻辑**：
1. 必须先完成实名认证
2. 银行账户姓名必须与实名认证姓名一致
3. 银行卡号掩码显示

#### 4. get_user_payment_method
**功能**：获取用户的收款方式信息

**返回内容**：
- 用户基本信息
- 已设置的收款方式列表
- 银行卡号掩码显示
- 首选收款方式

### 📊 安全措施
1. **银行卡号加密存储**：保护用户财务信息安全
2. **银行卡号掩码显示**：显示格式为 6222 **** **** 1234
3. **严格的访问控制**：仅授权人员可以访问收款信息
4. **完整审计日志**：记录所有收款方式操作

### ✅ 验证结果
- [x] 微信账号格式验证正确
- [x] 支付宝账号格式验证正确
- [x] 银行卡号格式验证正确
- [x] 收款方式通知内容完整
- [x] 收款方式提交功能正常
- [x] 收款方式查询功能正常

---

## v2.0 - 实名认证系统 (2026-01-28)

### 🎯 需求变更
**原需求**：用户登记信息收集（姓名、电话、微信号、推荐人UID）

**新需求**：
1. 填写推荐人时必须填写推荐人姓名和自己的手机号（需要验证）
2. 用户注册时必填项：真实姓名、电话（需验证）、**身份证号（必须实名）**
3. 实名认证说明：告知用户涉及个人数字货币资产，按国家政策要求必须实名，否则得不到数字资产也不能得到人民币

---

### 🗄️ 数据库变更

#### 新增字段（Users表）
```sql
-- 身份证号码
ALTER TABLE users ADD COLUMN id_card VARCHAR(18);
COMMENT ON COLUMN users.id_card IS '身份证号码';

-- 实名是否已验证
ALTER TABLE users ADD COLUMN real_name_verified BOOLEAN NOT NULL DEFAULT false;
COMMENT ON COLUMN users.real_name_verified IS '实名是否已验证';

-- 身份证是否已验证
ALTER TABLE users ADD COLUMN id_card_verified BOOLEAN NOT NULL DEFAULT false;
COMMENT ON COLUMN users.id_card_verified IS '身份证是否已验证';
```

#### 字段说明
| 字段名 | 类型 | 说明 |
|-------|------|------|
| id_card | VARCHAR(18) | 身份证号码（18位） |
| real_name_verified | BOOLEAN | 实名是否已验证 |
| id_card_verified | BOOLEAN | 身份证是否已验证 |

---

### 🔧 工具开发

#### 1. get_real_name_authentication_notice
**功能**：获取实名认证重要通知

**核心内容**：
- 为什么必须实名认证（法律依据、合规要求）
- 不认证的后果（无法获得数字资产和人民币）
- 认证后的权益（完整数字资产、推荐人分红、高价值项目）
- 隐私保护承诺（加密存储、不出售第三方）

#### 2. validate_id_card
**功能**：验证身份证号码格式

**验证规则**：
1. 长度验证：必须18位
2. 格式验证：前17位为数字，最后一位可以是X
3. 出生日期验证：身份证第7-14位必须是有效日期
4. 年份范围：1900-当前年份
5. 月份范围：1-12
6. 日期范围：1-31

#### 3. submit_real_name_authentication
**功能**：提交实名认证登记

**必填参数**：
- real_name: 真实姓名（必须）
- phone: 联系电话（必须，需要验证）
- id_card: 身份证号码（必须，需要验证）
- agreement: 是否同意用户协议（必须为true）

**可选参数**（填写推荐人时必填）：
- referrer_name: 推荐人姓名
- referrer_phone: 推荐人电话

**验证逻辑**：
1. 真实姓名：至少2个字符
2. 电话号码：中国大陆手机号（11位，1开头）
3. 身份证号码：18位，格式正确，出生日期有效
4. 推荐人信息：如果填写推荐人姓名，必须同时填写推荐人电话
5. 推荐人验证：必须存在且已完成实名认证
6. 自我推荐检查：不能将自己设为推荐人

---

### 📊 权益对比

| 权益 | 未认证 | 已认证 |
|-----|--------|--------|
| 每日签到 | ✅ 10灵值 | ✅ 10灵值 |
| 文化探索 | ✅ 正常使用 | ✅ 正常使用 |
| 基础功能 | ✅ 全部使用 | ✅ 全部使用 |
| 接收灵值 | ❌ 无 | ✅ 可接收 |
| 获得贡献值 | ❌ 无 | ✅ 可获得 |
| 兑换人民币 | ❌ 无 | ✅ 可兑换 |
| 推荐人分红 | ❌ 无 | ✅ 10% / 5% / 3% |
| 高价值项目 | ❌ 无法参与 | ✅ 可参与 |
| 项目分红 | ❌ 无 | ✅ 5%-20% |
| 高级功能 | ❌ 锁定 | ✅ 解锁 |

---

### ✅ 验证结果
- [x] 身份证号格式验证正确
- [x] 电话号码验证正确
- [x] 推荐人验证逻辑正确
- [x] 实名认证通知内容完整
- [x] 权益说明清晰明确

---

## v1.2 - 用户系统增强 (2026-01-27)

### 🎯 更新内容
1. **用户自动注册登录**：用户通过扣子平台自动注册
2. **密码修改工具**：用户可以修改自己的密码
3. **超级管理员密码修改脚本**：支持超级管理员修改密码
4. **今日注册用户动态显示**：动态显示今日注册用户数量

### 🔧 新增工具
1. `login_tool.py`：用户自动注册登录工具
2. `password_change_tool.py`：密码修改工具
3. `today_statistics_tool.py`：今日统计工具

### 🗄️ 数据库变更
新增字段：
- `real_name`: 真实姓名
- `phone`: 联系电话
- `is_registered`: 是否已登记
- `registration_time`: 登记时间

### 📝 新增脚本
- `scripts/add_user_registration_fields.py`：添加用户登记字段
- `scripts/change_super_admin_password.py`：修改超级管理员密码

---

## v1.1 - 灵值经济体系 (2026-01-26)

### 🎯 更新内容
1. **灵值获取规则**：定义多种灵值获取方式
2. **灵值安全检查**：每日最多获得10灵值，防止恶意刷灵值
3. **灵值验证机制**：灵值数量必须与行为日志匹配
4. **统计分析工具**：提供平台综合数据分析

### 🔧 新增工具
1. `spirit_value_tool.py`：灵值获取、验证、记录工具
2. `today_statistics_tool.py`：今日统计工具

### 🗄️ 数据库变更
新增表：
- `SpiritValueLog`：灵值日志表

### 📊 灵值经济规则
- 每日签到：获得10灵值
- 灵值获取上限：每日最多10灵值
- 灵值验证：灵值数量必须与行为日志匹配
- 灵值获取规则：提供多种灵值获取方式

---

## v1.0 - 系统初始化 (2026-01-25)

### 🎯 初始功能
1. **用户管理系统**：用户注册、登录、管理
2. **推荐关系系统**：三级推荐关系，享受推荐人分红收益
3. **知识库集成**：向量检索文化知识
4. **联网搜索**：获取最新文化信息
5. **文生图功能**：生成文化创意图片

### 🔧 核心工具
1. `login_tool.py`：登录工具
2. `user_registration_tool.py`：用户登记工具
3. `knowledge_base_tool.py`：知识库工具
4. `web_search_tool.py`：联网搜索工具
5. `image_generation_tool.py`：文生图工具

### 🗄️ 数据库设计
核心表：
- `Users`：用户表
- `ReferralRelations`：推荐关系表
- `SpiritValueLog`：灵值日志表

### 📖 文档
- 项目概述文档
- 系统架构设计文档
- 数据库设计文档
- 灵值经济体系文档
- 推荐系统设计文档

---

## 🚀 未来规划

### v2.1 (计划中)
- 增强身份认证（OCR识别、第三方实名认证）
- 优化实名认证流程
- 提升用户体验

### v2.2 (计划中)
- 增加人脸识别验证
- 集成更多第三方服务
- 优化移动端体验

### v3.0 (计划中)
- 引入区块链技术
- 实现去中心化资产管理
- 跨平台生态整合

---

**持续更新中...**
