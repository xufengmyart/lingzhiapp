# Coze平台工作流配置指南

> 本指南详细说明如何在Coze平台上配置"灵值生态园"智能体的核心工作流，重点详解【核心路由】工作流。

---

## 📋 目录

1. [工作流概览](#工作流概览)
2. [核心路由-用户意图分析与响应引导](#核心路由-用户意图分析与响应引导)
3. [双螺旋诊断](#双螺旋诊断)
4. [贡献值诠释](#贡献值诠释)
5. [工作流集成与测试](#工作流集成与测试)

---

## 工作流概览

"灵值生态园"智能体需要配置三个核心工作流，实现智能判断与自动融合：

| 工作流名称 | 触发条件 | 核心功能 | 输出 | 优先级 |
|-----------|---------|---------|------|--------|
| **核心路由** | 每次对话开始 | 分析用户意图，标记需求类型 | 标签：商业效率/文化深度/混合咨询 | 🔥 最高 |
| **双螺旋诊断** | 包含"如何"、"怎么"等咨询词 | 生成定制化建议 | 融合行动步骤+价值阐释 | ⭐ 高 |
| **贡献值诠释** | 涉及"贡献值"问题 | 计算数值+文化诠释 | 数字结果+文化解读 | ⭐ 高 |

---

## 核心路由-用户意图分析与响应引导

> **这是智能体的"大脑"，决定后续回复的策略与风格。**

### 1.1 工作流基础配置

#### 基础信息
- **工作流名称**：`核心路由 - 用户意图分析与响应引导`
- **描述**：分析用户输入的核心意图，标记为"商业效率"、"文化深度"或"混合咨询"，指导后续回复策略
- **触发方式**：
  - 建议设置为"对话开始"时自动触发
  - 或由关键词（如"咨询"、"帮助"）触发

#### 输入输出设计
- **输入变量**：`user_input`（String）- 用户的输入消息
- **输出变量**：`intent_type`（String）- 意图标签
- **输出值**：
  - `商业效率`：具体、事务性、求结果的问题
  - `文化深度`：抽象、求理解、探索性的问题
  - `混合咨询`：同时涉及两者，或意图模糊

---

### 1.2 节点配置详解

#### 节点1：开始节点（Start）
- **节点名称**：`input_start`
- **描述**：接收用户输入
- **变量配置**：
  ```json
  {
    "user_input": {
      "type": "string",
      "description": "用户的输入消息",
      "required": true
    }
  }
  ```

---

#### 节点2：LLM判断节点（核心）
- **节点名称**：`intent_classification`
- **节点类型**：LLM节点
- **模型选择**：`doubao-seed-1-6-251015`
- **温度设置**：`0.3`（降低随机性，确保分类稳定）

**系统提示词（System Prompt）**：
```
你是"灵值生态园"的意图分类器，负责分析用户输入的核心意图倾向。

请严格根据用户的最新问题，判断其核心意图倾向，只输出一个分类标签。

可选的分类标签为：

1. `商业效率`：问题明确关于"如何操作"、"规则是什么"、"多少钱/多少贡献值"、"有什么资源"、"怎么入驻/兑换"等具体、事务性、求结果的问题。

   关键词示例：
   - 怎么、如何、多少、操作、步骤
   - 规则、流程、SOP
   - 贡献值、积分、兑换
   - 资源、入驻、匹配
   - 金钱、价格、费用

2. `文化深度`：问题明确关于"有什么意义"、"什么感觉"、"文化内涵是什么"、"精神是什么"、"如何提升体验/美感"等抽象、求理解、探索性的问题。

   关键词示例：
   - 意义、感觉、氛围、精神
   - 文化内涵、美学、体验
   - 如何提升、怎么更有
   - 情感、共鸣、价值

3. `混合咨询`：问题同时涉及以上两者，或意图模糊，例如"怎么开一家有唐风的茶馆？"（既问操作，又问文化）。

   关键词示例：
   - 如何+文化
   - 怎么+美学
   - 同时包含具体操作与文化探索

判断原则：
- 如果问题包含明确的操作步骤或规则查询，优先判断为"商业效率"
- 如果问题主要探索意义、感觉、文化内涵，判断为"文化深度"
- 如果问题同时涉及两者，或无法明确区分，判断为"混合咨询"

输出格式（仅输出标签）：
[标签名称]

示例：
输入："贡献值怎么计算？"
输出：商业效率

输入："茶馆的唐风设计有什么意义？"
输出：文化深度

输入："怎么开一家有唐风的茶馆？"
输出：混合咨询
```

**用户输入（User Input）**：
```
用户问题：「{{user_input}}」
```

**输出配置**：
- **输出变量**：`classification_result`
- **输出类型**：String

---

#### 节点3：分支判断节点（Condition）
- **节点名称**：`intent_branch`
- **节点类型**：条件节点
- **分支配置**：

| 分支名称 | 条件表达式 | 对应意图 |
|---------|-----------|---------|
| `branch_business` | `classification_result == "商业效率"` | 商业效率 |
| `branch_culture` | `classification_result == "文化深度"` | 文化深度 |
| `branch_mixed` | `classification_result == "混合咨询"` | 混合咨询 |
| `branch_default` | `else` | 默认（混合咨询）|

---

#### 节点4A：商业效率分支（变量赋值）
- **节点名称**：`set_business_intent`
- **节点类型**：代码节点或变量赋值节点
- **代码**：
```python
# 设置意图类型为商业效率
intent_type = "商业效率"
# 设置回复策略侧重
reply_strategy = "侧重清晰、结构化地引用《总纲》第二部分（规则与数据引擎）"
# 设置知识库检索优先级
kb_priority = "规则与数据 > 生态全景"
```

---

#### 节点4B：文化深度分支（变量赋值）
- **节点名称**：`set_culture_intent`
- **节点类型**：代码节点或变量赋值节点
- **代码**：
```python
# 设置意图类型为文化深度
intent_type = "文化深度"
# 设置回复策略侧重
reply_strategy = "侧重用比喻和故事阐释《总纲》第一部分（生态全景与核心心法）"
# 设置知识库检索优先级
kb_priority = "生态全景 > 规则与数据"
```

---

#### 节点4C：混合咨询分支（变量赋值）
- **节点名称**：`set_mixed_intent`
- **节点类型**：代码节点或变量赋值节点
- **代码**：
```python
# 设置意图类型为混合咨询
intent_type = "混合咨询"
# 设置回复策略侧重
reply_strategy = "必须融合两部分，并尝试启动'双螺旋诊断'式提问"
# 设置知识库检索优先级
kb_priority = "全库检索，优先案例库"
```

---

#### 节点5：输出节点（End）
- **节点名称**：`output_result`
- **输出变量**：
  ```json
  {
    "intent_type": "用户意图类型（商业效率/文化深度/混合咨询）",
    "reply_strategy": "回复策略建议",
    "kb_priority": "知识库检索优先级",
    "classification_result": "原始分类结果"
  }
  ```

---

### 1.3 工作流完整流程图

```
用户输入 → 开始节点 → LLM判断节点 → 分支判断节点
                                          ↓
                    ┌─────────────────────┼─────────────────────┐
                    ↓                     ↓                     ↓
              商业效率分支           文化深度分支           混合咨询分支
                    ↓                     ↓                     ↓
              设置变量赋值           设置变量赋值           设置变量赋值
                    ↓                     ↓                     ↓
                    └─────────────────────┼─────────────────────┘
                                          ↓
                                    输出结果节点
```

---

### 1.4 在主Bot中集成核心路由

#### 集成方式1：每次对话自动调用
在Bot的编排页面，添加"工作流"节点，配置为"对话开始"时自动触发：
1. 添加工作流节点，选择"核心路由 - 用户意图分析与响应引导"
2. 将用户输入连接到工作流的`user_input`变量
3. 将工作流的`intent_type`输出连接到后续的LLM节点

#### 集成方式2：通过系统提示词引用
在Bot的"人设与回复逻辑"中，加入以下指令：

```
# 核心路由集成
在生成回复前，请参考本次对话中已分析出的用户意图倾向（{{intent_type}}）。

回复策略：
- 若倾向为'商业效率'，则侧重清晰、结构化地引用《总纲》第二部分（规则与数据引擎）
- 若倾向为'文化深度'，则侧重用比喻和故事阐释《总纲》第一部分（生态全景与核心心法）
- 若倾向为'混合咨询'，则必须融合两部分，并尝试启动'双螺旋诊断'式提问

知识库检索：
- 优先检索《灵值生态一体化服务总纲》
- 根据{{kb_priority}}调整检索顺序
```

---

### 1.5 测试用例

#### 测试用例1：商业效率
**输入**："贡献值是怎么计算的？"
**预期输出**：
```json
{
  "intent_type": "商业效率",
  "reply_strategy": "侧重清晰、结构化地引用《总纲》第二部分（规则与数据引擎）",
  "kb_priority": "规则与数据 > 生态全景"
}
```

#### 测试用例2：文化深度
**输入**："茶馆的唐风设计有什么意义？"
**预期输出**：
```json
{
  "intent_type": "文化深度",
  "reply_strategy": "侧重用比喻和故事阐释《总纲》第一部分（生态全景与核心心法）",
  "kb_priority": "生态全景 > 规则与数据"
}
```

#### 测试用例3：混合咨询
**输入**："怎么开一家有唐风的茶馆？"
**预期输出**：
```json
{
  "intent_type": "混合咨询",
  "reply_strategy": "必须融合两部分，并尝试启动'双螺旋诊断'式提问",
  "kb_priority": "全库检索，优先案例库"
}
```

---

## 双螺旋诊断

### 2.1 工作流配置
- **工作流名称**：`双螺旋诊断 - 定制化建议生成`
- **触发条件**：
  - 用户问题包含"如何"、"怎么"、"建议"、"规划"等咨询性词汇
  - 或由核心路由标记为"混合咨询"时触发

### 2.2 核心功能
生成融合"行动步骤"与"价值阐释"的定制化建议，实现70%实务方案+30%意义阐述的比例。

### 2.3 关键节点
1. **诊断问题生成节点**：判断是否需要诊断
2. **定制化建议生成节点**：生成融合建议
3. **价值升华节点**：与"三层架构"和"双螺旋飞轮"关联

---

## 贡献值诠释

### 3.1 工作流配置
- **工作流名称**：`贡献值诠释 - 数值与文化意义融合`
- **触发条件**：
  - 用户问题涉及"贡献值"、"积分"、"多少点"等

### 3.2 核心功能
将贡献值数字转化为文化意义，实现：
1. 精确的数值计算
2. 深度的文化诠释（"数字时代的功德簿"）

### 3.3 关键节点
1. **贡献值计算节点**：基于《总纲》第二部分规则计算
2. **文化意义生成节点**：生成文化隐喻
3. **融合输出节点**：数值+意义融合输出

---

## 工作流集成与测试

### 4.1 在Coze平台创建工作流

#### 步骤1：创建核心路由工作流
1. 登录Coze平台，进入"工作流"模块
2. 点击"创建工作流"
3. 按照上述配置创建"核心路由 - 用户意图分析与响应引导"
4. 发布工作流

#### 步骤2：创建其他工作流
按照相同步骤创建：
- 双螺旋诊断工作流
- 贡献值诠释工作流

### 4.2 在智能体中集成工作流

#### 步骤1：添加工作流节点
1. 进入"灵值生态园"智能体的编排页面
2. 添加"工作流"节点，选择对应的工作流
3. 配置输入输出映射

#### 步骤2：设置触发规则
- **核心路由**：设为"开始节点"（每次对话自动触发）
- **双螺旋诊断**：通过关键词"如何、怎么"触发
- **贡献值诠释**：通过关键词"贡献值、积分"触发

### 4.3 测试验证

#### 完整对话测试流程
```
用户：你好
→ 核心路由触发，标记为"混合咨询"
→ 智能体返回开场白

用户：贡献值怎么计算？
→ 核心路由触发，标记为"商业效率"
→ 贡献值诠释工作流触发
→ 智能体返回计算结果+文化意义

用户：茶馆的唐风有什么意义？
→ 核心路由触发，标记为"文化深度"
→ 智能体返回文化解读

用户：怎么开一家有唐风的茶馆？
→ 核心路由触发，标记为"混合咨询"
→ 双螺旋诊断工作流触发
→ 智能体返回融合建议
```

---

## 附录：常见问题

**Q1：核心路由的准确率如何提升？**
A：
1. 优化LLM提示词，增加更多关键词示例
2. 调整模型温度（建议0.3-0.5）
3. 添加用户反馈机制，持续优化

**Q2：工作流调用失败怎么办？**
A：
1. 检查工作流是否已发布
2. 检查输入输出变量是否匹配
3. 查看工作流日志定位问题

**Q3：如何平衡三种意图的回复？**
A：
- 商业效率：70%实务+30%意义
- 文化深度：30%实务+70%意义
- 混合咨询：50%实务+50%意义

---

**文档版本**：v3.0
**最后更新**：2024-12
**维护者**：灵值生态团队
