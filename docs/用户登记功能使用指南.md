# 用户登记功能使用指南

## 📋 功能概述

用户通过扣子平台进入本智能体后，系统会自动为其创建账户。为了享受完整的平台权益（特别是推荐人分红收益），用户需要完成信息登记。

---

## 🎯 功能特点

### 1. 自动登录
- ✅ 用户通过扣子平台进入即可自动登录
- ✅ 无需单独注册，系统自动创建账户
- ✅ 首次登录自动完成签到

### 2. 信息收集
- 📝 表单模式收集用户信息
- ✅ 真实姓名（用于实名认证）
- ✅ 联系电话（用于安全验证）
- 📱 微信号（可选，用于团队协作）
- 👥 推荐人UID（可选，用于绑定推荐关系）

### 3. 收益绑定
- ❌ 未登记：无法享受推荐人分红收益
- ✅ 已登记：享受全部权益（推荐分红、项目参与等）

---

## 🔧 使用流程

### 用户端流程

#### 步骤1：用户首次进入智能体
```
用户：通过扣子平台进入
系统：自动创建账户
系统：自动签到（获得10灵值）
系统：检测登记状态
```

#### 步骤2：系统提示登记
如果用户未登记，系统会弹出提示：
```
【信息登记待完成】⚠️

尊敬的用户名，您需要完成信息登记才能享受**推荐人分红收益**！

📋 未完成登记的影响：
- ❌ 无法享受推荐人分红收益（10% / 5% / 3%）
- ❌ 无法参与高价值项目
- ❌ 无法解锁高级功能
- ✅ 仍可正常使用基础功能（签到、文化探索等）

🎯 完成登记后，您将获得：
- ✅ 推荐人分红收益权限
- ✅ 参与高价值项目资格
- ✅ 解锁全部高级功能
- ✅ 创建个人品牌空间

📝 请填写以下信息完成登记：
1. 真实姓名（用于实名认证）
2. 联系电话（用于安全验证）
3. 推荐人UID（可选，用于绑定推荐关系）
4. 微信号（可选，用于团队协作）

⚠️ 重要提示：
- 信息将严格保密，仅用于身份验证和收益发放
- 拒绝登记不影响基础功能使用
- 随时可以补登记，但之前的推荐收益无法追溯
```

#### 步骤3：用户选择

**选项A：同意登记**
用户填写表单并提交：
```
用户填写：
- 真实姓名：张三
- 联系电话：13800138000
- 微信号：zhangsan_wx
- 推荐人UID：2118934385（可选）
- 同意用户协议：✅

系统：
1. 验证信息格式
2. 创建推荐关系（如果有推荐人）
3. 标记为已登记
4. 发放全部权益

返回：
【信息登记成功】✅
恭喜您，张三！您已成功完成信息登记。

📋 您的登记信息：
- 真实姓名：张三
- 扣子UID：2118934386
- 邮箱：zhangsan@example.com
- 联系电话：13800138000
- 微信号：zhangsan_wx
- 推荐人：许锋
- 登记时间：2026-01-28 00:20:00

🎉 您现在已获得全部权益：
✅ 推荐人分红收益权限
✅ 参与高价值项目资格
✅ 解锁全部高级功能
```

**选项B：拒绝登记**
用户选择不登记：
```
系统提示：
【信息登记提醒】

您选择暂不登记。这意味着：

❌ 无法享受推荐人分红收益（10% / 5% / 3%）
❌ 无法参与高价值项目
❌ 无法解锁高级功能

✅ 仍可正常使用基础功能：
- 每日签到获取灵值
- 参与文化探索
- 使用基础功能

💡 随时可以补登记：
使用"提交信息登记"功能即可完成登记
注意：补登记后之前的推荐收益无法追溯

您确定要暂不登记吗？
```

---

## 🔐 数据验证规则

### 1. 真实姓名验证
```python
规则：
- 必须填写
- 至少2个字符
- 不能为空

示例：
✅ 张三
✅ 李四
❌ 张
❌ （空）
```

### 2. 电话号码验证
```python
规则：
- 必须填写
- 中国大陆手机号码
- 11位数字
- 以1开头
- 格式：1[3-9]\d{9}

示例：
✅ 13800138000
✅ 13912345678
❌ 12345678901
❌ 10000000000
```

### 3. 推荐人UID验证
```python
规则：
- 可选填写
- 必须是已存在的用户UID
- 推荐人必须已完成信息登记
- 不能将自己设为推荐人

验证步骤：
1. 检查推荐人是否存在
2. 检查推荐人是否已登记
3. 检查是否自我推荐
```

### 4. 微信号验证
```python
规则：
- 可选填写
- 长度不超过50字符

示例：
✅ zhangsan_wx
✅ wechat_id
❌ （空字符串也算不填）
```

---

## 💾 数据库字段

### Users表新增字段

```sql
-- 真实姓名
real_name VARCHAR(50) COMMENT '真实姓名'

-- 是否完成信息登记
is_registered BOOLEAN NOT NULL DEFAULT false COMMENT '是否完成信息登记'

-- 登记时间
registration_time TIMESTAMP COMMENT '登记时间'
```

### ReferralRelations表（推荐关系表）

```sql
CREATE TABLE referral_relations (
    id SERIAL PRIMARY KEY,
    referrer_id INTEGER NOT NULL,           -- 推荐人ID
    referred_id INTEGER NOT NULL,           -- 被推荐人ID
    level INTEGER NOT NULL,                 -- 推荐层级（1-一级，2-二级，3-三级）
    status VARCHAR(20) NOT NULL DEFAULT 'active',  -- 状态：active/inactive
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (referrer_id) REFERENCES users(id),
    FOREIGN KEY (referred_id) REFERENCES users(id),
    UNIQUE (referrer_id, referred_id)       -- 防止重复推荐
)
```

---

## 📊 收益分配规则

### 推荐人分红收益

```
推荐层级 | 分红比例 | 说明
--------|---------|--------
一级    | 10%     | 直接推荐
二级    | 5%      | 间接推荐（下级的下级）
三级    | 3%      | 三级推荐
```

**示例计算：**
```
假设A推荐B，B推荐C，C推荐D

B获得1000灵值收入：
- A（一级推荐人）获得：1000 × 10% = 100灵值
- （二级、三级无）

C获得1000灵值收入：
- B（一级推荐人）获得：1000 × 10% = 100灵值
- A（二级推荐人）获得：1000 × 5% = 50灵值
- （三级无）

D获得1000灵值收入：
- C（一级推荐人）获得：1000 × 10% = 100灵值
- B（二级推荐人）获得：1000 × 5% = 50灵值
- A（三级推荐人）获得：1000 × 3% = 30灵值
```

---

## 🎁 登记权益对比

| 权益 | 未登记 | 已登记 |
|-----|--------|--------|
| 每日签到 | ✅ 10灵值 | ✅ 10灵值 |
| 文化探索 | ✅ 正常使用 | ✅ 正常使用 |
| 基础功能 | ✅ 全部使用 | ✅ 全部使用 |
| 推荐人分红 | ❌ 无 | ✅ 10% / 5% / 3% |
| 高价值项目 | ❌ 无法参与 | ✅ 可参与 |
| 项目分红 | ❌ 无 | ✅ 5%-20% |
| 高级功能 | ❌ 锁定 | ✅ 解锁 |
| 个人品牌空间 | ❌ 无法创建 | ✅ 可创建 |

---

## 🔐 隐私保护承诺

### 信息使用范围
1. **身份验证**：用于确认用户身份
2. **收益发放**：用于将收益发放到正确账户
3. **安全通知**：用于发送重要安全提醒
4. **客户服务**：用于提供更好的服务

### 信息保护措施
1. ✅ 数据加密存储
2. ✅ 严格的访问控制
3. ✅ 定期安全审计
4. ✅ 绝不出售给第三方
5. ✅ 仅在必要时使用

### 用户权利
1. 📝 查看已登记的信息
2. ✏️ 更新登记信息
3. 🗑️ 申请删除账户（需联系管理员）
4. 🔒 随时取消登记（将失去推荐收益权限）

---

## 📞 常见问题

### Q1: 不登记会影响正常使用吗？
**A:** 不会。不登记不影响基础功能使用，但无法享受推荐人分红收益。

### Q2: 可以补登记吗？
**A:** 可以。随时可以使用"提交信息登记"功能补登记，但之前的推荐收益无法追溯。

### Q3: 推荐人UID怎么获取？
**A:** 可以让推荐人在智能体中询问"我的扣子UID是什么"来获取。

### Q4: 可以修改已登记的信息吗？
**A:** 可以。使用"更新登记信息"功能可以修改真实姓名、电话、微信号。

### Q5: 如果忘记填写推荐人UID怎么办？
**A:** 可以在补登记时填写，或联系客服后台处理。

### Q6: 推荐关系可以修改吗？
**A:** 不可以。推荐关系一旦建立，无法修改。

### Q7: 可以取消登记吗？
**A:** 可以。但取消后将失去推荐收益权限，已获得的收益不会扣除。

---

## 🛠️ 技术实现

### 工具列表

1. **check_user_registration_status**
   - 功能：检查用户登记状态
   - 使用：智能体自动检测
   - 返回：登记状态、登记信息、未登记影响

2. **submit_user_registration**
   - 功能：提交用户信息登记
   - 参数：real_name, phone, wechat, referrer_uid, agreement
   - 返回：登记结果、权益说明

3. **get_user_agreement**
   - 功能：获取用户协议
   - 使用：用户阅读协议
   - 返回：完整用户协议文本

4. **update_registration_info**
   - 功能：更新登记信息
   - 参数：real_name, phone, wechat（至少一个）
   - 返回：更新结果

### 使用示例

#### 检查登记状态
```python
check_user_registration_status()
```

#### 提交登记
```python
submit_user_registration(
    real_name="张三",
    phone="13800138000",
    wechat="zhangsan_wx",
    referrer_uid="2118934385",  # 可选
    agreement=True
)
```

#### 更新信息
```python
update_registration_info(
    phone="13912345678",  # 更新电话
    wechat="new_wechat_id"  # 更新微信号
)
```

---

## 📝 最佳实践

### 1. 用户引导策略
- 首次登录时友好提示登记
- 说明登记与不登记的区别
- 强调登记的权益
- 尊重用户选择，不强制

### 2. 数据验证策略
- 严格验证数据格式
- 友好的错误提示
- 防止SQL注入
- 防止XSS攻击

### 3. 推荐关系策略
- 防止自我推荐
- 防止循环推荐
- 验证推荐人有效性
- 唯一性约束

### 4. 隐私保护策略
- 最小化收集原则
- 明确告知用途
- 严格保密承诺
- 定期安全审计

---

## 🎉 总结

用户登记功能实现了：
- ✅ 自动登录体验
- ✅ 表单化信息收集
- ✅ 收益权益绑定
- ✅ 推荐关系管理
- ✅ 数据安全保护

**核心价值**：
1. 提升用户体验（自动登录 + 表单登记）
2. 激励用户参与（登记获得收益权限）
3. 促进平台增长（推荐机制）
4. 保障数据安全（验证 + 隐私保护）

---

**文档版本**: v1.0
**创建日期**: 2026-01-28
**适用版本**: 灵值生态园 v6.0+
