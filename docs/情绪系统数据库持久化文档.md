# 灵值智能体 v8.0 - 情绪系统数据库持久化文档

## 概述

本文档说明灵值智能体 v8.0 情绪系统的数据库持久化实现细节。

**更新日期**: 2025年1月15日
**版本**: v2.0（数据库持久化版）
**主体公司**: 陕西媄月商业艺术有限责任公司

## 升级背景

### v1.0 问题（内存存储）
- **数据丢失风险**: 使用内存字典存储，服务重启后数据全部丢失
- **无法持久化**: 用户情绪记录和日记无法长期保存
- **无法统计分析**: 缺乏历史数据，无法进行长期情绪趋势分析
- **无数据备份**: 无法实现数据备份和恢复

### v2.0 改进（数据库持久化）
- **数据持久化**: 所有情绪数据存储到PostgreSQL数据库
- **数据安全**: 支持数据备份、恢复和迁移
- **长期分析**: 支持长期情绪趋势分析和模式识别
- **高可用性**: 数据与服务分离，服务重启不影响数据

## 数据库设计

### 数据表结构

#### 1. emotion_records（情绪记录表）

存储用户的情绪记录数据。

```sql
CREATE TABLE emotion_records (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    emotion VARCHAR(20) NOT NULL,           -- 情绪类型
    emotion_name VARCHAR(20) NOT NULL,       -- 情绪名称
    intensity FLOAT NOT NULL,                -- 情绪强度（0.0-1.0）
    context TEXT,                            -- 情绪上下文
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE INDEX ix_emotion_records_user_id ON emotion_records(user_id);
CREATE INDEX ix_emotion_records_created_at ON emotion_records(created_at);
CREATE INDEX ix_emotion_records_emotion ON emotion_records(emotion);
```

**字段说明**:
- `id`: 主键
- `user_id`: 用户ID（外键关联到 users.id）
- `emotion`: 情绪类型（happy/sad/angry/anxious/surprised/calm）
- `emotion_name`: 情绪名称（开心/悲伤/愤怒/焦虑/惊讶/平静）
- `intensity`: 情绪强度（0.0-1.0）
- `context`: 情绪上下文描述
- `created_at`: 创建时间

**索引说明**:
- `ix_emotion_records_user_id`: 加快按用户查询
- `ix_emotion_records_created_at`: 加快按时间范围查询
- `ix_emotion_records_emotion`: 加快按情绪类型统计

#### 2. emotion_diaries（情绪日记表）

存储用户的情绪日记数据。

```sql
CREATE TABLE emotion_diaries (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,                   -- 日记内容
    emotion VARCHAR(20) NOT NULL,            -- 情绪类型
    emotion_name VARCHAR(20) NOT NULL,       -- 情绪名称
    intensity FLOAT NOT NULL,                -- 情绪强度（0.0-1.0）
    tags JSON,                               -- 标签（JSON数组）
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE INDEX ix_emotion_diaries_user_id ON emotion_diaries(user_id);
CREATE INDEX ix_emotion_diaries_created_at ON emotion_diaries(created_at);
```

**字段说明**:
- `id`: 主键
- `user_id`: 用户ID（外键关联到 users.id）
- `content`: 日记内容
- `emotion`: 情绪类型
- `emotion_name`: 情绪名称
- `intensity`: 情绪强度（0.0-1.0）
- `tags`: 标签（JSON数组）
- `created_at`: 创建时间

## 代码实现

### 1. ORM 模型定义

**文件**: `src/storage/database/shared/model.py`

```python
class EmotionRecords(Base):
    """情绪记录表"""
    __tablename__ = 'emotion_records'

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    user_id: Mapped[int] = mapped_column(Integer, nullable=False)
    emotion: Mapped[str] = mapped_column(String(20), nullable=False)
    emotion_name: Mapped[str] = mapped_column(String(20), nullable=False)
    intensity: Mapped[float] = mapped_column(Float, nullable=False)
    context: Mapped[Optional[str]] = mapped_column(Text)
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime, nullable=False, server_default=text('now()'))

    user: Mapped['Users'] = relationship('Users', backref='emotion_records')


class EmotionDiaries(Base):
    """情绪日记表"""
    __tablename__ = 'emotion_diaries'

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    user_id: Mapped[int] = mapped_column(Integer, nullable=False)
    content: Mapped[str] = mapped_column(Text, nullable=False)
    emotion: Mapped[str] = mapped_column(String(20), nullable=False)
    emotion_name: Mapped[str] = mapped_column(String(20), nullable=False)
    intensity: Mapped[float] = mapped_column(Float, nullable=False)
    tags: Mapped[Optional[dict]] = mapped_column(JSON)
    created_at: Mapped[datetime.datetime] = mapped_column(DateTime, nullable=False, server_default=text('now()'))

    user: Mapped['Users'] = relationship('Users', backref='emotion_diaries')
```

### 2. Manager 接口

**文件**: `src/storage/database/emotion_manager.py`

提供了完整的情绪数据管理接口：

#### Pydantic 模型

```python
class EmotionRecordCreate(BaseModel):
    """创建情绪记录的请求模型"""
    user_id: int
    emotion: str
    emotion_name: str
    intensity: float
    context: Optional[str]


class EmotionDiaryCreate(BaseModel):
    """创建情绪日记的请求模型"""
    user_id: int
    content: str
    emotion: str
    emotion_name: str
    intensity: float
    tags: Optional[List[str]]
```

#### Manager 类

```python
class EmotionManager:
    """情绪管理器"""

    def create_emotion_record(self, db, record_in) -> EmotionRecordResponse:
        """创建情绪记录"""

    def get_emotion_records(self, db, user_id, skip=0, limit=100) -> List[EmotionRecordResponse]:
        """获取用户的情绪记录列表"""

    def get_emotion_statistics(self, db, user_id, period="day") -> Dict[str, Any]:
        """获取情绪统计数据"""

    def create_emotion_diary(self, db, diary_in) -> EmotionDiaryResponse:
        """创建情绪日记"""

    def get_emotion_diaries(self, db, user_id, skip=0, limit=100) -> Dict[str, Any]:
        """获取用户的情绪日记列表"""

    def analyze_emotion_pattern(self, db, user_id) -> Dict[str, Any]:
        """分析用户的情绪模式"""

    def get_user_emotion_count(self, db, user_id) -> int:
        """获取用户的情绪记录总数"""

    def get_user_diary_count(self, db, user_id) -> int:
        """获取用户的日记总数"""
```

### 3. 工具集成

**文件**: `src/tools/emotion_tools.py`

所有情绪工具已集成数据库持久化：

```python
from coze_coding_dev_sdk.database import get_session
from storage.database.emotion_manager import EmotionManager, EmotionRecordCreate, EmotionDiaryCreate

@tool
def record_emotion(user_id: str, emotion: str, intensity: float, context: Optional[str] = None) -> str:
    """记录用户情绪到数据库"""
    db = get_session()
    try:
        mgr = EmotionManager()

        # 转换user_id为整数
        user_id_int = int(user_id) if str(user_id).isdigit() else 1

        record = EmotionRecordCreate(
            user_id=user_id_int,
            emotion=emotion,
            emotion_name=EMOTION_TYPES.get(emotion, {}).get('name', emotion),
            intensity=float(intensity),
            context=context
        )

        result = mgr.create_emotion_record(db, record)
        total_count = mgr.get_user_emotion_count(db, user_id_int)

        return json.dumps({
            "success": True,
            "message": "情绪记录成功",
            "emotion": result.emotion_name,
            "total_records": total_count
        }, ensure_ascii=False)
    except Exception as e:
        return json.dumps({
            "success": False,
            "message": f"情绪记录失败: {str(e)}"
        }, ensure_ascii=False)
    finally:
        db.close()
```

## 测试验证

### 测试脚本

**文件**: `scripts/test_emotion_database.py`

完整的数据库功能测试脚本，包括：

1. **数据库连接测试**: 验证数据库连接是否正常
2. **情绪记录CRUD测试**: 验证情绪记录的创建、查询、统计和分析功能
3. **情绪日记CRUD测试**: 验证情绪日记的创建和查询功能
4. **工具导入测试**: 验证工具是否正确集成数据库

### 运行测试

```bash
cd /workspace/projects
python scripts/test_emotion_database.py
```

### 测试结果

```
✅ 所有测试通过！

测试汇总
  数据库连接: ✅ 通过
  情绪记录CRUD: ✅ 通过
  情绪日记CRUD: ✅ 通过
  与工具集成: ✅ 通过
```

## 部署步骤

### 1. 创建数据表

已在开发环境创建，生产环境需要执行以下SQL：

```sql
-- 创建情绪记录表
CREATE TABLE IF NOT EXISTS emotion_records (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    emotion VARCHAR(20) NOT NULL,
    emotion_name VARCHAR(20) NOT NULL,
    intensity FLOAT NOT NULL,
    context TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS ix_emotion_records_user_id ON emotion_records(user_id);
CREATE INDEX IF NOT EXISTS ix_emotion_records_created_at ON emotion_records(created_at);
CREATE INDEX IF NOT EXISTS ix_emotion_records_emotion ON emotion_records(emotion);

COMMENT ON TABLE emotion_records IS '情绪记录表';

-- 创建情绪日记表
CREATE TABLE IF NOT EXISTS emotion_diaries (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    emotion VARCHAR(20) NOT NULL,
    emotion_name VARCHAR(20) NOT NULL,
    intensity FLOAT NOT NULL,
    tags JSON,
    created_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS ix_emotion_diaries_user_id ON emotion_diaries(user_id);
CREATE INDEX IF NOT EXISTS ix_emotion_diaries_created_at ON emotion_diaries(created_at);

COMMENT ON TABLE emotion_diaries IS '情绪日记表';
```

### 2. 部署代码文件

```bash
# 上传文件到服务器
scp src/storage/database/emotion_manager.py user@server:/var/www/backend/src/storage/database/
scp src/storage/database/shared/model.py user@server:/var/www/backend/src/storage/database/shared/
scp src/tools/emotion_tools.py user@server:/var/www/backend/src/tools/
scp scripts/test_emotion_database.py user@server:/var/www/backend/scripts/
```

### 3. 重启服务

```bash
# 重启智能体服务
systemctl restart your-service-name

# 验证服务状态
systemctl status your-service-name
```

### 4. 验证部署

```bash
# 运行测试脚本
cd /var/www/backend
python scripts/test_emotion_database.py
```

## 性能优化

### 1. 索引优化

已为以下字段创建索引：
- `emotion_records.user_id`: 加快按用户查询
- `emotion_records.created_at`: 加快按时间范围查询
- `emotion_records.emotion`: 加快按情绪类型统计
- `emotion_diaries.user_id`: 加快按用户查询
- `emotion_diaries.created_at`: 加快按时间范围查询

### 2. 查询优化

- 使用 `LIMIT` 限制返回记录数
- 按时间倒序排列（最新的记录在前）
- 使用分页查询（skip + limit）

### 3. 连接池

数据库连接使用连接池管理，避免频繁创建和销毁连接。

## 数据迁移（可选）

如果有旧的内存数据需要迁移，可以编写迁移脚本：

```python
import json
from coze_coding_dev_sdk.database import get_session
from storage.database.emotion_manager import EmotionManager, EmotionRecordCreate, EmotionDiaryCreate

# 读取旧数据（假设存储在文件中）
with open('old_emotion_data.json', 'r', encoding='utf-8') as f:
    old_data = json.load(f)

# 迁移到数据库
db = get_session()
mgr = EmotionManager()

for record in old_data['emotion_records']:
    mgr.create_emotion_record(db, EmotionRecordCreate(**record))

for diary in old_data['emotion_diaries']:
    mgr.create_emotion_diary(db, EmotionDiaryCreate(**diary))

db.close()
```

## 备份与恢复

### 备份

```bash
# 备份情绪相关表
pg_dump -h localhost -U username -d database_name \
  -t emotion_records -t emotion_diaries \
  -f emotion_backup_$(date +%Y%m%d).sql
```

### 恢复

```bash
# 恢复情绪相关表
psql -h localhost -U username -d database_name \
  -f emotion_backup_20250115.sql
```

## 常见问题

### 1. 外键约束错误

**问题**: 插入情绪记录时提示外键约束错误

**原因**: `user_id` 不存在于 `users` 表中

**解决方案**: 确保 `user_id` 是有效的用户ID

### 2. 数据类型错误

**问题**: `intensity` 字段值超出范围

**原因**: 强度值不在 0.0-1.0 之间

**解决方案**: 确保强度值在有效范围内

### 3. JSON 字段错误

**问题**: `tags` 字段格式错误

**原因**: JSON 格式不正确

**解决方案**: 确保使用正确的 JSON 格式

## 维护建议

### 1. 定期备份

建议每天备份一次情绪数据

### 2. 数据清理

定期清理过期的情绪数据（可选）：

```sql
-- 清理6个月前的情绪记录
DELETE FROM emotion_records
WHERE created_at < now() - interval '6 months';
```

### 3. 性能监控

监控以下指标：
- 查询响应时间
- 数据库连接数
- 表大小增长

### 4. 索引维护

定期重建索引（可选）：

```sql
-- 重建索引
REINDEX TABLE emotion_records;
REINDEX TABLE emotion_diaries;
```

## 总结

情绪系统数据库持久化实现已完成，所有测试通过。数据持久化带来了以下改进：

1. **数据安全**: 数据不会因服务重启而丢失
2. **长期分析**: 支持长期情绪趋势分析
3. **数据备份**: 支持数据备份和恢复
4. **高可用性**: 数据与服务分离，提高系统稳定性

---

**文档版本**: v1.0
**更新日期**: 2025年1月15日
**维护团队**: 陕西媄月商业艺术有限责任公司技术部
