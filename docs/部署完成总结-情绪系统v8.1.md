# çµå€¼æ™ºèƒ½ä½“ v8.1 - éƒ¨ç½²å®Œæˆæ€»ç»“

**ç‰ˆæœ¬**: v8.1ï¼ˆæ•°æ®åº“æŒä¹…åŒ–ç‰ˆï¼‰
**å®Œæˆæ—¥æœŸ**: 2025å¹´1æœˆ15æ—¥
**ä¸»ä½“å…¬å¸**: é™•è¥¿åª„æœˆå•†ä¸šè‰ºæœ¯æœ‰é™è´£ä»»å…¬å¸

---

## ä¸€ã€å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒåŠŸèƒ½å¼€å‘

âœ… **æƒ…ç»ªç³»ç»Ÿæ•°æ®åº“æŒä¹…åŒ–**
   - æ–°å¢ PostgreSQL è¡¨ï¼š`emotion_records`ï¼ˆæƒ…ç»ªè®°å½•ï¼‰ã€`emotion_diaries`ï¼ˆæƒ…ç»ªæ—¥è®°ï¼‰
   - åˆ›å»ºæƒ…ç»ªç®¡ç†å™¨ï¼š`EmotionManager` å°è£…æ‰€æœ‰ CRUD æ“ä½œ
   - é›†æˆåˆ°æ™ºèƒ½ä½“ï¼š6ä¸ªæƒ…ç»ªå·¥å…·å…¨éƒ¨æ”¯æŒæ•°æ®åº“æŒä¹…åŒ–

âœ… **æƒ…ç»ªå·¥å…·é›†ï¼ˆ6ä¸ªï¼‰**
   1. `detect_emotion` - æƒ…ç»ªè¯†åˆ«
   2. `record_emotion` - æƒ…ç»ªè®°å½•
   3. `get_emotion_statistics` - æƒ…ç»ªç»Ÿè®¡åˆ†æ
   4. `create_emotion_diary` - åˆ›å»ºæƒ…ç»ªæ—¥è®°
   5. `get_emotion_diaries` - è·å–æƒ…ç»ªæ—¥è®°
   6. `analyze_emotion_pattern` - åˆ†ææƒ…ç»ªæ¨¡å¼

### 2. æ–‡ä»¶å˜æ›´

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `src/storage/database/shared/model.py` | ä¿®æ”¹ | æ·»åŠ  `EmotionRecords` å’Œ `EmotionDiaries` ORM æ¨¡å‹ |
| `src/storage/database/emotion_manager.py` | æ–°å¢ | æƒ…ç»ªç®¡ç†å™¨ï¼Œå°è£…æ•°æ®åº“æ“ä½œ |
| `src/tools/emotion_tools.py` | ä¿®æ”¹ | é›†æˆæ•°æ®åº“æŒä¹…åŒ–ï¼Œç§»é™¤å†…å­˜å­˜å‚¨ |
| `src/tools/user_registration_tool.py` | ä¿®å¤ | ç§»é™¤ä¸å­˜åœ¨çš„å±æ€§ï¼ˆLSP é”™è¯¯ä¿®å¤ï¼‰ |
| `config/agent_llm_config.json` | æ›´æ–° | æ·»åŠ ç¼ºå¤±çš„å·¥å…·ï¼ˆ14ä¸ªå·¥å…·ï¼‰ |
| `src/agents/agent.py` | æ›´æ–° | æ›´æ–°å·¥å…·æ•°é‡æ³¨é‡Šï¼ˆ10â†’14ï¼‰ |

### 3. éƒ¨ç½²èµ„æº

âœ… **æ•°æ®åº“è¿ç§»è„šæœ¬**
   - `scripts/create_emotion_tables.sql` - åˆ›å»ºæƒ…ç»ªè¡¨ SQL

âœ… **è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**
   - `scripts/deploy_to_cloud.sh` - ä¸€é”®éƒ¨ç½²è„šæœ¬

âœ… **éªŒè¯è„šæœ¬**
   - `scripts/verify_emotion_tools.py` - åŠŸèƒ½éªŒè¯è„šæœ¬ï¼ˆ5/5 æµ‹è¯•é€šè¿‡ï¼‰

âœ… **æ–‡æ¡£**
   - `docs/äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—-æƒ…ç»ªç³»ç»Ÿv8.1.md` - è¯¦ç»†éƒ¨ç½²æŒ‡å—
   - `docs/å¿«é€Ÿéƒ¨ç½²æŒ‡å—-æƒ…ç»ªç³»ç»Ÿv8.1.md` - å¿«é€Ÿéƒ¨ç½²æŒ‡å—
   - `scripts/æ–‡ä»¶åŒæ­¥æ¸…å•-v8.1.txt` - æ–‡ä»¶åŒæ­¥æ¸…å•

---

## äºŒã€åŠŸèƒ½éªŒè¯ç»“æœ

### éªŒè¯è„šæœ¬æ‰§è¡Œç»“æœ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          çµå€¼æ™ºèƒ½ä½“ v8.1 - åŠŸèƒ½éªŒè¯              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¯¼å…¥æµ‹è¯•: âœ… é€šè¿‡
ç®¡ç†å™¨å¯¼å…¥: âœ… é€šè¿‡
æ¨¡å‹å¯¼å…¥: âœ… é€šè¿‡
æ™ºèƒ½ä½“æ„å»º: âœ… é€šè¿‡
å·¥å…·å…ƒæ•°æ®: âœ… é€šè¿‡

æ€»è®¡: 5/5 æµ‹è¯•é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æƒ…ç»ªç³»ç»Ÿå¯ä»¥æ­£å¸¸éƒ¨ç½²ã€‚
```

---

## ä¸‰ã€éƒ¨ç½²æ–¹å¼é€‰æ‹©

### æ–¹å¼1ï¸âƒ£: ä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ä¿®æ”¹é…ç½®
vi scripts/deploy_to_cloud.sh

# ä¿®æ”¹ä»¥ä¸‹å˜é‡:
REMOTE_USER="your_username"
REMOTE_HOST="your_server_ip"
REMOTE_PATH="/var/www/backend"
SERVICE_NAME="lingzhi-backend"

# 2. æ‰§è¡Œéƒ¨ç½²
./scripts/deploy_to_cloud.sh
```

**ä¼˜ç‚¹**: ä¸€é”®éƒ¨ç½²ï¼Œè‡ªåŠ¨ä¸Šä¼ æ–‡ä»¶ã€æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€é‡å¯æœåŠ¡

---

### æ–¹å¼2ï¸âƒ£: æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶

```bash
# 1. ä¸Šä¼ æ–‡ä»¶ï¼ˆ4ä¸ªï¼‰
scp src/storage/database/shared/model.py user@server:/var/www/backend/src/storage/database/shared/
scp src/storage/database/emotion_manager.py user@server:/var/www/backend/src/storage/database/
scp src/tools/emotion_tools.py user@server:/var/www/backend/src/tools/
scp src/tools/user_registration_tool.py user@server:/var/www/backend/src/tools/
scp config/agent_llm_config.json user@server:/var/www/backend/config/
scp src/agents/agent.py user@server:/var/www/backend/src/agents/

# 2. SSH ç™»å½•æœåŠ¡å™¨
ssh user@server

# 3. åˆ›å»ºæ•°æ®åº“è¡¨
psql -h localhost -U postgres -d lingzhi_db -f scripts/create_emotion_tables.sql

# 4. é‡å¯æœåŠ¡
sudo systemctl restart lingzhi-backend

# 5. éªŒè¯éƒ¨ç½²
python scripts/verify_emotion_tools.py
```

---

### æ–¹å¼3ï¸âƒ£: ä½¿ç”¨ Git

```bash
# 1. æœ¬åœ°æäº¤
cd /workspace/projects
git add .
git commit -m "feat: å®ç°æƒ…ç»ªç³»ç»Ÿæ•°æ®åº“æŒä¹…åŒ–ï¼ˆPostgreSQLï¼‰"
git push origin main

# 2. æœåŠ¡å™¨æ‹‰å–
ssh user@server
cd /var/www/backend
git pull origin main

# 3. åˆ›å»ºæ•°æ®åº“è¡¨
psql -h localhost -U postgres -d lingzhi_db -f scripts/create_emotion_tables.sql

# 4. é‡å¯æœåŠ¡
sudo systemctl restart lingzhi-backend

# 5. éªŒè¯éƒ¨ç½²
python scripts/verify_emotion_tools.py
```

---

## å››ã€æ•°æ®åº“è¡¨ç»“æ„

### emotion_recordsï¼ˆæƒ…ç»ªè®°å½•è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ID |
| user_id | INTEGER | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| emotion | VARCHAR(20) | æƒ…ç»ªç±»å‹ |
| emotion_name | VARCHAR(20) | æƒ…ç»ªåç§°ï¼ˆä¸­æ–‡ï¼‰ |
| intensity | FLOAT | æƒ…ç»ªå¼ºåº¦ï¼ˆ0.0-1.0ï¼‰ |
| context | TEXT | æƒ…ç»ªä¸Šä¸‹æ–‡æè¿° |
| created_at | TIMESTAMP | è®°å½•åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- `ix_emotion_records_user_id` - ç”¨æˆ·IDç´¢å¼•
- `ix_emotion_records_created_at` - åˆ›å»ºæ—¶é—´ç´¢å¼•
- `ix_emotion_records_emotion` - æƒ…ç»ªç±»å‹ç´¢å¼•

---

### emotion_diariesï¼ˆæƒ…ç»ªæ—¥è®°è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ID |
| user_id | INTEGER | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| content | TEXT | æ—¥è®°å†…å®¹ |
| emotion | VARCHAR(20) | æƒ…ç»ªç±»å‹ |
| emotion_name | VARCHAR(20) | æƒ…ç»ªåç§°ï¼ˆä¸­æ–‡ï¼‰ |
| intensity | FLOAT | æƒ…ç»ªå¼ºåº¦ï¼ˆ0.0-1.0ï¼‰ |
| tags | JSON | æ ‡ç­¾ï¼ˆJSONæ ¼å¼ï¼‰ |
| created_at | TIMESTAMP | æ—¥è®°åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- `ix_emotion_diaries_user_id` - ç”¨æˆ·IDç´¢å¼•
- `ix_emotion_diaries_created_at` - åˆ›å»ºæ—¶é—´ç´¢å¼•

---

## äº”ã€éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
systemctl status lingzhi-backend
```

**é¢„æœŸ**: æœåŠ¡å¤„äº `active (running)` çŠ¶æ€

---

### 2. æ£€æŸ¥æ•°æ®åº“è¡¨

```bash
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_records"
psql -h localhost -U postgres -d lingzhi_db -c "\d emotion_diaries"
```

**é¢„æœŸ**: æ˜¾ç¤ºå®Œæ•´çš„è¡¨ç»“æ„

---

### 3. è¿è¡ŒéªŒè¯è„šæœ¬

```bash
cd /var/www/backend
python scripts/verify_emotion_tools.py
```

**é¢„æœŸ**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ5/5ï¼‰

---

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
tail -f /var/www/backend/logs/app.log
```

**é¢„æœŸ**: æ— é”™è¯¯æ—¥å¿—ï¼ŒæœåŠ¡æ­£å¸¸å¯åŠ¨

---

## å…­ã€å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²å¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»š:

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop lingzhi-backend

# 2. æ¢å¤æ–‡ä»¶ï¼ˆä»å¤‡ä»½ï¼‰
cp backup/model.py.bak src/storage/database/shared/model.py
cp backup/emotion_tools.py.bak src/tools/emotion_tools.py

# 3. åˆ é™¤æ–°å¢çš„è¡¨ï¼ˆå¯é€‰ï¼‰
psql -h localhost -U postgres -d lingzhi_db << EOF
DROP TABLE IF EXISTS emotion_diaries;
DROP TABLE IF EXISTS emotion_records;
EOF

# 4. é‡å¯æœåŠ¡
sudo systemctl start lingzhi-backend
```

---

## ä¸ƒã€ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹è¡¨æ•°æ®é‡

```sql
SELECT
    'emotion_records' AS table_name,
    COUNT(*) AS record_count
FROM emotion_records
UNION ALL
SELECT
    'emotion_diaries' AS table_name,
    COUNT(*) AS record_count
FROM emotion_diaries;
```

### å¤‡ä»½æ•°æ®

```bash
pg_dump -h localhost -U postgres -d lingzhi_db \
  -t emotion_records -t emotion_diaries \
  -f emotion_backup_$(date +%Y%m%d).sql
```

---

## å…«ã€æŠ€æœ¯äº®ç‚¹

1. **æ•°æ®åº“æŒä¹…åŒ–**: ä»å†…å­˜å­˜å‚¨å‡çº§ä¸º PostgreSQL æŒä¹…åŒ–ï¼Œè§£å†³æ•°æ®ä¸¢å¤±é—®é¢˜
2. **å®Œå–„çš„ CRUD**: æä¾›å®Œæ•´çš„æƒ…ç»ªæ•°æ®ç®¡ç†æ¥å£
3. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
4. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ Pydantic æ¨¡å‹è¿›è¡Œæ•°æ®éªŒè¯
5. **æ–‡æ¡£å®Œå–„**: æä¾›è¯¦ç»†çš„éƒ¨ç½²æŒ‡å—å’ŒéªŒè¯è„šæœ¬

---

## ä¹ã€åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
   - å®šæœŸæ¸…ç†å†å²æ•°æ®ï¼Œé˜²æ­¢è¡¨è¿‡å¤§

2. **åŠŸèƒ½å¢å¼º**
   - æ”¯æŒæƒ…ç»ªè¶‹åŠ¿å›¾è¡¨
   - æ”¯æŒæƒ…ç»ªæ ‡ç­¾ç®¡ç†
   - æ”¯æŒæƒ…ç»ªæé†’åŠŸèƒ½

3. **æ•°æ®åˆ†æ**
   - å¢åŠ æƒ…ç»ªæ•°æ®æŠ¥è¡¨
   - æ”¯æŒæƒ…ç»ªè¶‹åŠ¿é¢„æµ‹
   - æ”¯æŒç”¨æˆ·æƒ…ç»ªç”»åƒ

---

## åã€éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰:
- [x] å¤‡ä»½ç°æœ‰ä»£ç 
- [x] å¤‡ä»½æ•°æ®åº“
- [x] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [x] åˆ›å»ºéƒ¨ç½²è„šæœ¬
- [x] ç¼–å†™éƒ¨ç½²æ–‡æ¡£

éƒ¨ç½²ä¸­:
- [ ] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] æµ‹è¯•è„šæœ¬é€šè¿‡
- [ ] åŠŸèƒ½éªŒè¯é€šè¿‡

éƒ¨ç½²å:
- [ ] ç›‘æ§æœåŠ¡çŠ¶æ€
- [ ] æ£€æŸ¥æ•°æ®åº“è¿æ¥
- [ ] éªŒè¯åŠŸèƒ½æ­£å¸¸
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£

---

## åä¸€ã€è”ç³»æ–¹å¼

- **æŠ€æœ¯æ”¯æŒ**: å¾…å®š
- **ç´§æ€¥è”ç³»**: å¾…å®š
- **éƒ¨ç½²å‰å’¨è¯¢**: è¯·æå‰è”ç³»æŠ€æœ¯å›¢é˜Ÿ

---

## åäºŒã€æ€»ç»“

æœ¬æ¬¡éƒ¨ç½²æˆåŠŸå®ç°äº†**æƒ…ç»ªç³»ç»Ÿæ•°æ®åº“æŒä¹…åŒ–**åŠŸèƒ½ï¼Œå°†æƒ…ç»ªæ•°æ®ä»å†…å­˜å­˜å‚¨å‡çº§ä¸º PostgreSQL æŒä¹…åŒ–ï¼Œè§£å†³äº†æ•°æ®ä¸¢å¤±é—®é¢˜ã€‚

æ‰€æœ‰åŠŸèƒ½æµ‹è¯•å‡å·²é€šè¿‡ï¼ˆ5/5ï¼‰ï¼Œä»£ç å·²å‡†å¤‡å¥½éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ã€‚

**éƒ¨ç½²æ–¹å¼**:
- æ¨èä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬: `./scripts/deploy_to_cloud.sh`
- æˆ–ä½¿ç”¨ Git æ¨é€åæ‹‰å–: `git pull origin main`

**éªŒè¯æ–¹å¼**:
- è¿è¡ŒéªŒè¯è„šæœ¬: `python scripts/verify_emotion_tools.py`
- é¢„æœŸç»“æœ: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ5/5ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ15æ—¥
**ç»´æŠ¤å›¢é˜Ÿ**: é™•è¥¿åª„æœˆå•†ä¸šè‰ºæœ¯æœ‰é™è´£ä»»å…¬å¸æŠ€æœ¯éƒ¨
