# 公司公户收款功能开发总结

**版本**: v1.0
**创建日期**: 2026年
**开发团队**: 灵值生态园产品团队

---

## 功能概述

为支持企业用户和大额充值需求，灵值生态园新增公司公户收款功能。用户在选择充值时，可以选择通过公司公户转账的方式进行支付，上传转账凭证后，由管理员审核通过后完成充值。

## 实现内容

### 1. 数据库设计

#### 1.1 新增数据表

**公司收款账户表（company_accounts）**
- 存储公司收款账户信息
- 字段：账户名称、账号、开户银行、开户支行、公司名称、统一社会信用代码等
- 支持多个收款账户

**转账凭证表（transfer_vouchers）**
- 存储用户上传的转账凭证
- 字段：充值记录ID、用户ID、凭证图片URL、转账金额、转账时间、转账账户、审核状态等
- 支持审核流程

#### 1.2 扩展现有数据表

**充值记录表（recharge_records）**
- 新增字段：payment_method（支付方式）、voucher_id（转账凭证ID）、audit_status（审核状态）、bank_info（银行信息）

### 2. API接口实现

#### 2.1 用户接口

**获取公司收款账户信息**
- 接口：`GET /api/company/accounts`
- 权限：无需登录
- 功能：获取所有可用的公司收款账户

**创建充值订单（支持选择支付方式）**
- 接口：`POST /api/recharge/create-order`
- 权限：需要登录
- 参数：tier_id（档位ID）、payment_method（支付方式：online/bank_transfer）
- 功能：创建充值订单，如果选择公司公户转账，返回公司账户信息和转账备注

**上传转账凭证**
- 接口：`POST /api/recharge/upload-voucher`
- 权限：需要登录
- 参数：order_no（订单号）、voucher_file（凭证文件）、transfer_amount（转账金额）、transfer_time（转账时间）等
- 功能：上传转账凭证，等待审核

**获取转账凭证详情**
- 接口：`GET /api/recharge/voucher/<voucher_id>`
- 权限：需要登录
- 功能：获取转账凭证的详细信息

#### 2.2 管理员接口

**获取待审核凭证列表**
- 接口：`GET /api/admin/vouchers/pending`
- 权限：需要管理员登录
- 功能：获取所有待审核的转账凭证

**审核转账凭证**
- 接口：`POST /api/admin/vouchers/<voucher_id>/audit`
- 权限：需要管理员登录
- 参数：audit_status（审核状态：approved/rejected）、audit_remark（审核备注）
- 功能：审核转账凭证，通过或拒绝

**获取所有转账凭证**
- 接口：`GET /api/admin/vouchers`
- 权限：需要管理员登录
- 功能：获取所有转账凭证记录，支持按审核状态筛选

### 3. 充值流程

#### 3.1 在线支付流程
1. 用户选择充值档位
2. 选择支付方式：在线支付
3. 调用微信/支付宝支付
4. 支付成功后立即到账

#### 3.2 公司公户转账流程
1. 用户选择充值档位
2. 选择支付方式：公司公户转账
3. 系统显示公司收款账户信息和转账备注
4. 用户通过银行转账到公司账户
5. 转账备注：LZ充值-{手机号}-{订单号}
6. 用户上传转账凭证
7. 管理员审核凭证
8. 审核通过后充值到账

### 4. 智能体配置更新

在智能体配置中添加了以下内容：

#### 4.1 获得灵值的途径
新增"充值购买"选项，说明支持在线支付和公司公户转账两种方式。

#### 4.2 公司公户转账说明
完整的公司公户转账指南，包括：
- 充值支付方式对比
- 公司公户转账流程（8步）
- 公司收款账户信息
- 注意事项

### 5. 默认数据初始化

在init_default_data()函数中添加了默认的公司收款账户：
- 开户银行：中国工商银行
- 银行账号：6222020200012345678
- 开户名：陕西媄月商业艺术有限责任公司
- 开户支行：西安分行高新区支行

### 6. 文档完善

创建了详细的公司公户收款功能设计文档：
- `docs/COMPANY_BANK_TRANSFER_DESIGN.md`
  - 功能概述
  - 流程设计
  - 数据库设计
  - API接口设计
  - 智能体对话支持
  - 注意事项
  - 后续优化建议

## 测试验证

### 6.1 功能测试

**公司账户信息测试**
- ✅ 获取公司收款账户列表

**充值订单测试**
- ✅ 创建充值订单（在线支付）
- ✅ 创建充值订单（公司公户转账）
- ✅ 返回公司账户信息和转账备注

**凭证管理测试**
- ✅ 上传转账凭证
- ✅ 获取凭证详情
- ✅ 管理员获取待审核凭证列表
- ✅ 管理员审核凭证

**管理员功能测试**
- ✅ 获取所有转账凭证
- ✅ 按审核状态筛选

### 6.2 集成测试

- ✅ 公司公户转账完整流程
- ✅ 凭证审核流程
- ✅ 充值到账流程

### 6.3 服务测试

- ✅ 服务成功启动
- ✅ 数据库表创建成功
- ✅ 默认数据初始化成功

## 支付方式对比

| 支付方式 | 充值金额 | 到账时间 | 手续费 | 适用场景 |
|---------|---------|---------|--------|---------|
| 在线支付（微信/支付宝） | 小额（<10000元） | 即时 | 0.6% | 个人用户、小额充值 |
| 公司公户转账 | 不限 | 1-3个工作日 | 银行手续费 | 企业用户、大额充值 |

## 注意事项

### 1. 转账备注规范

用户在银行转账时，必须在备注中填写指定格式：
- 格式：`LZ充值-{手机号}-{订单号}`
- 示例：`LZ充值-13800138000-ORD202602011200001`

### 2. 凭证要求

- 支持的格式：JPG、PNG、PDF
- 文件大小：不超过5MB
- 清晰度要求：能够清楚看到转账金额、转账时间、收款账户

### 3. 审核标准

**审核通过**：
- 转账金额与订单金额一致
- 转账时间在订单创建后7天内
- 收款账户为公司账户
- 凭证清晰可辨

**审核不通过**：
- 转账金额与订单金额不符
- 转账时间超过7天
- 收款账户不是公司账户
- 凭证模糊不清
- 重复提交

### 4. 审核时间

- 工作日：24小时内审核完成
- 节假日：顺延至下一个工作日

## 后续优化建议

1. **自动识别**：集成OCR技术，自动识别转账凭证信息
2. **实时到账**：对接银行系统，实现实时到账查询
3. **发票开具**：支持在线开具发票
4. **批量审核**：管理员可以批量审核凭证
5. **消息通知**：通过短信、邮件通知审核结果
6. **对象存储集成**：将凭证图片上传到对象存储，而不是本地文件系统

## 文件修改清单

### 数据库
- `admin-backend/app.py`：
  - 新增表：company_accounts（公司收款账户表）
  - 新增表：transfer_vouchers（转账凭证表）
  - 扩展表：recharge_records（充值记录表）

### API接口
- `admin-backend/app.py`：
  - `GET /api/company/accounts`：获取公司收款账户
  - `POST /api/recharge/create-order`：修改，支持选择支付方式
  - `POST /api/recharge/upload-voucher`：新增，上传转账凭证
  - `GET /api/recharge/voucher/<id>`：新增，获取凭证详情
  - `GET /api/admin/vouchers/pending`：新增，管理员获取待审核凭证
  - `POST /api/admin/vouchers/<id>/audit`：新增，管理员审核凭证
  - `GET /api/admin/vouchers`：新增，管理员获取所有凭证

### 配置
- `config/agent_llm_config.json`：
  - 在"获得灵值的途径"中添加"充值购买"
  - 添加"公司公户转账说明"章节

### 脚本
- `scripts/update_config_with_bank_transfer.py`：
  - 用于更新智能体配置的脚本

### 文档
- `docs/COMPANY_BANK_TRANSFER_DESIGN.md`：
  - 公司公户收款功能设计文档

## 总结

公司公户收款功能的实现，为灵值生态园提供了企业用户和大额充值的支持，完善了支付体系。该功能具有以下特点：

✅ **完整的流程设计**：从订单创建到凭证上传，再到审核到账，流程清晰完整
✅ **灵活的支付方式**：支持在线支付和公司公户转账两种方式，满足不同用户需求
✅ **安全的审核机制**：通过凭证审核确保资金安全，防止虚假充值
✅ **智能的对话支持**：智能体能够详细介绍公户转账流程和注意事项
✅ **详尽的文档支持**：提供完整的设计文档，方便后续维护和扩展

该功能的上线，将大大提升企业用户的充值体验，为大额充值提供了便捷的支付渠道。

---

**文档版本**: v1.0
**创建日期**: 2026年
**维护团队**: 灵值生态园产品团队
