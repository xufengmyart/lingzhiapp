# 灵值智能体 v8.0 - 情绪系统数据库部署检查清单

**版本**: v2.0（数据库持久化版）
**更新日期**: 2025年1月15日
**主体公司**: 陕西媄月商业艺术有限责任公司

## 部署前检查清单

### 1. 数据库表检查 ✅

- [ ] 确认 `emotion_records` 表已创建
- [ ] 确认 `emotion_diaries` 表已创建
- [ ] 确认索引已创建：
  - [ ] `ix_emotion_records_user_id`
  - [ ] `ix_emotion_records_created_at`
  - [ ] `ix_emotion_records_emotion`
  - [ ] `ix_emotion_diaries_user_id`
  - [ ] `ix_emotion_diaries_created_at`
- [ ] 确认外键约束已建立：
  - [ ] `emotion_records_user_id_fkey`
  - [ ] `emotion_diaries_user_id_fkey`

**验证SQL**:
```sql
-- 检查表是否存在
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('emotion_records', 'emotion_diaries');

-- 检查索引是否存在
SELECT indexname FROM pg_indexes
WHERE tablename IN ('emotion_records', 'emotion_diaries');

-- 检查外键约束是否存在
SELECT conname FROM pg_constraint
WHERE conname IN ('emotion_records_user_id_fkey', 'emotion_diaries_user_id_fkey');
```

### 2. ORM 模型检查 ✅

- [ ] 确认 `model.py` 中已定义 `EmotionRecords` 类
- [ ] 确认 `model.py` 中已定义 `EmotionDiaries` 类
- [ ] 确认字段定义正确：
  - [ ] `EmotionRecords.id` (Integer, primary_key)
  - [ ] `EmotionRecords.user_id` (Integer, nullable=False)
  - [ ] `EmotionRecords.emotion` (String(20), nullable=False)
  - [ ] `EmotionRecords.emotion_name` (String(20), nullable=False)
  - [ ] `EmotionRecords.intensity` (Float, nullable=False)
  - [ ] `EmotionRecords.context` (Text, nullable=True)
  - [ ] `EmotionRecords.created_at` (DateTime, nullable=False)
  - [ ] `EmotionDiaries` 字段类似

### 3. Manager 接口检查 ✅

- [ ] 确认 `emotion_manager.py` 已创建
- [ ] 确认 `EmotionManager` 类已定义
- [ ] 确认所有方法已实现：
  - [ ] `create_emotion_record()`
  - [ ] `get_emotion_records()`
  - [ ] `get_emotion_statistics()`
  - [ ] `create_emotion_diary()`
  - [ ] `get_emotion_diaries()`
  - [ ] `analyze_emotion_pattern()`
  - [ ] `get_user_emotion_count()`
  - [ ] `get_user_diary_count()`

### 4. 工具集成检查 ✅

- [ ] 确认 `emotion_tools.py` 已更新
- [ ] 确认已导入数据库模块：
  - [ ] `from coze_coding_dev_sdk.database import get_session`
  - [ ] `from storage.database.emotion_manager import EmotionManager`
- [ ] 确认所有工具函数已集成数据库：
  - [ ] `record_emotion()`
  - [ ] `get_emotion_statistics()`
  - [ ] `create_emotion_diary()`
  - [ ] `get_emotion_diaries()`
  - [ ] `analyze_emotion_pattern()`
- [ ] 确认所有工具都有异常处理和资源管理（try-finally）

### 5. Agent 配置检查 ✅

- [ ] 确认 `config/agent_llm_config.json` 已更新
- [ ] 确认 System Prompt 已更新为 v8.0 版本
- [ ] 确认工具列表包含所有情绪工具：
  - [ ] "情绪识别"
  - [ ] "情绪记录"
  - [ ] "情绪统计分析"
  - [ ] "情绪日记"

### 6. 依赖项检查 ✅

- [ ] 确认 `requirements.txt` 包含所有必要的依赖项：
  - [ ] SQLAlchemy>=2.0.0
  - [ ] pydantic>=2.0.0
  - [ ] psycopg2-binary
  - [ ] psycopg3
  - [ ] psycopg-pool
- [ ] 确认所有依赖项已安装

### 7. 测试验证 ✅

- [ ] 运行 `test_emotion_database.py` 测试脚本
- [ ] 确认所有测试通过：
  - [ ] 数据库连接测试
  - [ ] 情绪记录CRUD测试
  - [ ] 情绪日记CRUD测试
  - [ ] 工具导入测试

## 部署步骤检查清单

### 1. 生产环境准备

- [ ] 备份现有数据库
- [ ] 创建测试环境（可选）

### 2. 创建数据表

- [ ] 在生产数据库执行建表SQL：
  ```sql
  -- emotion_records 表
  CREATE TABLE IF NOT EXISTS emotion_records (...);
  -- emotion_diaries 表
  CREATE TABLE IF NOT EXISTS emotion_diaries (...);
  ```
- [ ] 创建索引
- [ ] 设置表注释

### 3. 部署代码文件

- [ ] 上传 `src/storage/database/shared/model.py`
- [ ] 上传 `src/storage/database/emotion_manager.py`
- [ ] 上传 `src/tools/emotion_tools.py`
- [ ] 上传 `scripts/test_emotion_database.py`
- [ ] 设置正确的文件权限

### 4. 重启服务

- [ ] 停止智能体服务
- [ ] 更新代码
- [ ] 启动智能体服务
- [ ] 验证服务状态

### 5. 功能验证

- [ ] 运行测试脚本
- [ ] 验证情绪记录功能
- [ ] 验证情绪日记功能
- [ ] 验证情绪统计功能
- [ ] 验证情绪模式分析功能

## 已知问题与限制

### 1. user_id 映射策略

**当前实现**：
- 如果 `user_id` 无法转换为整数，使用默认值 1
- 这可能导致数据混淆

**潜在风险**：
- 多个用户的数据可能被错误地关联到同一个用户ID
- 数据隐私和安全风险

**建议改进**：
- 添加用户ID验证逻辑
- 如果 user_id 无效，返回明确的错误信息
- 记录错误日志以便追踪

### 2. 外键约束错误

**当前实现**：
- 如果 `user_id` 不存在于 `users` 表中，会报外键约束错误
- 错误信息会返回给用户

**潜在风险**：
- 可能暴露数据库结构信息

**建议改进**：
- 添加用户存在性验证
- 如果用户不存在，返回友好的错误信息

### 3. 数据验证

**当前实现**：
- `intensity` 值应该在 0.0-1.0 之间
- 但没有在数据库层面强制约束

**潜在风险**：
- 可能插入无效数据

**建议改进**：
- 在数据库层面添加 CHECK 约束：
  ```sql
  ALTER TABLE emotion_records
  ADD CONSTRAINT chk_intensity_range
  CHECK (intensity >= 0.0 AND intensity <= 1.0);
  ```

## 监控与维护

### 日常监控

- [ ] 监控数据库连接数
- [ ] 监控查询响应时间
- [ ] 监控表大小增长
- [ ] 监控错误日志

### 定期维护

- [ ] 每周检查索引使用情况
- [ ] 每月分析查询性能
- [ ] 每季度清理过期数据（可选）
- [ ] 每月备份情绪数据

### 备份策略

- [ ] 每日备份情绪相关表
- [ ] 验证备份文件完整性
- [ ] 测试恢复流程
- [ ] 保留至少 30 天的备份

## 回滚方案

### 如果部署失败

1. **停止服务**
   ```bash
   systemctl stop your-service-name
   ```

2. **回滚代码**
   ```bash
   git checkout <previous-commit>
   ```

3. **删除新增的表（可选）**
   ```sql
   DROP TABLE IF EXISTS emotion_diaries;
   DROP TABLE IF EXISTS emotion_records;
   ```

4. **重启服务**
   ```bash
   systemctl start your-service-name
   ```

5. **验证服务**
   ```bash
   systemctl status your-service-name
   ```

### 如果数据出现问题

1. **停止数据写入**
   - 暂停情绪相关功能

2. **分析问题**
   - 查看错误日志
   - 分析数据库状态

3. **恢复数据**
   - 从备份恢复
   - 或执行数据修复

4. **重新启用功能**
   - 验证数据一致性
   - 重新启用功能

## 性能优化建议

### 1. 查询优化

- [ ] 使用 EXPLAIN ANALYZE 分析慢查询
- [ ] 优化复杂的统计查询
- [ ] 考虑使用物化视图（materialized views）

### 2. 索引优化

- [ ] 监控索引使用情况
- [ ] 删除未使用的索引
- [ ] 考虑添加复合索引

### 3. 数据归档

- [ ] 制定数据归档策略
- [ ] 定期归档历史数据
- [ ] 减少主表数据量

## 安全检查

### 1. 访问控制

- [ ] 确认数据库用户权限最小化
- [ ] 确认只有必要的应用可以访问情绪数据
- [ ] 确认敏感数据加密存储（如果有）

### 2. 数据隐私

- [ ] 确认用户数据隔离
- [ ] 确认数据访问日志
- [ ] 确认数据删除策略

### 3. 审计日志

- [ ] 记录所有数据修改操作
- [ ] 记录用户访问日志
- [ ] 定期审计日志

## 联系支持

如遇到问题，请联系：

- **技术文档**: `docs/` 目录
- **测试脚本**: `scripts/test_emotion_database.py`
- **日志文件**: `logs/app.log`

---

**检查清单版本**: v1.0
**更新日期**: 2025年1月15日
**维护团队**: 陕西媄月商业艺术有限责任公司技术部
