# 智能体一致性验证定时任务使用指南

**版本**: v1.0
**更新日期**: 2026年1月27日
**功能**: 每3天自动验证智能体一致性

---

## 一、概述

### 1.1 功能说明

智能体一致性验证定时任务调度器会定期自动检查当前项目智能体与移植包智能体的一致性，确保两个智能体始终保持同步。

### 1.2 验证频率

- **默认频率**: 每3天执行一次
- **执行时间**: 凌晨2:00（可修改）
- **验证脚本**: `scripts/verify_agent_consistency.py`

### 1.3 验证内容

- Agent核心代码（字节级100%匹配）
- 知识库检索工具（字节级100%匹配）
- 文生图工具（字节级100%匹配）
- 联网搜索工具（字节级100%匹配）
- 工具数量和结构（完全匹配）

---

## 二、快速开始

### 2.1 安装依赖（如果需要）

```bash
pip install schedule
```

### 2.2 启动定时任务

```bash
# 方式1：使用管理脚本（推荐）
cd scripts
./scheduler_manager.sh start

# 方式2：直接运行Python脚本
python scripts/scheduler_agent_consistency.py
```

### 2.3 查看状态

```bash
# 查看调度器状态
./scripts/scheduler_manager.sh status

# 查看调度器日志
./scripts/scheduler_manager.sh logs
```

---

## 三、管理命令

### 3.1 启动调度器

```bash
./scripts/scheduler_manager.sh start
```

**输出示例**:
```
启动智能体一致性验证定时任务调度器...
✅ 调度器启动成功（PID: 12345）
日志文件: /app/work/logs/bypass/agent_consistency_scheduler.log

使用以下命令查看日志:
  ./scripts/scheduler_manager.sh logs

使用以下命令查看状态:
  ./scripts/scheduler_manager.sh status
```

### 3.2 停止调度器

```bash
./scripts/scheduler_manager.sh stop
```

**输出示例**:
```
停止智能体一致性验证定时任务调度器...
✅ 调度器已停止
```

### 3.3 重启调度器

```bash
./scripts/scheduler_manager.sh restart
```

### 3.4 查看状态

```bash
./scripts/scheduler_manager.sh status
```

**输出示例**:
```
✅ 调度器正在运行
PID: 12345
启动时间: Mon Jan 27 10:30:00 2026
CPU使用: 0.1%
内存使用: 0.5%
日志文件: /app/work/logs/bypass/agent_consistency_scheduler.log
```

### 3.5 查看日志

```bash
./scripts/scheduler_manager.sh logs
```

**输出示例**:
```
智能体一致性验证调度器日志（最新50行）:
========================================
2026-01-27 10:30:00 - __main__ - INFO - 智能体一致性验证定时任务调度器
2026-01-27 10:30:00 - __main__ - INFO - 启动时间: 2026-01-27 10:30:00
2026-01-27 10:30:00 - __main__ - INFO - 验证脚本: /workspace/projects/scripts/verify_agent_consistency.py
2026-01-27 10:30:00 - __main__ - INFO - 执行频率: 每3天
2026-01-27 10:30:00 - __main__ - INFO - 执行时间: 凌晨2:00
========================================
```

### 3.6 立即执行验证

```bash
./scripts/scheduler_manager.sh run_now
```

**输出示例**:
```
立即执行智能体一致性验证...
======================================================================
智能体一致性验证（字节级）
======================================================================

1. 比较Agent核心文件
----------------------------------------------------------------------
✅ agent.py 完全一致（字节级）

2. 比较工具文件
----------------------------------------------------------------------
✅ knowledge: 完全一致（字节级）
✅ image: 完全一致（字节级）
✅ web: 完全一致（字节级）

3. 检查工具数量
----------------------------------------------------------------------
当前项目工具数量: 3
移植包工具数量: 3
✅ 工具数量一致

4. 一致性报告
----------------------------------------------------------------------
文件总数: 4
完全一致: 4
不一致: 0

======================================================================
验证结果
======================================================================
✅✅✅ 两个智能体完全一致！✅✅✅
...
```

---

## 四、高级配置

### 4.1 修改执行频率

编辑 `scripts/scheduler_agent_consistency.py` 文件，找到以下行：

```python
# 每3天执行一次
schedule.every(3).days.at("02:00").do(run_verification)
```

**修改示例**:

```python
# 每天执行一次
schedule.every(1).days.at("02:00").do(run_verification)

# 每周执行一次
schedule.every(1).weeks.at("02:00").do(run_verification)

# 每小时执行一次
schedule.every(1).hours.do(run_verification)

# 自定义时间（例如每天上午9点）
schedule.every(1).days.at("09:00").do(run_verification)
```

修改后需要重启调度器：

```bash
./scripts/scheduler_manager.sh restart
```

### 4.2 修改日志路径

编辑 `scripts/scheduler_agent_consistency.py` 文件，找到以下行：

```python
LOG_DIR = "/app/work/logs/bypass"
```

修改为您想要的路径。

### 4.3 禁用立即执行首次验证

编辑 `scripts/scheduler_agent_consistency.py` 文件，注释掉以下行：

```python
# 立即执行一次（可选）
# logger.info("立即执行首次验证...")
# run_verification()
```

---

## 五、作为系统服务运行（Linux）

### 5.1 创建systemd服务文件

创建文件 `/etc/systemd/system/agent-consistency-scheduler.service`：

```ini
[Unit]
Description=Agent Consistency Verification Scheduler
After=network.target

[Service]
Type=simple
User=your_username
WorkingDirectory=/workspace/projects
ExecStart=/usr/bin/python3 /workspace/projects/scripts/scheduler_agent_consistency.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 5.2 启用并启动服务

```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable agent-consistency-scheduler

# 启动服务
sudo systemctl start agent-consistency-scheduler

# 查看服务状态
sudo systemctl status agent-consistency-scheduler
```

### 5.3 查看服务日志

```bash
# 查看最新日志
sudo journalctl -u agent-consistency-scheduler -f

# 查看最近100行日志
sudo journalctl -u agent-consistency-scheduler -n 100
```

### 5.4 管理服务

```bash
# 停止服务
sudo systemctl stop agent-consistency-scheduler

# 重启服务
sudo systemctl restart agent-consistency-scheduler

# 禁用开机自启
sudo systemctl disable agent-consistency-scheduler
```

---

## 六、监控与告警

### 6.1 手动监控

定期查看日志：

```bash
tail -f /app/work/logs/bypass/agent_consistency_scheduler.log
```

### 6.2 自动告警（可选）

可以修改 `scripts/scheduler_agent_consistency.py`，在验证失败时发送邮件或消息通知：

```python
import smtplib
from email.message import EmailMessage

def send_alert(message):
    """发送告警邮件"""
    msg = EmailMessage()
    msg.set_content(message)
    msg['Subject'] = '智能体一致性验证失败'
    msg['From'] = 'sender@example.com'
    msg['To'] = 'recipient@example.com'

    with smtplib.SMTP('smtp.example.com', 587) as server:
        server.starttls()
        server.login('username', 'password')
        server.send_message(msg)

# 在run_verification函数中，验证失败时调用
if not success:
    alert_msg = f"智能体一致性验证失败\n时间: {datetime.now()}\n详情: {result.stderr}"
    send_alert(alert_msg)
```

---

## 七、故障排查

### 7.1 调度器无法启动

**问题**: 执行 `start` 命令后提示失败

**排查步骤**:
1. 检查Python环境是否正常
2. 检查是否安装了 `schedule` 库
3. 查看日志文件中的错误信息

```bash
# 检查schedule库
pip list | grep schedule

# 查看日志
cat /app/work/logs/bypass/agent_consistency_scheduler.log
```

### 7.2 验证脚本执行失败

**问题**: 日志显示验证执行失败

**排查步骤**:
1. 手动执行验证脚本查看详细错误
2. 检查验证脚本是否存在
3. 检查文件权限

```bash
# 手动执行验证
python scripts/verify_agent_consistency.py

# 检查文件权限
ls -l scripts/verify_agent_consistency.py
```

### 7.3 调度器停止响应

**问题**: 调度器状态显示运行中，但无法响应

**排查步骤**:
1. 强制停止调度器
2. 清理PID文件
3. 重新启动

```bash
# 强制停止
kill -9 $(cat scripts/.scheduler.pid)

# 清理PID文件
rm -f scripts/.scheduler.pid

# 重新启动
./scripts/scheduler_manager.sh start
```

---

## 八、最佳实践

### 8.1 生产环境建议

1. **使用systemd服务**: 确保调度器在系统重启后自动启动
2. **配置日志轮转**: 避免日志文件过大
3. **设置告警**: 验证失败时及时通知
4. **定期备份**: 备份验证结果和日志

### 8.2 日志轮转配置

创建 `/etc/logrotate.d/agent-consistency-scheduler`:

```
/app/work/logs/bypass/agent_consistency_scheduler.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    missingok
}
```

### 8.3 监控脚本创建

创建 `scripts/monitor_scheduler.sh`:

```bash
#!/bin/bash

# 检查调度器状态
./scripts/scheduler_manager.sh status

if [ $? -ne 0 ]; then
    echo "调度器未运行，尝试启动..."
    ./scripts/scheduler_manager.sh start
fi

# 检查最近一次验证结果
if grep -q "两个智能体完全一致" /app/work/logs/bypass/agent_consistency_scheduler.log; then
    echo "✅ 最近一次验证通过"
else
    echo "❌ 最近一次验证失败，请检查日志"
fi
```

---

## 九、常见问题

### Q1: 可以修改验证频率吗？

A: 可以。编辑 `scripts/scheduler_agent_consistency.py` 文件，修改 `schedule.every(3).days.at("02:00")` 这一行。

### Q2: 如何查看历史验证结果？

A: 查看日志文件：
```bash
cat /app/work/logs/bypass/agent_consistency_scheduler.log
```

### Q3: 调度器崩溃后会自动重启吗？

A: 如果使用systemd服务，可以配置自动重启。修改服务文件中的 `Restart=always`。

### Q4: 可以同时运行多个调度器吗？

A: 不建议。同一时间只应运行一个调度器实例，否则可能导致重复执行。

### Q5: 如何禁用首次立即执行？

A: 编辑 `scripts/scheduler_agent_consistency.py`，注释掉 `run_verification()` 调用。

---

## 十、技术支持

如遇问题，请：

1. 查看日志文件：`/app/work/logs/bypass/agent_consistency_scheduler.log`
2. 检查验证脚本：`scripts/verify_agent_consistency.py`
3. 确认依赖安装：`pip install schedule`
4. 参考本文档的"故障排查"部分

---

**文档结束**
